// LiveUI Client v1.0.0
"use strict";(()=>{function e(r,o,s){let a=!r.tag&&!r.text&&!r.comment&&r.children||r.fragment,l={...r,el:a?null:o,children:void 0};if(a||(o.i=l),r.refId&&s&&s.set(r.refId,l),r.tag){if(o.nodeType!==Node.ELEMENT_NODE)throw Error(`Hydration error: expected element <${r.tag}> but found nodeType ${o.nodeType}`);{let e=o;if(e.tagName.toLowerCase()!==r.tag.toLowerCase())throw Error(`Hydration error: expected tag <${r.tag}> but found <${e.tagName}>`)}}else if(void 0!==r.text&&""!==r.text&&o.nodeType!==Node.TEXT_NODE)throw Error("Hydration error: expected text node but found nodeType "+o.nodeType);if(r.children&&r.children.length>0){l.children=[];let a=Array.from(o.childNodes).filter(i),h=function(i,n,r,o,s){let a=0;for(let l=0;n.length>l;l++){let h=n[l];if(!h.tag&&!h.text&&!h.comment&&h.children||h.fragment){let e={...h,el:null,children:[]};h.refId&&s&&s.set(h.refId,e),h.children&&(a+=t(e.children,h.children,r,a,o,s)),i.push(e);continue}if(""===h.text){let t=r[a];if(!t||t.nodeType!==Node.TEXT_NODE)throw Error("Hydration error: expected empty text node at index "+l);let n=e(h,t,s);i.push(n),a++;continue}let d=r[a];if(!d)throw Error("Hydration error: missing DOM node for child index "+l);let f=e(h,d,s);i.push(f),a++}return a}(l.children,r.children,a,o,s),d=n(r.children);if(h!==d)throw Error(`Hydration error: expected ${d} renderable children, hydrated ${h}`)}return l}function t(i,n,r,o,s,a){let l=o;for(let o=0;n.length>o;o++){let h=n[o];if(!h.tag&&!h.text&&!h.comment&&h.children||h.fragment){let e={...h,el:null,children:[]};h.refId&&a&&a.set(h.refId,e),h.children&&(l+=t(e.children,h.children,r,l,s,a)),i.push(e);continue}if(""===h.text){let t=r[l];if(!t||t.nodeType!==Node.TEXT_NODE)throw Error("Hydration error: expected empty text node at index "+o);let n=e(h,t,a);i.push(n),l++;continue}let d=r[l];if(!d)throw Error("Hydration error: missing DOM node for child index "+o);let f=e(h,d,a);i.push(f),l++}return l-o}function i(){return 1}function n(e){if(!e||0===e.length)return 0;let t=0;for(let i of e)!(i.tag||i.text||i.comment)&&i.children||i.fragment?t+=n(i.children):(i.tag||void 0!==i.text||i.comment)&&t++;return t}function r(e){if(null==e)return null;let t=typeof e;if("string"===t||"number"===t||"boolean"===t)return e;if(Array.isArray(e)){let t=e.map(r).filter(e=>void 0!==e);return t.length>0?t:null}if(e instanceof Date)return e.toISOString();if(e instanceof DOMTokenList)return Array.from(e);if(!(e instanceof Node))try{return JSON.parse(JSON.stringify(e))}catch{return}}var o,s,a,l,h,d,f,c,u=Object.create,p=Object.defineProperty,w=Object.getOwnPropertyDescriptor,m=Object.getOwnPropertyNames,v=Object.getPrototypeOf,b={}.hasOwnProperty,y=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),g=y(e=>{var t,i,n=e&&e.o||function(e,t,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(e,i):r?r.value=i:t.set(e,i),i},r=e&&e.l||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"h",{value:1}),e.Subject=void 0,e.Subject=class{constructor(){t.set(this,void 0),i.set(this,void 0),n(this,t,0,"f"),n(this,i,new Set,"f")}get size(){return r(this,i,"f").size}subscribe(e){if(r(this,t,"f"))throw Error("Cannot subscribe to a closed subject");return r(this,i,"f").add(e),()=>r(this,i,"f").delete(e)}publish(e){r(this,i,"f").forEach(t=>t(e))}close(){r(this,i,"f").clear(),n(this,t,1,"f")}},t=new WeakMap,i=new WeakMap}),E=y(e=>{var t,i,n=e&&e.o||function(e,t,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(e,i):r?r.value=i:t.set(e,i),i},r=e&&e.l||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"h",{value:1}),e.BehaviorSubject=void 0,i=g(),e.BehaviorSubject=class extends i.Subject{constructor(e){super(),t.set(this,void 0),n(this,t,e,"f")}get value(){return r(this,t,"f")}publish(e){n(this,t,e,"f"),super.publish(e)}subscribe(e){return r(this,t,"f")&&e(r(this,t,"f")),super.subscribe(e)}},t=new WeakMap}),O=y(e=>{var t=e&&e.u||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);(!r||("get"in r?!t.h:r.writable||r.configurable))&&(r={enumerable:1,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.p||function(e,i){for(var n in e)"default"!==n&&!{}.hasOwnProperty.call(i,n)&&t(i,e,n)};Object.defineProperty(e,"h",{value:1}),i(E(),e),i(g(),e)}),M=y(e=>{var t,i,n,r,o,s,a,l,h,d;Object.defineProperty(e,"h",{value:1}),e.PubSubEvents=e.Events=e.ChannelReceiver=e.SystemSender=e.ErrorTypes=e.ChannelState=e.ClientActions=e.ServerActions=e.PresenceEventTypes=void 0,(d=t||(e.PresenceEventTypes=t={})).JOIN="JOIN",d.LEAVE="LEAVE",d.UPDATE="UPDATE",function(e){e.PRESENCE="PRESENCE",e.SYSTEM="SYSTEM",e.BROADCAST="BROADCAST",e.ERROR="ERROR",e.CONNECT="CONNECT"}(i||(e.ServerActions=i={})),function(e){e.JOIN_CHANNEL="JOIN_CHANNEL",e.LEAVE_CHANNEL="LEAVE_CHANNEL",e.BROADCAST="BROADCAST"}(n||(e.ClientActions=n={})),function(e){e.IDLE="IDLE",e.JOINING="JOINING",e.JOINED="JOINED",e.STALLED="STALLED",e.CLOSED="CLOSED"}(r||(e.ChannelState=r={})),function(e){e.UNAUTHORIZED_CONNECTION="UNAUTHORIZED_CONNECTION",e.UNAUTHORIZED_JOIN_REQUEST="UNAUTHORIZED_JOIN_REQUEST",e.UNAUTHORIZED_BROADCAST="UNAUTHORIZED_BROADCAST",e.INVALID_MESSAGE="INVALID_MESSAGE",e.HANDLER_NOT_FOUND="HANDLER_NOT_FOUND",e.PRESENCE_ERROR="PRESENCE_ERROR",e.CHANNEL_ERROR="CHANNEL_ERROR",e.ENDPOINT_ERROR="ENDPOINT_ERROR",e.INTERNAL_SERVER_ERROR="INTERNAL_SERVER_ERROR"}(o||(e.ErrorTypes=o={})),function(e){e.ENDPOINT="ENDPOINT",e.CHANNEL="CHANNEL"}(s||(e.SystemSender=s={})),function(e){e.ALL_USERS="ALL_USERS",e.ALL_EXCEPT_SENDER="ALL_EXCEPT_SENDER"}(a||(e.ChannelReceiver=a={})),function(e){e.ACKNOWLEDGE="ACKNOWLEDGE",e.CONNECTION="CONNECTION"}(l||(e.Events=l={})),function(e){e.MESSAGE="MESSAGE",e.PRESENCE="PRESENCE",e.GET_PRESENCE="GET_PRESENCE"}(h||(e.PubSubEvents=h={}))}),N=y(e=>{Object.defineProperty(e,"h",{value:1}),e.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}}),k=y(e=>{Object.defineProperty(e,"h",{value:1})}),S=y(e=>{var t=e&&e.u||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);(!r||("get"in r?!t.h:r.writable||r.configurable))&&(r={enumerable:1,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.p||function(e,i){for(var n in e)"default"!==n&&!{}.hasOwnProperty.call(i,n)&&t(i,e,n)};Object.defineProperty(e,"h",{value:1}),i(N(),e),i(k(),e)}),C=y(e=>{function t(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}function i(e,t){if(!function(e){return"string"==typeof e}(e))throw new a("Expected string, got "+typeof e,t)}function n(e,i){if(!t(e))throw new a("Expected object, got "+typeof e,i)}function r(e,i){if(!function(e){return t(e)?Object.keys(e).every(e=>"string"==typeof e):0}(e))throw new a("Expected record with string keys, got "+typeof e,i)}function o(e,t,i){let n=Object.values(t);if(!n.includes(e))throw new a(`Expected one of [${n.join(", ")}], got ${JSON.stringify(e)}`,i)}Object.defineProperty(e,"h",{value:1}),e.channelEventSchema=e.serverMessageSchema=e.presenceMessageSchema=e.clientMessageSchema=e.ValidationError=void 0;var s=M(),a=class extends Error{constructor(e,t){super(t?`${t}: ${e}`:e),this.path=t,this.name="ValidationError"}};e.ValidationError=a,e.clientMessageSchema={parse(e){n(e,"clientMessage");let t=e;if(!("event"in t))throw new a("Missing required field","event");if(!("requestId"in t))throw new a("Missing required field","requestId");if(!("channelName"in t))throw new a("Missing required field","channelName");if(!("payload"in t))throw new a("Missing required field","payload");if(!("action"in t))throw new a("Missing required field","action");return i(t.event,"event"),i(t.requestId,"requestId"),i(t.channelName,"channelName"),r(t.payload,"payload"),o(t.action,s.ClientActions,"action"),{event:t.event,requestId:t.requestId,channelName:t.channelName,payload:t.payload,action:t.action}}},e.presenceMessageSchema={parse(e){n(e,"presenceMessage");let t=e;if(!("requestId"in t))throw new a("Missing required field","requestId");if(!("channelName"in t))throw new a("Missing required field","channelName");if(!("event"in t))throw new a("Missing required field","event");if(!("action"in t))throw new a("Missing required field","action");if(!("payload"in t))throw new a("Missing required field","payload");if(i(t.requestId,"requestId"),i(t.channelName,"channelName"),o(t.event,s.PresenceEventTypes,"event"),t.action!==s.ServerActions.PRESENCE)throw new a(`Expected ${s.ServerActions.PRESENCE}, got ${JSON.stringify(t.action)}`,"action");n(t.payload,"payload");let l=t.payload;if(!("presence"in l))throw new a("Missing required field","payload.presence");if(!("changed"in l))throw new a("Missing required field","payload.changed");return function(e){if(!function(e){return Array.isArray(e)}(e))throw new a("Expected array, got "+typeof e,"payload.presence")}(l.presence),l.presence.forEach((e,t)=>{r(e,`payload.presence[${t}]`)}),r(l.changed,"payload.changed"),{requestId:t.requestId,channelName:t.channelName,event:t.event,action:s.ServerActions.PRESENCE,payload:{presence:l.presence,changed:l.changed}}}},e.serverMessageSchema={parse(e){n(e,"serverMessage");let t=e;if(!("event"in t))throw new a("Missing required field","event");if(!("requestId"in t))throw new a("Missing required field","requestId");if(!("channelName"in t))throw new a("Missing required field","channelName");if(!("payload"in t))throw new a("Missing required field","payload");if(!("action"in t))throw new a("Missing required field","action");i(t.event,"event"),i(t.requestId,"requestId"),i(t.channelName,"channelName"),r(t.payload,"payload");let o=[s.ServerActions.BROADCAST,s.ServerActions.CONNECT,s.ServerActions.ERROR,s.ServerActions.SYSTEM];if(!o.includes(t.action))throw new a(`Expected one of [${o.join(", ")}], got ${JSON.stringify(t.action)}`,"action");return{event:t.event,requestId:t.requestId,channelName:t.channelName,payload:t.payload,action:t.action}}},e.channelEventSchema={parse(t){n(t,"channelEvent");let i=t;if(!("action"in i))throw new a("Missing required field","action");return i.action===s.ServerActions.PRESENCE?e.presenceMessageSchema.parse(t):e.serverMessageSchema.parse(t)}}}),x=y(e=>{var t=e&&e.u||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);(!r||("get"in r?!t.h:r.writable||r.configurable))&&(r={enumerable:1,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.p||function(e,i){for(var n in e)"default"!==n&&!{}.hasOwnProperty.call(i,n)&&t(i,e,n)};Object.defineProperty(e,"h",{value:1}),i(O(),e),i(M(),e),i(S(),e),i(C(),e)}),R=y(e=>{var t,i,n,r,o,s,a,l,h,d,f,c,u,p,w,m,v=e&&e.o||function(e,t,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(e,i):r?r.value=i:t.set(e,i),i},b=e&&e.l||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"h",{value:1}),e.Channel=void 0,m=x(),e.Channel=class{constructor(e,f,c,u){t.add(this),i.set(this,void 0),n.set(this,void 0),r.set(this,void 0),o.set(this,void 0),s.set(this,void 0),a.set(this,void 0),l.set(this,void 0),h.set(this,void 0),d.set(this,void 0),v(this,i,c,"f"),v(this,n,[],"f"),v(this,r,[],"f"),v(this,a,u,"f"),v(this,s,e,"f"),v(this,h,f,"f"),v(this,l,new m.Subject,"f"),v(this,d,new m.BehaviorSubject(m.ChannelState.IDLE),"f"),v(this,o,()=>{},"f")}get channelState(){return b(this,d,"f").value}get presence(){return b(this,r,"f")}acknowledge(e){b(this,d,"f").publish(m.ChannelState.JOINED),b(this,t,"m",c).call(this,e),b(this,t,"m",f).call(this)}join(){let e={action:m.ClientActions.JOIN_CHANNEL,event:m.ClientActions.JOIN_CHANNEL,payload:b(this,a,"f"),channelName:b(this,i,"f"),requestId:(0,m.uuid)()};if(b(this,d,"f").value!==m.ChannelState.JOINED)if(b(this,d,"f").publish(m.ChannelState.JOINING),b(this,h,"f").value)b(this,s,"f").call(this,e);else{let t=b(this,h,"f").subscribe(i=>{i&&(t(),b(this,d,"f").value===m.ChannelState.JOINING&&b(this,s,"f").call(this,e))})}}leave(){let e={action:m.ClientActions.LEAVE_CHANNEL,event:m.ClientActions.LEAVE_CHANNEL,channelName:b(this,i,"f"),requestId:(0,m.uuid)(),payload:{}};b(this,t,"m",p).call(this,e),b(this,d,"f").publish(m.ChannelState.CLOSED),b(this,o,"f").call(this)}onChannelStateChange(e){return b(this,d,"f").subscribe(t=>{e(t)})}onJoin(e){return b(this,t,"m",w).call(this,(t,i)=>{if(t===m.PresenceEventTypes.JOIN)return e(i.changed)})}onLeave(e){return b(this,t,"m",w).call(this,(t,i)=>{if(t===m.PresenceEventTypes.LEAVE)return e(i.changed)})}onMessage(e){return b(this,t,"m",u).call(this,(t,i)=>{e(t,i)})}onMessageEvent(e,t){return this.onMessage((i,n)=>{if(i===e)return t(n)})}onPresenceChange(e){return b(this,t,"m",w).call(this,(t,i)=>{if(t===m.PresenceEventTypes.UPDATE)return e(i)})}onUsersChange(e){return b(this,t,"m",w).call(this,(t,i)=>e(i.presence))}sendMessage(e,n){let r=(0,m.uuid)(),o={action:m.ClientActions.BROADCAST,channelName:b(this,i,"f"),requestId:r,event:e,payload:n};b(this,t,"m",p).call(this,o)}sendForResponse(e,n){let r=(0,m.uuid)();return new Promise(o=>{let s=b(this,t,"m",u).call(this,(e,t,i)=>{r===i&&(o(t),s())}),a={action:m.ClientActions.BROADCAST,channelName:b(this,i,"f"),requestId:r,event:e,payload:n};b(this,t,"m",p).call(this,a)})}},i=new WeakMap,n=new WeakMap,r=new WeakMap,o=new WeakMap,s=new WeakMap,a=new WeakMap,l=new WeakMap,h=new WeakMap,d=new WeakMap,t=new WeakSet,f=function(){b(this,n,"f").forEach(e=>b(this,s,"f").call(this,e)),v(this,n,[],"f")},c=function(e){b(this,o,"f").call(this);let n=e.subscribe(e=>{e.channelName===b(this,i,"f")&&this.channelState===m.ChannelState.JOINED&&b(this,l,"f").publish(e)}),f=b(this,h,"f").subscribe(e=>{if(e&&b(this,d,"f").value===m.ChannelState.STALLED){let e={action:m.ClientActions.JOIN_CHANNEL,event:m.ClientActions.JOIN_CHANNEL,payload:b(this,a,"f"),channelName:b(this,i,"f"),requestId:(0,m.uuid)()};b(this,s,"f").call(this,e)}else!e&&b(this,d,"f").value===m.ChannelState.JOINED&&b(this,d,"f").publish(m.ChannelState.STALLED)}),c=b(this,t,"m",w).call(this,(e,t)=>{v(this,r,t.presence,"f")});v(this,o,()=>{n(),f(),c()},"f")},u=function(e){return b(this,l,"f").subscribe(t=>{if(t.action!==m.ServerActions.PRESENCE)return e(t.event,t.payload,t.requestId)})},p=function(e){if(b(this,d,"f").value===m.ChannelState.JOINED)return b(this,s,"f").call(this,e);b(this,n,"f").push(e)},w=function(e){return b(this,l,"f").subscribe(t=>{if(t.action===m.ServerActions.PRESENCE)return e(t.event,t.payload)})}}),T=y(e=>{var t,i,n,r,o,s,a,l=e&&e.o||function(e,t,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(e,i):r?r.value=i:t.set(e,i),i},h=e&&e.l||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"h",{value:1}),e.PondClient=void 0,s=x(),a=R(),e.PondClient=class{constructor(e,n={}){let r;t.add(this),i.set(this,void 0);try{r=new URL(e)}catch{r=new URL(""+window.location),r.pathname=e}this.m=0;let a=new URLSearchParams(n);r.search=""+a,"wss:"!==r.protocol&&"ws:"!==r.protocol&&(r.protocol="https:"===r.protocol?"wss:":"ws:"),this.v=r,l(this,i,new Map,"f"),this.O=new s.Subject,this.M=new s.BehaviorSubject(0),h(this,t,"m",o).call(this)}connect(){this.m=0;let e=new WebSocket(""+this.v);e.onmessage=e=>{let t=e.data.trim().split("\n");for(let e of t)if(e.trim()){let t=JSON.parse(e),i=s.channelEventSchema.parse(t);this.O.publish(i)}},e.onerror=()=>e.close(),e.onclose=()=>{this.M.publish(0),!this.m&&setTimeout(()=>{this.connect()},1e3)},this.N=e}getState(){return this.M.value}disconnect(){var e;this.M.publish(0),this.m=1,null===(e=this.N)||void 0===e||e.close(),h(this,i,"f").clear()}createChannel(e,r){let o=h(this,i,"f").get(e);if(o&&o.channelState!==s.ChannelState.CLOSED)return o;let l=h(this,t,"m",n).call(this),d=new a.Channel(l,this.M,e,r||{});return h(this,i,"f").set(e,d),d}onConnectionChange(e){return this.M.subscribe(e)}},i=new WeakMap,t=new WeakSet,n=function(){return e=>{this.M.value&&this.N.send(JSON.stringify(e))}},r=function(e){var r;let o=null!==(r=h(this,i,"f").get(e.channelName))&&void 0!==r?r:new a.Channel(h(this,t,"m",n).call(this),this.M,e.channelName,{});h(this,i,"f").set(e.channelName,o),o.acknowledge(this.O)},o=function(){this.O.subscribe(e=>{e.event===s.Events.ACKNOWLEDGE?h(this,t,"m",r).call(this,e):e.event===s.Events.CONNECTION&&e.action===s.ServerActions.CONNECT&&this.M.publish(1)})}}),j=y((e,t)=>{var i=function(){if("object"==typeof self&&self)return self;if("object"==typeof window&&window)return window;throw Error("Unable to resolve global `this`")};t.exports=function(){if(this)return this;if("object"==typeof globalThis&&globalThis)return globalThis;try{Object.defineProperty(Object.prototype,"k",{get:function(){return this},configurable:1})}catch{return i()}try{return __global__||i()}finally{delete Object.prototype.k}}()}),_=y((e,t)=>{t.exports={name:"websocket",description:"Websocket Client & Server Library implementing the WebSocket protocol as specified in RFC 6455.",keywords:["websocket","websockets","socket","networking","comet","push","RFC-6455","realtime","server","client"],author:"Brian McKelvey <theturtle32@gmail.com> (https://github.com/theturtle32)",contributors:["IÃ±aki Baz Castillo <ibc@aliax.net> (http://dev.sipdoc.net)"],version:"1.0.35",repository:{type:"git",url:"https://github.com/theturtle32/WebSocket-Node.git"},homepage:"https://github.com/theturtle32/WebSocket-Node",engines:{node:">=4.0.0"},dependencies:{bufferutil:"^4.0.1",debug:"^2.2.0","es5-ext":"^0.10.63","typedarray-to-buffer":"^3.1.5","utf-8-validate":"^5.0.2",yaeti:"^0.0.6"},devDependencies:{"buffer-equal":"^1.0.0",gulp:"^4.0.2","gulp-jshint":"^2.0.4","jshint-stylish":"^2.2.1",jshint:"^2.0.0",tape:"^4.9.1"},config:{verbose:0},scripts:{test:"tape test/unit/*.js",gulp:"gulp"},main:"index",directories:{lib:"./lib"},browser:"lib/browser.js",license:"Apache-2.0"}}),I=y((e,t)=>{t.exports=_().version}),q=y((e,t)=>{function i(e,t){return t?new r(e,t):new r(e)}var n,r,o;if("object"==typeof globalThis)n=globalThis;else try{n=j()}catch{}finally{if(!n&&"u">typeof window&&(n=window),!n)throw Error("Could not determine global this")}r=n.WebSocket||n.MozWebSocket,o=I(),r&&["CONNECTING","OPEN","CLOSING","CLOSED"].forEach(function(e){Object.defineProperty(i,e,{get:function(){return r[e]}})}),t.exports={w3cwebsocket:r?i:null,version:o}}),A=y(e=>{Object.defineProperty(e,"h",{value:1}),e.PondClient=void 0;var t=x(),i=T(),n=q().w3cwebsocket;e.PondClient=class extends i.PondClient{connect(e=1){this.m=0;let i=new n(""+this.v);i.onopen=()=>this.M.publish(1),i.onmessage=e=>{let i=e.data.trim().split("\n");for(let e of i)if(e.trim()){let i=JSON.parse(e),n=t.channelEventSchema.parse(i);this.O.publish(n)}},i.onerror=()=>i.close(),i.onclose=()=>{this.M.publish(0),!this.m&&setTimeout(()=>{this.connect()},1e3)}}}}),D=(c=null!=(f=y(e=>{var t,i,n,r;Object.defineProperty(e,"h",{value:1}),e.PondClient=e.ChannelState=void 0,t=x(),Object.defineProperty(e,"ChannelState",{enumerable:1,get:function(){return t.ChannelState}}),i=T(),n=A(),r=typeof window>"u"?n.PondClient:i.PondClient,e.PondClient=r})())?u(v(f)):{},((e,t,i,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let i of m(t))!b.call(e,i)&&undefined!==i&&p(e,i,{get:()=>t[i],enumerable:!(n=w(t,i))||n.enumerable});return e})(p(c,"default",{value:f,enumerable:1}),f)),P=class{static configure(e){this.debugMode=e.debug??0}static debug(e,t,i){}static warn(e,t,i){}static error(e,t,i){}};P.debugMode=0,o=class{constructor(e,t,i,n,r){this.root=e,this.events=t,this.router=i,this.uploads=n,this.refs=r}apply(e){let t=this.traverse(e.path);if(t)switch(P.debug("Patcher","Apply",{op:e.op,path:e.path,index:e.index,name:e.name,selector:e.selector}),e.op){case"setText":this.setText(t,e.value);break;case"setAttr":this.setAttr(t,e.value);break;case"delAttr":this.delAttr(t,e.name);break;case"setStyleDecl":this.setStyleDecl(t,e.selector,e.name,e.value);break;case"delStyleDecl":this.delStyleDecl(t,e.selector,e.name);break;case"replaceNode":this.replaceNode(t,e.value,e.path);break;case"addChild":this.addChild(t,e.value,e.index);break;case"delChild":this.delChild(t,e.index,e.value?.key);break;case"moveChild":this.moveChild(t,e.value);break;case"setRef":this.setRef(t,e.value);break;case"delRef":this.delRef(t);break;case"setComment":this.setComment(t,e.value);break;case"setStyle":this.setStyle(t,e.value);break;case"delStyle":this.delStyle(t,e.name);break;case"setHandlers":this.setHandlers(t,e.value);break;case"setRouter":this.setRouter(t,e.value);break;case"delRouter":this.delRouter(t);break;case"setUpload":this.setUpload(t,e.value);break;case"delUpload":this.delUpload(t);break;case"setComponent":t.componentId=e.value;break;default:P.warn("Patcher","Unsupported op",e.op)}else P.warn("Patcher","Target not found for path",e.path)}traverse(e){let t=this.root;for(let i of e){if(!t.children||!t.children[i])return P.warn("Patcher","Traverse missing child",{path:e,failedIndex:i,currentTag:t.tag,childrenLength:t.children?.length}),null;t=t.children[i]}return P.debug("Patcher","Traverse resolved",{path:e,tag:t.tag,componentId:t.componentId,key:t.key,hasChildren:!!t.children?.length}),t}setText(e,t){e.el&&(e.el.textContent=t),e.text=t}setAttr(e,t){if(e.el&&e.el instanceof Element)for(let[i,n]of Object.entries(t))e.el.setAttribute(i,n.join(" "));e.attrs||(e.attrs={}),Object.assign(e.attrs,t)}delAttr(e,t){e.el&&e.el instanceof Element&&e.el.removeAttribute(t),e.attrs&&delete e.attrs[t]}replaceNode(t,i,n){let r=this.collectDomNodes(t);if(0===r.length)return void P.warn("Patcher","Cannot replace node with no DOM elements",t);let o=r[0];if(!o.parentNode)return void P.warn("Patcher","Cannot replace node without parent",t);let s=this.render(i);o.parentNode.replaceChild(s,o);for(let e=1;r.length>e;e++){let t=r[e];t.parentNode&&t.parentNode.removeChild(t)}this.events.detach(t),this.router.detach(t),this.uploads.unbind(t),this.detachRefsRecursively(t);let a=n.slice(0,-1),l=n[n.length-1],h=this.traverse(a);if(h&&h.children){let t=e(i,s,this.refs);h.children[l]=t,this.events.attach(t),this.router.attach(t)}}collectDomNodes(e){if(e.el)return[e.el];let t=[];if(e.children)for(let i of e.children){let e=this.collectDomNodes(i);for(let i of e)t.push(i)}return t}render(e){if(void 0!==e.text)return document.createTextNode(e.text);if(e.tag){let t=document.createElement(e.tag);if(e.attrs)for(let[i,n]of Object.entries(e.attrs))t.setAttribute(i,n.join(" "));if(e.style&&t instanceof HTMLElement)for(let[i,n]of Object.entries(e.style))t.style.setProperty(i,n);if(e.styles&&t instanceof HTMLStyleElement&&(t.textContent=this.buildStyleContent(e.styles)),e.children)for(let i of e.children)t.appendChild(this.render(i));return t}if(e.children&&e.children.length>0){let t=document.createDocumentFragment();for(let i of e.children)t.appendChild(this.render(i));return t}return document.createComment(e.comment||"")}addChild(t,i,n){if(!t.el||!t.el.childNodes)return void P.warn("Patcher","Cannot add child to non-element",t);let r=this.render(i),o=e(i,r,this.refs);t.children||(t.children=[]);let s=Math.max(0,Math.min(n,t.children.length));if(t.children.length>s){let e=null;for(let i=s;t.children.length>i;i++)if(t.children[i].el){e=t.children[i].el;break}e?t.el.insertBefore(r,e):t.el.appendChild(r),t.children.splice(s,0,o)}else t.el.appendChild(r),t.children.push(o);this.events.attach(o),this.router.attach(o)}delChild(e,t,i){if(!e.children||!e.children[t]){if(i&&e.children){let n=e.children.findIndex(e=>e&&e.key===i);n>=0&&(t=n)}if(!e.children||!e.children[t])return void P.warn("Patcher","Cannot delete missing child",{index:t,childrenLength:e.children?.length,parentTag:e.tag,parentComponentId:e.componentId})}let n=e.children[t];this.removeDomNodes(n),e.children.splice(t,1),this.events.detach(n),this.router.detach(n),this.uploads.unbind(n),this.detachRefsRecursively(n)}removeDomNodes(e){let t=this.collectDomNodes(e);for(let e of t)e.parentNode&&e.parentNode.removeChild(e)}moveChild(e,t){if(!e.children||0===e.children.length)return void P.warn("Patcher","Cannot move child in empty parent",{value:t});let i=-1,n=Math.max(0,Math.min(t.newIdx,e.children.length-1));if(t.key){let n=t.key,r=e.children.findIndex(e=>e&&e.key===n);r>=0&&(i=r)}if(0>i||i>=e.children.length)return void P.warn("Patcher","Cannot move missing child",{fromIdx:i,value:t});let r=e.children[i];e.children.splice(i,1);let o=Math.max(0,Math.min(n,e.children.length));if(e.children.splice(o,0,r),!e.el||!r.el)return;let s=null;for(let t=o+1;e.children.length>t;t++)if(e.children[t].el){s=e.children[t].el;break}s?e.el.insertBefore(r.el,s):e.el.appendChild(r.el)}setRef(e,t){e.refId=t,this.refs.set(t,e)}delRef(e){e.refId&&(this.refs.delete(e.refId),delete e.refId)}setComment(e,t){e.el&&(e.el.textContent=t),e.comment=t}setStyle(e,t){if(e.el&&e.el instanceof HTMLElement)for(let[i,n]of Object.entries(t))e.el.style.setProperty(i,n);e.style||(e.style={}),Object.assign(e.style,t)}setStyleDecl(e,t,i,n){if(e.el&&e.el instanceof HTMLStyleElement&&e.el.sheet){let r=e.el.sheet;for(let e=0;r.cssRules.length>e;e++){let o=r.cssRules[e];if(o.selectorText===t)return void o.style.setProperty(i,n)}let o=r.cssRules.length;try{r.insertRule(`${t} { ${i}: ${n}; }`,o)}catch(e){P.warn("Patcher","Failed to insert rule",{selector:t,error:e})}}}delStyleDecl(e,t,i){if(e.el&&e.el instanceof HTMLStyleElement&&e.el.sheet){let n=e.el.sheet;for(let e=0;n.cssRules.length>e;e++){let r=n.cssRules[e];if(r.selectorText===t)return void r.style.removeProperty(i)}}}delStyle(e,t){e.el&&e.el instanceof HTMLElement&&e.el.style.removeProperty(t),e.style&&delete e.style[t]}setHandlers(e,t){this.events.detach(e),e.handlers=t,this.events.attach(e)}setRouter(e,t){this.router.detach(e),e.router=t,this.router.attach(e)}delRouter(e){this.router.detach(e),delete e.router}setUpload(e,t){this.uploads.bind(e,t)}delUpload(e){this.uploads.unbind(e)}detachRefsRecursively(e){if(this.uploads.unbind(e),e.refId&&this.refs.delete(e.refId),e.children)for(let t of e.children)this.detachRefsRecursively(t)}buildStyleContent(e){let t=[];for(let[i,n]of Object.entries(e)){let e=[];for(let[t,i]of Object.entries(n))e.push(`${t}: ${i};`);e.length>0&&t.push(`${i} { ${e.join(" ")} }`)}return t.join("\n")}},s=class{constructor(e,t){this.channel=e,this.sid=t,this.listeners=new WeakMap}attach(e){if(e&&(e.el&&e.handlers&&e.handlers.length>0&&this.bindEvents(e),e.children))for(let t of e.children)this.attach(t)}detach(e){if(e&&(e.el&&this.unbindEvents(e.el),e.children))for(let t of e.children)this.detach(t)}bindEvents(e){if(!e.el||!e.handlers)return;let t=e.el,i=this.listeners.get(t);i||(i=new Map,this.listeners.set(t,i));for(let n of e.handlers){if(!n||!n.event||!n.handler)continue;let r=i.get(n.event)||[];if(r.some(e=>e.handlerId===n.handler))continue;let o=t=>{!(n.listen&&n.listen.includes("allowDefault"))&&t.cancelable&&t.preventDefault(),this.triggerHandler(n,t,e),(!n.listen||!n.listen.includes("bubble"))&&t.stopPropagation()};t.addEventListener(n.event,o),i.set(n.event,[...r,{handlerId:n.handler,listener:o}]),P.debug("Events","Attached listener",{event:n.event,handler:n.handler})}}unbindEvents(e){let t=this.listeners.get(e);if(t){for(let[i,n]of t.entries())for(let t of n)e.removeEventListener(i,t.listener);this.listeners.delete(e)}}triggerHandler(e,t,i){P.debug("Events","Triggering handler",{handlerId:e.handler,type:t.type});let n=i.el instanceof Element?i.el:void 0,o=function(e,t,i){if(!Array.isArray(t)||0===t.length)return;let n={};return t.forEach(t=>{if("string"!=typeof t||0===t.length)return;let o=function(e,t,i){let n,o=e.split(".").map(e=>e.trim()).filter(Boolean);if(0!==o.length){switch(o.shift()){case"event":n=t;break;case"target":n=t.target??null;break;case"currentTarget":n=t.currentTarget??null;break;case"element":case"ref":n=i?.refElement??(t.currentTarget instanceof Element?t.currentTarget:null);break;default:return}for(let e of o){if(null==n)return;try{n=n[e]}catch{return}}return r(n)}}(t,e,i);void 0!==o&&(n[t]=o)}),Object.keys(n).length>0?n:void 0}(t,e.props,{refElement:n}),s={name:t.type};void 0!==o&&(s.detail=o),P.debug("WS Send","evt",{t:"evt",sid:this.sid,hid:e.handler,payload:s}),this.channel.sendMessage("evt",{t:"evt",sid:this.sid,hid:e.handler,payload:s})}},a=class{constructor(e,t){this.channel=e,this.sessionId=t,this.listeners=new WeakMap,window.addEventListener("popstate",e=>this.onPopState(e))}attach(e){if(!e||!e.router||!e.el)return;let t=e.el;if(this.listeners.has(t))return;let i=t=>{t.preventDefault(),this.navigate(e.router)};t.addEventListener("click",i),this.listeners.set(t,i)}detach(e){if(!e||!e.el)return;let t=e.el,i=this.listeners.get(t);i&&(t.removeEventListener("click",i),this.listeners.delete(t))}navigate(e){let t=e.path??window.location.pathname,i=void 0!==e.query?e.query:window.location.search,n=void 0!==e.hash?e.hash:window.location.hash,r=i.startsWith("?")?i.substring(1):i,o=t+(r?"?"+r:"")+(n?"#"+n:"");e.replace?window.history.replaceState({},"",o):window.history.pushState({},"",o),this.sendNav("nav",t,r,n)}onPopState(e){let t=window.location.pathname,i=window.location.search,n=window.location.hash;this.sendNav("pop",t,i,n)}sendNav(e,t,i,n){P.debug("Router","Sending "+e,{path:t,query:i,hash:n});let r=i.startsWith("?")?i.substring(1):i;P.debug("WS Send",e,{sid:this.sessionId,path:t,q:r,hash:n}),this.channel.sendMessage(e,{sid:this.sessionId,path:t,q:r,hash:n})}},l=class{constructor(e){this.refs=e}execute(e){if(e&&0!==e.length)for(let t of e)this.executeOne(t)}executeOne(e){let t=this.refs.get(e.ref);if(!t||!t.el)return void P.warn("DOMAction","Ref not found",{ref:e.ref});let i=t.el;try{switch(e.kind){case"dom.call":e.method&&"function"==typeof i[e.method]?i[e.method](...e.args||[]):P.warn("DOMAction","Method not found",{method:e.method});break;case"dom.set":e.prop&&(i[e.prop]=e.value);break;case"dom.toggle":e.prop&&(i[e.prop]=!i[e.prop]);break;case"dom.class":e.class&&(1==e.on?i.classList.add(e.class):0==e.on?i.classList.remove(e.class):i.classList.toggle(e.class));break;case"dom.scroll":if(i.scrollIntoView){let t={};e.behavior&&(t.behavior=e.behavior),e.block&&(t.block=e.block),e.inline&&(t.inline=e.inline),i.scrollIntoView(t)}break;default:P.warn("DOMAction","Unknown action kind",{kind:e.kind})}}catch(e){P.error("DOMAction","Execution failed",e)}}},h=class{constructor(e){this.runtime=e,this.bindings=new Map,this.active=new Map}bind(e,t){if(!(e.el&&e.el instanceof HTMLInputElement))return void P.warn("Uploads","Upload binding requires an input element",e);let i=e.el,n=t.uploadId;this.unbind(e);let r=()=>this.handleInputChange(n,i,t);i.addEventListener("change",r),t.accept&&t.accept.length>0?i.setAttribute("accept",t.accept.join(",")):i.removeAttribute("accept"),t.multiple&&P.warn("Uploads","Multiple file selection not supported; forcing single file"),i.removeAttribute("multiple"),this.bindings.set(n,{node:e,element:i,meta:t,changeHandler:r}),P.debug("Uploads","Bound upload",n)}unbind(e){for(let[t,i]of this.bindings.entries())if(i.node===e)return void this.detachBinding(t)}detachBinding(e){let t=this.bindings.get(e);t&&(t.element.removeEventListener("change",t.changeHandler),this.bindings.delete(e),this.abortUpload(e,0),P.debug("Uploads","Unbound upload",e))}handleControl(e){!e||!e.id||(P.debug("Uploads","Control message",e),("cancel"===e.op||"error"===e.op)&&this.abortUpload(e.id,1))}handleInputChange(e,t,i){let n=t.files;if(!n||0===n.length)return this.sendMessage({op:"cancelled",id:e}),void this.abortUpload(e,1);let r=n[0];return i.multiple&&n.length>1?(this.sendMessage({op:"error",id:e,error:"Multiple file uploads are not supported yet"}),void(t.value="")):r?i.maxSize&&i.maxSize>0&&r.size>i.maxSize?(this.sendMessage({op:"error",id:e,error:`File exceeds maximum size (${i.maxSize} bytes)`}),void(t.value="")):(this.sendMessage({op:"change",id:e,meta:{name:r.name,size:r.size,type:r.type}}),void this.startUpload(e,r,t)):void this.sendMessage({op:"cancelled",id:e})}startUpload(e,t,i){let n=this.runtime.getSessionId();if(!n)return;let r=`${this.runtime.getUploadEndpoint().replace(/\/+$/,"")}/${encodeURIComponent(n)}/${encodeURIComponent(e)}`;this.abortUpload(e,0);let o=new XMLHttpRequest;o.upload.onprogress=i=>{this.sendMessage({op:"progress",id:e,loaded:i.loaded,total:i.lengthComputable?i.total:t.size})},o.onerror=()=>{this.active.delete(e),this.sendMessage({op:"error",id:e,error:"Upload failed"})},o.onabort=()=>{this.active.delete(e),this.sendMessage({op:"cancelled",id:e})},o.onload=()=>{this.active.delete(e),200>o.status||o.status>=300?this.sendMessage({op:"error",id:e,error:`Upload failed (${o.status})`}):(this.sendMessage({op:"progress",id:e,loaded:t.size,total:t.size}),i.value="")};let s=new FormData;s.append("file",t),o.open("POST",r,1),o.send(s),this.active.set(e,{xhr:o,element:i}),P.debug("Uploads","Started upload",{uploadId:e,target:r})}abortUpload(e,t){let i=this.active.get(e);i&&(i.xhr.abort(),t&&(i.element.value=""),this.active.delete(e))}sendMessage(e){P.debug("WS Send","upload",e),this.runtime.sendUploadMessage(e)}},d=class{constructor(){this.config={},this.root=null,this.refs=new Map,this.sessionId="";let e=this.getBootPayload();e?(this.sessionId=e.sid,this.config=e.client||{},P.configure({debug:e.client?.debug}),P.debug("Runtime","Booting...",e),this.connect(e),this.hydrate(e)):P.error("Runtime","No boot payload found")}getBootPayload(){if(typeof window>"u")return null;let e=document.getElementById("live-boot");if(e&&e.textContent)try{return JSON.parse(e.textContent)}catch(e){P.error("Runtime","Failed to parse boot payload",e)}return window.__LIVEUI_BOOT__||null}hydrate(e){try{let t=function(e){if("html"===e.tag)return document.documentElement;if(e.children)for(let i of e.children){let e=t(i);if(e)return e}return null},i=JSON.parse(e.json),n=t(i);if(!n)return void P.error("Runtime","Could not find <html> element in JSON tree");this.root=this.hydrateWithComponentWrappers(i,n),this.eventManager&&this.root&&this.eventManager.attach(this.root),this.router&&this.root&&this.attachRouterRecursively(this.root),this.eventManager&&this.router&&this.uploadManager&&(this.patcher=new o(this.root,this.eventManager,this.router,this.uploadManager,this.refs)),P.debug("Runtime","Hydration complete")}catch(e){P.error("Runtime","Hydration failed",e)}}hydrateWithComponentWrappers(t,i){if("html"===t.tag)return e(t,i,this.refs);let n={...t,el:null,children:void 0};if(t.componentId&&(n.componentId=t.componentId),t.children&&t.children.length>0){n.children=[];for(let e of t.children){let t=this.hydrateWithComponentWrappers(e,i);n.children.push(t)}}return null===n.el&&n.children&&1===n.children.length&&"html"===n.children[0].tag&&(n.el=i),n}connect(e){this.client=new D.PondClient(e.client?.endpoint||"/live"),this.channel=this.client.createChannel("live/"+e.sid,{sid:e.sid,ver:e.ver,ack:e.seq,loc:e.location}),this.eventManager=new s(this.channel,e.sid),this.router=new a(this.channel,e.sid),this.uploadManager=new h(this),this.domActions=new l(this.refs),this.channel.onChannelStateChange(e=>{P.debug("Runtime","Channel state:",e)}),this.channel.onMessage((e,t)=>{P.debug("WS Recv",e,t),this.handleMessage(t)}),this.client.connect(),this.channel.join()}getSessionId(){return this.sessionId}getUploadEndpoint(){return this.config.upload||"/pondlive/upload"}sendUploadMessage(e){P.debug("WS Send",{t:"upload",...e}),this.channel.sendMessage({t:"upload",...e})}handleMessage(e){switch(e.t){case"frame":this.handleFrame(e);break;case"init":this.handleInit(e);break;case"domreq":this.handleDOMRequest(e);break;case"upload":this.uploadManager.handleControl(e);break;default:P.debug("Runtime","Unknown message type",e.t)}}handleFrame(e){if(P.debug("Runtime","Received frame",{seq:e.seq,ops:e.patch.length}),this.patcher&&e.patch)for(let t of e.patch)this.patcher.apply(t);e.effects&&this.domActions.execute(e.effects)}handleInit(e){P.debug("Runtime","Re-initialized",e)}handleDOMRequest(e){let{id:t,ref:i,props:n,method:r,args:o}=e,s=this.refs.get(i);if(!s||!s.el)return void this.sendDOMResponse({t:"domres",id:t,error:"ref not found"});let a=s.el;try{let e,i;if(n&&Array.isArray(n)){i={};for(let e of n)i[e]=a[e]}r&&"function"==typeof a[r]&&(e=a[r](...o||[])),this.sendDOMResponse({t:"domres",id:t,result:e,values:i})}catch(e){this.sendDOMResponse({t:"domres",id:t,error:e.message||"unknown error"})}}sendDOMResponse(e){let t={...e,sid:this.sessionId};P.debug("WS Send","domres",t),this.channel.sendMessage("domres",t)}attachRouterRecursively(e){if(this.router&&this.router.attach(e),e.children)for(let t of e.children)this.attachRouterRecursively(t)}},"u">typeof window&&window.addEventListener("DOMContentLoaded",()=>{let e=new d;window.__LIVEUI__=e})})();