// LiveUI Client v1.0.0
"use strict";(()=>{function e(e){return S.get(e)}function t(e,t){let i=function(e,t){let i=new Map;if(!Array.isArray(e))return i;let n=t?.root??document.body??document,o=n?{container:n,startIndex:0,endIndex:n.childNodes.length-1}:null,l=new Map;e.forEach(e=>{e&&"string"==typeof e.componentId&&l.set(e.componentId,e)});let d=1;for(;l.size>0&&d;){d=0;for(let[e,t]of Array.from(l.entries())){let n=t.parentId?i.get(t.parentId):o;if(!n)continue;k.debug("[Manifest]","computing component range",{id:e,parentId:t.parentId,parentPath:t.parentPath,firstChild:t.firstChild,lastChild:t.lastChild,parentRangeContainer:n.container.nodeName,parentRangeStart:n.startIndex,parentRangeEnd:n.endIndex});let c=r(n,t.parentPath,t.firstChild),u=r(n,t.parentPath,t.lastChild);k.debug("[Manifest]","resolved boundary nodes",{id:e,firstNode:c?.nodeName,lastNode:u?.nodeName});let f=s(c,u,n.container),p=a(c,f)??c,m=a(u,f)??u??p,y=p?h(f,p):n.startIndex;0>y&&(y=n.startIndex);let g=m?h(f,m):y;y>g&&(g=y),k.debug("[Manifest]","computed component range",{id:e,container:f.nodeName,startIndex:y,endIndex:g}),i.set(e,{container:f,startIndex:y,endIndex:g}),l.delete(e),d=1}}return i}(e,t);return function(e){e.forEach((e,t)=>{t&&S.set(t,e)});let t=Array.from(S.entries()).map(([e,t])=>({id:e.substring(0,12)+"...",container:t.container.nodeName,start:t.startIndex,end:t.endIndex,childCount:t.container.childNodes.length}));k.debug("[Manifest]","registered component ranges",{count:S.size,ranges:t})}(i),i}function i(t,i,r){let s=r?.get(t)??e(t);return s?n(s,i):null}function n(e,t){if(!e||e.startIndex>e.endIndex)return k.debug("[Manifest]","resolveNodeBySegments: invalid range",{range:e}),null;let i=e.container;if(!i)return k.debug("[Manifest]","resolveNodeBySegments: no container",{range:e}),null;if(k.debug("[Manifest]","resolveNodeBySegments START",{segments:t,rangeInfo:{containerNodeName:i.nodeName,startIndex:e.startIndex,endIndex:e.endIndex,childCount:i.childNodes.length}}),!Array.isArray(t)||0===t.length){let t=d(e);return k.debug("[Manifest]","resolveNodeBySegments: using range root",{result:t?.nodeName}),t}let n=null;for(let i=0;t.length>i;i++){let r=t[i];if(!r)continue;if(!n){if(n=c(e,r.index),k.debug("[Manifest]","resolveNodeBySegments: selecting top-level child",{step:i,offset:r.index,node:n?.nodeName}),!n)return null;continue}if(!(n instanceof Element||n instanceof DocumentFragment))return k.debug("[Manifest]","resolveNodeBySegments: current not Element/Fragment",{step:i,current:n?.nodeName}),null;let s=l(n,r.index),o=n.childNodes.item(s)??null;if(k.debug("[Manifest]","resolveNodeBySegments: navigating dom segment",{step:i,index:r.index,clamped:s,currentNodeName:n.nodeName,nextNodeName:o?.nodeName}),n=o,!n)return null}return k.debug("[Manifest]","resolveNodeBySegments END",{result:n?.nodeName}),n??d(e)}function r(e,t,i){let r=function(e,t){let i=[];return Array.isArray(e)&&e.length>0&&i.push(...e),Array.isArray(t)&&t.length>0&&i.push(...t),i.length>0?i:void 0}(t,i);return r?n(e,r):n(e,t)??n(e,i)}function s(e,t,i){let n=o(e);if(!t)return n[0]??i;let r=o(t);for(let e of n)if(r.includes(e))return e;return n[0]??r[0]??i}function o(e){let t=[],i=e;for(;i&&i.parentNode;){let e=i.parentNode;t.push(e),i=e}return t}function a(e,t){if(!e||!t)return e;let i=e;for(;i&&i.parentNode&&i.parentNode!==t;)i=i.parentNode;return i}function l(e,t){let i=e.childNodes.length-1;return 0>i||0>t?0:t>i?i:t}function h(e,t){if(!e||!t)return-1;let i=e.childNodes;for(let e=0;i.length>e;e++)if(i.item(e)===t)return e;return-1}function d(e){return c(e,0)}function c(e,t){let i=e.container;if(!i||0===i.childNodes.length)return null;let n=l(i,e.startIndex),r=Math.max(n,l(i,e.endIndex))-n,s=Number.isFinite(t)?t:0;return i.childNodes.item(n+(s>0?r>s?s:r:0))??null}function u(e){let t=e.container;return t instanceof Element?t:t instanceof Document?t.body??t.documentElement??null:t instanceof DocumentFragment?t.firstElementChild??null:null}function f(e,t){return!Number.isFinite(t)||0>t?0:t>e?e:t}function p(e){if(L.clear(),j.clear(),e){for(let[t,i]of Object.entries(e)){let e=+t;if(Number.isNaN(e))continue;let n=g(i);L.set(e,n),y(e,n)}k.debug("[Events]","registered slot table",{slots:L.size})}else k.debug("[Events]","cleared slot table")}function m(e){let t=L.get(e);return t?g(t):void 0}function y(e,t){t.forEach(t=>{let i=t.event;if(!i)return;let n=j.get(i)??new Set,r=n.size>0;n.add(e),j.set(i,n),!r&&1===n.size&&function(e){Array.isArray(e)&&e.forEach(e=>{e&&_.forEach(t=>{try{t(e)}catch{}})})}([i]),k.debug("[Events]","indexed event",{event:i,slotId:e,totalSlots:n.size})})}function g(e){return Array.isArray(e)?e.map(e=>({event:e?.event??"",handler:e?.handler??"",listen:Array.isArray(e?.listen)?[...e.listen]:void 0,props:Array.isArray(e?.props)?[...e.props]:void 0})):[]}function v(t,n){if(!Array.isArray(t))return;let r=0;t.forEach((t,s)=>{if(k.debug("[Router]","processing binding "+s,{componentId:t?.componentId?.substring(0,12)+"...",pathLength:t?.path?.length,pathValue:t?.pathValue}),!t||"string"!=typeof t.componentId)return void k.debug("[Router]",`skipping binding ${s}: invalid descriptor`);let o=n?.get(t.componentId)??e(t.componentId);o?k.debug("[Router]","component range for binding "+s,{container:o.container.nodeName,start:o.startIndex,end:o.endIndex,childCount:o.container.childNodes.length}):k.debug("[Router]","no component range found for binding "+s);let a=i(t.componentId,t.path,n);k.debug("[Router]","resolved node for binding "+s,{nodeType:a?.nodeName,isElement:a instanceof Element}),!(a instanceof Element)&&o&&o.container instanceof Element&&(k.debug("[Router]",`binding ${s} falling back to range container`,{containerNodeName:o.container.nodeName}),a=o.container),a instanceof Element?(D.set(a,{path:t.pathValue??void 0,query:t.query??void 0,hash:t.hash??void 0,replace:t.replace??void 0}),a.i={path:t.pathValue,appliedAt:Date.now(),componentId:t.componentId},k.debug("[Router]",`binding ${s} applied successfully`,{path:t.pathValue,nodeName:a.nodeName,isConnected:a.isConnected,hasParent:!!a.parentElement}),r+=1):k.debug("[Router]",`binding ${s} failed: node is not an Element`)}),k.debug("[Router]","applied router bindings",{count:r})}function w(e){if(!e||typeof Node>"u")return;let t=(e instanceof Document?e:e.ownerDocument)??document;if(!t||"function"!=typeof t.createTreeWalker)return;let i=t.createTreeWalker(e,NodeFilter.SHOW_TEXT,null),n=[],r=i.nextNode();for(;r;)r.nodeType===Node.TEXT_NODE&&((r.textContent??"").trim()||n.push(r)),r=i.nextNode();n.forEach(e=>{e.parentNode&&e.parentNode.removeChild(e)})}function b(e,t,i){if(!Array.isArray(t)||0===t.length)return;let n={};return t.forEach(t=>{if("string"!=typeof t||0===t.length)return;let r=function(e,t,i){let n,r=e.split(".").map(e=>e.trim()).filter(Boolean);if(0!==r.length){switch(r.shift()){case"event":n=t;break;case"target":n=t.target??null;break;case"currentTarget":n=t.currentTarget??null;break;case"element":case"ref":n=i?.refElement??(t.currentTarget instanceof Element?t.currentTarget:null);break;default:return}for(let e of r){if(null==n)return;try{n=n[e]}catch{return}}return E(n)}}(t,e,i);void 0!==r&&(n[t]=r)}),Object.keys(n).length>0?n:void 0}function E(e){if(null==e)return null;let t=typeof e;if("string"===t||"number"===t||"boolean"===t)return e;if(Array.isArray(e)){let t=e.map(E).filter(e=>void 0!==e);return t.length>0?t:null}if(e instanceof Date)return e.toISOString();if(e instanceof DOMTokenList)return Array.from(e);if(!(e instanceof Node))try{return JSON.parse(JSON.stringify(e))}catch{return}}function M(e={}){let t=typeof window>"u"?null:window;return t?(e.force&&(F=null),F||(F=function(e){return new Promise((t,i)=>{let n=()=>{try{let i=function(e){let t={...e.o??{}},i=function(e){if(e.l&&"object"==typeof e.l)return k.debug("[Entry]","Boot payload from window",{sid:e.l.sid,hasListPaths:Array.isArray(e.l.listPaths),listPathsLength:Array.isArray(e.l.listPaths)?e.l.listPaths.length:0}),e.l;if(typeof document>"u")return null;let t=document.getElementById("live-boot")?.textContent?.trim();if(!t)return k.debug("[Entry]","No boot script content found"),null;k.debug("[Entry]","Boot script found",{contentLength:t.length});try{let i=JSON.parse(t);return e.l=i,k.debug("[Entry]","Boot payload parsed successfully",{sid:i.sid,hasListPaths:Array.isArray(i.listPaths),listPathsLength:Array.isArray(i.listPaths)?i.listPaths.length:0,listPaths:i.listPaths,hasComponentPaths:Array.isArray(i.componentPaths),componentPathsLength:Array.isArray(i.componentPaths)?i.componentPaths.length:0}),i}catch(e){return k.error("Failed to parse boot payload",e),null}}(e),n=t.boot??i??null;n&&(t.boot=n,e.l=n,"boolean"==typeof n.client?.debug&&(t.debug=n.client.debug)),typeof t.debug>"u"&&(t.debug=0),e.o=t;let r=0!=t.autoConnect;t.autoConnect=0;let s=new W(t);return function(e,t){let i=W;i.boot=M,i.instance=t,e.LiveUI=i,e.LiveUIInstance=t,e.h&&(e.h.installed=1,e.h.instance=t)}(e,s),k.debug("[Entry]","LiveUI client created",{autoConnect:r,debug:t.debug,hasBoot:!!n}),r&&n&&s.connect().catch(e=>{k.error("Failed to connect after boot",e)}),s}(e);t(i)}catch(e){i(e)}};if("u">typeof document&&"loading"===document.readyState){let e=()=>{document.removeEventListener("DOMContentLoaded",e),n()};document.addEventListener("DOMContentLoaded",e)}else n()})}(t)),F):Promise.reject(Error("[LiveUI] window is not available in this environment"))}var R,N,k,I,O,A,C,S,T,x,L,j,_,D,P,q,U,H,$,B,W,F,J,G,z=Object.create,V=Object.defineProperty,K=Object.getOwnPropertyDescriptor,Z=Object.getOwnPropertyNames,Q=Object.getPrototypeOf,X={}.hasOwnProperty,Y=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),ee=(e,t,i,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of Z(t))!X.call(e,r)&&r!==i&&V(e,r,{get:()=>t[r],enumerable:!(n=K(t,r))||n.enumerable});return e},te=Y(e=>{var t,i,n=e&&e.u||function(e,t,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(e,i):r?r.value=i:t.set(e,i),i},r=e&&e.p||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"m",{value:1}),e.Subject=void 0,e.Subject=class{constructor(){t.set(this,void 0),i.set(this,void 0),n(this,t,0,"f"),n(this,i,new Set,"f")}get size(){return r(this,i,"f").size}subscribe(e){if(r(this,t,"f"))throw Error("Cannot subscribe to a closed subject");return r(this,i,"f").add(e),()=>r(this,i,"f").delete(e)}publish(e){r(this,i,"f").forEach(t=>t(e))}close(){r(this,i,"f").clear(),n(this,t,1,"f")}},t=new WeakMap,i=new WeakMap}),ie=Y(e=>{var t,i,n=e&&e.u||function(e,t,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(e,i):r?r.value=i:t.set(e,i),i},r=e&&e.p||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"m",{value:1}),e.BehaviorSubject=void 0,i=te(),e.BehaviorSubject=class extends i.Subject{constructor(e){super(),t.set(this,void 0),n(this,t,e,"f")}get value(){return r(this,t,"f")}publish(e){n(this,t,e,"f"),super.publish(e)}subscribe(e){return r(this,t,"f")&&e(r(this,t,"f")),super.subscribe(e)}},t=new WeakMap}),ne=Y(e=>{var t=e&&e.v||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);(!r||("get"in r?!t.m:r.writable||r.configurable))&&(r={enumerable:1,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.M||function(e,i){for(var n in e)"default"!==n&&!{}.hasOwnProperty.call(i,n)&&t(i,e,n)};Object.defineProperty(e,"m",{value:1}),i(ie(),e),i(te(),e)}),re=Y(e=>{var t,i,n,r,s,o,a,l,h,d;Object.defineProperty(e,"m",{value:1}),e.PubSubEvents=e.Events=e.ChannelReceiver=e.SystemSender=e.ErrorTypes=e.ChannelState=e.ClientActions=e.ServerActions=e.PresenceEventTypes=void 0,(d=t||(e.PresenceEventTypes=t={})).JOIN="JOIN",d.LEAVE="LEAVE",d.UPDATE="UPDATE",function(e){e.PRESENCE="PRESENCE",e.SYSTEM="SYSTEM",e.BROADCAST="BROADCAST",e.ERROR="ERROR",e.CONNECT="CONNECT"}(i||(e.ServerActions=i={})),function(e){e.JOIN_CHANNEL="JOIN_CHANNEL",e.LEAVE_CHANNEL="LEAVE_CHANNEL",e.BROADCAST="BROADCAST"}(n||(e.ClientActions=n={})),function(e){e.IDLE="IDLE",e.JOINING="JOINING",e.JOINED="JOINED",e.STALLED="STALLED",e.CLOSED="CLOSED"}(r||(e.ChannelState=r={})),function(e){e.UNAUTHORIZED_CONNECTION="UNAUTHORIZED_CONNECTION",e.UNAUTHORIZED_JOIN_REQUEST="UNAUTHORIZED_JOIN_REQUEST",e.UNAUTHORIZED_BROADCAST="UNAUTHORIZED_BROADCAST",e.INVALID_MESSAGE="INVALID_MESSAGE",e.HANDLER_NOT_FOUND="HANDLER_NOT_FOUND",e.PRESENCE_ERROR="PRESENCE_ERROR",e.CHANNEL_ERROR="CHANNEL_ERROR",e.ENDPOINT_ERROR="ENDPOINT_ERROR",e.INTERNAL_SERVER_ERROR="INTERNAL_SERVER_ERROR"}(s||(e.ErrorTypes=s={})),function(e){e.ENDPOINT="ENDPOINT",e.CHANNEL="CHANNEL"}(o||(e.SystemSender=o={})),function(e){e.ALL_USERS="ALL_USERS",e.ALL_EXCEPT_SENDER="ALL_EXCEPT_SENDER"}(a||(e.ChannelReceiver=a={})),function(e){e.ACKNOWLEDGE="ACKNOWLEDGE",e.CONNECTION="CONNECTION"}(l||(e.Events=l={})),function(e){e.MESSAGE="MESSAGE",e.PRESENCE="PRESENCE",e.GET_PRESENCE="GET_PRESENCE"}(h||(e.PubSubEvents=h={}))}),se=Y(e=>{Object.defineProperty(e,"m",{value:1}),e.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}}),oe=Y(e=>{Object.defineProperty(e,"m",{value:1})}),ae=Y(e=>{var t=e&&e.v||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);(!r||("get"in r?!t.m:r.writable||r.configurable))&&(r={enumerable:1,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.M||function(e,i){for(var n in e)"default"!==n&&!{}.hasOwnProperty.call(i,n)&&t(i,e,n)};Object.defineProperty(e,"m",{value:1}),i(se(),e),i(oe(),e)}),le=Y(e=>{function t(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}function i(e,t){if(!function(e){return"string"==typeof e}(e))throw new a("Expected string, got "+typeof e,t)}function n(e,i){if(!t(e))throw new a("Expected object, got "+typeof e,i)}function r(e,i){if(!function(e){return t(e)?Object.keys(e).every(e=>"string"==typeof e):0}(e))throw new a("Expected record with string keys, got "+typeof e,i)}function s(e,t,i){let n=Object.values(t);if(!n.includes(e))throw new a(`Expected one of [${n.join(", ")}], got ${JSON.stringify(e)}`,i)}Object.defineProperty(e,"m",{value:1}),e.channelEventSchema=e.serverMessageSchema=e.presenceMessageSchema=e.clientMessageSchema=e.ValidationError=void 0;var o=re(),a=class extends Error{constructor(e,t){super(t?`${t}: ${e}`:e),this.path=t,this.name="ValidationError"}};e.ValidationError=a,e.clientMessageSchema={parse(e){n(e,"clientMessage");let t=e;if(!("event"in t))throw new a("Missing required field","event");if(!("requestId"in t))throw new a("Missing required field","requestId");if(!("channelName"in t))throw new a("Missing required field","channelName");if(!("payload"in t))throw new a("Missing required field","payload");if(!("action"in t))throw new a("Missing required field","action");return i(t.event,"event"),i(t.requestId,"requestId"),i(t.channelName,"channelName"),r(t.payload,"payload"),s(t.action,o.ClientActions,"action"),{event:t.event,requestId:t.requestId,channelName:t.channelName,payload:t.payload,action:t.action}}},e.presenceMessageSchema={parse(e){n(e,"presenceMessage");let t=e;if(!("requestId"in t))throw new a("Missing required field","requestId");if(!("channelName"in t))throw new a("Missing required field","channelName");if(!("event"in t))throw new a("Missing required field","event");if(!("action"in t))throw new a("Missing required field","action");if(!("payload"in t))throw new a("Missing required field","payload");if(i(t.requestId,"requestId"),i(t.channelName,"channelName"),s(t.event,o.PresenceEventTypes,"event"),t.action!==o.ServerActions.PRESENCE)throw new a(`Expected ${o.ServerActions.PRESENCE}, got ${JSON.stringify(t.action)}`,"action");n(t.payload,"payload");let l=t.payload;if(!("presence"in l))throw new a("Missing required field","payload.presence");if(!("changed"in l))throw new a("Missing required field","payload.changed");return function(e){if(!function(e){return Array.isArray(e)}(e))throw new a("Expected array, got "+typeof e,"payload.presence")}(l.presence),l.presence.forEach((e,t)=>{r(e,`payload.presence[${t}]`)}),r(l.changed,"payload.changed"),{requestId:t.requestId,channelName:t.channelName,event:t.event,action:o.ServerActions.PRESENCE,payload:{presence:l.presence,changed:l.changed}}}},e.serverMessageSchema={parse(e){n(e,"serverMessage");let t=e;if(!("event"in t))throw new a("Missing required field","event");if(!("requestId"in t))throw new a("Missing required field","requestId");if(!("channelName"in t))throw new a("Missing required field","channelName");if(!("payload"in t))throw new a("Missing required field","payload");if(!("action"in t))throw new a("Missing required field","action");i(t.event,"event"),i(t.requestId,"requestId"),i(t.channelName,"channelName"),r(t.payload,"payload");let s=[o.ServerActions.BROADCAST,o.ServerActions.CONNECT,o.ServerActions.ERROR,o.ServerActions.SYSTEM];if(!s.includes(t.action))throw new a(`Expected one of [${s.join(", ")}], got ${JSON.stringify(t.action)}`,"action");return{event:t.event,requestId:t.requestId,channelName:t.channelName,payload:t.payload,action:t.action}}},e.channelEventSchema={parse(t){n(t,"channelEvent");let i=t;if(!("action"in i))throw new a("Missing required field","action");return i.action===o.ServerActions.PRESENCE?e.presenceMessageSchema.parse(t):e.serverMessageSchema.parse(t)}}}),he=Y(e=>{var t=e&&e.v||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);(!r||("get"in r?!t.m:r.writable||r.configurable))&&(r={enumerable:1,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.M||function(e,i){for(var n in e)"default"!==n&&!{}.hasOwnProperty.call(i,n)&&t(i,e,n)};Object.defineProperty(e,"m",{value:1}),i(ne(),e),i(re(),e),i(ae(),e),i(le(),e)}),de=Y(e=>{var t,i,n,r,s,o,a,l,h,d,c,u,f,p,m,y,g=e&&e.u||function(e,t,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(e,i):r?r.value=i:t.set(e,i),i},v=e&&e.p||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"m",{value:1}),e.Channel=void 0,y=he(),e.Channel=class{constructor(e,c,u,f){t.add(this),i.set(this,void 0),n.set(this,void 0),r.set(this,void 0),s.set(this,void 0),o.set(this,void 0),a.set(this,void 0),l.set(this,void 0),h.set(this,void 0),d.set(this,void 0),g(this,i,u,"f"),g(this,n,[],"f"),g(this,r,[],"f"),g(this,a,f,"f"),g(this,o,e,"f"),g(this,h,c,"f"),g(this,l,new y.Subject,"f"),g(this,d,new y.BehaviorSubject(y.ChannelState.IDLE),"f"),g(this,s,()=>{},"f")}get channelState(){return v(this,d,"f").value}get presence(){return v(this,r,"f")}acknowledge(e){v(this,d,"f").publish(y.ChannelState.JOINED),v(this,t,"m",u).call(this,e),v(this,t,"m",c).call(this)}join(){let e={action:y.ClientActions.JOIN_CHANNEL,event:y.ClientActions.JOIN_CHANNEL,payload:v(this,a,"f"),channelName:v(this,i,"f"),requestId:(0,y.uuid)()};if(v(this,d,"f").value!==y.ChannelState.JOINED)if(v(this,d,"f").publish(y.ChannelState.JOINING),v(this,h,"f").value)v(this,o,"f").call(this,e);else{let t=v(this,h,"f").subscribe(i=>{i&&(t(),v(this,d,"f").value===y.ChannelState.JOINING&&v(this,o,"f").call(this,e))})}}leave(){let e={action:y.ClientActions.LEAVE_CHANNEL,event:y.ClientActions.LEAVE_CHANNEL,channelName:v(this,i,"f"),requestId:(0,y.uuid)(),payload:{}};v(this,t,"m",p).call(this,e),v(this,d,"f").publish(y.ChannelState.CLOSED),v(this,s,"f").call(this)}onChannelStateChange(e){return v(this,d,"f").subscribe(t=>{e(t)})}onJoin(e){return v(this,t,"m",m).call(this,(t,i)=>{if(t===y.PresenceEventTypes.JOIN)return e(i.changed)})}onLeave(e){return v(this,t,"m",m).call(this,(t,i)=>{if(t===y.PresenceEventTypes.LEAVE)return e(i.changed)})}onMessage(e){return v(this,t,"m",f).call(this,(t,i)=>{e(t,i)})}onMessageEvent(e,t){return this.onMessage((i,n)=>{if(i===e)return t(n)})}onPresenceChange(e){return v(this,t,"m",m).call(this,(t,i)=>{if(t===y.PresenceEventTypes.UPDATE)return e(i)})}onUsersChange(e){return v(this,t,"m",m).call(this,(t,i)=>e(i.presence))}sendMessage(e,n){let r=(0,y.uuid)(),s={action:y.ClientActions.BROADCAST,channelName:v(this,i,"f"),requestId:r,event:e,payload:n};v(this,t,"m",p).call(this,s)}sendForResponse(e,n){let r=(0,y.uuid)();return new Promise(s=>{let o=v(this,t,"m",f).call(this,(e,t,i)=>{r===i&&(s(t),o())}),a={action:y.ClientActions.BROADCAST,channelName:v(this,i,"f"),requestId:r,event:e,payload:n};v(this,t,"m",p).call(this,a)})}},i=new WeakMap,n=new WeakMap,r=new WeakMap,s=new WeakMap,o=new WeakMap,a=new WeakMap,l=new WeakMap,h=new WeakMap,d=new WeakMap,t=new WeakSet,c=function(){v(this,n,"f").forEach(e=>v(this,o,"f").call(this,e)),g(this,n,[],"f")},u=function(e){v(this,s,"f").call(this);let n=e.subscribe(e=>{e.channelName===v(this,i,"f")&&this.channelState===y.ChannelState.JOINED&&v(this,l,"f").publish(e)}),c=v(this,h,"f").subscribe(e=>{if(e&&v(this,d,"f").value===y.ChannelState.STALLED){let e={action:y.ClientActions.JOIN_CHANNEL,event:y.ClientActions.JOIN_CHANNEL,payload:v(this,a,"f"),channelName:v(this,i,"f"),requestId:(0,y.uuid)()};v(this,o,"f").call(this,e)}else!e&&v(this,d,"f").value===y.ChannelState.JOINED&&v(this,d,"f").publish(y.ChannelState.STALLED)}),u=v(this,t,"m",m).call(this,(e,t)=>{g(this,r,t.presence,"f")});g(this,s,()=>{n(),c(),u()},"f")},f=function(e){return v(this,l,"f").subscribe(t=>{if(t.action!==y.ServerActions.PRESENCE)return e(t.event,t.payload,t.requestId)})},p=function(e){if(v(this,d,"f").value===y.ChannelState.JOINED)return v(this,o,"f").call(this,e);v(this,n,"f").push(e)},m=function(e){return v(this,l,"f").subscribe(t=>{if(t.action===y.ServerActions.PRESENCE)return e(t.event,t.payload)})}}),ce=Y(e=>{var t,i,n,r,s,o,a,l=e&&e.u||function(e,t,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(e,i):r?r.value=i:t.set(e,i),i},h=e&&e.p||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"m",{value:1}),e.PondClient=void 0,o=he(),a=de(),e.PondClient=class{constructor(e,n={}){let r;t.add(this),i.set(this,void 0);try{r=new URL(e)}catch{r=new URL(""+window.location),r.pathname=e}this.R=0;let a=new URLSearchParams(n);r.search=""+a,"wss:"!==r.protocol&&"ws:"!==r.protocol&&(r.protocol="https:"===r.protocol?"wss:":"ws:"),this.N=r,l(this,i,new Map,"f"),this.k=new o.Subject,this.I=new o.BehaviorSubject(0),h(this,t,"m",s).call(this)}connect(){this.R=0;let e=new WebSocket(""+this.N);e.onmessage=e=>{let t=e.data.trim().split("\n");for(let e of t)if(e.trim()){let t=JSON.parse(e),i=o.channelEventSchema.parse(t);this.k.publish(i)}},e.onerror=()=>e.close(),e.onclose=()=>{this.I.publish(0),!this.R&&setTimeout(()=>{this.connect()},1e3)},this.O=e}getState(){return this.I.value}disconnect(){var e;this.I.publish(0),this.R=1,null===(e=this.O)||void 0===e||e.close(),h(this,i,"f").clear()}createChannel(e,r){let s=h(this,i,"f").get(e);if(s&&s.channelState!==o.ChannelState.CLOSED)return s;let l=h(this,t,"m",n).call(this),d=new a.Channel(l,this.I,e,r||{});return h(this,i,"f").set(e,d),d}onConnectionChange(e){return this.I.subscribe(e)}},i=new WeakMap,t=new WeakSet,n=function(){return e=>{this.I.value&&this.O.send(JSON.stringify(e))}},r=function(e){var r;let s=null!==(r=h(this,i,"f").get(e.channelName))&&void 0!==r?r:new a.Channel(h(this,t,"m",n).call(this),this.I,e.channelName,{});h(this,i,"f").set(e.channelName,s),s.acknowledge(this.k)},s=function(){this.k.subscribe(e=>{e.event===o.Events.ACKNOWLEDGE?h(this,t,"m",r).call(this,e):e.event===o.Events.CONNECTION&&e.action===o.ServerActions.CONNECT&&this.I.publish(1)})}}),ue=Y((e,t)=>{var i=function(){if("object"==typeof self&&self)return self;if("object"==typeof window&&window)return window;throw Error("Unable to resolve global `this`")};t.exports=function(){if(this)return this;if("object"==typeof globalThis&&globalThis)return globalThis;try{Object.defineProperty(Object.prototype,"A",{get:function(){return this},configurable:1})}catch{return i()}try{return __global__||i()}finally{delete Object.prototype.A}}()}),fe=Y((e,t)=>{t.exports={name:"websocket",description:"Websocket Client & Server Library implementing the WebSocket protocol as specified in RFC 6455.",keywords:["websocket","websockets","socket","networking","comet","push","RFC-6455","realtime","server","client"],author:"Brian McKelvey <theturtle32@gmail.com> (https://github.com/theturtle32)",contributors:["Iñaki Baz Castillo <ibc@aliax.net> (http://dev.sipdoc.net)"],version:"1.0.35",repository:{type:"git",url:"https://github.com/theturtle32/WebSocket-Node.git"},homepage:"https://github.com/theturtle32/WebSocket-Node",engines:{node:">=4.0.0"},dependencies:{bufferutil:"^4.0.1",debug:"^2.2.0","es5-ext":"^0.10.63","typedarray-to-buffer":"^3.1.5","utf-8-validate":"^5.0.2",yaeti:"^0.0.6"},devDependencies:{"buffer-equal":"^1.0.0",gulp:"^4.0.2","gulp-jshint":"^2.0.4","jshint-stylish":"^2.2.1",jshint:"^2.0.0",tape:"^4.9.1"},config:{verbose:0},scripts:{test:"tape test/unit/*.js",gulp:"gulp"},main:"index",directories:{lib:"./lib"},browser:"lib/browser.js",license:"Apache-2.0"}}),pe=Y((e,t)=>{t.exports=fe().version}),me=Y((e,t)=>{function i(e,t){return t?new r(e,t):new r(e)}var n,r,s;if("object"==typeof globalThis)n=globalThis;else try{n=ue()}catch{}finally{if(!n&&"u">typeof window&&(n=window),!n)throw Error("Could not determine global this")}r=n.WebSocket||n.MozWebSocket,s=pe(),r&&["CONNECTING","OPEN","CLOSING","CLOSED"].forEach(function(e){Object.defineProperty(i,e,{get:function(){return r[e]}})}),t.exports={w3cwebsocket:r?i:null,version:s}}),ye=Y(e=>{Object.defineProperty(e,"m",{value:1}),e.PondClient=void 0;var t=he(),i=ce(),n=me().w3cwebsocket;e.PondClient=class extends i.PondClient{connect(e=1){this.R=0;let i=new n(""+this.N);i.onopen=()=>this.I.publish(1),i.onmessage=e=>{let i=e.data.trim().split("\n");for(let e of i)if(e.trim()){let i=JSON.parse(e),n=t.channelEventSchema.parse(i);this.k.publish(n)}},i.onerror=()=>i.close(),i.onclose=()=>{this.I.publish(0),!this.R&&setTimeout(()=>{this.connect()},1e3)}}}}),ge=Y(e=>{var t,i,n,r;Object.defineProperty(e,"m",{value:1}),e.PondClient=e.ChannelState=void 0,t=he(),Object.defineProperty(e,"ChannelState",{enumerable:1,get:function(){return t.ChannelState}}),i=ce(),n=ye(),r=typeof window>"u"?n.PondClient:i.PondClient,e.PondClient=r}),ve={};((e,t)=>{for(var i in t)V(e,i,{get:t[i],enumerable:1})})(ve,{LiveRuntime:()=>C,LiveUI:()=>B,bootClient:()=>M}),G=null!=(J=ge())?z(Q(J)):{},R=ee(V(G,"default",{value:J,enumerable:1}),J),(N=class e{static configure(t){e.debugEnabled=!!t?.debug}static debug(...t){e.debugEnabled&&e.emit("log","debug",t)}static info(...t){e.emit("log","info",t)}static warn(...t){e.emit("warn","warn",t)}static error(...t){e.emit("error","error",t)}static emit(e,t,i){typeof console>"u"||(console[e]??console.log)(`[LiveUI][${t}]`,...i)}}).debugEnabled=0,k=N,I=class{constructor(e){this.payload=null,this.options={debug:e?.debug??0,scriptId:e?.scriptId??"live-boot"}}load(e){let t=e??this.readWindowPayload()??this.readScriptPayload();return t&&"string"==typeof t.sid?(this.payload=t,this.cacheToWindow(t),this.options.debug&&k.debug("[boot]","payload loaded",{sid:t.sid,version:t.ver,hasHtml:!!t.html}),this.payload):(this.options.debug&&this.log("boot payload unavailable"),this.payload)}get(){return this.payload}ensure(){let e=this.payload??this.load();if(!e||"string"!=typeof e.sid)throw Error("[LiveUI] boot payload is required before connecting");return e}readWindowPayload(){if(typeof window>"u")return null;let e=window.l;return e&&"string"==typeof e.sid?e:null}readScriptPayload(){if(typeof document>"u")return null;let e=document.getElementById(this.options.scriptId)?.textContent;if(!e)return null;try{return JSON.parse(e)}catch(e){return this.log("failed to parse boot payload",e),null}}cacheToWindow(e){typeof window>"u"||(window.l=e)}log(e,t){this.options.debug&&(t?k.warn("[boot]",e,t):k.warn("[boot]",e))}},O=class{constructor(){this.listeners=new Map}on(e,t){let i=this.listeners.get(e)??new Set;return i.add(t),this.listeners.set(e,i),()=>this.off(e,t)}once(e,t){let i=this.on(e,e=>{i(),t(e)});return i}off(e,t){let i=this.listeners.get(e);i&&(i.delete(t),0===i.size&&this.listeners.delete(e))}emit(e,t){let i=this.listeners.get(e);if(i)for(let n of Array.from(i))try{n(t)}catch(t){k.error("event listener error",e,t)}}clear(){this.listeners.clear()}},A={endpoint:"/live",uploadEndpoint:"/pondlive/upload/",autoConnect:1,debug:0,reconnect:1,reconnectDelay:1e3,maxReconnectAttempts:5},C=class{constructor(e){this.events=new O,this.client=null,this.channel=null,this.bootPayload=null,this.connectPromise=null,this.reconnectTimer=null,this.reconnectAttempts=0,this.disposed=0,this.state={status:"disconnected"},this.lastAck=0,this.sessionId=null,this.version=0,this.nextEventSeq=1,this.lastEventAck=0,this.pendingEvents=[],this.inFlightEvents=[],this.maxInFlightEvents=2,this.options={...A,...e??{}},k.configure({debug:this.options.debug}),this.bootLoader=new I({debug:this.options.debug}),this.bootPayload=this.options.boot?this.bootLoader.load(this.options.boot):this.bootLoader.load(),this.sessionId=this.bootPayload?.sid??null,this.version=this.bootPayload?.ver??0,k.debug("[Runtime]","initialized",{sessionId:this.sessionId,version:this.version,hasBoot:!!this.bootPayload}),this.options.autoConnect&&this.bootPayload&&this.connect()}on(e,t){return this.events.on(e,t)}once(e,t){return this.events.once(e,t)}off(e,t){this.events.off(e,t)}getState(){return this.state}getBootPayload(){return this.bootPayload}getSessionId(){return this.sessionId??this.bootPayload?.sid??null}getUploadEndpoint(){return this.bootPayload?.client?.upload??this.options.uploadEndpoint}sendUploadMessage(e){let t=this.getSessionId();if(!this.channel||!t||!e.id)return;let i={t:"upload",sid:t,id:e.id,op:e.op};e.meta&&(i.meta=e.meta),"number"==typeof e.loaded&&(i.loaded=e.loaded),"number"==typeof e.total&&(i.total=e.total),e.error&&(i.error=e.error),k.debug("[Runtime]","→ sending upload message",i),this.channel.sendMessage("upload",i)}sendDOMResponse(e){let t=this.getSessionId();if(!this.channel||!t||!e.id)return;let i={t:"domres",sid:t,id:e.id};e.values&&(i.values=e.values),void 0!==e.result&&(i.result=e.result),e.error&&(i.error=e.error),k.debug("[Runtime]","→ sending domres",i),this.channel.sendMessage("domres",i)}async connect(){if(this.disposed)throw Error("[LiveUI] runtime disposed");if(k.debug("[Runtime]","connect requested",{hasBoot:!!this.bootPayload,disposed:this.disposed,state:this.state.status}),!this.channel||"connected"!==this.state.status)return this.connectPromise||(this.connectPromise=new Promise((e,t)=>{try{let t=this.bootPayload??this.bootLoader.load();if(!t||"string"!=typeof t.sid)throw Error("[LiveUI] missing boot payload; call load() before connecting");this.bootPayload=t,this.updateState({status:"connecting"}),k.debug("[Runtime]","opening socket",{endpoint:this.options.endpoint});let i=new R.PondClient(this.options.endpoint);this.client=i;let n=this.buildJoinPayload(t);k.debug("[Runtime]","joining channel",{sid:t.sid,ack:n.ack,version:n.ver});let r=i.createChannel("live/"+t.sid,n);this.channel=r,r.onChannelStateChange(i=>{k.debug("[Runtime]","channel state changed",i),i===R.ChannelState.JOINED&&(this.reconnectAttempts=0,this.sessionId=t.sid,this.version=t.ver??0,this.updateState({status:"connected",sessionId:t.sid,version:this.version}),this.events.emit("connected",{sid:t.sid,version:this.version}),k.debug("[Runtime]","session joined",{sid:t.sid,version:this.version}),e(),this.connectPromise=null)}),r.onMessage((e,t)=>{k.debug("[Runtime]","← received message",t),this.routeMessage(t)}),r.onLeave(()=>{this.handleChannelLeave()}),i.connect(),r.join()}catch(e){k.debug("[Runtime]","connect failed",e),this.connectPromise=null,this.handleErrorEvent(e),t(e)}})),this.connectPromise}disconnect(){if(this.clearReconnectTimer(),this.reconnectAttempts=0,this.connectPromise=null,this.channel){try{this.channel.leave()}catch(e){k.debug("[Runtime]","channel leave error",e)}this.channel=null}if(this.client){try{this.client.disconnect()}catch(e){k.debug("[Runtime]","client disconnect error",e)}this.client=null}this.updateState({status:"disconnected"}),this.events.emit("disconnected",void 0)}destroy(){this.disposed=1,this.disconnect(),this.events.clear()}sendEvent(e,t,i){if(!this.channel||!(this.sessionId??this.bootPayload?.sid))return;let n=this.allocateEventSeq(i);this.pendingEvents.push({hid:e,payload:t,seq:n}),this.drainEventQueue()}sendNavigation(e,t,i=""){let n=this.sessionId??this.bootPayload?.sid;if(!this.channel||!n)return;k.debug("[Runtime]","send navigation",{path:e,q:t,hash:i});let r=new URL(window.location.href);r.pathname=e,r.search=t,r.hash=i,window.history.pushState({},"",""+r);let s={t:"nav",sid:n,path:e,q:t,hash:i};k.debug("[Runtime]","→ sending navigation",s),this.channel.sendMessage("nav",s)}sendPopNavigation(e,t,i=""){let n=this.sessionId??this.bootPayload?.sid;if(!this.channel||!n)return;k.debug("[Runtime]","send pop navigation",{path:e,q:t,hash:i});let r={t:"pop",sid:n,path:e,q:t,hash:i};k.debug("[Runtime]","→ sending pop navigation",r),this.channel.sendMessage("pop",r)}requestRecover(){let e=this.sessionId??this.bootPayload?.sid;if(!this.channel||!e)return;k.debug("[Runtime]","request recover",{sid:e});let t={t:"recover",sid:e};k.debug("[Runtime]","→ sending recover",t),this.channel.sendMessage("recover",t)}buildJoinPayload(e){return{sid:e.sid,ver:e.ver??0,ack:this.lastAck||e.seq||0,loc:{path:e.location?.path??"/",q:e.location?.q??"",hash:e.location?.hash??""}}}routeMessage(e){if(e&&"string"==typeof e.t)switch(k.debug("[Runtime]","received message",{type:e?.t}),this.events.emit("message",e),e.t){case"init":this.handleInit(e);break;case"frame":this.handleFrame(e);break;case"template":this.events.emit("template",e);break;case"resume":this.events.emit("resume",e);break;case"join":this.events.emit("join",e);break;case"evt-ack":this.handleEventAck(e);break;case"diagnostic":this.events.emit("diagnostic",e);break;case"error":this.handleErrorMessage(e);break;case"upload":this.events.emit("upload",e);break;case"domreq":this.events.emit("domreq",e)}}handleInit(e){let t=this.sessionId;this.sessionId=e.sid,(!t||t!==e.sid)&&this.resetEventSequencing(),this.version=e.ver,k.debug("[Runtime]","init received",{sid:e.sid,version:e.ver,seq:e.seq}),"number"==typeof e.seq&&(this.lastAck=e.seq,this.sendAck(e.seq)),this.events.emit("init",e),this.markEventFrameApplied()}handleFrame(e){this.version=e.ver,k.debug("[Runtime]","frame received",{version:e.ver,seq:e.seq,ops:Array.isArray(e.patch)?e.patch.length:0}),"number"==typeof e.seq&&(this.lastAck=e.seq,this.sendAck(e.seq)),this.events.emit("frame",e),this.markEventFrameApplied()}handleErrorMessage(e){let t=Error(e.message??"server error");t.name=e.code??"ServerError",this.handleErrorEvent(t)}handleChannelLeave(){if(k.debug("[Runtime]","channel left, cleaning up"),this.channel=null,this.sessionId=null,this.version=0,this.resetEventSequencing(),this.client){try{this.client.disconnect()}catch(e){k.debug("[Runtime]","client disconnect error",e)}this.client=null}this.updateState({status:"disconnected"}),this.events.emit("disconnected",void 0),!this.disposed&&this.options.reconnect&&this.scheduleReconnect()}scheduleReconnect(){if(this.reconnectAttempts>=this.options.maxReconnectAttempts||this.reconnectTimer)return;this.reconnectAttempts+=1;let e=this.options.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);k.debug("[Runtime]","scheduling reconnect",{attempt:this.reconnectAttempts,delay:e}),this.updateState({status:"reconnecting",attempt:this.reconnectAttempts}),this.reconnectTimer=setTimeout(()=>{this.reconnectTimer=null,this.connect()},e)}clearReconnectTimer(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null)}sendAck(e){let t=this.sessionId??this.bootPayload?.sid;if(!this.channel||!t)return;k.debug("[Runtime]","acknowledging frame",{seq:e});let i={t:"ack",sid:t,seq:e};k.debug("[Runtime]","→ sending ack",i),this.channel.sendMessage("ack",i)}drainEventQueue(){if(!this.channel)return;let e=this.sessionId??this.bootPayload?.sid;if(e)for(;this.pendingEvents.length>0&&this.maxInFlightEvents>this.inFlightEvents.length;){let t=this.pendingEvents.shift();if(!t)break;this.transmitEvent(t,e)}}transmitEvent(e,t){if(!this.channel)return;k.debug("[Runtime]","send event",{handler:e.hid,cseq:e.seq});let i={t:"evt",sid:t,hid:e.hid,payload:e.payload,cseq:e.seq};k.debug("[Runtime]","→ sending event",i),this.inFlightEvents.push({seq:e.seq,acked:0,frameApplied:0}),this.channel.sendMessage("evt",i)}allocateEventSeq(e){if("number"==typeof e&&e>0)return e>=this.nextEventSeq&&(this.nextEventSeq=e+1),e;let t=this.nextEventSeq;return this.nextEventSeq+=1,t}handleEventAck(e){let t="number"==typeof e.cseq?e.cseq:0;t>this.lastEventAck&&(this.lastEventAck=t),t>=this.nextEventSeq&&(this.nextEventSeq=t+1),this.markEventAcked(t),this.events.emit("evtack",e)}resetEventSequencing(){this.nextEventSeq=1,this.lastEventAck=0,this.pendingEvents.length=0,this.inFlightEvents.length=0}markEventAcked(e){for(let t of this.inFlightEvents)if(t.seq===e){t.acked=1;break}this.releaseCompletedEvent()}markEventFrameApplied(){for(let e of this.inFlightEvents)if(!e.frameApplied){e.frameApplied=1;break}this.releaseCompletedEvent()}releaseCompletedEvent(){let e=0;for(;this.inFlightEvents.length>0&&this.inFlightEvents[0].acked&&this.inFlightEvents[0].frameApplied;)this.inFlightEvents.shift(),e=1;e&&this.drainEventQueue()}handleErrorEvent(e){k.warn("[Runtime]","runtime error",e),this.events.emit("error",{error:e}),this.updateState({status:"error",error:e})}updateState(e){this.state=e,this.events.emit("state",e)}},S=new Map,"u">typeof window&&(window.__DEBUG_COMPONENT_RANGES__=S),T=class{constructor(){this.slots=new Map,this.lists=new Map}reset(){this.slots.clear(),this.lists.clear(),k.debug("[DomRegistry]","reset")}prime(e,i){return t(e,i)}registerSlotAnchors(t,i){let r=function(t,i){let r=new Map;if(!Array.isArray(t))return r;for(let s of t){if(!s)continue;let t=+s.slot;if(!Number.isInteger(t)||0>t||r.has(t))continue;let o=i?.get(s.componentId)??e(s.componentId);if(!o)continue;let a=n(o,s.path);if(!a)continue;let l=a,h=+s.textChildIndex;if(Number.isInteger(h)&&h>=0)if(a instanceof Text)l=a;else if(a instanceof Element||a instanceof DocumentFragment){let e=a.childNodes.item(h);if(e)l=e;else if("u">typeof document){let e=document.createTextNode(""),t=a.childNodes.item(h)??null;a.insertBefore(e,t),l=e}}else l=null;l&&(r.set(t,l),k.debug("[Manifest]","slot anchor resolved",{slotId:t,componentId:s.componentId,targetNode:l.nodeName,path:s.path,textChildIndex:s.textChildIndex}))}return r}(t,i);r.forEach((e,t)=>this.slots.set(t,e)),k.debug("[DomRegistry]","registered slot anchors",{count:r.size})}registerListContainers(t,i,r){let s=function(t,i){let r=new Map;if(k.debug("[Manifest]","resolveListContainers START",{descriptorsIsArray:Array.isArray(t),descriptorsLength:Array.isArray(t)?t.length:"N/A",hasOverrides:!!i}),!Array.isArray(t))return k.debug("[Manifest]","resolveListContainers: descriptors not an array, returning empty"),r;for(let s=0;t.length>s;s++){let o=t[s];if(k.debug("[Manifest]",`resolveListContainers: processing descriptor[${s}]`,{descriptor:o,hasDescriptor:!!o}),!o)continue;let a=+o.slot;if(!Number.isInteger(a)||0>a||r.has(a)){k.debug("[Manifest]",`resolveListContainers: skipping descriptor[${s}] - invalid slot`,{slotId:a,isInteger:Number.isInteger(a),alreadyHas:r.has(a)});continue}let l=i?.get(o.componentId)??e(o.componentId);if(!l){k.debug("[Manifest]",`resolveListContainers: descriptor[${s}] - NO RANGE FOUND`,{componentId:o.componentId,hasOverride:!!i?.get(o.componentId),hasComponentRange:!!e(o.componentId)});continue}if(k.debug("[Manifest]",`resolveListContainers: descriptor[${s}] - found range`,{componentId:o.componentId,range:l,atRoot:o.atRoot}),o.atRoot){let e=u(l);e?(k.debug("[Manifest]",`resolveListContainers: descriptor[${s}] - resolved atRoot element`,{slotId:a,elementNodeName:e.nodeName}),r.set(a,e)):k.debug("[Manifest]",`resolveListContainers: descriptor[${s}] - atRoot but no container element`);continue}let h=n(l,o.path);k.debug("[Manifest]",`resolveListContainers: descriptor[${s}] - resolved node by segments`,{nodeType:h?.nodeName,isElement:h instanceof Element}),h instanceof Element?(r.set(a,h),k.debug("[Manifest]",`resolveListContainers: descriptor[${s}] - SUCCESS`,{slotId:a,elementNodeName:h.nodeName})):k.debug("[Manifest]",`resolveListContainers: descriptor[${s}] - node not an Element, skipping`)}return k.debug("[Manifest]","resolveListContainers END",{containerCount:r.size}),r}(t,i);s.forEach((e,t)=>{let i=r?.get(t),{rows:n,order:s}=function(e,t){let i=new Map,n=[];if(!e||!Array.isArray(t)||0===t.length)return{rows:i,order:n};let r=Array.from(e.childNodes),s=0;for(let e of t){if(!e||!e.key)continue;let t=Math.max(1,+e.count||1),o=[];for(let e=0;t>e&&r.length>s;e+=1,s+=1){let e=r[s];e&&o.push(e)}0!==o.length&&(i.set(e.key,{nodes:o}),n.push(e.key))}return{rows:i,order:n}}(e,i);this.lists.set(t,{container:e,rows:n,order:s})}),k.debug("[DomRegistry]","registered list containers",{count:s.size})}registerSlots(e){Array.isArray(e)&&(e.forEach(e=>{if(e&&"number"==typeof e.anchorId&&!this.slots.has(e.anchorId)){let t="u">typeof document?document.createTextNode(""):null;t&&this.slots.set(e.anchorId,t)}}),k.debug("[DomRegistry]","registered additional slots",{total:this.slots.size}))}getSlot(e){return this.slots.get(e)}registerLists(e,t,i){this.registerListContainers(e,t,i)}getList(e){return this.lists.get(e)?.container}getRow(e,t){return this.lists.get(e)?.rows.get(t)}insertRow(e,t,i,n){if(!t||0===i.length)return;let r=this.lists.get(e);if(!r)return;r.rows.set(t,{nodes:[...i]});let s=f(r.order.length,n);r.order.splice(s,0,t),k.debug("[DomRegistry]","inserted row",{slotId:e,key:t,index:s})}deleteRow(e,t){let i=this.lists.get(e);if(!i)return;i.rows.delete(t);let n=i.order.indexOf(t);n>=0&&i.order.splice(n,1),k.debug("[DomRegistry]","deleted row",{slotId:e,key:t})}moveRow(e,t,i){let n=this.lists.get(e);if(!n)return;let r=n.order.indexOf(t);if(-1===r)return;n.order.splice(r,1);let s=f(n.order.length,i);n.order.splice(s,0,t),k.debug("[DomRegistry]","moved row",{slotId:e,key:t,to:s})}getRowKeyAt(e,t){let i=this.lists.get(e);if(!i)return;let n=i.order??[];return t>=0&&n.length>t?n[t]:void 0}getRowFirstNode(e,t){return this.getRow(e,t)?.nodes[0]}},x=class{constructor(){this.meta=new Map,this.bindings=new Map}clear(){Array.from(this.bindings.keys()).forEach(e=>this.detach(e)),this.meta.clear(),k.debug("[Refs]","cleared all bindings")}apply(e){if(e){if(Array.isArray(e.del))for(let t of e.del)this.detach(t),this.meta.delete(t);if(e.add)for(let[t,i]of Object.entries(e.add))t&&this.meta.set(t,i);k.debug("[Refs]","applied ref delta",{added:e.add?Object.keys(e.add).length:0,removed:e.del?.length??0})}}registerBindings(e,t){Array.isArray(e)&&(k.debug("[Refs]","registering ref bindings",{count:e.length}),e.forEach((e,n)=>{if(!e||"string"!=typeof e.refId||0===e.refId.length)return;k.debug("[Refs]","processing ref binding",{index:n,descriptor:{componentId:e.componentId,path:e.path,refId:e.refId},hasRefId:!!e.refId,refIdLength:e.refId?.length??0}),k.debug("[Refs]","resolving node for ref",{refId:e.refId,componentId:e.componentId,path:e.path});let r=i(e.componentId,e.path,t);k.debug("[Refs]","node resolved",{refId:e.refId,node:r,isElement:r instanceof Element,nodeType:r?.nodeType,nodeName:r?.nodeName}),r instanceof Element?(k.debug("[Refs]","attaching ref",{refId:e.refId,node:r}),this.attach(e.refId,r)):(k.debug("[Refs]","node is not Element, detaching",{refId:e.refId,node:r}),this.detach(e.refId))}))}get(e){return this.bindings.get(e)?.element}attach(e,t){if(!this.meta.get(e))return;let i=this.bindings.get(e);if(i&&i.element===t)return;this.detach(e);let n=new Map;this.bindings.set(e,{element:t,listeners:n}),k.debug("[Refs]","attached ref",{refId:e,tag:t.tagName})}detach(e){let t=this.bindings.get(e);t&&(t.listeners.forEach((e,i)=>{t.element.removeEventListener(i,e)}),this.bindings.delete(e),k.debug("[Refs]","detached ref",{refId:e}))}},L=new Map,j=new Map,_=new Set,D=new WeakMap,P=class{constructor(e,t,i){this.dom=e,this.refs=t,this.uploads=i}applyFrame(e){Array.isArray(e.patch)&&(k.debug("[Patcher]","applying frame patch",{opCount:e.patch.length}),this.applyOps(e.patch))}applyOps(e){k.debug("[Patcher]","applying ops",{count:e.length});for(let t of e)if(Array.isArray(t)&&0!==t.length)switch(t[0]){case"setText":this.applySetText(t[1],t[2]);break;case"setAttrs":this.applySetAttrs(t[1],t[2]||{});break;case"list":this.applyList(t[1],t.slice(2))}}applySetText(e,t){let i=this.dom.getSlot(e);if(i)return i instanceof Text?(i.textContent=t??"",void k.debug("[Patcher]","setText applied",{slotId:e,nodeType:"Text"})):void(i instanceof Element&&(i.textContent=t??"",k.debug("[Patcher]","setText applied",{slotId:e,nodeType:i.tagName})));k.debug("[Patcher]","setText skipped (missing slot)",{slotId:e})}applySetAttrs(e,t){let i=this.dom.getSlot(e);i instanceof Element?(Object.entries(t??{}).forEach(([e,t])=>{null==t||""===t?i.removeAttribute(e):i.setAttribute(e,t)}),k.debug("[Patcher]","setAttrs applied",{slotId:e,keys:Object.keys(t??{})})):k.debug("[Patcher]","setAttrs skipped (non-element)",{slotId:e})}applyList(e,t){let i=this.dom.getList(e);i instanceof Element?(k.debug("[Patcher]","list patch",{slotId:e,opCount:t.length}),t.forEach(t=>{if(Array.isArray(t))switch(t[0]){case"del":this.applyListDelete(e,i,t);break;case"ins":this.applyListInsert(e,i,t);break;case"mov":this.applyListMove(e,i,t)}})):k.debug("[Patcher]","list op skipped (no container)",{slotId:e})}applyListDelete(e,t,i){let n=i[1],r=this.dom.getRow(e,n);r?(r.nodes.forEach(e=>{e.parentNode===t&&t.removeChild(e)}),this.dom.deleteRow(e,n),k.debug("[Patcher]","list delete applied",{slotId:e,key:n})):k.debug("[Patcher]","list delete skipped (missing row)",{slotId:e,key:n})}applyListInsert(e,t,i){let[n,r,s]=i,o=s?.html??"";if(!o)return void k.debug("[Patcher]","list insert skipped (no html)",{slotId:e,index:r});let a=document.createElement("template");a.innerHTML=o;let l=a.content,h=Array.from(l.childNodes);if(0===h.length)return void k.debug("[Patcher]","list insert skipped (no nodes)",{slotId:e,index:r});let d=this.dom.getRowKeyAt(e,r),c=d?this.dom.getRowFirstNode(e,d):null;t.insertBefore(l,c??null),this.dom.insertRow(e,s?.key??"",h,r);let u=h.find(e=>e instanceof Element)??null;u&&this.registerRowMetadata(u,s?.componentPaths??[],s?.slotPaths,s?.listPaths,s?.bindings),k.debug("[Patcher]","list insert applied",{slotId:e,index:r,key:s?.key,nodeCount:h.length})}applyListMove(e,t,i){let n=i[1],r=i[2];if(n===r)return;let s=this.dom.getRowKeyAt(e,n);if(!s)return void k.debug("[Patcher]","list move skipped (missing source key)",{slotId:e,from:n,to:r});let o=this.dom.getRow(e,s);if(!o)return void k.debug("[Patcher]","list move skipped (missing record)",{slotId:e,from:n,to:r});let a=this.dom.getRowKeyAt(e,r),l=a?this.dom.getRowFirstNode(e,a):null;o.nodes.forEach(e=>{e.parentNode===t&&t.insertBefore(e,l??null)}),this.dom.moveRow(e,s,r),k.debug("[Patcher]","list move applied",{slotId:e,from:n,to:r,key:s})}registerRowMetadata(e,i,n,r,s){let o=t(i??[],{root:e});this.dom.registerSlotAnchors(n??void 0,o),this.dom.registerLists(r??void 0,o),s?.slots&&Object.entries(s.slots).forEach(([e,t])=>{!function(e,t){if(!Number.isFinite(e)||(L.delete(e),j.forEach(t=>t.delete(e)),!Array.isArray(t)))return;let i=g(t);L.set(e,i),y(e,i),k.debug("[Events]","registered slot bindings",{slotId:e,count:i.length})}(+e,t)}),s?.router&&v(s.router,o),s?.refs&&this.refs?.registerBindings(s.refs,o),s?.uploads&&this.uploads?.registerBindings(s.uploads,o,{replace:0}),k.debug("[Patcher]","row metadata registered",{slots:s?.slots?Object.keys(s.slots).length:0,routers:s?.router?.length??0,refs:s?.refs?.length??0,uploads:s?.uploads?.length??0})}},q=class{constructor(e){this.runtime=e,this.bindings=new Map,this.elementToUpload=new WeakMap,this.active=new Map,this.componentBindings=new Map}clear(){this.bindings.forEach(e=>{e.element.removeEventListener("change",e.changeHandler)}),this.bindings.clear(),this.componentBindings.clear(),this.active.forEach(e=>e.xhr.abort()),this.active.clear(),k.debug("[Uploads]","cleared bindings and active uploads")}prime(e,t){this.clear(),this.registerBindings(e,t),k.debug("[Uploads]","primed upload bindings",{count:e?.length??0})}registerBindings(e,t,i){if(!Array.isArray(e))return;if(k.debug("[Uploads]","register bindings",{count:e.length,replace:0!=i?.replace}),0==i?.replace)return void e.forEach(e=>{!e||"string"!=typeof e.uploadId||0===e.uploadId.length||this.attachDescriptor(e,t)});let n=new Map;e.forEach(e=>{if(!e||"string"!=typeof e.uploadId||0===e.uploadId.length)return;let t=e.componentId||"__root__",i=n.get(t)??[];i.push(e),n.set(t,i)}),n.forEach((e,i)=>{this.replaceBindingsForComponent(i,e,t)})}replaceBindingsForComponent(e,t,i){let n=e||"__root__",r=this.componentBindings.get(n);if(r&&(r.forEach(e=>this.detachBinding(e)),this.componentBindings.delete(n)),!t||0===t.length)return;let s=new Set;t.forEach(e=>{!e||"string"!=typeof e.uploadId||0===e.uploadId.length||(this.attachDescriptor(e,i),s.add(e.uploadId))}),s.size>0&&this.componentBindings.set(n,s),k.debug("[Uploads]","component bindings replaced",{componentId:n,count:t?.length??0})}handleControl(e){!e||!e.id||(k.debug("[Uploads]","control message",{op:e.op,id:e.id}),("cancel"===e.op||"error"===e.op)&&this.abortUpload(e.id,1))}attachDescriptor(e,t){let n=i(e.componentId,e.path,t),r=this.resolveInput(n);if(!r)return;let s=e.uploadId;this.detachBinding(s);let o=()=>this.handleInputChange(s,r,e);r.addEventListener("change",o),this.syncAttributes(r,e),this.bindings.set(s,{id:s,element:r,descriptor:e,changeHandler:o}),this.elementToUpload.set(r,s);let a=e.componentId||"__root__",l=this.componentBindings.get(a)??new Set;l.add(s),this.componentBindings.set(a,l),k.debug("[Uploads]","attached upload descriptor",{uploadId:s,componentId:a,multiple:!!e.multiple})}detachBinding(e){let t=this.bindings.get(e);if(!t)return;t.element.removeEventListener("change",t.changeHandler),this.bindings.delete(e),this.elementToUpload.delete(t.element),this.abortUpload(e,0);let i=t.descriptor.componentId||"__root__",n=this.componentBindings.get(i);n&&(n.delete(e),0===n.size&&this.componentBindings.delete(i))}resolveInput(e){if(!e)return null;if(e instanceof HTMLInputElement)return e;if(e instanceof Element){if("input"===e.tagName.toLowerCase()&&"file"===e.getAttribute("type"))return e;let t=e.querySelector('input[type="file"]');if(t instanceof HTMLInputElement)return t}return null}syncAttributes(e,t){Array.isArray(t.accept)&&t.accept.length>0?e.setAttribute("accept",t.accept.join(",")):e.removeAttribute("accept"),t.multiple?e.multiple=1:(e.multiple=0,e.removeAttribute("multiple"))}handleInputChange(e,t,i){let n=t.files;if(!n||0===n.length)return this.sendUploadMessage({op:"cancelled",id:e}),void this.abortUpload(e,1);let r="function"==typeof n.item?n.item(0):n[0]??null;if(r)return"number"==typeof i.maxSize&&i.maxSize>0&&r.size>i.maxSize?(this.sendUploadMessage({op:"error",id:e,error:`File exceeds maximum size (${i.maxSize} bytes)`}),void(t.value="")):(this.sendUploadMessage({op:"change",id:e,meta:{name:r.name,size:r.size,type:r.type}}),this.startUpload(e,r,t),void k.debug("[Uploads]","input change processed",{uploadId:e,file:r.name,size:r.size}));this.sendUploadMessage({op:"cancelled",id:e})}startUpload(e,t,i){let n=this.runtime.getSessionId();if(!n)return;let r=this.runtime.getUploadEndpoint(),s=this.buildUploadURL(r,n,e);this.abortUpload(e,0);let o=new XMLHttpRequest;o.upload.onprogress=i=>{this.sendUploadMessage({op:"progress",id:e,loaded:i.loaded??0,total:i.lengthComputable?i.total:t.size})},o.onerror=()=>{this.active.delete(e),this.sendUploadMessage({op:"error",id:e,error:"Upload failed"})},o.onabort=()=>{this.active.delete(e),this.sendUploadMessage({op:"cancelled",id:e})},o.onload=()=>{this.active.delete(e),200>o.status||o.status>=300?this.sendUploadMessage({op:"error",id:e,error:`Upload failed (${o.status})`}):(this.sendUploadMessage({op:"progress",id:e,loaded:t.size,total:t.size}),i.value="")};let a=new FormData;a.append("file",t),o.open("POST",s,1),o.send(a),this.active.set(e,{xhr:o,element:i}),k.debug("[Uploads]","upload started",{uploadId:e,target:s})}abortUpload(e,t){let i=this.active.get(e);i&&(i.xhr.abort(),t&&(i.element.value=""),this.active.delete(e),k.debug("[Uploads]","upload aborted",{uploadId:e,cleared:t}))}sendUploadMessage(e){e.id&&(this.runtime.sendUploadMessage(e),k.debug("[Uploads]","sent upload message",e))}buildUploadURL(e,t,i){return`${(e&&e.length>0?e:"/pondlive/upload/").replace(/\/+$/,"")}/${encodeURIComponent(t)}/${encodeURIComponent(i)}`}},U=class{constructor(){this.metaTags=new Map,this.linkTags=new Map,this.scriptTags=new Map,this.descriptionMeta=null,this.indexExistingTags()}indexExistingTags(){typeof document>"u"||(document.querySelectorAll("meta[data-live-key]").forEach(e=>{if(e instanceof HTMLMetaElement){let t=e.getAttribute("data-live-key");t&&(this.metaTags.set(t,e),"description"===e.name&&(this.descriptionMeta=e))}}),document.querySelectorAll("link[data-live-key]").forEach(e=>{if(e instanceof HTMLLinkElement){let t=e.getAttribute("data-live-key");t&&this.linkTags.set(t,e)}}),document.querySelectorAll("script[data-live-key]").forEach(e=>{if(e instanceof HTMLScriptElement){let t=e.getAttribute("data-live-key");t&&this.scriptTags.set(t,e)}}))}applyEffect(e){if("u">=typeof document){if(k.debug("[Metadata]","applying effect",e),void 0!==e.title&&(document.title=e.title),void 0!==e.description?this.updateDescription(e.description):e.clearDescription&&this.clearDescription(),e.metaRemove)for(let t of e.metaRemove)this.removeMeta(t);if(e.metaAdd)for(let t of e.metaAdd)this.addOrUpdateMeta(t);if(e.linkRemove)for(let t of e.linkRemove)this.removeLink(t);if(e.linkAdd)for(let t of e.linkAdd)this.addOrUpdateLink(t);if(e.scriptRemove)for(let t of e.scriptRemove)this.removeScript(t);if(e.scriptAdd)for(let t of e.scriptAdd)this.addOrUpdateScript(t)}}updateDescription(e){this.descriptionMeta||(this.descriptionMeta=document.createElement("meta"),this.descriptionMeta.name="description",this.descriptionMeta.setAttribute("data-live-managed","true"),document.head.appendChild(this.descriptionMeta)),this.descriptionMeta.content=e}clearDescription(){this.descriptionMeta&&this.descriptionMeta.hasAttribute("data-live-managed")&&(this.descriptionMeta.remove(),this.descriptionMeta=null)}addOrUpdateMeta(e){let t=this.metaTags.get(e.key);if(t||(t=document.createElement("meta"),t.setAttribute("data-live-key",e.key),document.head.appendChild(t),this.metaTags.set(e.key,t)),e.name&&(t.name=e.name),void 0!==e.content&&(t.content=e.content),e.property&&t.setAttribute("property",e.property),e.charset&&t.setAttribute("charset",e.charset),e.httpEquiv&&t.setAttribute("http-equiv",e.httpEquiv),e.itemProp&&t.setAttribute("itemprop",e.itemProp),e.attrs)for(let[i,n]of Object.entries(e.attrs))t.setAttribute(i,n);"description"===e.name&&(this.descriptionMeta=t)}removeMeta(e){let t=this.metaTags.get(e);t&&(t===this.descriptionMeta&&(this.descriptionMeta=null),t.remove(),this.metaTags.delete(e))}addOrUpdateLink(e){let t=this.linkTags.get(e.key);if(t||(t=document.createElement("link"),t.setAttribute("data-live-key",e.key),document.head.appendChild(t),this.linkTags.set(e.key,t)),e.rel&&(t.rel=e.rel),e.href&&(t.href=e.href),e.type&&(t.type=e.type),e.as&&t.setAttribute("as",e.as),e.media&&(t.media=e.media),e.hreflang&&(t.hreflang=e.hreflang),e.title&&(t.title=e.title),e.crossorigin&&t.setAttribute("crossorigin",e.crossorigin),e.integrity&&(t.integrity=e.integrity),e.referrerpolicy&&t.setAttribute("referrerpolicy",e.referrerpolicy),e.sizes&&t.setAttribute("sizes",e.sizes),e.attrs)for(let[i,n]of Object.entries(e.attrs))t.setAttribute(i,n)}removeLink(e){let t=this.linkTags.get(e);t&&(t.remove(),this.linkTags.delete(e))}addOrUpdateScript(e){let t=this.scriptTags.get(e.key);t&&(t.remove(),this.scriptTags.delete(e.key));let i=document.createElement("script");if(i.setAttribute("data-live-key",e.key),e.src&&(i.src=e.src),e.type&&(i.type=e.type),e.async&&(i.async=1),e.defer&&(i.defer=1),e.module&&(i.type="module"),e.noModule&&i.setAttribute("nomodule",""),e.crossorigin&&i.setAttribute("crossorigin",e.crossorigin),e.integrity&&(i.integrity=e.integrity),e.referrerpolicy&&i.setAttribute("referrerpolicy",e.referrerpolicy),e.nonce&&(i.nonce=e.nonce),e.inner&&(i.textContent=e.inner),e.attrs)for(let[t,n]of Object.entries(e.attrs))i.setAttribute(t,n);document.head.appendChild(i),this.scriptTags.set(e.key,i)}removeScript(e){let t=this.scriptTags.get(e);t&&(t.remove(),this.scriptTags.delete(e))}dispose(){this.metaTags.forEach(e=>{e.hasAttribute("data-live-key")&&e.remove()}),this.linkTags.forEach(e=>{e.hasAttribute("data-live-key")&&e.remove()}),this.scriptTags.forEach(e=>{e.hasAttribute("data-live-key")&&e.remove()}),this.metaTags.clear(),this.linkTags.clear(),this.scriptTags.clear(),this.descriptionMeta=null}},H=class{constructor(e,t){this.dom=new T,this.runtime=e,this.options=t??{},this.uploads=new q(e),this.refs=new x,this.metadata=new U,this.patcher=new P(this.dom,this.refs,this.uploads),this.runtime.on("init",e=>this.applyTemplate(e)),this.runtime.on("template",e=>this.applyTemplate(e)),this.runtime.on("frame",e=>this.applyFrame(e)),this.runtime.on("upload",e=>this.uploads.handleControl(e)),this.runtime.on("domreq",e=>this.handleDOMRequest(e));let i=this.runtime.getBootPayload();i&&this.applyTemplate(i)}applyTemplate(e){if(typeof document>"u"||"string"!=typeof e.html)return;let t=this.resolveRoot();if(!t)return;let i=e.componentPaths;if(k.debug("[Hydration]","applying template",{slotPaths:e.slotPaths?.length??0,listPaths:e.listPaths?.length??0,componentPaths:i?.length??0,htmlLength:e.html?.length??0}),t instanceof Document){let n=t.body??t.documentElement??t;n&&(n.innerHTML=e.html,w(n));let r=this.dom.prime(i,{root:t});return this.componentRanges=r,void this.primeRegistries(e,n??t,r)}if(t instanceof ShadowRoot){t.innerHTML=e.html,w(t);let n=this.dom.prime(i,{root:t});return this.componentRanges=n,void this.primeRegistries(e,t,n)}t.innerHTML=e.html,w(t);let n=this.dom.prime(i,{root:t});this.componentRanges=n,this.primeRegistries(e,t,n)}applyFrame(e){k.debug("[Hydration]","applying frame",{seq:e.seq,ver:e.ver,patchOps:Array.isArray(e.patch)?e.patch.length:0,effects:e.effects?.length??0}),this.patcher.applyFrame(e),e.bindings?.slots&&p(e.bindings.slots),e.bindings?.router&&v(e.bindings.router,this.componentRanges),e.bindings?.refs&&this.refs.registerBindings(e.bindings.refs,this.componentRanges),e.bindings?.uploads&&this.uploads.registerBindings(e.bindings.uploads,this.componentRanges),this.refs.apply(e.refs),e.effects&&this.applyEffects(e.effects),e.nav&&this.applyNavigation(e.nav),k.debug("[Hydration]","frame applied",{hasSlots:!!e.bindings?.slots,hasRouter:!!e.bindings?.router?.length,hasRefs:!!e.bindings?.refs?.length,hasUploads:!!e.bindings?.uploads?.length,refDeltaAdd:e.refs?.add?Object.keys(e.refs.add).length:0,refDeltaDel:e.refs?.del?.length??0,effectsApplied:e.effects?.length??0,navApplied:!(!e.nav?.push&&!e.nav?.replace)})}applyEffects(e){for(let t of e)"metadata"===t.type?this.metadata.applyEffect(t):"dom"===t.type?this.applyDOMAction(t):"cookies"===t.type&&this.applyCookieEffect(t)}applyDOMAction(e){if(!e.ref||!e.kind)return;let t=this.refs.get(e.ref);if(t)try{let i=e.kind;if("dom.call"===i&&e.method)"function"==typeof t[e.method]&&(t[e.method](...Array.isArray(e.args)?e.args:[]),k.debug("[Hydration]","DOM action call",{ref:e.ref,method:e.method}));else if("dom.set"===i&&e.prop)t[e.prop]=e.value,k.debug("[Hydration]","DOM action set",{ref:e.ref,prop:e.prop});else if("dom.toggle"===i&&e.prop)t[e.prop]=e.value,k.debug("[Hydration]","DOM action toggle",{ref:e.ref,prop:e.prop,value:e.value});else if("dom.class"===i&&e.class&&t instanceof Element)1==e.on?t.classList.add(e.class):t.classList.remove(e.class),k.debug("[Hydration]","DOM action class",{ref:e.ref,class:e.class,on:e.on});else if("dom.scroll"===i&&t instanceof Element){let i={};e.behavior&&(i.behavior=e.behavior),e.block&&(i.block=e.block),e.inline&&(i.inline=e.inline),t.scrollIntoView(i),k.debug("[Hydration]","DOM action scroll",{ref:e.ref,options:i})}}catch(t){k.warn("[Hydration]","DOM action failed",{ref:e.ref,kind:e.kind,error:t})}else k.debug("[Hydration]","DOM action skipped (element not found)",{ref:e.ref,kind:e.kind})}applyCookieEffect(e){if(typeof window>"u"||"function"!=typeof fetch)return;if(!e.endpoint||!e.sid||!e.token)return void k.debug("[Hydration]","Cookie effect skipped (missing required fields)",e);let t=e.method||"POST";k.debug("[Hydration]","Applying cookie effect",{endpoint:e.endpoint,method:t}),fetch(e.endpoint,{method:t,headers:{"Content-Type":"application/json"},body:JSON.stringify({sid:e.sid,token:e.token}),credentials:"include"}).then(t=>{t.ok?k.debug("[Hydration]","Cookie effect succeeded",{endpoint:e.endpoint}):k.warn("[Hydration]","Cookie effect failed",{endpoint:e.endpoint,status:t.status})}).catch(t=>{k.warn("[Hydration]","Cookie effect error",{endpoint:e.endpoint,error:t})})}applyNavigation(e){if(typeof window>"u"||typeof history>"u"||!e.push&&!e.replace&&!e.back)return;if(e.back){try{history.back(),k.debug("[Hydration]","Navigation back")}catch(e){k.warn("[Hydration]","Navigation back failed",{error:e})}return}let t=e.replace||e.push;if(t&&"string"==typeof t)try{e.replace?(history.replaceState(null,"",e.replace),k.debug("[Hydration]","Navigation replace",{url:e.replace})):(history.pushState(null,"",e.push),k.debug("[Hydration]","Navigation push",{url:e.push}))}catch(e){k.warn("[Hydration]","Navigation failed",{url:t,error:e})}else k.debug("[Hydration]","Navigation skipped (invalid URL)",e)}resolveRoot(){let e=this.options.root??document.body??document;return e?e instanceof Element||e instanceof Document||e instanceof ShadowRoot?e:document.body??document:null}primeRegistries(e,t,i){if(!t)return;this.dom.reset(),this.refs.clear(),this.refs.apply(e.refs),p(e.bindings?.slots?e.bindings.slots:void 0);let n=function(e){let t=new Map;if(!e||!Array.isArray(e.d))return t;let i=Array.isArray(e.slots)?e.slots:[];return e.d.forEach((e,n)=>{if(!e||"list"!==e.kind||!Array.isArray(e.list)||0===e.list.length)return;let r=e.list.map(e=>{if(e&&"string"==typeof e.key&&0!==e.key.length)return{key:e.key,count:Math.max(1,+e.rootCount||1)}}).filter(e=>!!e);0!==r.length&&t.set(i[n]?.anchorId??n,r)}),t}(e);this.dom.registerSlotAnchors(e.slotPaths,i),Array.isArray(e.slots)&&this.dom.registerSlots(e.slots),this.dom.registerListContainers(e.listPaths,i,n),e.bindings?.router&&v(e.bindings.router,i),e.bindings?.refs&&this.refs.registerBindings(e.bindings.refs,i),this.uploads.prime(e.bindings?.uploads??null,i),k.debug("[Hydration]","registries primed",{slots:e.slotPaths?.length??0,lists:e.listPaths?.length??0,routers:e.bindings?.router?.length??0,refs:e.bindings?.refs?.length??0,uploads:e.bindings?.uploads?.length??0})}handleDOMRequest(e){if(!e||!e.id||!e.ref)return void this.runtime.sendDOMResponse({id:e?.id??"",error:"invalid request"});let t=this.refs.get(e.ref);if(t)try{let i,n={};e.method&&"function"==typeof t[e.method]&&(i=t[e.method](...Array.isArray(e.args)?e.args:[])),Array.isArray(e.props)&&e.props.forEach(e=>{e&&(n[e]=t[e])}),this.runtime.sendDOMResponse({id:e.id,result:i,values:Object.keys(n).length>0?n:void 0})}catch(t){this.runtime.sendDOMResponse({id:e.id,error:t instanceof Error?t.message:"unknown error"})}else this.runtime.sendDOMResponse({id:e.id,error:"element not found"})}getRegistry(){return this.dom}},$=class{constructor(e,t){this.dom=e,this.runtime=t,this.handlers=new Map}setup(){var e;typeof document>"u"||(this.registerEvents(["click"]),this.registerEvents(Array.from(j.keys())),this.stopSlotObserver=(_.add(e=e=>this.bind(e)),()=>_.delete(e)),k.debug("[Delegation]","event delegation setup complete",{handlers:this.handlers.size}))}teardown(){typeof document>"u"||(this.stopSlotObserver&&(this.stopSlotObserver(),this.stopSlotObserver=void 0),this.handlers.forEach((e,t)=>{document.removeEventListener(t,e,1)}),this.handlers.clear(),k.debug("[Delegation]","event delegation torn down"))}registerEvents(e){e.forEach(e=>this.bind(e))}bind(e){if(this.handlers.has(e)||typeof document>"u")return;let t=t=>this.handleEvent(e,t);document.addEventListener(e,t,1),this.handlers.set(e,t),k.debug("[Delegation]","bound event listener",{event:e})}handleEvent(e,t){let i=t.target;if(!(i instanceof Element))return;let n=function(e){if(!e)return;let t=e;for(;t;){let e=D.get(t);if(e?.path)return e;t=t.parentElement}}(i);if("click"===e){let e=[],t=i;for(;t&&5>e.length;){let i=t.i;e.push({tag:t.tagName,hasDebug:!!i,debugPath:i?.path,isConnected:t.isConnected}),t=t.parentElement}k.debug("[Delegation]","click event",{tag:i.tagName,hasRouterMeta:!!n,hasPath:!!n?.path,parentChain:e})}if(n&&n.path&&"click"===e)return k.debug("[Delegation]","router navigation triggered",{path:n.path,query:n.query,hash:n.hash,replace:n.replace}),this.runtime.sendNavigation(n.path,n.query??"",n.hash??""),void t.preventDefault();let r=function(e){let t=j.get(e);return t?Array.from(t):[]}(e);for(let n of r){let r=m(n)??[],s=this.dom.getSlot(n);if(s instanceof Element&&(s===i||s.contains(i))){let i=r.find(t=>t.event===e);if(i){let r=b(t,i.props);this.runtime.sendEvent(i.handler,r?{name:e,detail:r}:{name:e}),k.debug("[Delegation]","slot event dispatched",{slotId:n,handler:i.handler,event:e});break}}}}},W=B=class{constructor(e){this.runtime=new C(e),this.C=new H(this.runtime),this.events=new $(this.C.getRegistry(),this.runtime),this.events.setup()}connect(){return this.runtime.connect()}disconnect(){this.runtime.disconnect(),this.events.teardown()}destroy(){this.runtime.destroy(),this.events.teardown()}getState(){return this.runtime.getState()}getBootPayload(){return this.runtime.getBootPayload()}on(e,t){return this.runtime.on(e,t)}once(e,t){return this.runtime.once(e,t)}off(e,t){this.runtime.off(e,t)}sendEvent(e,t,i){this.runtime.sendEvent(e,t,i)}sendNavigation(e,t,i){this.runtime.sendNavigation(e,t,i)}getHydrationManager(){return this.C}},F=null,"u">typeof window&&M().catch(e=>{k.error("Boot failed",e)}),(e=>{ee(V({},"__esModule",{value:1}),e)})(ve)})();