"use strict";var e=(()=>{var e=Object.create,t=Object.defineProperty,n=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyNames,r=Object.getPrototypeOf,s=Object.prototype.hasOwnProperty,o=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),a=(e,n)=>{for(var i in n)t(e,i,{get:n[i],enumerable:!0})},l=(e,r,o,a)=>{if(r&&"object"==typeof r||"function"==typeof r)for(let l of i(r))!s.call(e,l)&&l!==o&&t(e,l,{get:()=>r[l],enumerable:!(a=n(r,l))||a.enumerable});return e},c=o(e=>{var t,n,i=e&&e.__classPrivateFieldSet||function(e,t,n,i,r){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?r.call(e,n):r?r.value=n:t.set(e,n),n},r=e&&e.__classPrivateFieldGet||function(e,t,n,i){if("a"===n&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?i:"a"===n?i.call(e):i?i.value:t.get(e)};Object.defineProperty(e,"__esModule",{value:!0}),e.Subject=void 0,e.Subject=class{constructor(){t.set(this,void 0),n.set(this,void 0),i(this,t,!1,"f"),i(this,n,new Set,"f")}get size(){return r(this,n,"f").size}subscribe(e){if(r(this,t,"f"))throw Error("Cannot subscribe to a closed subject");return r(this,n,"f").add(e),()=>r(this,n,"f").delete(e)}publish(e){r(this,n,"f").forEach(t=>t(e))}close(){r(this,n,"f").clear(),i(this,t,!0,"f")}},t=new WeakMap,n=new WeakMap}),d=o(e=>{var t,n=e&&e.__classPrivateFieldSet||function(e,t,n,i,r){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?r.call(e,n):r?r.value=n:t.set(e,n),n},i=e&&e.__classPrivateFieldGet||function(e,t,n,i){if("a"===n&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?i:"a"===n?i.call(e):i?i.value:t.get(e)};Object.defineProperty(e,"__esModule",{value:!0}),e.BehaviorSubject=void 0;var r=c(),s=class extends r.Subject{constructor(e){super(),t.set(this,void 0),n(this,t,e,"f")}get value(){return i(this,t,"f")}publish(e){n(this,t,e,"f"),super.publish(e)}subscribe(e){return i(this,t,"f")&&e(i(this,t,"f")),super.subscribe(e)}};e.BehaviorSubject=s,t=new WeakMap}),u=o(e=>{var t=e&&e.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var r=Object.getOwnPropertyDescriptor(t,n);(!r||("get"in r?!t.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,r)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),n=e&&e.__exportStar||function(e,n){for(var i in e)"default"!==i&&!Object.prototype.hasOwnProperty.call(n,i)&&t(n,e,i)};Object.defineProperty(e,"__esModule",{value:!0}),n(d(),e),n(c(),e)}),h=o(e=>{var t,n,i,r,s,o,a,l,c,d;Object.defineProperty(e,"__esModule",{value:!0}),e.PubSubEvents=e.Events=e.ChannelReceiver=e.SystemSender=e.ErrorTypes=e.ChannelState=e.ClientActions=e.ServerActions=e.PresenceEventTypes=void 0,(n=t||(e.PresenceEventTypes=t={})).JOIN="JOIN",n.LEAVE="LEAVE",n.UPDATE="UPDATE",function(e){e.PRESENCE="PRESENCE",e.SYSTEM="SYSTEM",e.BROADCAST="BROADCAST",e.ERROR="ERROR",e.CONNECT="CONNECT"}(i||(e.ServerActions=i={})),function(e){e.JOIN_CHANNEL="JOIN_CHANNEL",e.LEAVE_CHANNEL="LEAVE_CHANNEL",e.BROADCAST="BROADCAST"}(r||(e.ClientActions=r={})),function(e){e.IDLE="IDLE",e.JOINING="JOINING",e.JOINED="JOINED",e.STALLED="STALLED",e.CLOSED="CLOSED"}(s||(e.ChannelState=s={})),function(e){e.UNAUTHORIZED_CONNECTION="UNAUTHORIZED_CONNECTION",e.UNAUTHORIZED_JOIN_REQUEST="UNAUTHORIZED_JOIN_REQUEST",e.UNAUTHORIZED_BROADCAST="UNAUTHORIZED_BROADCAST",e.INVALID_MESSAGE="INVALID_MESSAGE",e.HANDLER_NOT_FOUND="HANDLER_NOT_FOUND",e.PRESENCE_ERROR="PRESENCE_ERROR",e.CHANNEL_ERROR="CHANNEL_ERROR",e.ENDPOINT_ERROR="ENDPOINT_ERROR",e.INTERNAL_SERVER_ERROR="INTERNAL_SERVER_ERROR"}(o||(e.ErrorTypes=o={})),function(e){e.ENDPOINT="ENDPOINT",e.CHANNEL="CHANNEL"}(a||(e.SystemSender=a={})),function(e){e.ALL_USERS="ALL_USERS",e.ALL_EXCEPT_SENDER="ALL_EXCEPT_SENDER"}(l||(e.ChannelReceiver=l={})),function(e){e.ACKNOWLEDGE="ACKNOWLEDGE",e.CONNECTION="CONNECTION"}(c||(e.Events=c={})),function(e){e.MESSAGE="MESSAGE",e.PRESENCE="PRESENCE",e.GET_PRESENCE="GET_PRESENCE"}(d||(e.PubSubEvents=d={}))}),f=o(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}}),p=o(e=>{Object.defineProperty(e,"__esModule",{value:!0})}),m=o(e=>{var t=e&&e.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var r=Object.getOwnPropertyDescriptor(t,n);(!r||("get"in r?!t.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,r)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),n=e&&e.__exportStar||function(e,n){for(var i in e)"default"!==i&&!Object.prototype.hasOwnProperty.call(n,i)&&t(n,e,i)};Object.defineProperty(e,"__esModule",{value:!0}),n(f(),e),n(p(),e)}),g=o(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.channelEventSchema=e.serverMessageSchema=e.presenceMessageSchema=e.clientMessageSchema=e.ValidationError=void 0;var t=h(),n=class extends Error{constructor(e,t){super(t?`${t}: ${e}`:e),this.path=t,this.name="ValidationError"}};function i(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}function r(e,t){if(!function(e){return"string"==typeof e}(e))throw new n("Expected string, got "+typeof e,t)}function s(e,t){if(!i(e))throw new n("Expected object, got "+typeof e,t)}function o(e,t){if(!function(e){return!!i(e)&&Object.keys(e).every(e=>"string"==typeof e)}(e))throw new n("Expected record with string keys, got "+typeof e,t)}function a(e,t,i){let r=Object.values(t);if(!r.includes(e))throw new n(`Expected one of [${r.join(", ")}], got ${JSON.stringify(e)}`,i)}e.ValidationError=n,e.clientMessageSchema={parse(e){s(e,"clientMessage");let i=e;if(!("event"in i))throw new n("Missing required field","event");if(!("requestId"in i))throw new n("Missing required field","requestId");if(!("channelName"in i))throw new n("Missing required field","channelName");if(!("payload"in i))throw new n("Missing required field","payload");if(!("action"in i))throw new n("Missing required field","action");return r(i.event,"event"),r(i.requestId,"requestId"),r(i.channelName,"channelName"),o(i.payload,"payload"),a(i.action,t.ClientActions,"action"),{event:i.event,requestId:i.requestId,channelName:i.channelName,payload:i.payload,action:i.action}}},e.presenceMessageSchema={parse(e){s(e,"presenceMessage");let i=e;if(!("requestId"in i))throw new n("Missing required field","requestId");if(!("channelName"in i))throw new n("Missing required field","channelName");if(!("event"in i))throw new n("Missing required field","event");if(!("action"in i))throw new n("Missing required field","action");if(!("payload"in i))throw new n("Missing required field","payload");if(r(i.requestId,"requestId"),r(i.channelName,"channelName"),a(i.event,t.PresenceEventTypes,"event"),i.action!==t.ServerActions.PRESENCE)throw new n(`Expected ${t.ServerActions.PRESENCE}, got ${JSON.stringify(i.action)}`,"action");s(i.payload,"payload");let l=i.payload;if(!("presence"in l))throw new n("Missing required field","payload.presence");if(!("changed"in l))throw new n("Missing required field","payload.changed");return function(e,t){if(!function(e){return Array.isArray(e)}(e))throw new n("Expected array, got "+typeof e,t)}(l.presence,"payload.presence"),l.presence.forEach((e,t)=>{o(e,`payload.presence[${t}]`)}),o(l.changed,"payload.changed"),{requestId:i.requestId,channelName:i.channelName,event:i.event,action:t.ServerActions.PRESENCE,payload:{presence:l.presence,changed:l.changed}}}},e.serverMessageSchema={parse(e){s(e,"serverMessage");let i=e;if(!("event"in i))throw new n("Missing required field","event");if(!("requestId"in i))throw new n("Missing required field","requestId");if(!("channelName"in i))throw new n("Missing required field","channelName");if(!("payload"in i))throw new n("Missing required field","payload");if(!("action"in i))throw new n("Missing required field","action");r(i.event,"event"),r(i.requestId,"requestId"),r(i.channelName,"channelName"),o(i.payload,"payload");let a=[t.ServerActions.BROADCAST,t.ServerActions.CONNECT,t.ServerActions.ERROR,t.ServerActions.SYSTEM];if(!a.includes(i.action))throw new n(`Expected one of [${a.join(", ")}], got ${JSON.stringify(i.action)}`,"action");return{event:i.event,requestId:i.requestId,channelName:i.channelName,payload:i.payload,action:i.action}}},e.channelEventSchema={parse(i){s(i,"channelEvent");let r=i;if(!("action"in r))throw new n("Missing required field","action");return r.action===t.ServerActions.PRESENCE?e.presenceMessageSchema.parse(i):e.serverMessageSchema.parse(i)}}}),y=o(e=>{var t=e&&e.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var r=Object.getOwnPropertyDescriptor(t,n);(!r||("get"in r?!t.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,r)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),n=e&&e.__exportStar||function(e,n){for(var i in e)"default"!==i&&!Object.prototype.hasOwnProperty.call(n,i)&&t(n,e,i)};Object.defineProperty(e,"__esModule",{value:!0}),n(u(),e),n(h(),e),n(m(),e),n(g(),e)}),b=o(e=>{var t,n,i,r,s,o,a,l,c,d,u,h,f,p,m,g=e&&e.__classPrivateFieldSet||function(e,t,n,i,r){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?r.call(e,n):r?r.value=n:t.set(e,n),n},b=e&&e.__classPrivateFieldGet||function(e,t,n,i){if("a"===n&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?i:"a"===n?i.call(e):i?i.value:t.get(e)};Object.defineProperty(e,"__esModule",{value:!0}),e.Channel=void 0;var v=y();e.Channel=class{constructor(e,u,h,f){t.add(this),n.set(this,void 0),i.set(this,void 0),r.set(this,void 0),s.set(this,void 0),o.set(this,void 0),a.set(this,void 0),l.set(this,void 0),c.set(this,void 0),d.set(this,void 0),g(this,n,h,"f"),g(this,i,[],"f"),g(this,r,[],"f"),g(this,a,f,"f"),g(this,o,e,"f"),g(this,c,u,"f"),g(this,l,new v.Subject,"f"),g(this,d,new v.BehaviorSubject(v.ChannelState.IDLE),"f"),g(this,s,()=>{},"f")}get channelState(){return b(this,d,"f").value}get presence(){return b(this,r,"f")}acknowledge(e){b(this,d,"f").publish(v.ChannelState.JOINED),b(this,t,"m",h).call(this,e),b(this,t,"m",u).call(this)}join(){let e={action:v.ClientActions.JOIN_CHANNEL,event:v.ClientActions.JOIN_CHANNEL,payload:b(this,a,"f"),channelName:b(this,n,"f"),requestId:(0,v.uuid)()};if(b(this,d,"f").value!==v.ChannelState.JOINED)if(b(this,d,"f").publish(v.ChannelState.JOINING),b(this,c,"f").value)b(this,o,"f").call(this,e);else{let t=b(this,c,"f").subscribe(n=>{n&&(t(),b(this,d,"f").value===v.ChannelState.JOINING&&b(this,o,"f").call(this,e))})}}leave(){let e={action:v.ClientActions.LEAVE_CHANNEL,event:v.ClientActions.LEAVE_CHANNEL,channelName:b(this,n,"f"),requestId:(0,v.uuid)(),payload:{}};b(this,t,"m",p).call(this,e),b(this,d,"f").publish(v.ChannelState.CLOSED),b(this,s,"f").call(this)}onChannelStateChange(e){return b(this,d,"f").subscribe(t=>{e(t)})}onJoin(e){return b(this,t,"m",m).call(this,(t,n)=>{if(t===v.PresenceEventTypes.JOIN)return e(n.changed)})}onLeave(e){return b(this,t,"m",m).call(this,(t,n)=>{if(t===v.PresenceEventTypes.LEAVE)return e(n.changed)})}onMessage(e){return b(this,t,"m",f).call(this,(t,n)=>{e(t,n)})}onMessageEvent(e,t){return this.onMessage((n,i)=>{if(n===e)return t(i)})}onPresenceChange(e){return b(this,t,"m",m).call(this,(t,n)=>{if(t===v.PresenceEventTypes.UPDATE)return e(n)})}onUsersChange(e){return b(this,t,"m",m).call(this,(t,n)=>e(n.presence))}sendMessage(e,i){let r=(0,v.uuid)(),s={action:v.ClientActions.BROADCAST,channelName:b(this,n,"f"),requestId:r,event:e,payload:i};b(this,t,"m",p).call(this,s)}sendForResponse(e,i){let r=(0,v.uuid)();return new Promise(s=>{let o=b(this,t,"m",f).call(this,(e,t,n)=>{r===n&&(s(t),o())}),a={action:v.ClientActions.BROADCAST,channelName:b(this,n,"f"),requestId:r,event:e,payload:i};b(this,t,"m",p).call(this,a)})}},n=new WeakMap,i=new WeakMap,r=new WeakMap,s=new WeakMap,o=new WeakMap,a=new WeakMap,l=new WeakMap,c=new WeakMap,d=new WeakMap,t=new WeakSet,u=function(){b(this,i,"f").forEach(e=>b(this,o,"f").call(this,e)),g(this,i,[],"f")},h=function(e){b(this,s,"f").call(this);let i=e.subscribe(e=>{e.channelName===b(this,n,"f")&&this.channelState===v.ChannelState.JOINED&&b(this,l,"f").publish(e)}),u=b(this,c,"f").subscribe(e=>{if(e&&b(this,d,"f").value===v.ChannelState.STALLED){let e={action:v.ClientActions.JOIN_CHANNEL,event:v.ClientActions.JOIN_CHANNEL,payload:b(this,a,"f"),channelName:b(this,n,"f"),requestId:(0,v.uuid)()};b(this,o,"f").call(this,e)}else!e&&b(this,d,"f").value===v.ChannelState.JOINED&&b(this,d,"f").publish(v.ChannelState.STALLED)}),h=b(this,t,"m",m).call(this,(e,t)=>{g(this,r,t.presence,"f")});g(this,s,()=>{i(),u(),h()},"f")},f=function(e){return b(this,l,"f").subscribe(t=>{if(t.action!==v.ServerActions.PRESENCE)return e(t.event,t.payload,t.requestId)})},p=function(e){if(b(this,d,"f").value===v.ChannelState.JOINED)return b(this,o,"f").call(this,e);b(this,i,"f").push(e)},m=function(e){return b(this,l,"f").subscribe(t=>{if(t.action===v.ServerActions.PRESENCE)return e(t.event,t.payload)})}}),v=o(e=>{var t,n,i,r,s,o=e&&e.__classPrivateFieldSet||function(e,t,n,i,r){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?r.call(e,n):r?r.value=n:t.set(e,n),n},a=e&&e.__classPrivateFieldGet||function(e,t,n,i){if("a"===n&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?i:"a"===n?i.call(e):i?i.value:t.get(e)};Object.defineProperty(e,"__esModule",{value:!0}),e.PondClient=void 0;var l=y(),c=b();e.PondClient=class{constructor(e,i={}){let r;t.add(this),n.set(this,void 0);try{r=new URL(e)}catch{r=new URL(window.location.toString()),r.pathname=e}this._disconnecting=!1;let c=new URLSearchParams(i);r.search=c.toString();let d="https:"===r.protocol?"wss:":"ws:";"wss:"!==r.protocol&&"ws:"!==r.protocol&&(r.protocol=d),this._address=r,o(this,n,new Map,"f"),this._broadcaster=new l.Subject,this._connectionState=new l.BehaviorSubject(!1),a(this,t,"m",s).call(this)}connect(){this._disconnecting=!1;let e=new WebSocket(this._address.toString());e.onmessage=e=>{let t=e.data.trim().split("\n");for(let e of t)if(e.trim()){let t=JSON.parse(e),n=l.channelEventSchema.parse(t);this._broadcaster.publish(n)}},e.onerror=()=>e.close(),e.onclose=()=>{this._connectionState.publish(!1),!this._disconnecting&&setTimeout(()=>{this.connect()},1e3)},this._socket=e}getState(){return this._connectionState.value}disconnect(){var e;this._connectionState.publish(!1),this._disconnecting=!0,null===(e=this._socket)||void 0===e||e.close(),a(this,n,"f").clear()}createChannel(e,r){let s=a(this,n,"f").get(e);if(s&&s.channelState!==l.ChannelState.CLOSED)return s;let o=a(this,t,"m",i).call(this),d=new c.Channel(o,this._connectionState,e,r||{});return a(this,n,"f").set(e,d),d}onConnectionChange(e){return this._connectionState.subscribe(e)}},n=new WeakMap,t=new WeakSet,i=function(){return e=>{this._connectionState.value&&this._socket.send(JSON.stringify(e))}},r=function(e){var r;let s=null!==(r=a(this,n,"f").get(e.channelName))&&void 0!==r?r:new c.Channel(a(this,t,"m",i).call(this),this._connectionState,e.channelName,{});a(this,n,"f").set(e.channelName,s),s.acknowledge(this._broadcaster)},s=function(){this._broadcaster.subscribe(e=>{e.event===l.Events.ACKNOWLEDGE?a(this,t,"m",r).call(this,e):e.event===l.Events.CONNECTION&&e.action===l.ServerActions.CONNECT&&this._connectionState.publish(!0)})}}),E=o((e,t)=>{var n=function(){if("object"==typeof self&&self)return self;if("object"==typeof window&&window)return window;throw Error("Unable to resolve global `this`")};t.exports=function(){if(this)return this;if("object"==typeof globalThis&&globalThis)return globalThis;try{Object.defineProperty(Object.prototype,"__global__",{get:function(){return this},configurable:!0})}catch{return n()}try{return __global__||n()}finally{delete Object.prototype.__global__}}()}),w=o((e,t)=>{t.exports={name:"websocket",description:"Websocket Client & Server Library implementing the WebSocket protocol as specified in RFC 6455.",keywords:["websocket","websockets","socket","networking","comet","push","RFC-6455","realtime","server","client"],author:"Brian McKelvey <theturtle32@gmail.com> (https://github.com/theturtle32)",contributors:["IÃ±aki Baz Castillo <ibc@aliax.net> (http://dev.sipdoc.net)"],version:"1.0.35",repository:{type:"git",url:"https://github.com/theturtle32/WebSocket-Node.git"},homepage:"https://github.com/theturtle32/WebSocket-Node",engines:{node:">=4.0.0"},dependencies:{bufferutil:"^4.0.1",debug:"^2.2.0","es5-ext":"^0.10.63","typedarray-to-buffer":"^3.1.5","utf-8-validate":"^5.0.2",yaeti:"^0.0.6"},devDependencies:{"buffer-equal":"^1.0.0",gulp:"^4.0.2","gulp-jshint":"^2.0.4","jshint-stylish":"^2.2.1",jshint:"^2.0.0",tape:"^4.9.1"},config:{verbose:!1},scripts:{test:"tape test/unit/*.js",gulp:"gulp"},main:"index",directories:{lib:"./lib"},browser:"lib/browser.js",license:"Apache-2.0"}}),A=o((e,t)=>{t.exports=w().version}),C=o((e,t)=>{var n;if("object"==typeof globalThis)n=globalThis;else try{n=E()}catch{}finally{if(!n&&typeof window<"u"&&(n=window),!n)throw Error("Could not determine global this")}var i=n.WebSocket||n.MozWebSocket,r=A();function s(e,t){return t?new i(e,t):new i(e)}i&&["CONNECTING","OPEN","CLOSING","CLOSED"].forEach(function(e){Object.defineProperty(s,e,{get:function(){return i[e]}})}),t.exports={w3cwebsocket:i?s:null,version:r}}),S=o(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.PondClient=void 0;var t=y(),n=v(),i=C().w3cwebsocket,r=class extends n.PondClient{connect(e=1){this._disconnecting=!1;let n=new i(this._address.toString());n.onopen=()=>this._connectionState.publish(!0),n.onmessage=e=>{let n=e.data.trim().split("\n");for(let e of n)if(e.trim()){let n=JSON.parse(e),i=t.channelEventSchema.parse(n);this._broadcaster.publish(i)}},n.onerror=()=>n.close(),n.onclose=()=>{this._connectionState.publish(!1),!this._disconnecting&&setTimeout(()=>{this.connect()},1e3)}}};e.PondClient=r}),x=o(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.PondClient=e.ChannelState=void 0;var t=y();Object.defineProperty(e,"ChannelState",{enumerable:!0,get:function(){return t.ChannelState}});var n=v(),i=S(),r=typeof window>"u"?i.PondClient:n.PondClient;e.PondClient=r}),k={};a(k,{ComputedSignal:()=>Pt,Signal:()=>Dt,applyOps:()=>Et,bootClient:()=>Ut,clearPatcherCaches:()=>Ct,configurePatcher:()=>wt,default:()=>Bt,dom:()=>T,getPatcherConfig:()=>At,getPatcherStats:()=>St,getRefElement:()=>H,getRefMeta:()=>W,morphElement:()=>yt});var O,I,N=(I=null!=(O=x())?e(r(O)):{},l(t(I,"default",{value:O,enumerable:!0}),O)),T={};a(T,{deleteRow:()=>Ve,ensureList:()=>ze,getRow:()=>$e,getSlot:()=>qe,initLists:()=>Ue,registerList:()=>He,registerSlot:()=>Le,reset:()=>Fe,setRow:()=>We,unregisterList:()=>Be,unregisterSlot:()=>je});var M=new Map;function _(e){if(typeof document>"u"||!e)return null;let t=`[data-live-ref="${function(e){return"string"!=typeof e?"":typeof CSS<"u"&&"function"==typeof CSS.escape?CSS.escape(e):e.replace(/["]|\\/g,"\\$&")}(e)}"]`;try{return document.querySelector(t)}catch{return document.querySelector(`[data-live-ref="${e}"]`)}}function R(e,t){let n=M.get(e);return n?t&&(n.meta=t,n.element||(n.element=_(e))):(n={id:e,meta:t??{tag:""},element:_(e)},M.set(e,n)),n}function D(e,t){if(!e||!t)return null;let n=function(e){let t=e;for(;t;){if("function"==typeof t.getAttribute&&t.getAttribute("data-live-ref"))return t;t=t.parentElement}return null}(e);if(!n)return null;let i=n.getAttribute("data-live-ref");if(!i)return null;let r=R(i);if(r.element=n,!function(e,t){if(!e||!e.events)return!1;for(let[n,i]of Object.entries(e.events))if(n===t||i?.listen&&i.listen.includes(t))return!0;return!1}(r.meta,t))return null;let s=function(e,t){if(!e||!e.events)return[];let n=[],i=new Set;for(let[r,s]of Object.entries(e.events)){if(!s)continue;let e=Array.isArray(s.listen)?s.listen:[];if((r===t||e.includes(t))&&Array.isArray(s.props))for(let e of s.props)"string"!=typeof e||0===e.length||i.has(e)||(i.add(e),n.push(e))}return n}(r.meta,t);return{id:i,element:n,props:s,notify(e){r.lastPayloads||(r.lastPayloads=Object.create(null)),r.lastPayloads[t]={...e}}}}function P(e,t){if(!e)return;let n=R(e);n.element=t,n.meta.tag||(n.meta={...n.meta,tag:t.tagName.toLowerCase()})}function L(e,t){let n=M.get(e);n&&(!t||n.element===t)&&(n.element=null)}function q(e,t){e instanceof Element&&t(e);let n=e.querySelectorAll?.bind(e);"function"==typeof n&&n("[data-live-ref]").forEach(e=>{e instanceof Element&&t(e)})}function j(){M.clear()}function B(e){if(e)for(let[t,n]of Object.entries(e))t&&R(t,n)}function F(e){if(Array.isArray(e))for(let t of e)t&&M.delete(t)}function U(e){!e||typeof document>"u"||q(e,e=>{let t=e.getAttribute("data-live-ref");t&&P(t,e)})}function z(e){!e||typeof document>"u"||q(e,e=>{let t=e.getAttribute("data-live-ref");t&&L(t,e)})}function H(e){return M.get(e)?.element??null}function W(e){return M.get(e)?.meta??null}function $(e,t){if("string"!=typeof e)return;let n=e.trim();if(!n)return;let i=n.split(".");if(0===i.length)return;let r=i.shift();if(!r)return;let s=function(e,t){switch(e){case"event":return t.event??void 0;case"target":return t.target??void 0;case"currentTarget":return t.handlerElement?t.handlerElement:t.event&&"currentTarget"in t.event?t.event.currentTarget??void 0:void 0;case"element":case"ref":return t.refElement??t.handlerElement??t.target??void 0;default:return}}(r,t);return void 0!==s?function(e,t){let n=e;for(let e of t)if(e){if(null==n)return;try{n=n[e]}catch{return}}return n}(s,i):void 0}function V(e,t){if(!Array.isArray(e)||0===e.length)return null;let n={};for(let i of e){if("string"!=typeof i||0===i.length)continue;let e=$(i,t);if(void 0===e)continue;let r=J(e);void 0!==r&&(n[i]=r)}return Object.keys(n).length>0?n:null}function J(e){if(null===e)return null;let t=typeof e;if("string"===t||"number"===t||"boolean"===t)return e;if(e instanceof Date)return e.toISOString();if(typeof FileList<"u"&&e instanceof FileList)return function(e){let t=[];for(let n=0;n<e.length;n++){let i=e.item(n);i&&t.push({name:i.name,size:i.size,type:i.type})}return t}(e);if(typeof File<"u"&&e instanceof File)return{name:e.name,size:e.size,type:e.type};if(typeof DOMTokenList<"u"&&e instanceof DOMTokenList)return Array.from(e);if(typeof TimeRanges<"u"&&e instanceof TimeRanges){let t=[];for(let n=0;n<e.length;n++)try{t.push({start:e.start(n),end:e.end(n)})}catch{}return t}if(Array.isArray(e))return e.map(e=>J(e)).filter(e=>void 0!==e);if(e&&"object"==typeof e)try{return JSON.parse(JSON.stringify(e))}catch{return}}function K(e,t,n){let i=e?H(e):null;if(!i)return{ok:!1,reason:"missing_element"};let r="string"==typeof t?t.trim():"";if(!r)return{ok:!1,reason:"missing_property"};try{return i[r]=n,{ok:!0}}catch(e){return{ok:!1,reason:"set_failed",error:e}}}var G=new Map,Q=new Map,X=new Map,Z=new WeakMap,Y=new Map,ee=new Map,te=new WeakMap,ne="data-on",ie="data-router-",re=["click","input","change","submit"],se=new Set(["blur","focus","mouseenter","mouseleave","pointerenter","pointerleave"]);function oe(e,t,n){if(e&&"string"==typeof t&&0!==t.length)switch(t){case"path":case"query":case"hash":case"replace":!function(e,t,n){let i=te.get(e);if(null==n||""===n){if(!i)return;return delete i[t],void(!i.path&&!i.query&&!i.hash&&!i.replace&&te.delete(e))}i||(i={},te.set(e,i)),i[t]=n}(e,t,n)}}function ae(e){return Array.isArray(e)?e.map(e=>{let t={event:e?.event||"",handler:e?.handler||""};return Array.isArray(e?.listen)&&e.listen.length>0&&(t.listen=[...e.listen]),Array.isArray(e?.props)&&e.props.length>0&&(t.props=[...e.props]),t}):[]}function le(e){let t=ee.get(e);if(!t)return;let n=Y.get(e)??[];if(!Array.isArray(n)||0===n.length)return void Z.delete(t);let i=new Map;for(let e of n){if(!e||"string"!=typeof e.event||"string"!=typeof e.handler)continue;let t=e.event.trim(),n=e.handler.trim();0===t.length||0===n.length||i.set(t,n)}0!==i.size?Z.set(t,i):Z.delete(t)}function ce(e){if(Y.clear(),e&&"object"==typeof e)for(let[t,n]of Object.entries(e)){let e=+t;Number.isNaN(e)||Y.set(e,ae(n))}ee.forEach((e,t)=>{le(t)})}function de(e,t){Number.isFinite(e)&&(Array.isArray(t)?Y.set(e,ae(t)):Y.set(e,[]),le(e))}function ue(e){let t=ee.get(e);t&&(Z.delete(t),function(e){e&&te.delete(e)}(t)),ee.delete(e)}function he(e){if(!e.hasAttribute("href")&&!e.hasAttribute("xlink:href"))return!1;let t=e instanceof HTMLAnchorElement,n="http://www.w3.org/2000/svg"===e.namespaceURI&&"a"===e.tagName.toLowerCase();return t||n}function fe(e){if(e)for(let[t,n]of Object.entries(e)){let e=G.get(t);if(e)for(let t of Me(e))Te(t);G.set(t,n);for(let e of Me(n))Ne(e)}}function pe(){G.clear(),Q.clear(),xe()}function me(e){if(!e||!e.startsWith(ne))return null;let t=e.slice(ne.length);if(0===t.length)return null;let n=t.startsWith("-")?t.slice(1):t;if(0===n.length)return null;let i=n.indexOf("-"),r=-1===i?n:n.slice(0,i);return r.length>0?r:null}function ge(e){if(!e)return[];if("function"==typeof e.getAttributeNames)return e.getAttributeNames();let t=[];if(e.attributes)for(let n=0;n<e.attributes.length;n++){let i=e.attributes.item(n);i&&t.push(i.name)}return t}function ye(e){if(!e)return;let t=ge(e);if(0===t.length)return Z.has(e)&&Z.delete(e),void(te.has(e)&&te.delete(e));let n=null,i=!1;for(let r of t){if(!r.startsWith(ne)){if(r.startsWith(ie)){let t=r.slice(ie.length),n=e.getAttribute(r);e.removeAttribute(r),oe(e,t,n??"")}continue}let t=r.slice(ne.length),s=e.getAttribute(r);if(e.removeAttribute(r),t.includes("-"))continue;i=!0;let o=me(r);!o||!s||(n||(n=new Map),n.set(o,s))}n&&n.size>0?Z.set(e,n):(i||Z.has(e))&&Z.delete(e)}function be(e){if(!e)return;let t=e instanceof Document?e:e.ownerDocument??(typeof document<"u"?document:null);if(!t)return;let n=e instanceof Document?t.documentElement??null:e;if(!n)return;let i=t.createTreeWalker(n,NodeFilter.SHOW_ELEMENT);n instanceof Element&&ye(n);let r=i.nextNode();for(;r;)r instanceof Element&&ye(r),r=i.nextNode()}var ve=null,Ee=null,we=null;function Ae(e){we=e}function Ce(e){return se.has(e)}function Se(e){if(X.has(e))return;let t=Ce(e),n=t=>{ve&&function(e,t,n){let i=e.target;if(!(i&&i instanceof Element))return;if(we)try{we(e,t)}catch{}let r=function(e,t){let n=e;for(;n&&n!==document.documentElement;){let e=Z.get(n);if(e||ge(n).some(e=>e.startsWith(ne))&&(ye(n),e=Z.get(n)),e&&e.size>0){let i=e.get(t);if(i){let e=G.get(i);if(!e||_e(e,t))return{id:i,element:n}}for(let[i,r]of e.entries()){if(i===t)continue;let e=G.get(r);if(e&&_e(e,t))return{id:r,element:n}}}n=n.parentElement}return null}(i,t);if(r){let s=G.get(r.id);if(s&&_e(s,t)){let o=D(r.element,t),a=function(e,t){let n=[],i=new Set,r=e=>{if(Array.isArray(e))for(let t of e)"string"!=typeof t||0===t.length||i.has(t)||(i.add(t),n.push(t))};return r(e),r(t),n.length>0?n:void 0}(s.props,o?.props),l=ke(e,i,a,r.element,o?.element??null),c=te.get(r.element);if(c&&(void 0!==c.path&&void 0===l["currentTarget.dataset.routerPath"]&&(l["currentTarget.dataset.routerPath"]=c.path),void 0!==c.query&&void 0===l["currentTarget.dataset.routerQuery"]&&(l["currentTarget.dataset.routerQuery"]=c.query),void 0!==c.hash&&void 0===l["currentTarget.dataset.routerHash"]&&(l["currentTarget.dataset.routerHash"]=c.hash),void 0!==c.replace&&void 0===l["currentTarget.dataset.routerReplace"]&&(l["currentTarget.dataset.routerReplace"]=c.replace)),o&&o.notify(l),"submit"===t&&e.preventDefault(),"click"===t){let t=Oe(i);t&&Ie(e,t)&&e.preventDefault()}return void n({hid:r.id,payload:l})}}let s=D(i,t);if(s){let t=ke(e,i,s.props,s.element,s.element);return s.notify(t),void n({hid:s.id,payload:t})}if("click"===t&&Ee&&e instanceof MouseEvent){let t=Oe(i);if(t&&Ie(e,t)){let n=t.getAttribute("href")??t.getAttribute("xlink:href");if(n)try{let t=new URL(n,window.location.href),i=t.pathname,r=t.search.substring(1),s=t.hash.startsWith("#")?t.hash.substring(1):t.hash;if(Ee(i,r,s))return e.preventDefault(),void e.stopPropagation()}catch{}}}}(t,e,ve)};document.addEventListener(e,n,t),X.set(e,n)}function xe(){Q.forEach((e,t)=>{Se(t)}),X.forEach((e,t)=>{!Q.has(t)&&!re.includes(t)&&function(e){let t=X.get(e);if(!t)return;let n=Ce(e);document.removeEventListener(e,t,n),X.delete(e)}(t)})}function ke(e,t,n,i,r){let s={type:e.type};if((t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement)&&(s.value=t.value,t instanceof HTMLInputElement&&("checkbox"===t.type||"radio"===t.type)&&(s.checked=t.checked)),e instanceof KeyboardEvent&&(s.key=e.key,s.keyCode=e.keyCode,s.altKey=e.altKey,s.ctrlKey=e.ctrlKey,s.metaKey=e.metaKey,s.shiftKey=e.shiftKey),e instanceof MouseEvent&&(s.clientX=e.clientX,s.clientY=e.clientY),Array.isArray(n)){let o=V(n,{event:e,target:t,handlerElement:i??null,refElement:r??null});if(o)for(let[e,t]of Object.entries(o))s[e]=t}return s}function Oe(e){let t=e;for(;t&&t!==document.documentElement;){if(he(t))return t;t=t.parentElement}return null}function Ie(e,t){if(0!==e.button||e.ctrlKey||e.metaKey||e.altKey||e.shiftKey||!he(t))return!1;let n=t.getAttribute("href")??t.getAttribute("xlink:href")??void 0;if(!n)return!1;let i=t.getAttribute("target");if(i&&"_self"!==i)return!1;try{let e=new URL(n,window.location.href);return!(e.origin!==window.location.origin||e.pathname===window.location.pathname&&e.search===window.location.search&&e.hash)}catch{return!1}}function Ne(e){let t=Q.get(e)??0;Q.set(e,t+1)}function Te(e){let t=Q.get(e);t&&(t<=1?Q.delete(e):Q.set(e,t-1))}function Me(e){if(!e)return[];let t=new Set,n=[];if(e.event&&(t.add(e.event),n.push(e.event)),Array.isArray(e.listen))for(let i of e.listen)"string"!=typeof i||0===i.length||t.has(i)||(t.add(i),n.push(i));return n}function _e(e,t){return!!e&&(e.event===t||!!Array.isArray(e.listen)&&e.listen.includes(t))}var Re=new Map,De=new Map;function Pe(e){let t=new Map;return e&&e.querySelectorAll("[data-row-key]").forEach(e=>{let n=e.getAttribute("data-row-key");n&&t.set(n,e)}),t}function Le(e,t){t&&(Re.set(e,t),function(e,t){if(Number.isFinite(e)&&t){if(t instanceof Element)return ee.set(e,t),void le(e);ee.delete(e)}}(e,t))}function qe(e){return Re.get(e)??null}function je(e){ue(e),Re.delete(e)}function Be(e){De.delete(e)}function Fe(){Re.forEach((e,t)=>{ue(t)}),Re.clear(),De.clear()}function Ue(e,t){if(!Array.isArray(e))return;let n=e=>{if(t instanceof Map){let n=t.get(e);return n instanceof Element?n:null}if(t&&"object"==typeof t){let n=t[e+""];return n instanceof Element?n:null}return null};for(let t of e){if(De.has(t)&&De.get(t)?.container instanceof Element)continue;let e=n(t);e&&He(t,e)}}function ze(e){let t=De.get(e);if(!t||!t.container)throw Error(`liveui: list slot ${e} not registered`);return t}function He(e,t,n){t&&De.set(e,{container:t,rows:n??Pe(t)})}function We(e,t,n){ze(e).rows.set(t,n)}function $e(e,t){return ze(e).rows.get(t)??null}function Ve(e,t){ze(e).rows.delete(t)}var Je=new Map;function Ke(){Je.clear()}function Ge(e,t){if(!e||!t||!t.container)return null;let{container:n}=t,{startIndex:i,endIndex:r}=t;if(!Number.isFinite(i)||!Number.isFinite(r))return null;let s=Math.max(0,Math.trunc(i)),o=Math.trunc(r);if(!Number.isFinite(o))return null;o<s&&(o=s-1);let a={container:n,startIndex:s,endIndex:o};return Je.set(e,a),a}function Qe(e){return e?Je.get(e)??null:null}function Xe(...e){}function Ze(...e){}function Ye(e){return Array.isArray(e)?e.filter(e=>Number.isInteger(e)):[]}function et(e,t){let n=e.childNodes.length-1;return n<0||t<0?0:t>n?n:t}function tt(e,t){if(!t||t.endIndex<t.startIndex)return null;let n=nt(t,Ye(e.parentPath));if(!n)return null;let i=n.parentNode??t.container,r=function(e,t){if(!e||!t)return-1;let n=e.childNodes;for(let e=0;e<n.length;e++)if(n.item(e)===t)return e;return-1}(i,n);return r<0?null:{container:i,startIndex:r,endIndex:r}}function nt(e,t){if(!e||e.endIndex<e.startIndex)return null;let n=Ye(t),i=et(e.container,e.startIndex),r=e.container.childNodes.item(i)??null;if(!r)return null;if(0===n.length)return r;for(let e of n){if(!(r instanceof Element||r instanceof DocumentFragment))return null;let t=et(r,e);if(r=r.childNodes.item(t)??null,!r)return null}return r}function it(e,t){let n=new Map;if(!Array.isArray(e))return n;for(let i of e){if(!i)continue;let e=+i.slot;if(!Number.isInteger(e)||e<0||n.has(e))continue;let r=t?.get(i.componentId)??Qe(i.componentId);if(!r){Ze(i.componentId,Array.from(t?.keys()??[]));continue}let s=nt(r,i.elementPath);if(!s){Ze();continue}let o=s,a=+i.textChildIndex;if(Number.isInteger(a)&&a>=0)if(s instanceof Text)o=s;else if(s instanceof Element||s instanceof DocumentFragment){let e=s.childNodes.item(a)??null;if(!e&&typeof document<"u"){e=document.createTextNode("");let t=a<s.childNodes.length?s.childNodes.item(a):null;s.insertBefore(e,t)}o=e}else o=null;o?(Xe(i.componentId),n.set(e,o)):Ze(s instanceof Element&&s.tagName)}return n}function rt(e,t){let n=new Map;if(!Array.isArray(e))return n;for(let i of e){if(!i)continue;let e=+i.slot;if(!Number.isInteger(e)||e<0||n.has(e))continue;let r=t?.get(i.componentId)??Qe(i.componentId);if(!r){Ze(i.componentId,Array.from(t?.keys()??[]));continue}let s=nt(r,i.elementPath);s instanceof Element?(Xe(i.componentId),n.set(e,s)):Ze()}return n}function st(e,t){let n=function(e,t){let n=new Map;if(!Array.isArray(e)||0===e.length)return n;let i=function(e){if(e&&e instanceof Document)return e.body??e;if(e&&"childNodes"in e)return e;if(typeof document<"u")return document.body??document;throw Error("liveui: unable to resolve root container for manifest resolution")}(t?.root??null),r=t?.baseRange??function(e){let t=e.childNodes.length;return{container:e,startIndex:0,endIndex:t>0?t-1:-1}}(i),s=t?.baseId??"";t?.baseRange&&s&&n.set(s,t.baseRange);let o=new Map;for(let t of e)!t||"string"!=typeof t.componentId||o.set(t.componentId,t);let a=!0;for(;o.size>0&&a;){a=!1;for(let[e,t]of Array.from(o.entries())){let i=t.parentId??"",l=null;if(i?l=n.get(i)??Qe(i):(l=s?n.get(s)??null:null,l||(l=r)),!l)continue;let c=tt(t,l);c?(n.set(e,c),o.delete(e),a=!0):o.delete(e)}}return n}(e,t);return function(e){if(e){if(e instanceof Map){for(let[t,n]of Array.from(e.entries())){let i=Ge(t,n);i?e.set(t,i):e.delete(t)}return}for(let[t,n]of Object.entries(e)){let i=Ge(t,n);i?e[t]=i:delete e[t]}}}(n),n}var ot={enableDirtyChecking:!0,enableBatching:!0,enableFragmentPooling:!0,enableMemoization:!0,enableVirtualScrolling:!0,virtualScrollThreshold:100,memoizationCacheSize:1e3},at="data-on",lt=document.createElement("template"),ct=new Map;function dt(e){if(ot.enableFragmentPooling&&ct.has(e))return ct.get(e).cloneNode(!0);lt.innerHTML=e;let t=lt.content.cloneNode(!0);return ot.enableFragmentPooling&&ct.size<50&&ct.set(e,t.cloneNode(!0)),t}var ut=new class{constructor(e){this.cache=new Map,this.maxSize=e}key(e,t,n){return`${e}:${t}:${JSON.stringify(n)}`}has(e){return this.cache.has(e)}get(e){return this.cache.get(e)}set(e,t){if(this.cache.size>=this.maxSize){let e=this.cache.keys().next().value;void 0!==e&&this.cache.delete(e)}this.cache.set(e,t)}clear(){this.cache.clear()}}(ot.memoizationCacheSize),ht=new class{constructor(){this.batch={reads:[],writes:[]},this.scheduled=!1}scheduleRead(e){this.batch.reads.push(e),this.schedule()}scheduleWrite(e){this.batch.writes.push(e),this.schedule()}schedule(){this.scheduled||(this.scheduled=!0,requestAnimationFrame(()=>{this.flush()}))}flush(){this.batch.reads.forEach(e=>e()),this.batch.writes.forEach(e=>e()),this.batch={reads:[],writes:[]},this.scheduled=!1}immediate(){this.scheduled&&this.flush()}},ft=new Map;function pt(e,t){return ot.enableVirtualScrolling&&t>ot.virtualScrollThreshold}function mt(e,t){let n=function(e,t){if(!e)throw Error(`liveui: slot ${t} not registered`);return e}(qe(e),e);ot.enableDirtyChecking&&n.textContent===t||(ot.enableBatching?ht.scheduleWrite(()=>{n.textContent=t}):n.textContent=t)}function gt(e,t,n){let i=qe(e);if(!(i instanceof Element))throw Error(`liveui: slot ${e} is not an element`);let r=function(e){let t=Y.get(e);if(t)return ae(t)}(e)??[],s=new Map;for(let e of r)!e||"string"!=typeof e.event||s.set(e.event,{handler:e.handler,listen:e.listen?[...e.listen]:void 0,props:e.props?[...e.props]:void 0});let o=e=>{if("string"!=typeof e)return;let t=e.split(/\s+/).map(e=>e.trim()).filter(e=>e.length>0);return t.length>0?t:void 0},a=!1;if(t)for(let e of Object.keys(t)){if("string"==typeof e&&e.startsWith(ie)){let n=e.slice(ie.length);oe(i,n,t[e]),delete t[e];continue}if("string"!=typeof e||!e.startsWith(at))continue;a=!0;let n=t[e];delete t[e];let r=e.slice(at.length);if(r.startsWith("-")&&(r=r.slice(1)),0===r.length)continue;let l="",c=r.indexOf("-");-1!==c&&(l=r.slice(c+1),r=r.slice(0,c));let d=r.trim();if(0===d.length)continue;let u=s.get(d)??{};"listen"===l?u.listen=o(n):"props"===l?u.props=o(n):u.handler="string"==typeof n?n:null!=n?n+"":"",s.set(d,u)}if(Array.isArray(n)&&n.length>0)for(let e=n.length-1;e>=0;e--){let t=n[e];if("string"==typeof t&&t.startsWith(ie)){let r=t.slice(ie.length);oe(i,r,void 0),n.splice(e,1);continue}if("string"!=typeof t||!t.startsWith(at))continue;a=!0,n.splice(e,1);let r=t.slice(at.length);if(r.startsWith("-")&&(r=r.slice(1)),0===r.length)continue;let o=r.indexOf("-");-1!==o&&(r=r.slice(0,o));let l=r.trim();0!==l.length&&s.delete(l)}if(a){let t=[];s.forEach((e,n)=>{let i=e.handler?.trim();if(!i)return;let r={event:n,handler:i};e.listen&&e.listen.length>0&&(r.listen=[...e.listen]),e.props&&e.props.length>0&&(r.props=[...e.props]),t.push(r)}),de(e,t)}let l=i.getAttribute("data-live-ref"),c=()=>{if(t)for(let[e,n]of Object.entries(t))null!=n&&(ot.enableDirtyChecking&&i.getAttribute(e)===n+""||i.setAttribute(e,n+""));if(n)for(let e of n)i.hasAttribute(e)&&i.removeAttribute(e);let e=i.getAttribute("data-live-ref");(function(e,t,n){t&&(!n||t!==n)&&L(t,e),n?P(n,e):t&&!n&&L(t,e)})(i,l,e),ye(i)};ot.enableBatching?ht.scheduleWrite(c):c()}function yt(e,t){let n=e.attributes,i=t.attributes;for(let i=n.length-1;i>=0;i--){let r=n[i];t.hasAttribute(r.name)||e.removeAttribute(r.name)}for(let t=0;t<i.length;t++){let n=i[t];e.getAttribute(n.name)!==n.value&&e.setAttribute(n.name,n.value)}1===e.childNodes.length&&e.firstChild?.nodeType===Node.TEXT_NODE&&1===t.childNodes.length&&t.firstChild?.nodeType===Node.TEXT_NODE&&e.firstChild.textContent!==t.firstChild.textContent&&(e.firstChild.textContent=t.firstChild.textContent)}function bt(e,t,n){if(!e)return;let i=Array.isArray(e.slots)?e.slots.filter(e=>Number.isInteger(e)&&e>=0):[],r=new Set(i),s=it(e.slotPaths,n);if(s.size>0)if(r.size>0)for(let e of Array.from(r)){let t=s.get(e);t&&(Le(e,t),r.delete(e))}else for(let[e,t]of s.entries())Le(e,t);let o=rt(e.listPaths,n);for(let[e,t]of o.entries())He(e,t);r.size>0&&i.length>0&&r.forEach(e=>{})}function vt(e,t){if(!Array.isArray(t)||0===t.length)return;let n=ze(e),i=n.container,r=ot.enableBatching?Array.from(i.children):null,s=n.rows.size;for(let n of t)if(n&&n.length)switch(n[0]){case"del":{let t=n[1],r=$e(e,t);if(r&&r.parentNode===i){let e=()=>{z(r),i.removeChild(r)};ot.enableBatching?ht.scheduleWrite(e):e()}Ve(e,t),s--;break}case"ins":{let t=n[1],o=n[2]||{key:"",html:""};if(o&&"object"==typeof o&&o.bindings)for(let[e,t]of Object.entries(o.bindings)){let n=+e;Number.isNaN(n)||de(n,t??[])}let a,l=ut.key("ins",e,o.html);ot.enableMemoization&&ut.has(l)?a=ut.get(l).cloneNode(!0):(a=dt(o.html||""),ot.enableMemoization&&ut.set(l,a.cloneNode(!0))),be(a);let c=Array.from(a.childNodes);if(0===c.length)break;let d=()=>{let n=ot.enableBatching?r[t]||null:i.children[t]||null;i.insertBefore(a,n);for(let e of c)e instanceof Element&&U(e);let l=c[0];if(l instanceof Element){We(e,o.key,l);let n=st(o.componentPaths);if(bt(o,0,n),pt(0,s)){let n=ft.get(e);n&&(t<n.visibleRange.start||t>n.visibleRange.end)&&(l instanceof HTMLElement||l instanceof SVGElement)&&(l.style.display="none")}}};ot.enableBatching?ht.scheduleWrite(d):d(),s++;break}case"mov":{let e=n[1],t=n[2];if(e===t)break;let s=()=>{let n=ot.enableBatching?r:Array.from(i.children),s=n[e];if(s){let e=t<n.length?n[t]:null;i.insertBefore(s,e)}};ot.enableBatching?ht.scheduleWrite(s):s();break}}if(pt(0,s)){let t=ft.get(e);t?t.totalItems=s:function(e,t){if(!ot.enableVirtualScrolling)return;let n={container:t,totalItems:0,visibleRange:{start:0,end:50},itemHeight:0};n.observer=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){let t=e.target;(t instanceof HTMLElement||t instanceof SVGElement)&&(t.style.display="")}})},{root:t,threshold:.1}),ft.set(e,n)}(e,i)}}function Et(e){if(Array.isArray(e)){for(let t of e)if(t&&0!==t.length)switch(t[0]){case"setText":mt(t[1],t[2]);break;case"setAttrs":gt(t[1],t[2]||{},t[3]||[]);break;case"list":vt(t[1],t.slice(2))}ot.enableBatching&&ht.immediate()}}function wt(e){Object.assign(ot,e)}function At(){return{...ot}}function Ct(){ct.clear(),ut.clear(),ft.clear()}function St(){return{htmlCacheSize:ct.size,memoizerCacheSize:ut.cache.size,virtualScrollCount:ft.size}}var xt=new WeakMap,kt=new Map,Ot=new Map;function It(e){if("string"!=typeof e||0===e.length)return;let t=kt.get(e);t&&(xt.delete(t),kt.delete(e)),function(e){for(let[t,n]of Ot.entries())n.delete(e)&&0===n.size&&Ot.delete(t)}(e)}function Nt(e,t){if(!e||"string"!=typeof e.uploadId)return!1;let n=function(e,t,n){if("string"!=typeof e||0===e.length)return null;let i=n?.get(e)??Qe(e);return i?nt(i,t):null}(e.componentId,e.path,t);if(!(n instanceof HTMLInputElement))return!1;n.type&&"file"!==n.type.toLowerCase()&&(n.type="file"),It(e.uploadId),function(e,t){Array.isArray(t.accept)&&t.accept.length>0?e.setAttribute("accept",t.accept.join(",")):e.removeAttribute("accept"),t.multiple?e.setAttribute("multiple","multiple"):e.removeAttribute("multiple")}(n,e);let i={id:e.uploadId,multiple:!!e.multiple};return Array.isArray(e.accept)&&e.accept.length>0&&(i.accept=[...e.accept]),"number"==typeof e.maxSize&&!Number.isNaN(e.maxSize)&&(i.maxSize=e.maxSize),xt.set(n,i),kt.set(e.uploadId,n),!0}function Tt(e,t,n){if("string"!=typeof e||0===e.length)return;let i=Ot.get(e);if(i&&(i.forEach(e=>It(e)),Ot.delete(e)),!Array.isArray(t)||0===t.length)return;let r=new Set;for(let i of t)i&&"string"==typeof i.uploadId&&Nt({...i,componentId:e},n)&&r.add(i.uploadId);r.size>0&&Ot.set(e,r)}function Mt(e,t){if(!Array.isArray(e)||0===e.length)return;let n=new Map;for(let t of e){if(!t||"string"!=typeof t.componentId)continue;let e=n.get(t.componentId)??[];e.push(t),n.set(t.componentId,e)}for(let[e,i]of n.entries())Tt(e,i,t)}function _t(e,t){Ot.forEach(e=>{e.forEach(e=>It(e))}),Ot.clear(),kt.clear(),Array.isArray(e)&&0!==e.length&&Mt(e,t)}var Rt=class{constructor(e){this.uploads=new Map,this.options=e,Ae((e,t)=>this.handleDomEvent(e,t))}dispose(){Ae(null),this.abortAll()}onDisconnect(){this.abortAll()}handleControl(e){if(!e||"cancel"!==e.op)return;let t=this.uploads.get(e.id);t?.xhr&&t.xhr.abort()}handleDomEvent(e,t){if("change"!==t)return;let n=e.target;if(!n)return;let i=this.resolveInput(n);if(!i)return;let r=function(e){if(e)return xt.get(e)??void 0}(i)?.id;if(!r)return;let s=i.files;if(!s||0===s.length)return;let o=s[0],a=this.options.getSessionId();a&&this.options.isConnected()?(this.sendMessage({t:"upload",sid:a,id:r,op:"change",meta:this.buildMeta(o)}),this.startUpload(a,r,o,i)):a&&this.sendMessage({t:"upload",sid:a,id:r,op:"error",error:"not connected"})}startUpload(e,t,n,i){let r=this.uploads.get(t);r?.xhr&&r.xhr.abort();let s=this.options.getEndpoint();if(!s)return void this.sendMessage({t:"upload",sid:e,id:t,op:"error",error:"upload endpoint missing"});let o=this.buildUploadURL(s,e,t),a=new XMLHttpRequest;a.open("POST",o,!0),a.upload.onprogress=e=>{if(!e.lengthComputable)return;let n=this.options.getSessionId();n&&this.sendMessage({t:"upload",sid:n,id:t,op:"progress",loaded:e.loaded,total:e.total})};let l=()=>{this.uploads.get(t)?.xhr===a&&this.uploads.delete(t)};a.onload=()=>{if(l(),a.status>=200&&a.status<300)return;let e=this.options.getSessionId();e&&this.sendMessage({t:"upload",sid:e,id:t,op:"error",error:"HTTP "+a.status})},a.onerror=()=>{l();let e=this.options.getSessionId();e&&this.sendMessage({t:"upload",sid:e,id:t,op:"error",error:"network error"})},a.onabort=()=>{l();let e=this.options.getSessionId();e&&this.sendMessage({t:"upload",sid:e,id:t,op:"cancelled"})};let c=new FormData;c.append("file",n,n.name),a.send(c),this.uploads.set(t,{xhr:a,input:i}),i.value=""}buildUploadURL(e,t,n){return`${e.endsWith("/")?e:e+"/"}${encodeURIComponent(t)}/${encodeURIComponent(n)}`}buildMeta(e){return{name:e.name,size:e.size,type:e.type||void 0}}resolveInput(e){if(e instanceof HTMLInputElement)return e;if(e.closest){let t=e.closest('input[type="file"][data-pond-upload]');return t instanceof HTMLInputElement?t:null}return null}sendMessage(e){try{this.options.send(e)}catch{}}abortAll(){for(let[,e]of this.uploads)try{e.xhr.abort()}catch{}this.uploads.clear()}},Dt=class{constructor(e){this.subscribers=new Set,this.value=e}get(){return this.value}set(e){this.value!==e&&(this.value=e,this.notify())}update(e){this.set(e(this.value))}subscribe(e){return this.subscribers.add(e),e(this.value),()=>this.subscribers.delete(e)}notify(){this.subscribers.forEach(e=>e(this.value))}},Pt=class{constructor(e,t){this.subscribers=new Set,this.unsubscribers=[],this.value=e(),t.forEach(t=>{let n=t.subscribe(()=>{let t=e();this.value!==t&&(this.value=t,this.notify())});this.unsubscribers.push(n)})}get(){return this.value}subscribe(e){return this.subscribers.add(e),e(this.value),()=>this.subscribers.delete(e)}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.subscribers.clear()}notify(){this.subscribers.forEach(e=>e(this.value))}},Lt=class{constructor(){this.listeners=new Map}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.off(e,t)}off(e,t){let n=this.listeners.get(e);n&&(n.delete(t),0===n.size&&this.listeners.delete(e))}emit(e,t){let n=this.listeners.get(e);n&&n.forEach(e=>{try{e(t)}catch{}})}once(e,t){let n=i=>{t(i),this.off(e,n)};return this.on(e,n)}removeAllListeners(e){e?this.listeners.delete(e):this.listeners.clear()}listenerCount(e){return this.listeners.get(e)?.size??0}},qt=class{constructor(e){this.updates=new Map,this.nextId=0,this.debug=!1,this.onRollback=e?.onRollback,this.onError=e?.onError,this.debug=e?.debug||!1}apply(e){let t="opt_"+this.nextId++,n=function(e){let t=[];for(let n of e){let[e,i,...r]=n;if("setText"===e){let e=qe(i);if(e){let n=e.textContent||"";t.push(["setText",i,n])}}else if("setAttrs"===e){let e=qe(i);if(e&&e instanceof Element){let[n,s]=r,o={},a=[];for(let t of Object.keys(n)){let n=e.getAttribute(t);null!==n?o[t]=n:a.push(t)}for(let t of s){let n=e.getAttribute(t);null!==n&&(o[t]=n)}t.push(["setAttrs",i,o,a])}}else if("list"===e){let e=r,n=[];for(let t of e){let[e,...i]=t;if("ins"===e){let[,{key:e}]=i;n.push(["del",e])}else if("del"!==e&&"mov"===e){let[e,t]=i;n.push(["mov",t,e])}}n.length>0&&t.push(["list",i,...n.reverse()])}}return t.reverse()}(e),i={id:t,patches:e,inverseOps:n,timestamp:Date.now()};return this.updates.set(t,i),Et(e),this.debug,t}commit(e){this.updates.delete(e)&&this.debug}rollback(e){let t=this.updates.get(e);if(t){this.debug;try{Et(t.inverseOps),this.onRollback?.(e,t.patches)}catch(e){this.onError?.(e,"rollback")}this.updates.delete(e)}}getPendingCount(){return this.updates.size}clear(){this.updates.clear()}},jt=class{constructor(e){this.boot=null,this.debug=!1,this.debug=e?.debug||!1}load(e){let t=e??this.detect();return t&&"string"==typeof t.sid&&0!==t.sid.length?(this.apply(t),t):(this.log("No boot payload detected or payload invalid"),null)}detect(){if(typeof window<"u"){let e=window.__LIVEUI_BOOT__;if(e&&"object"==typeof e&&"string"==typeof e.sid)return e}if(typeof document<"u"){let e=document.getElementById("live-boot")?.textContent;if(e)try{return JSON.parse(e)}catch(e){this.log("Failed to parse boot payload from DOM",e)}}return null}apply(e){let t;if(this.boot=e,e.handlers&&(pe(),fe(e.handlers),xe()),ce(e.bindings?.slots??null),j(),B(e.refs?.add??null),typeof document<"u"&&(U(document),Ke(),t=st(e.componentPaths,{root:document})),this.registerInitialDom(e),_t(e.bindings?.uploads??null,t),typeof window<"u"&&e.location){let t=e.location.q?"?"+e.location.q:"",n=e.location.hash?"#"+e.location.hash:"",i=`${e.location.path}${t}${n}`,r=`${window.location.pathname}${window.location.search}${window.location.hash}`;i&&r!==i&&window.history.replaceState({},"",i)}}registerInitialDom(e){if(typeof document>"u")return;Fe();let t=it(e.slotPaths);if(this.debug,Array.isArray(e.slots)&&e.slots.length>0)for(let n of e.slots){if(!n||"number"!=typeof n.anchorId)continue;let e=t.get(n.anchorId);e?Le(n.anchorId,e):this.debug}else for(let[e,n]of t.entries())Le(e,n);let n=rt(e.listPaths);for(let[e,t]of n.entries())He(e,t)}get(){return this.boot}ensure(){if(!this.boot||!this.boot.sid)throw Error("LiveUI: boot payload is required before connecting");return this.boot}getJoinLocation(){let e=this.boot?.location??{path:"/",q:"",hash:""};if(typeof window>"u")return e;let t=window.location.pathname||e.path||"/",n=window.location.search??"",i=n.startsWith("?")?n.substring(1):n,r=window.location.hash??"";return{path:t,q:i,hash:r.startsWith("#")?r.substring(1):r}}log(...e){this.debug}},Bt=class extends Lt{constructor(e={}){super(),this.client=null,this.channel=null,this.pubsubChannels=new Map,this.connectionState=new Dt({status:"disconnected"}),this.sessionId=new Dt(null),this.version=new Dt(0),this.lastAck=0,this.hasBootPayload=!1,this.autoConnectCleanup=null,this.expectedSeq=null,this.frameBuffer=new Map,this.MAX_FRAME_BUFFER_SIZE=50,this.eventQueue=[],this.patchQueue=[],this.batchScheduled=!1,this.rafHandle=null,this.rafUsesTimeoutFallback=!1,this.pendingUploadBindings=[],this.cookieRequests=new Set,this.templateCache=new Map,this.MAX_TEMPLATE_CACHE_SIZE=100,this.reconnectAttempts=0,this.reconnectTimer=null,this.isReconnecting=!1,this.diagnostics=[],this.errorOverlay=null,this.errorListEl=null,this.errorOverlayVisible=!1,this.handleDebugKeydown=e=>this.onDebugKeydown(e),this.metrics={patchesApplied:0,averagePatchTime:0,framesReceived:0,eventsProcessed:0,reconnections:0,uptime:0,effectsMs:0,maxEffectMs:0,slowEffects:0,framesBuffered:0,framesDropped:0,sequenceGaps:0},this.startTime=0,this.patchTimes=[],this.patchTimeTotal=0,this.uploads=null,this.lastOptimisticNavTime=0,this.OPTIMISTIC_NAV_WINDOW=100,this.eventDebouncer=new Map,this.handlePopState=()=>{if("connected"!==this.connectionState.get().status||!this.channel)return void this.log("Not connected, cannot handle popstate");let e=window.location.pathname,t=window.location.search.substring(1),n=window.location.hash.startsWith("#")?window.location.hash.substring(1):window.location.hash,i={t:"pop",sid:this.sessionId.get(),path:e,q:t,hash:n};this.log("Sending popstate navigation:",i),this.channel.sendMessage("pop",i)},this.bootHandler=new jt({debug:e.debug||!1}),this.optimistic=new qt({onRollback:(e,t)=>this.emit("rollback",{id:e,patches:t}),onError:(e,t)=>this.emit("error",{error:e,context:t}),debug:e.debug||!1}),this.uploads=new Rt({getSessionId:()=>this.sessionId.get(),getEndpoint:()=>this.options.uploadEndpoint??null,send:e=>this.sendUploadMessage(e),isConnected:()=>"connected"===this.connectionState.get().status&&null!==this.channel});let t={...e??{}},n=t.boot??null;delete t.boot,this.options={endpoint:t.endpoint??"/live",uploadEndpoint:t.uploadEndpoint??"/pondlive/upload/",autoConnect:!1!==t.autoConnect,debug:t.debug??!1,reconnect:!1!==t.reconnect,maxReconnectAttempts:t.maxReconnectAttempts??5,reconnectDelay:t.reconnectDelay??1e3,...t},n&&(this.options.boot=n);let i=this.bootHandler.load(n);if(this.hasBootPayload=!!i,i&&(i.client?.endpoint&&"string"==typeof i.client.endpoint&&(this.options.endpoint=i.client.endpoint),i.client?.upload&&"string"==typeof i.client.upload&&(this.options.uploadEndpoint=i.client.upload),"boolean"==typeof i.client?.debug&&(this.options.debug=i.client.debug),this.sessionId.set(i.sid),this.version.set(i.ver??0),this.lastAck=i.seq??0,i.errors&&i.errors.length>0))for(let e of i.errors)this.recordDiagnostic(e);this.connectionState.subscribe(e=>{this.log("Connection state changed:",e)}),this.options.debug&&typeof window<"u"&&window.addEventListener("keydown",this.handleDebugKeydown),this.setupAutoConnect()}async connect(){this.clearAutoConnect();let e,t=this.connectionState.get();if("connected"!==t.status&&"connecting"!==t.status){try{e=this.bootHandler.ensure()}catch(e){return this.log("Boot payload error:",e),this.setState({status:"error",error:e}),void this.emit("error",{error:e,context:"boot"})}e.client?.endpoint&&"string"==typeof e.client.endpoint&&(this.options.endpoint=e.client.endpoint),e.client?.upload&&"string"==typeof e.client.upload&&(this.options.uploadEndpoint=e.client.upload),this.setState({status:"connecting"}),this.startTime=Date.now();try{this.log("Connecting to",this.options.endpoint);let t=e.sid,n=this.bootHandler.getJoinLocation(),i={sid:t,ver:e.ver??0,ack:this.lastAck??e.seq??0,loc:{path:n.path,q:n.q,hash:n.hash}};this.client=new N.PondClient(this.options.endpoint),typeof document<"u"&&function(e){ve=e,re.forEach(e=>{Se(e)})}(e=>this.sendEvent(e)),typeof document<"u"&&function(e){Ee=e,X.has("click")||Se("click")}((e,t,n)=>this.sendNavigation(e,t,n)),typeof window<"u"&&window.addEventListener("popstate",this.handlePopState);let r="live/"+t;this.channel=this.client.createChannel(r,i),this.channel.onChannelStateChange(e=>{this.log("Channel state changed:",e),"JOINED"===e&&this.onConnected()}),this.channel.onMessage((e,t)=>{(e=>null!==e&&"object"==typeof e&&"string"==typeof e.t)(t)?this.handleMessage(t):this.log("Ignoring non-server payload",e,t)}),this.channel.onLeave(()=>{this.log("Channel left"),this.onDisconnected()}),this.client.connect(),this.channel.join()}catch(e){this.log("Connection error:",e),this.setState({status:"error",error:e}),this.emit("error",{error:e,context:"connect"}),this.options.reconnect&&!this.isReconnecting&&this.scheduleReconnect()}}else this.log("Already connected or connecting")}disconnect(){this.clearReconnectTimer(),this.isReconnecting=!1,this.cancelScheduledBatch(),this.patchQueue=[],this.pendingUploadBindings=[];for(let e of this.pubsubChannels.values())try{e.dispose(),e.channel.leave()}catch(e){this.log("Error leaving pubsub channel",e)}this.pubsubChannels.clear(),this.channel&&(this.channel.leave(),this.channel=null),this.client&&(this.client.disconnect(),this.client=null),typeof window<"u"&&window.removeEventListener("popstate",this.handlePopState),this.setState({status:"disconnected"}),this.sessionId.set(null),this.version.set(0),pe(),j(),X.forEach((e,t)=>{let n="blur"===t||"focus"===t;document.removeEventListener(t,e,n)}),X.clear(),ve=null,we=null,Ee=null,this.uploads?.onDisconnect(),this.emit("disconnected",void 0)}setupAutoConnect(){if(!this.options.autoConnect)return;if(!this.hasBootPayload)return void this.log("Auto-connect skipped: no boot payload detected");let e=()=>{this.clearAutoConnect(),this.log("Auto-connecting after DOM ready"),this.connect().catch(e=>{this.log("Auto-connect failed:",e)})};if(typeof document>"u")e();else{if("loading"===document.readyState){let t=()=>{document.removeEventListener("DOMContentLoaded",t),e()};return document.addEventListener("DOMContentLoaded",t),void(this.autoConnectCleanup=()=>{document.removeEventListener("DOMContentLoaded",t)})}"function"==typeof queueMicrotask?queueMicrotask(e):Promise.resolve().then(e)}}clearAutoConnect(){this.autoConnectCleanup&&(this.autoConnectCleanup(),this.autoConnectCleanup=null)}getConnectionState(){return this.connectionState.get()}getMetrics(){return{...this.metrics,uptime:this.startTime?Date.now()-this.startTime:0}}onStateChange(e){return this.connectionState.subscribe(e)}onSessionIdChange(e){return this.sessionId.subscribe(e)}onVersionChange(e){return this.version.subscribe(e)}sendEventDebounced(e,t=300){let n=this.eventDebouncer.get(e.hid);n&&clearTimeout(n);let i=setTimeout(()=>{this.sendEvent(e),this.eventDebouncer.delete(e.hid)},t);this.eventDebouncer.set(e.hid,i)}applyOptimistic(e){return this.optimistic.apply(e)}commitOptimistic(e){this.optimistic.commit(e)}rollbackOptimistic(e){this.optimistic.rollback(e)}setState(e){let t=this.connectionState.get();this.hasStateChanged(t,e)&&(this.connectionState.set(e),this.emit("stateChanged",{from:t,to:e}))}onConnected(){let e=this.sessionId.get(),t=this.version.get();e&&(this.isReconnecting&&(this.isReconnecting=!1,this.reconnectAttempts=0,this.emit("reconnected",{sessionId:e})),this.setState({status:"connected",sessionId:e,version:t}),this.emit("connected",{sessionId:e,version:t}),this.flushEventQueue())}onDisconnected(){this.setState({status:"disconnected"}),this.options.reconnect&&!this.isReconnecting&&this.scheduleReconnect(),this.uploads?.onDisconnect()}scheduleReconnect(){if(this.reconnectAttempts>=this.options.maxReconnectAttempts)return this.log("Max reconnect attempts reached"),void this.emit("error",{error:Error("Max reconnect attempts reached"),context:"reconnect"});this.isReconnecting=!0,this.reconnectAttempts++;let e=this.options.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);this.log(`Reconnecting in ${e}ms (attempt ${this.reconnectAttempts}/${this.options.maxReconnectAttempts})`),this.setState({status:"reconnecting",attempt:this.reconnectAttempts}),this.emit("reconnecting",{attempt:this.reconnectAttempts}),this.reconnectTimer=setTimeout(()=>{this.metrics.reconnections++,this.connect()},e)}clearReconnectTimer(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null)}handleMessage(e){if(e&&e.t)switch(this.log("Received message:",e.t,e),e.t){case"init":this.handleInit(e);break;case"frame":this.handleFrame(e);break;case"template":this.handleTemplate(e);break;case"join":this.handleJoin(e);break;case"resume":this.handleResume(e);break;case"error":this.handleError(e);break;case"diagnostic":this.handleDiagnostic(e);break;case"pubsub":this.handlePubsub(e);break;case"upload":this.uploads?.handleControl(e);break;case"domreq":this.handleDOMRequest(e);break;default:this.log("Unknown message type:",e.t)}else this.log("Invalid message",e)}handleInit(e){if(this.sessionId.set(e.sid),this.version.set(e.ver),this.expectedSeq=void 0!==e.seq?e.seq+1:null,this.frameBuffer.clear(),Array.isArray(e.errors)&&e.errors.length>0)for(let t of e.errors)this.recordDiagnostic(t);let t;e.handlers&&(fe(e.handlers),xe()),ce(e.bindings?.slots??null),j(),e.refs?.add&&B(e.refs.add),typeof document<"u"&&(U(document),be(document),t=st(e.componentPaths,{root:document})),_t(e.bindings?.uploads??null,t),void 0!==e.seq&&(this.lastAck=e.seq,this.sendAck(e.seq)),this.log("Session initialized:",e.sid,"version:",e.ver),this.onConnected()}handleFrame(e){let t=this.sessionId.get();if(e.sid===t)if(this.metrics.framesReceived++,void 0!==e.seq){if(null===this.expectedSeq)return this.expectedSeq=e.seq+1,this.applyFrame(e),void this.drainFrameBuffer();if(e.seq===this.expectedSeq)return this.expectedSeq=e.seq+1,this.applyFrame(e),void this.drainFrameBuffer();if(e.seq>this.expectedSeq){if(this.metrics.sequenceGaps++,this.log("Frame arrived out of order",{expected:this.expectedSeq,received:e.seq,gap:e.seq-this.expectedSeq}),this.frameBuffer.size>=this.MAX_FRAME_BUFFER_SIZE){this.metrics.framesDropped++,this.log("Frame buffer full, dropping oldest frame");let e=Math.min(...this.frameBuffer.keys());this.frameBuffer.delete(e)}return this.frameBuffer.set(e.seq,e),void this.metrics.framesBuffered++}if(e.seq<this.expectedSeq)return this.metrics.framesDropped++,void this.log("Dropping duplicate/late frame",{expected:this.expectedSeq,received:e.seq})}else this.applyFrame(e);else this.log("Session mismatch, ignoring frame")}applyFrame(e){if(this.version.set(e.ver),e.patch&&e.patch.length>0&&(this.log("Queueing",e.patch.length,"operations"),this.patchQueue.push(...e.patch),this.scheduleBatch()),e.handlers&&(e.handlers.add&&fe(e.handlers.add),e.handlers.del&&function(e){if(Array.isArray(e))for(let t of e){let e=G.get(t);if(G.delete(t),e)for(let t of Me(e))Te(t)}}(e.handlers.del),xe()),e.bindings?.slots)for(let[t,n]of Object.entries(e.bindings.slots)){let e=+t;!Number.isInteger(e)||e<0||de(e,Array.isArray(n)?n:[])}if(Array.isArray(e.bindings?.uploads)&&(this.batchScheduled||this.patchQueue.length>0?this.pendingUploadBindings.push(e.bindings.uploads):Mt(e.bindings.uploads)),e.refs&&(e.refs.del&&F(e.refs.del),e.refs.add&&B(e.refs.add)),e.nav){let t=Date.now()-this.lastOptimisticNavTime<this.OPTIMISTIC_NAV_WINDOW;e.nav.push?t?window.history.replaceState({},"",e.nav.push):window.history.pushState({},"",e.nav.push):e.nav.replace&&window.history.replaceState({},"",e.nav.replace),this.lastOptimisticNavTime=0}e.effects&&e.effects.length>0&&this.applyEffects(e.effects),void 0!==e.seq&&this.sendAck(e.seq),e.metrics&&(this.log("Frame metrics:",e.metrics),"number"==typeof e.metrics.effectsMs&&(this.metrics.effectsMs=e.metrics.effectsMs),"number"==typeof e.metrics.maxEffectMs&&(this.metrics.maxEffectMs=e.metrics.maxEffectMs),"number"==typeof e.metrics.slowEffects&&(this.metrics.slowEffects=e.metrics.slowEffects))}handleTemplate(e){if(!e)return;let t=this.sessionId.get();e.sid&&t&&e.sid!==t?this.log("Template message for different session",e.sid):e.scope?this.applyComponentTemplatePayload(e,e.scope):this.applyRootTemplatePayload(e)}handleDiagnostic(e){e&&this.recordDiagnostic(e)}drainFrameBuffer(){for(;null!==this.expectedSeq&&this.frameBuffer.has(this.expectedSeq);){let e=this.frameBuffer.get(this.expectedSeq);this.frameBuffer.delete(this.expectedSeq),this.expectedSeq=e.seq+1,this.log("Draining buffered frame",{seq:e.seq}),this.applyFrame(e)}}applyEffects(e){for(let t of e)try{switch(this.log("Applying effect:",t),this.emit("effect",{effect:t}),"string"==typeof t.type?t.type.toLowerCase():""){case"boot":this.applyBootEffect(t);break;case"componentboot":this.applyComponentBootEffect(t);break;case"dom":this.applyDOMActionEffect(t);break;case"domcall":this.applyLegacyDOMCallEffect(t);break;case"scroll":case"scrolltop":this.applyScrollEffect(t);break;case"focus":this.applyFocusEffect(t);break;case"alert":window.alert(t.message);break;case"toast":this.applyToastEffect(t);break;case"push":this.applyPushEffect(t);break;case"replace":this.applyReplaceEffect(t);break;case"dispatch":this.dispatchCustomEvent(t.eventName,t.detail);break;case"metadata":this.applyMetadataEffect(t);break;case"cookies":this.handleCookieEffect(t);break;case"custom":break;default:this.log("Unknown effect type:",t.type)}}catch(e){this.log("Error applying effect:",t,e),this.emit("error",{error:e,context:"effect"})}}applyRootTemplatePayload(e){if(typeof document>"u")return;let t=this.getTemplateMarkup(e,"__root__");Ct(),Fe(),document.body?document.body.innerHTML=t:document.documentElement&&(document.documentElement.innerHTML=t);let n=document.body??document;be(n),pe(),e.handlers&&Object.keys(e.handlers).length>0&&fe(e.handlers),xe(),ce(e.bindings?.slots??null),e.refs?.del&&F(e.refs.del),e.refs?.add&&B(e.refs.add),U(document),Ke();let i=n.childNodes.length,r={container:n,startIndex:0,endIndex:i>0?i-1:-1},s=st(e.componentPaths,{root:document});this.registerTemplateAnchors(r,e,s),_t(e.bindings?.uploads??null,s)}applyComponentTemplatePayload(e,t){if(typeof document>"u"||!t||!t.componentId)return;let n=this.findComponentRange(t.componentId);if(!n)return void this.options.debug;let i=this.extractSlotIds(e.slots);for(let e of i)je(e);let r=this.extractListSlotIds(e.listPaths);for(let e of r)Be(e);Ct();let s=document.createElement("template"),o=this.getTemplateMarkup(e,t.componentId);s.innerHTML=o;let a=s.content.cloneNode(!0);be(a);let l=[];for(let e=a.firstChild;e;e=e.nextSibling)l.push(e);let{container:c}=n,d=n.startIndex,u=n.endIndex,h=u+1<c.childNodes.length?c.childNodes.item(u+1):null;for(let e=u;e>=d;e--){let t=c.childNodes.item(e);t&&c.removeChild(t)}c.insertBefore(a,h);let f=l.length,p=Ge(t.componentId,{container:c,startIndex:d,endIndex:f>0?d+f-1:d-1});p||(p={container:c,startIndex:d,endIndex:f>0?d+f-1:d-1});let m=st(e.componentPaths,{baseId:t.componentId,baseRange:p});if(this.registerTemplateAnchors(p,e,m),Tt(t.componentId,e.bindings?.uploads??null,m),e.handlers&&Object.keys(e.handlers).length>0&&(fe(e.handlers),xe()),e.bindings?.slots)for(let[t,n]of Object.entries(e.bindings.slots)){let e=+t;!Number.isInteger(e)||e<0||de(e,Array.isArray(n)?n:[])}e.refs?.del&&F(e.refs.del),e.refs?.add&&B(e.refs.add),U(c)}handleDOMRequest(e){if(!e||!e.id)return;let t=e.ref??"",n=Array.isArray(e.props)?e.props:[],i={t:"domres",id:e.id};if(!t)return i.error="missing_ref",void this.sendDOMResponse(i);let r=H(t);if(!r)return i.error="not_found",void this.sendDOMResponse(i);if(e.method)try{let t=e.method.trim();if(!t)return i.error="empty_method",void this.sendDOMResponse(i);let n=r[t];if("function"!=typeof n)return i.error="method_not_found",void this.sendDOMResponse(i);let s=Array.isArray(e.args)?e.args:[],o=n.apply(r,s);i.result=o}catch(e){return i.error=e instanceof Error?e.message:e+"",void this.sendDOMResponse(i)}if(n.length>0)try{let e=V(n,{event:null,target:r,handlerElement:r,refElement:r});e&&Object.keys(e).length>0?i.values=e:i.values={}}catch(e){return i.error=e instanceof Error?e.message:e+"",void this.sendDOMResponse(i)}this.sendDOMResponse(i)}applyDOMActionEffect(e){if(typeof document>"u")return;let t=(e.kind??e.Kind??"").toLowerCase(),n=(e.ref??e.Ref??"").trim();if(t)if(n)switch(t){case"dom.call":{let t=(e.method??e.Method??"").trim();if(!t)return void this.reportDOMActionFailure(e,"missing_method");let i=this.normalizeDOMActionArgs(e),r=function(e,t,n=[]){let i=e?H(e):null;if(!i)return{ok:!1,reason:"missing_element"};let r=i[t];if("function"!=typeof r)return{ok:!1,reason:"missing_method"};try{let e=r.apply(i,Array.isArray(n)?n:[]);return e&&"function"==typeof e.then&&e.catch(e=>{}),{ok:!0}}catch(e){return{ok:!1,reason:"invoke_failed",error:e}}}(n,t,i);r.ok||this.reportDOMActionFailure(e,r.reason??"call_failed",{method:t,argsLength:i.length},r.error);break}case"dom.set":{let t=(e.prop??e.Prop??"").trim();if(!t)return void this.reportDOMActionFailure(e,"missing_property");let i=K(n,t,e.value??e.Value);i.ok||this.reportDOMActionFailure(e,i.reason??"set_failed",{prop:t},i.error);break}case"dom.toggle":{let t=(e.prop??e.Prop??"").trim();if(!t)return void this.reportDOMActionFailure(e,"missing_property");let i=e.value??e.Value;if("boolean"!=typeof i)return void this.reportDOMActionFailure(e,"invalid_toggle_value",{prop:t,value:i});let r=function(e,t,n){return"boolean"!=typeof n?{ok:!1,reason:"invalid_value"}:K(e,t,n)}(n,t,i);r.ok||this.reportDOMActionFailure(e,r.reason??"toggle_failed",{prop:t,value:i},r.error);break}case"dom.class":{let t=(e.class??e.Class??"").trim();if(!t)return void this.reportDOMActionFailure(e,"missing_class");let i=e.on??e.On,r=function(e,t,n){let i=e?H(e):null;if(!i)return{ok:!1,reason:"missing_element"};let r="string"==typeof t?t.trim():"";if(!r)return{ok:!1,reason:"missing_class"};if(!("classList"in i))return{ok:!1,reason:"classlist_missing"};try{return void 0===n?i.classList.toggle(r):i.classList.toggle(r,n),{ok:!0}}catch(e){return{ok:!1,reason:"class_toggle_failed",error:e}}}(n,t,i);r.ok||this.reportDOMActionFailure(e,r.reason??"class_failed",{className:t,toggle:i},r.error);break}case"dom.scroll":{let t={},i=e.behavior??e.Behavior,r=e.block??e.Block,s=e.inline??e.Inline;i&&(t.behavior=i),r&&(t.block=r),s&&(t.inline=s);let o=function(e,t){let n=e?H(e):null;if(!n)return{ok:!1,reason:"missing_element"};let i=n.scrollIntoView;if("function"!=typeof i)return{ok:!1,reason:"missing_scroll"};try{return t&&Object.keys(t).length>0?i.call(n,t):i.call(n),{ok:!0}}catch(e){return{ok:!1,reason:"scroll_failed",error:e}}}(n,Object.keys(t).length>0?t:null);o.ok||this.reportDOMActionFailure(e,o.reason??"scroll_failed",void 0,o.error);break}default:this.reportDOMActionFailure(e,"unknown_kind",{kind:t})}else this.reportDOMActionFailure(e,"missing_ref");else this.reportDOMActionFailure(e,"missing_kind")}applyLegacyDOMCallEffect(e){let t=Array.isArray(e.args)?e.args:Array.isArray(e.Args)?e.Args:void 0!==e.args?[e.args]:void 0!==e.Args?[e.Args]:void 0,n={type:"dom",kind:"dom.call",ref:e.ref??e.Ref??void 0,method:e.method??e.Method??void 0,args:t};this.applyDOMActionEffect(n)}normalizeDOMActionArgs(e){return Array.isArray(e.args)?e.args:Array.isArray(e.Args)?e.Args:void 0!==e.args?[e.args]:void 0!==e.Args?[e.Args]:[]}reportDOMActionFailure(e,t,n,i){let r=e.kind??e.Kind??"",s=`DOM action ${r||"unknown"} failed: ${t}`,o={kind:r,ref:e.ref??e.Ref??""??""};n&&Object.assign(o,n),i instanceof Error?(o.error=i.message,i.stack&&(o.stack=i.stack)):void 0!==i&&(o.error=i);let a={t:"diagnostic",sid:this.sessionId.get()??"",code:"dom_action_failed",message:s,details:{phase:"dom_action",metadata:o}};this.recordDiagnostic(a)}sendDOMResponse(e){if(this.channel)try{this.channel.sendMessage("domres",e)}catch(e){this.log("Failed to send DOM response",e)}else this.log("Cannot send DOM response without channel",e)}applyScrollEffect(e){let t=e.behavior||"smooth",n=e.selector;if(!n||"ScrollTop"===e.type)return void window.scrollTo({top:0,behavior:t});let i=document.querySelector(n);i instanceof Element&&i.scrollIntoView({behavior:t,block:e.block||"start"})}applyMetadataEffect(e){if(typeof document>"u")return;Object.prototype.hasOwnProperty.call(e,"title")&&void 0!==e.title&&(document.title=e.title);let t=document.head;if(!t)return;let n="data-live-key",i="data-live-head",r=e=>{!Array.isArray(e)||0===e.length||e.forEach(e=>{t.querySelectorAll(`[${n}="${e}"]`).forEach(e=>{e.parentNode?.removeChild(e)})})},s=(e,t)=>{let n=new Set(t);Array.from(e.attributes).forEach(t=>{n.has(t.name)||e.removeAttribute(t.name)})},o=(e,r)=>{if(!e||!e.key)return;let o=t.querySelector(`meta[${n}="${e.key}"]`);if(o||(o=document.createElement("meta"),t.appendChild(o)),s(o,[n]),o.setAttribute(n,e.key),o.setAttribute(i,r),void 0!==e.name&&o.setAttribute("name",e.name),void 0!==e.content&&o.setAttribute("content",e.content),void 0!==e.property&&o.setAttribute("property",e.property),void 0!==e.charset&&o.setAttribute("charset",e.charset),void 0!==e.httpEquiv&&o.setAttribute("http-equiv",e.httpEquiv),void 0!==e.itemProp&&o.setAttribute("itemprop",e.itemProp),e.attrs)for(let[t,n]of Object.entries(e.attrs))null!=n&&o.setAttribute(t,n+"")},a=e=>{if(!e||!e.key)return;let r=t.querySelector(`link[${n}="${e.key}"]`);if(r||(r=document.createElement("link"),t.appendChild(r)),s(r,[n]),r.setAttribute(n,e.key),r.setAttribute(i,"link"),void 0!==e.rel&&r.setAttribute("rel",e.rel),void 0!==e.href&&r.setAttribute("href",e.href),void 0!==e.type&&r.setAttribute("type",e.type),void 0!==e.as&&r.setAttribute("as",e.as),void 0!==e.media&&r.setAttribute("media",e.media),void 0!==e.hreflang&&r.setAttribute("hreflang",e.hreflang),void 0!==e.title&&r.setAttribute("title",e.title),void 0!==e.crossorigin&&r.setAttribute("crossorigin",e.crossorigin),void 0!==e.integrity&&r.setAttribute("integrity",e.integrity),void 0!==e.referrerpolicy&&r.setAttribute("referrerpolicy",e.referrerpolicy),void 0!==e.sizes&&r.setAttribute("sizes",e.sizes),e.attrs)for(let[t,n]of Object.entries(e.attrs))null!=n&&r.setAttribute(t,n+"")},l=e=>{if(!e||!e.key)return;let r=t.querySelector(`script[${n}="${e.key}"]`);if(r||(r=document.createElement("script"),t.appendChild(r)),s(r,[n]),r.setAttribute(n,e.key),r.setAttribute(i,"script"),e.module?r.setAttribute("type","module"):void 0!==e.type&&r.setAttribute("type",e.type),void 0!==e.src&&r.setAttribute("src",e.src),e.async&&r.setAttribute("async","async"),e.defer&&r.setAttribute("defer","defer"),e.noModule&&r.setAttribute("nomodule","nomodule"),void 0!==e.crossorigin&&r.setAttribute("crossorigin",e.crossorigin),void 0!==e.integrity&&r.setAttribute("integrity",e.integrity),void 0!==e.referrerpolicy&&r.setAttribute("referrerpolicy",e.referrerpolicy),void 0!==e.nonce&&r.setAttribute("nonce",e.nonce),e.attrs)for(let[t,n]of Object.entries(e.attrs))null!=n&&r.setAttribute(t,n+"");void 0!==e.inner&&(r.textContent=e.inner)};if(e.clearDescription&&r(["description"]),Object.prototype.hasOwnProperty.call(e,"description")&&void 0!==e.description){let t=e.description;t.trim().length>0?o({key:"description",name:"description",content:t},"description"):r(["description"])}if(Array.isArray(e.metaRemove)&&r(e.metaRemove),Array.isArray(e.metaAdd))for(let t of e.metaAdd)o(t,"meta");if(Array.isArray(e.linkRemove)&&r(e.linkRemove),Array.isArray(e.linkAdd))for(let t of e.linkAdd)a(t);if(Array.isArray(e.scriptRemove)&&r(e.scriptRemove),Array.isArray(e.scriptAdd))for(let t of e.scriptAdd)l(t)}handleCookieEffect(e){this.performCookieSync(e)}async performCookieSync(e){let t=e.token??e.Token;if(!t)return void this.log("Cookie effect missing token",e);if(this.cookieRequests.has(t))return;let n=e.endpoint??e.Endpoint??"/pondlive/cookie";if(!n)return void this.log("Cookie effect missing endpoint",e);let i=e.sid??e.SID??this.sessionId.get();if(!i)return void this.log("Cookie effect missing session identifier",e);let r=(e.method??e.Method??"POST").toUpperCase();this.cookieRequests.add(t);try{let e=await fetch(n,{method:r,credentials:"include",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({sid:i,token:t})});!e.ok&&204!==e.status&&this.log("Cookie negotiation failed",{endpoint:n,status:e.status,statusText:e.statusText})}catch(e){this.log("Cookie negotiation error",e),this.emit("error",{error:e,context:"cookies"})}finally{this.cookieRequests.delete(t)}}applyFocusEffect(e){let t=e.selector||e.Selector;if(!t)return;let n=document.querySelector(t);n&&(n instanceof HTMLElement||n instanceof SVGElement)&&"function"==typeof n.focus&&n.focus()}applyToastEffect(e){let t=e.message||e.Message,n=e.duration||3e3,i=e.variant||"info";this.emit("effect",{effect:{type:"toast",message:t,duration:n,variant:i}}),this.listenerCount("effect")}applyPushEffect(e){let t=e.url||e.URL;t&&window.history.pushState({},"",t)}applyReplaceEffect(e){let t=e.url||e.URL;t&&window.history.replaceState({},"",t)}applyBootEffect(e){let t=e?.boot;t&&(this.applyRootTemplatePayload(t),this.bootHandler.load(t))}applyComponentBootEffect(e){if(typeof document>"u"||!e||!e.componentId)return;let{componentId:t,html:n,slots:i,listSlots:r,bindings:s,slotPaths:o,listPaths:a}=e,l=this.findComponentRange(t);if(!l)return void this.options.debug;if(Array.isArray(i))for(let e of i)je(e);if(Array.isArray(r))for(let e of r)Be(e);Ct();let c=document.createElement("template");c.innerHTML=n||"";let d=c.content.cloneNode(!0);be(d);let u=[];for(let e=d.firstChild;e;e=e.nextSibling)u.push(e);let h=l.container,f=l.endIndex+1,p=f<h.childNodes.length?h.childNodes.item(f):null;for(let e=l.endIndex;e>=l.startIndex;e--){let t=h.childNodes.item(e);t&&h.removeChild(t)}h.insertBefore(d,p??null);let m=u.length,g=null;if(m>0){let e=l.startIndex+m-1;g=Ge(t,{container:h,startIndex:l.startIndex,endIndex:e})}else g=Ge(t,{container:h,startIndex:l.startIndex,endIndex:l.startIndex-1});g||(g={container:h,startIndex:l.startIndex,endIndex:l.startIndex-1});let y=st(e.componentPaths,{baseId:t,baseRange:g}),b=s?.slots??s;if(b&&"object"==typeof b)for(let[e,t]of Object.entries(b)){let n=+e;Number.isNaN(n)||de(n,Array.isArray(t)?t:[])}this.registerComponentAnchors(g,Array.isArray(i)?i:[],Array.isArray(r)?r:[],Array.isArray(o)?o:void 0,Array.isArray(a)?a:void 0,y),Tt(t,s?.uploads??s?.uploads??null,y),Array.isArray(o)&&o.length>0&&it(o,y).forEach((e,t)=>Le(t,e))}registerTemplateAnchors(e,t,n){if(!e)return;let i=this.extractSlotIds(t.slots),r=this.extractListSlotIds(t.listPaths);this.registerComponentAnchors(e,i,r,t.slotPaths,t.listPaths,n)}extractSlotIds(e){if(!Array.isArray(e))return[];let t=[];for(let n of e){let e=+n?.anchorId;Number.isInteger(e)&&e>=0&&t.push(e)}return t}extractListSlotIds(e){if(!Array.isArray(e))return[];let t=new Set,n=[];for(let i of e){let e=+i?.slot;!Number.isInteger(e)||e<0||t.has(e)||(t.add(e),n.push(e))}return n}getTemplateMarkup(e,t){let n=t&&t.length>0?t:"__root__",i="string"==typeof e.templateHash?e.templateHash:"";if("string"==typeof e.html)return this.cacheTemplateMarkup(n,i,e.html),e.html;if(i){let e=this.lookupTemplateMarkup(n,i);if(null!==e)return e}if(Array.isArray(e.s)&&e.s.length>0){let t=e.s.join("");return this.cacheTemplateMarkup(n,i,t),t}return this.cacheTemplateMarkup(n,i,""),""}buildTemplateCacheKey(e,t){return`${e}::${t}`}cacheTemplateMarkup(e,t,n){if(!t)return;let i=this.buildTemplateCacheKey(e,t);if(this.templateCache.has(i)&&this.templateCache.delete(i),this.templateCache.set(i,n),this.templateCache.size>this.MAX_TEMPLATE_CACHE_SIZE){let e=this.templateCache.keys().next();e.done||this.templateCache.delete(e.value)}}lookupTemplateMarkup(e,t){if(!t)return null;let n=this.buildTemplateCacheKey(e,t);if(!this.templateCache.has(n))return null;let i=this.templateCache.get(n);return void 0!==i?i:null}findComponentRange(e){return typeof document>"u"||!e?null:Qe(e)}registerComponentAnchors(e,t,n,i,r,s){if(!e||e.endIndex<e.startIndex)return;let o=Array.isArray(t)?t.filter(e=>Number.isInteger(e)&&e>=0):[],a=Array.isArray(n)?n.filter(e=>Number.isInteger(e)&&e>=0):[],l=new Set(o),c=new Set(a),d=it(i,s);if(d.size>0)if(l.size>0)for(let e of Array.from(l)){let t=d.get(e);t&&(Le(e,t),l.delete(e))}else for(let[e,t]of d.entries())Le(e,t);let u=rt(r,s);if(u.size>0)if(c.size>0)for(let e of Array.from(c)){let t=u.get(e);t&&(He(e,t),c.delete(e))}else for(let[e,t]of u.entries())He(e,t)}dispatchCustomEvent(e,t){let n=new CustomEvent(e,{detail:t,bubbles:!0,cancelable:!0});document.dispatchEvent(n)}scheduleBatch(){if(this.batchScheduled)return;if(this.batchScheduled=!0,"function"==typeof requestAnimationFrame)return this.rafUsesTimeoutFallback=!1,void(this.rafHandle=requestAnimationFrame(()=>{this.rafHandle=null,this.flushBatch()}));this.rafUsesTimeoutFallback=!0;let e=setTimeout(()=>{this.rafHandle=null,this.flushBatch()},16);this.rafHandle=e}flushBatch(){if(0===this.patchQueue.length)return this.batchScheduled=!1,this.rafHandle=null,this.rafUsesTimeoutFallback=!1,void(this.pendingUploadBindings.length>0&&this.flushPendingUploadBindings());let e=performance.now();this.log("Applying batched",this.patchQueue.length,"operations");let t=this.patchQueue;this.patchQueue=[],this.batchScheduled=!1,this.rafHandle=null,this.rafUsesTimeoutFallback=!1,Et(t),this.flushPendingUploadBindings();let n=performance.now()-e;if(this.metrics.patchesApplied+=t.length,this.patchTimes.push(n),this.patchTimeTotal+=n,this.patchTimes.length>100){let e=this.patchTimes.shift();void 0!==e&&(this.patchTimeTotal-=e)}let i=this.patchTimes.length;this.metrics.averagePatchTime=i?this.patchTimeTotal/i:0,this.emit("frameApplied",{operations:t.length,duration:n}),this.emit("metricsUpdated",this.getMetrics())}cancelScheduledBatch(){null!==this.rafHandle&&(this.rafUsesTimeoutFallback?clearTimeout(this.rafHandle):"function"==typeof cancelAnimationFrame&&cancelAnimationFrame(this.rafHandle),this.rafHandle=null,this.batchScheduled=!1,this.rafUsesTimeoutFallback=!1)}flushPendingUploadBindings(){if(0===this.pendingUploadBindings.length)return;let e=this.pendingUploadBindings;this.pendingUploadBindings=[];let t=[];for(let n of e)!Array.isArray(n)||0===n.length||t.push(...n);t.length>0&&Mt(t)}hasStateChanged(e,t){if(e.status!==t.status)return!0;switch(t.status){case"connected":return"connected"!==e.status||e.sessionId!==t.sessionId||e.version!==t.version;case"reconnecting":return"reconnecting"!==e.status||e.attempt!==t.attempt;case"error":return"error"!==e.status||e.error!==t.error;default:return!1}}handleJoin(e){this.sessionId.set(e.sid),this.version.set(e.ver),"number"==typeof e.ack&&e.ack>this.lastAck&&(this.lastAck=e.ack),this.log("Joined session:",e.sid,"ack:",e.ack)}handleResume(e){this.log("Resume from",e.from,"to",e.to);let t=e.from>0?e.from-1:0;if(t>this.lastAck&&(this.lastAck=t),this.expectedSeq=e.from,this.frameBuffer.clear(),Array.isArray(e.errors)&&e.errors.length>0)for(let t of e.errors)this.recordDiagnostic(t);this.emit("resumed",{from:e.from,to:e.to}),this.isReconnecting&&this.flushEventQueue()}handleError(e){let t=Error(e.message);this.emit("error",{error:t,context:e.code}),this.recordDiagnostic(e)}handlePubsub(e){if(e.topic)switch(e.op){case"join":this.joinPubsubTopic(e.topic);break;case"leave":this.leavePubsubTopic(e.topic);break;default:this.log("Unknown pubsub op:",e)}}recordDiagnostic(e){if(!this.options.debug)return;let t=this.buildDiagnosticKey(e),n={key:t,code:e.code??"runtime_panic",message:e.message??"Runtime panic recovered",details:e.details,timestamp:Date.now()},i=this.diagnostics.findIndex(e=>e.key===t);i>=0?this.diagnostics[i]=n:(this.diagnostics.push(n),this.diagnostics.length>20&&this.diagnostics.shift()),typeof document<"u"&&this.renderErrorOverlay()}buildDiagnosticKey(e){let t=e.details,n=t?.componentId??t?.componentName??"",i=t?.hook??"",r=t?.phase??"",s=t?.panic??"";return[e.code??"",e.message??"",n,i,r,s].join("|")}joinPubsubTopic(e){if(!e||!this.client||this.pubsubChannels.has(e))return;let t=this.client.createChannel("pubsub/"+e,{sid:this.sessionId.get()??void 0}),n=t.onLeave(()=>{this.pubsubChannels.delete(e)});this.pubsubChannels.set(e,{channel:t,dispose:n});try{t.join(),this.log("Joined pubsub topic",e)}catch(t){this.pubsubChannels.delete(e),n(),this.log("Failed to join pubsub topic",e,t)}}leavePubsubTopic(e){let t=this.pubsubChannels.get(e);if(t){this.pubsubChannels.delete(e);try{t.dispose(),t.channel.leave(),this.log("Left pubsub topic",e)}catch(t){this.log("Failed to leave pubsub topic",e,t)}}}ensureErrorOverlayElements(){if(!this.options.debug||typeof document>"u"||this.errorOverlay)return;let e=document.createElement("div");e.id="live-error-overlay",e.setAttribute("role","alertdialog"),e.setAttribute("aria-live","assertive"),e.setAttribute("aria-modal","true"),e.style.cssText="position:fixed;inset:0;background:rgba(15,23,42,0.82);color:#e2e8f0;z-index:2147483646;display:none;align-items:flex-start;justify-content:center;overflow-y:auto;padding:48px 24px;box-sizing:border-box;backdrop-filter:blur(6px)",e.addEventListener("click",t=>{t.target===e&&this.hideErrorOverlay()});let t=document.createElement("div");t.style.cssText='width:min(960px,100%);background:rgba(15,23,42,0.95);border-radius:16px;border:1px solid rgba(148,163,184,0.35);box-shadow:0 25px 50px -12px rgba(15,23,42,0.8);display:flex;flex-direction:column;overflow:hidden;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif';let n=document.createElement("header");n.style.cssText="display:flex;align-items:center;justify-content:space-between;gap:12px;padding:20px 24px;background:rgba(15,23,42,0.88);border-bottom:1px solid rgba(148,163,184,0.28);position:sticky;top:0;z-index:1";let i=document.createElement("h2");i.textContent="LiveUI Runtime Errors",i.style.cssText="margin:0;font-size:18px;font-weight:700;color:#f8fafc;";let r=document.createElement("div");r.style.cssText="display:flex;flex-direction:column;gap:4px;",r.appendChild(i);let s=document.createElement("span");s.textContent="â§âE / â§Ctrl+E to toggle â¢ Esc to dismiss",s.style.cssText="font-size:12px;color:#94a3b8;",r.appendChild(s);let o=document.createElement("div");o.style.cssText="display:flex;align-items:center;gap:8px;";let a=document.createElement("button");a.type="button",a.textContent="Retry render",a.style.cssText="padding:6px 12px;border-radius:6px;border:1px solid rgba(59,130,246,0.4);background:rgba(37,99,235,0.18);color:#bfdbfe;font-size:12px;font-weight:600;cursor:pointer",a.addEventListener("click",()=>this.requestRecovery());let l=document.createElement("button");l.type="button",l.textContent="Clear",l.style.cssText="padding:6px 12px;border-radius:6px;border:1px solid rgba(34,197,94,0.45);background:rgba(34,197,94,0.18);color:#bbf7d0;font-size:12px;font-weight:600;cursor:pointer",l.addEventListener("click",()=>this.clearDiagnostics());let c=document.createElement("button");c.type="button",c.textContent="Close",c.style.cssText="padding:6px 12px;border-radius:6px;border:1px solid rgba(248,113,113,0.4);background:rgba(248,113,113,0.18);color:#fecaca;font-size:12px;font-weight:600;cursor:pointer",c.addEventListener("click",()=>this.hideErrorOverlay()),o.appendChild(a),o.appendChild(l),o.appendChild(c),n.appendChild(r),n.appendChild(o);let d=document.createElement("div");d.style.cssText="padding:16px 24px 24px;display:flex;flex-direction:column;gap:16px;",t.appendChild(n),t.appendChild(d),e.appendChild(t),document.body.appendChild(e),this.errorOverlay=e,this.errorListEl=d}renderErrorOverlay(){if(!this.options.debug||typeof document>"u"||(this.ensureErrorOverlayElements(),!this.errorOverlay||!this.errorListEl))return;let e=this.errorListEl;if(e.innerHTML="",0===this.diagnostics.length){let t=document.createElement("div");t.textContent="No runtime errors captured yet.",t.style.cssText="font-size:14px;color:#94a3b8;",e.appendChild(t)}else{let t=[...this.diagnostics].sort((e,t)=>t.timestamp-e.timestamp);for(let n of t)e.appendChild(this.createDiagnosticElement(n))}this.errorOverlay.style.display="flex",this.errorOverlayVisible=!0}createDiagnosticElement(e){let t=document.createElement("article");t.style.cssText="background:rgba(15,23,42,0.65);border:1px solid rgba(148,163,184,0.25);border-radius:12px;padding:18px 20px;display:flex;flex-direction:column;gap:12px";let n=document.createElement("div");n.style.cssText="display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px;";let i=document.createElement("h3");i.textContent=e.message||"Runtime panic recovered",i.style.cssText="margin:0;font-size:16px;font-weight:700;color:#f8fafc;";let r=document.createElement("div");r.style.cssText="display:flex;align-items:center;gap:8px;";let s=document.createElement("span");s.textContent=e.code||"runtime_panic",s.style.cssText="font-size:11px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;background:rgba(37,99,235,0.18);color:#bfdbfe;border:1px solid rgba(37,99,235,0.35);border-radius:9999px;padding:4px 10px";let o=document.createElement("time"),a=e.details?.capturedAt?new Date(e.details.capturedAt):new Date(e.timestamp);Number.isNaN(a.getTime())?o.textContent=new Date(e.timestamp).toLocaleString():(o.dateTime=a.toISOString(),o.textContent=a.toLocaleString()),o.style.cssText="font-size:12px;color:#94a3b8;",r.appendChild(s),r.appendChild(o),n.appendChild(i),n.appendChild(r),t.appendChild(n);let l=e.details,c=document.createElement("div");c.style.cssText="display:flex;flex-direction:column;gap:4px;font-size:12px;color:#cbd5f5;";let d=l?.componentName&&l.componentId?`${l.componentName} (${l.componentId})`:l?.componentName??l?.componentId??"";if(this.appendMeta(c,"Component",d),this.appendMeta(c,"Phase",l?.phase),l?.hook){let e=null!=l.hookIndex?`${l.hook} (#${l.hookIndex})`:l.hook;this.appendMeta(c,"Hook",e)}if(this.appendMeta(c,"Panic",l?.panic),c.childNodes.length>0&&t.appendChild(c),l?.suggestion){let e=document.createElement("p");e.textContent=l.suggestion,e.style.cssText="margin:0;padding:12px 14px;border-radius:8px;background:rgba(34,197,94,0.12);color:#bbf7d0;font-size:13px;border-left:3px solid rgba(34,197,94,0.45);",t.appendChild(e)}let u=l?.metadata;if(u&&Object.keys(u).length>0){let e=document.createElement("dl");e.style.cssText="display:grid;grid-template-columns:max-content 1fr;gap:4px 12px;padding:12px;border-radius:8px;background:rgba(15,23,42,0.5);";for(let[t,n]of Object.entries(u)){let i=document.createElement("dt");i.textContent=t,i.style.cssText="font-weight:600;color:#e2e8f0;";let r=document.createElement("dd");r.textContent=this.formatMetadataValue(n),r.style.cssText="margin:0;white-space:pre-wrap;color:#cbd5f5;",e.appendChild(i),e.appendChild(r)}t.appendChild(e)}if(l?.stack){let e=document.createElement("pre");e.textContent=l.stack.trim(),e.style.cssText="margin:0;padding:12px;border-radius:8px;background:#020617;color:#f1f5f9;max-height:220px;overflow:auto;font-size:12px;line-height:1.45;",t.appendChild(e)}return t}appendMeta(e,t,n){if(!n)return;let i=document.createElement("div");i.style.cssText="display:flex;gap:6px;align-items:flex-start;";let r=document.createElement("span");r.textContent=t+":",r.style.cssText="font-weight:600;min-width:88px;color:#e2e8f0;";let s=document.createElement("span");s.textContent=n,s.style.cssText="flex:1;",i.appendChild(r),i.appendChild(s),e.appendChild(i)}formatMetadataValue(e){if(null==e)return"null";if("string"==typeof e)return e;if("number"==typeof e||"boolean"==typeof e)return e+"";try{return JSON.stringify(e,null,2)}catch{return e+""}}hideErrorOverlay(){this.errorOverlay&&(this.errorOverlay.style.display="none",this.errorOverlayVisible=!1)}clearDiagnostics(){this.diagnostics=[],this.errorListEl&&(this.errorListEl.innerHTML=""),this.hideErrorOverlay()}requestRecovery(){let e=this.sessionId.get();e&&this.channel?(this.log("Requesting runtime recovery"),this.channel.sendMessage("recover",{t:"recover",sid:e})):this.log("Cannot request recovery without active session/channel")}onDebugKeydown(e){if(this.options.debug){if("Escape"===e.key&&this.errorOverlayVisible)return void this.hideErrorOverlay();("e"===e.key||"E"===e.key)&&e.shiftKey&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),this.renderErrorOverlay())}}sendEvent(e){if("connected"!==this.connectionState.get().status||!this.channel)return this.log("Not connected, queueing event"),void this.eventQueue.push(e);let t={t:"evt",sid:this.sessionId.get(),hid:e.hid,payload:e.payload};this.log("Sending event:",t),this.channel.sendMessage("evt",t),this.metrics.eventsProcessed++}sendUploadMessage(e){"connected"===this.connectionState.get().status&&this.channel?this.channel.sendMessage("upload",e):this.log("Not connected, skipping upload message")}sendNavigation(e,t,n){if("connected"!==this.connectionState.get().status||!this.channel)return this.log("Not connected, cannot navigate"),!1;let i={t:"nav",sid:this.sessionId.get(),path:e,q:t,hash:n};this.log("Sending navigation:",i),this.channel.sendMessage("nav",i);let r=t?"?"+t:"",s=n?"#"+n:"";return window.history.pushState({},"",`${e}${r}${s}`),this.lastOptimisticNavTime=Date.now(),!0}requestRouterReset(e){let t=this.sessionId.get();if(!t||!this.channel)return void this.log("Cannot request router reset without active session/channel");let n="string"==typeof e?e.trim():"";if(!n)return void this.log("Cannot request router reset without component id");let i={t:"routerReset",sid:t,componentId:n};this.log("Requesting router reset:",i),this.channel.sendMessage("routerReset",i)}sendAck(e){if(!this.channel)return;let t={t:"ack",sid:this.sessionId.get(),seq:e};this.channel.sendMessage("ack",t),"number"==typeof e&&e>this.lastAck&&(this.lastAck=e)}flushEventQueue(){if(0===this.eventQueue.length)return;this.log("Flushing",this.eventQueue.length,"queued events");let e=this.eventQueue;this.eventQueue=[];for(let t of e)this.sendEvent(t)}log(...e){this.options.debug}},Ft=null;function Ut({force:e=!1}={}){let t=typeof window>"u"?null:window;return t?(e&&(Ft=null),Ft||(Ft=function(e){return new Promise((t,n)=>{let i=()=>{try{let n=function(e){let t={...e.__LIVEUI_OPTIONS__??{}},n=function(e){let t=e.__LIVEUI_BOOT__;if(t&&"object"==typeof t&&"string"==typeof t.sid)return t;if(typeof document>"u")return null;let n=document.getElementById("live-boot")?.textContent;if(!n)return null;try{let t=JSON.parse(n);return e.__LIVEUI_BOOT__=t,t}catch{return null}}(e),i=t.boot,r=n??i??null,s=!1!==t.autoConnect,o={...t,autoConnect:!1},a="boolean"==typeof r?.client?.debug?r.client.debug:void 0;typeof a<"u"?o.debug=a:typeof o.debug>"u"&&(o.debug=!0),r&&(o.boot=r,n||(e.__LIVEUI_BOOT__=r));let l=new Bt(o);return function(e,t){let n=Bt;Object.assign(n,{instance:t,dom:T,applyOps:Et,patcher:{configure:wt,getConfig:At,clearCaches:Ct,getStats:St,morphElement:yt},boot:Ut}),e.LiveUI=n,e.LiveUIInstance=t,e.__LIVEUI_DEVTOOLS__&&(e.__LIVEUI_DEVTOOLS__.installed=!0,e.__LIVEUI_DEVTOOLS__.instance=t)}(e,l),s&&r&&l.connect().catch(e=>{}),l}(e);t(n)}catch(e){n(e)}};if(typeof document<"u"&&"loading"===document.readyState){let e=()=>{document.removeEventListener("DOMContentLoaded",e),i()};document.addEventListener("DOMContentLoaded",e)}else i()})}(t)),Ft):Promise.reject(Error("LiveUI: window is not available for bootstrapping."))}return typeof window<"u"&&Ut().catch(()=>{}),(e=>l(t({},"__esModule",{value:!0}),e))(k)})();"undefined"!=typeof window&&(window.LiveUI=e.default,window.LiveUI.dom=e.dom,window.LiveUI.applyOps=e.applyOps);