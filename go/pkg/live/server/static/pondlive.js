// LiveUI Client v1.0.0
"use strict";var t=(()=>{function t(t,e){let i=St.get(t);return i?e&&(i.meta=e):(i={id:t,meta:e??{tag:""},element:null},St.set(t,i)),i}function e(e,i){if(!e||!i)return null;let n=function(t){let e=t;for(;e;){if(r(e))return e;e=e.parentElement}return null}(e);if(!n)return null;let o=r(n);if(!o)return null;let s=t(o);if(s.element=n,!function(t,e){if(!t||!t.events)return 0;for(let[i,n]of Object.entries(t.events))if(i===e||n?.listen&&n.listen.includes(e))return 1;return 0}(s.meta,i))return null;let l=function(t,e){if(!t||!t.events)return[];let i=[],n=new Set;for(let[r,o]of Object.entries(t.events))if(o&&(r===e||(Array.isArray(o.listen)?o.listen:[]).includes(e))&&Array.isArray(o.props))for(let t of o.props)"string"!=typeof t||0===t.length||n.has(t)||(n.add(t),i.push(t));return i}(s.meta,i);return{id:o,element:n,props:l,notify(t){s.lastPayloads||(s.lastPayloads=Object.create(null)),s.lastPayloads[i]={...t}}}}function i(t,e){let i=St.get(t);i&&(!e||i.element===e)&&(i.element&&n(i.element,t),i.element=null)}function n(t,e){let i=jt.get(t);i&&(i.delete(e),0===i.size&&jt.delete(t))}function r(t){if(!t)return null;let e=jt.get(t);if(e&&e.size>0){let t=e.values().next();if(!t.done)return t.value??null}return null}function o(){St.clear(),jt=new WeakMap}function s(e){if(e)for(let[i,n]of Object.entries(e))i&&t(i,n)}function l(t){if(Array.isArray(t))for(let e of t)e&&St.delete(e)}function a(t){if(!t||typeof document>"u")return;let e=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT),n=t;for(;n;){if(n instanceof Element){let t=jt.get(n);if(t&&t.size>0)for(let e of Array.from(t))i(e,n)}n=e.nextNode()}}function u(t){return St.get(t)?.element??null}function f(t){return St.get(t)?.meta??null}function c(e,r){if(e){if(!r)return void i(e,null);!function(e,i){if(!e)return;let r=t(e);r.element&&r.element!==i&&n(r.element,e),r.element=i,r.meta.tag||(r.meta={...r.meta,tag:i.tagName.toLowerCase()}),function(t,e){let i=jt.get(t);i||(i=new Set,jt.set(t,i)),i.add(e)}(i,e)}(e,r)}}function h(t,e){if("string"!=typeof t)return;let i=t.trim();if(!i)return;let n=i.split(".");if(0===n.length)return;let r=n.shift();if(!r)return;let o=function(t,e){switch(t){case"event":return e.event??void 0;case"target":return e.target??void 0;case"currentTarget":return e.handlerElement?e.handlerElement:e.event&&"currentTarget"in e.event?e.event.currentTarget??void 0:void 0;case"element":case"ref":return e.refElement??e.handlerElement??e.target??void 0;default:return}}(r,e);return void 0!==o?function(t,e){let i=t;for(let t of e)if(t){if(null==i)return;try{i=i[t]}catch{return}}return i}(o,n):void 0}function d(t,e){if(!Array.isArray(t)||0===t.length)return null;let i={};for(let n of t){if("string"!=typeof n||0===n.length)continue;let t=h(n,e);if(void 0===t)continue;let r=p(t);void 0!==r&&(i[n]=r)}return Object.keys(i).length>0?i:null}function p(t){if(null===t)return null;let e=typeof t;if("string"===e||"number"===e||"boolean"===e)return t;if(t instanceof Date)return t.toISOString();if("u">typeof FileList&&t instanceof FileList)return function(t){let e=[];for(let i=0;t.length>i;i++){let n=t.item(i);n&&e.push({name:n.name,size:n.size,type:n.type})}return e}(t);if("u">typeof File&&t instanceof File)return{name:t.name,size:t.size,type:t.type};if("u">typeof DOMTokenList&&t instanceof DOMTokenList)return Array.from(t);if("u">typeof TimeRanges&&t instanceof TimeRanges){let e=[];for(let i=0;t.length>i;i++)try{e.push({start:t.start(i),end:t.end(i)})}catch{}return e}if(Array.isArray(t))return t.map(t=>p(t)).filter(t=>void 0!==t);if(t&&"object"==typeof t)try{return JSON.parse(JSON.stringify(t))}catch{return}}function m(t,e,i){let n=t?u(t):null;if(!n)return{ok:0,reason:"missing_element"};let r="string"==typeof e?e.trim():"";if(!r)return{ok:0,reason:"missing_property"};try{return n[r]=i,{ok:1}}catch(t){return{ok:0,reason:"set_failed",error:t}}}function y(t,e,i){if(t&&"string"==typeof e&&0!==e.length)switch(e){case"path":case"query":case"hash":case"replace":!function(t,e,i){let n=Lt.get(t);if(null==i||""===i){if(!n)return;return delete n[e],void(!n.path&&!n.query&&!n.hash&&!n.replace&&Lt.delete(t))}n||(n={},Lt.set(t,n)),n[e]=i}(t,e,i)}}function g(t){return Array.isArray(t)?t.map(t=>{let e={event:t?.event||"",handler:t?.handler||""};return Array.isArray(t?.listen)&&t.listen.length>0&&(e.listen=[...t.listen]),Array.isArray(t?.props)&&t.props.length>0&&(e.props=[...t.props]),e}):[]}function b(t){let e=qt.get(t);if(!e)return;let i=Dt.get(t)??[];if(!Array.isArray(i)||0===i.length)return void It.delete(e);let n=new Map;for(let t of i){if(!t||"string"!=typeof t.event||"string"!=typeof t.handler)continue;let e=t.event.trim(),i=t.handler.trim();0===e.length||0===i.length||n.set(e,i)}0!==n.size?It.set(e,n):It.delete(e)}function w(t){if(Dt.clear(),t&&"object"==typeof t)for(let[e,i]of Object.entries(t)){let t=+e;Number.isNaN(t)||Dt.set(t,g(i))}qt.forEach((t,e)=>{b(e)})}function v(t,e){Number.isFinite(t)&&(Dt.set(t,Array.isArray(e)?g(e):[]),b(t))}function x(t){let e=qt.get(t);e&&(It.delete(e),function(t){t&&Lt.delete(t)}(e)),qt.delete(t)}function k(t){if(!t.hasAttribute("href")&&!t.hasAttribute("xlink:href"))return 0;let e=t instanceof HTMLAnchorElement,i="http://www.w3.org/2000/svg"===t.namespaceURI&&"a"===t.tagName.toLowerCase();return e||i}function E(t){if(t)for(let[e,i]of Object.entries(t)){let t=_t.get(e);if(t)for(let e of I(t))R(e);_t.set(e,i);for(let t of I(i))T(t)}}function M(){_t.clear(),Tt.clear(),C()}function O(t){Wt=t}function A(t){return zt.has(t)}function N(t){if(Rt.has(t))return;let i=A(t),n=i=>{Ft&&function(t,i,n){let r=t.target;if(!(r&&r instanceof Element))return;if(Wt)try{Wt(t,i)}catch{}let o=function(t,e){let i=t;for(;i&&i!==document.documentElement;){let t=It.get(i);if(t&&t.size>0){let n=t.get(e);if(n){let t=_t.get(n);if(!t||D(t,e))return{id:n,element:i}}for(let[n,r]of t.entries()){if(n===e)continue;let t=_t.get(r);if(t&&D(t,e))return{id:r,element:i}}}i=i.parentElement}return null}(r,i);if(o){let s=_t.get(o.id);if(s&&D(s,i)){let l=e(o.element,i),a=function(t,e){let i=[],n=new Set,r=t=>{if(Array.isArray(t))for(let e of t)"string"!=typeof e||0===e.length||n.has(e)||(n.add(e),i.push(e))};return r(t),r(e),i.length>0?i:void 0}(s.props,l?.props),u=S(t,r,a,o.element,l?.element??null),f=Lt.get(o.element);if(f&&(void 0!==f.path&&void 0===u["currentTarget.dataset.routerPath"]&&(u["currentTarget.dataset.routerPath"]=f.path),void 0!==f.query&&void 0===u["currentTarget.dataset.routerQuery"]&&(u["currentTarget.dataset.routerQuery"]=f.query),void 0!==f.hash&&void 0===u["currentTarget.dataset.routerHash"]&&(u["currentTarget.dataset.routerHash"]=f.hash),void 0!==f.replace&&void 0===u["currentTarget.dataset.routerReplace"]&&(u["currentTarget.dataset.routerReplace"]=f.replace)),l&&l.notify(u),"submit"===i&&t.preventDefault(),"click"===i){let e=j(r);e&&_(t,e)&&t.preventDefault()}return void n({hid:o.id,payload:u})}}let s=e(r,i);if(s){let e=S(t,r,s.props,s.element,s.element);return s.notify(e),void n({hid:s.id,payload:e})}if("click"===i&&Ut&&t instanceof MouseEvent){let e=j(r);if(e&&_(t,e)){let i=e.getAttribute("href")??e.getAttribute("xlink:href");if(i)try{let e=new URL(i,window.location.href),n=e.pathname,r=e.search.substring(1),o=e.hash.startsWith("#")?e.hash.substring(1):e.hash;if(Ut(n,r,o))return t.preventDefault(),void t.stopPropagation()}catch{}}}}(i,t,Ft)};document.addEventListener(t,n,i),Rt.set(t,n)}function C(){Tt.forEach((t,e)=>{N(e)}),Rt.forEach((t,e)=>{!Tt.has(e)&&!$t.includes(e)&&function(t){let e=Rt.get(t);if(!e)return;let i=A(t);document.removeEventListener(t,e,i),Rt.delete(t)}(e)})}function S(t,e,i,n,r){let o={type:t.type};if((e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement)&&(o.value=e.value,e instanceof HTMLInputElement&&("checkbox"===e.type||"radio"===e.type)&&(o.checked=e.checked)),t instanceof KeyboardEvent&&(o.key=t.key,o.keyCode=t.keyCode,o.altKey=t.altKey,o.ctrlKey=t.ctrlKey,o.metaKey=t.metaKey,o.shiftKey=t.shiftKey),t instanceof MouseEvent&&(o.clientX=t.clientX,o.clientY=t.clientY),Array.isArray(i))if(i.includes("*")){let e=function(t){let e={};for(let i in t)try{let n=t[i];if("function"==typeof n||n instanceof Node||n instanceof Window||"target"===i||"currentTarget"===i||"srcElement"===i)continue;if(null!==n&&"object"==typeof n)try{JSON.stringify(n),e[i]=n}catch{continue}else e[i]=n}catch{continue}return e}(t);Object.assign(o,e)}else{let s=d(i,{event:t,target:e,handlerElement:n??null,refElement:r??null});s&&Object.assign(o,s)}return o}function j(t){let e=t;for(;e&&e!==document.documentElement;){if(k(e))return e;e=e.parentElement}return null}function _(t,e){if(0!==t.button||t.ctrlKey||t.metaKey||t.altKey||t.shiftKey||!k(e))return 0;let i=e.getAttribute("href")??e.getAttribute("xlink:href")??void 0;if(!i)return 0;let n=e.getAttribute("target");if(n&&"_self"!==n)return 0;try{let t=new URL(i,window.location.href);return!(t.origin!==window.location.origin||t.pathname===window.location.pathname&&t.search===window.location.search&&t.hash)}catch{return 0}}function T(t){let e=Tt.get(t)??0;Tt.set(t,e+1)}function R(t){let e=Tt.get(t);e&&(e>1?Tt.set(t,e-1):Tt.delete(t))}function I(t){if(!t)return[];let e=new Set,i=[];if(t.event&&(e.add(t.event),i.push(t.event)),Array.isArray(t.listen))for(let n of t.listen)"string"!=typeof n||0===n.length||e.has(n)||(e.add(n),i.push(n));return i}function D(t,e){return t?t.event===e?1:Array.isArray(t.listen)?t.listen.includes(e):0:0}function q(t){let e=new Map;return t&&t.querySelectorAll("[data-row-key]").forEach(t=>{let i=t.getAttribute("data-row-key");i&&e.set(i,t)}),e}function L(t,e){e&&(Ht.set(t,e),function(t,e){if(Number.isFinite(t)&&e){if(e instanceof Element)return qt.set(t,e),void b(t);qt.delete(t)}}(t,e))}function P(t){return Ht.get(t)??null}function $(t){x(t),Ht.delete(t)}function z(t){Jt.delete(t)}function F(){Ht.forEach((t,e)=>{x(e)}),Ht.clear(),Jt.clear()}function U(t,e){if(!Array.isArray(t))return;let i=t=>{if(e instanceof Map){let i=e.get(t);return i instanceof Element?i:null}if(e&&"object"==typeof e){let i=e[t+""];return i instanceof Element?i:null}return null};for(let e of t){if(Jt.has(e)&&Jt.get(e)?.container instanceof Element)continue;let t=i(e);t&&H(e,t)}}function W(t){let e=Jt.get(t);if(!e||!e.container)throw Error(`liveui: list slot ${t} not registered`);return e}function H(t,e,i){e&&Jt.set(t,{container:e,rows:i??q(e)})}function J(t,e,i){W(t).rows.set(e,i)}function B(t,e){return W(t).rows.get(e)??null}function G(t,e){W(t).rows.delete(e)}function V(){Bt.clear()}function K(t,e){if(!t||!e||!e.container)return null;let{container:i}=e,{startIndex:n,endIndex:r}=e;if(!Number.isFinite(n)||!Number.isFinite(r))return null;let o=Math.max(0,Math.trunc(n)),s=Math.trunc(r);if(!Number.isFinite(s))return null;o>s&&(s=o-1);let l={container:i,startIndex:o,endIndex:s};return Bt.set(t,l),l}function Q(t){return t?Bt.get(t)??null:null}function Z(){}function X(){}function Y(t){return Array.isArray(t)?t.filter(t=>Number.isInteger(t)):[]}function tt(t,e){let i=t.childNodes.length-1;return 0>i||0>e?0:e>i?i:e}function et(t,e){if(!e||e.startIndex>e.endIndex)return null;let i=it(e,Y(t.parentPath));if(!i)return null;let n=i.parentNode??e.container,r=function(t,e){if(!t||!e)return-1;let i=t.childNodes;for(let t=0;i.length>t;t++)if(i.item(t)===e)return t;return-1}(n,i);return 0>r?null:{container:n,startIndex:r,endIndex:r}}function it(t,e){if(!t||t.startIndex>t.endIndex)return null;let i=Y(e),n=tt(t.container,t.startIndex),r=t.container.childNodes.item(n)??null;if(!r)return null;if(0===i.length)return r;for(let t of i){if(!(r instanceof Element||r instanceof DocumentFragment))return null;let e=tt(r,t);if(r=r.childNodes.item(e)??null,!r)return null}return r}function nt(t,e){let i=new Map;if(!Array.isArray(t))return i;for(let n of t){if(!n)continue;let t=+n.slot;if(!Number.isInteger(t)||0>t||i.has(t))continue;let r=e?.get(n.componentId)??Q(n.componentId);if(!r){X(Array.from(e?.keys()??[]));continue}let o=it(r,n.elementPath);if(!o){X();continue}let s=o,l=+n.textChildIndex;if(Number.isInteger(l)&&l>=0)if(o instanceof Text)s=o;else if(o instanceof Element||o instanceof DocumentFragment){let t=o.childNodes.item(l)??null;if(!t&&"u">typeof document){t=document.createTextNode("");let e=o.childNodes.length>l?o.childNodes.item(l):null;o.insertBefore(t,e)}s=t}else s=null;s?(Z(),i.set(t,s)):X(Element)}return i}function rt(t,e){let i=new Map;if(!Array.isArray(t))return i;for(let n of t){if(!n)continue;let t=+n.slot;if(!Number.isInteger(t)||0>t||i.has(t))continue;let r=e?.get(n.componentId)??Q(n.componentId);if(!r){X(Array.from(e?.keys()??[]));continue}let o=it(r,n.elementPath);o instanceof Element?(Z(),i.set(t,o)):X()}return i}function ot(t,e){let i=function(t,e){let i=new Map;if(!Array.isArray(t)||0===t.length)return i;let n=function(t){if(t&&t instanceof Document)return t.body??t;if(t&&"childNodes"in t)return t;if("u">typeof document)return document.body??document;throw Error("liveui: unable to resolve root container for manifest resolution")}(e?.root??null),r=e?.baseRange??function(t){let e=t.childNodes.length;return{container:t,startIndex:0,endIndex:e>0?e-1:-1}}(n),o=e?.baseId??"";e?.baseRange&&o&&i.set(o,e.baseRange);let s=new Map;for(let e of t)!e||"string"!=typeof e.componentId||s.set(e.componentId,e);let l=1;for(;s.size>0&&l;){l=0;for(let[t,e]of Array.from(s.entries())){let n=e.parentId??"",a=null;if(n?a=i.get(n)??Q(n):(a=o?i.get(o)??null:null,a||(a=r)),!a)continue;let u=et(e,a);u?(i.set(t,u),s.delete(t),l=1):s.delete(t)}}return i}(t,e);return function(t){if(t){if(t instanceof Map){for(let[e,i]of Array.from(t.entries())){let n=K(e,i);n?t.set(e,n):t.delete(e)}return}for(let[e,i]of Object.entries(t)){let n=K(e,i);n?t[e]=n:delete t[e]}}}(i),i}function st(t,e,i){let n=function(t,e,i){let n=null;return n=t&&t.length>0?i?.overrides?.get(t)??Q(t):i?.fallbackRange??null,n?it(n,e??void 0):null}(t,e,{overrides:i?.overrides,fallbackRange:i?.fallbackRange??null});return n instanceof Element?n:null}function lt(t,e){if(Array.isArray(t)&&0!==t.length)for(let i of t){if(!i)continue;let t=st(i.componentId??"",i.path??void 0,e);t&&(void 0!==i.pathValue&&y(t,"path",i.pathValue??""),void 0!==i.query&&y(t,"query",i.query??""),void 0!==i.hash&&y(t,"hash",i.hash??""),void 0!==i.replace&&y(t,"replace",i.replace??""))}}function at(t,e){if(Array.isArray(t)&&0!==t.length)for(let i of t){if(!i||"string"!=typeof i.refId||0===i.refId.length)continue;let t=st(i.componentId??"",i.path??void 0,e);t&&c(i.refId,t)}}function ut(t){if("string"!=typeof t||0===t.length)return;let e=Vt.get(t);e&&(Gt.delete(e),Vt.delete(t)),function(t){for(let[e,i]of Kt.entries())i.delete(t)&&0===i.size&&Kt.delete(e)}(t)}function ft(t,e){if(!t||"string"!=typeof t.uploadId)return 0;let i=function(t,e,i){if("string"!=typeof t||0===t.length)return null;let n=i?.get(t)??Q(t);return n?it(n,e):null}(t.componentId,t.path,e);if(!(i instanceof HTMLInputElement))return 0;i.type&&"file"!==i.type.toLowerCase()&&(i.type="file"),ut(t.uploadId),function(t,e){Array.isArray(e.accept)&&e.accept.length>0?t.setAttribute("accept",e.accept.join(",")):t.removeAttribute("accept"),e.multiple?t.setAttribute("multiple","multiple"):t.removeAttribute("multiple")}(i,t);let n={id:t.uploadId,multiple:!!t.multiple};return Array.isArray(t.accept)&&t.accept.length>0&&(n.accept=[...t.accept]),"number"==typeof t.maxSize&&!Number.isNaN(t.maxSize)&&(n.maxSize=t.maxSize),Gt.set(i,n),Vt.set(t.uploadId,i),1}function ct(t,e,i){if("string"!=typeof t||0===t.length)return;let n=Kt.get(t);if(n&&(n.forEach(t=>ut(t)),Kt.delete(t)),!Array.isArray(e)||0===e.length)return;let r=new Set;for(let n of e)n&&"string"==typeof n.uploadId&&ft({...n,componentId:t},i)&&r.add(n.uploadId);r.size>0&&Kt.set(t,r)}function ht(t,e){if(!Array.isArray(t)||0===t.length)return;let i=new Map;for(let e of t){if(!e||"string"!=typeof e.componentId)continue;let t=i.get(e.componentId)??[];t.push(e),i.set(e.componentId,t)}for(let[t,n]of i.entries())ct(t,n,e)}function dt(t,e){Kt.forEach(t=>{t.forEach(t=>ut(t))}),Kt.clear(),Vt.clear(),Array.isArray(t)&&0!==t.length&&ht(t,e)}function pt(t){if(Zt.enableFragmentPooling&&te.has(t))return te.get(t).cloneNode(1);Yt.innerHTML=t;let e=Yt.content.cloneNode(1);return Zt.enableFragmentPooling&&50>te.size&&te.set(t,e.cloneNode(1)),e}function mt(t,e){return Zt.enableVirtualScrolling&&e>Zt.virtualScrollThreshold}function yt(t,e){let i=function(t,e){if(!t)throw Error(`liveui: slot ${e} not registered`);return t}(P(t),t);Zt.enableDirtyChecking&&i.textContent===e||(Zt.enableBatching?ie.scheduleWrite(()=>{i.textContent=e}):i.textContent=e)}function gt(t,e,i){let n=P(t);if(!(n instanceof Element))throw Error(`liveui: slot ${t} is not an element`);let r=function(t){let e=Dt.get(t);if(e)return g(e)}(t)??[],o=new Map;for(let t of r)!t||"string"!=typeof t.event||o.set(t.event,{handler:t.handler,listen:t.listen?[...t.listen]:void 0,props:t.props?[...t.props]:void 0});let s=t=>{if("string"!=typeof t)return;let e=t.split(/\s+/).map(t=>t.trim()).filter(t=>t.length>0);return e.length>0?e:void 0},l=0;if(e)for(let t of Object.keys(e)){if("string"==typeof t&&t.startsWith(Pt)){let i=t.slice(Pt.length);y(n,i,e[t]),delete e[t];continue}if("string"!=typeof t||!t.startsWith(Xt))continue;l=1;let i=e[t];delete e[t];let r=t.slice(Xt.length);if(r.startsWith("-")&&(r=r.slice(1)),0===r.length)continue;let a="",u=r.indexOf("-");-1!==u&&(a=r.slice(u+1),r=r.slice(0,u));let f=r.trim();if(0===f.length)continue;let c=o.get(f)??{};"listen"===a?c.listen=s(i):"props"===a?c.props=s(i):c.handler="string"==typeof i?i:null!=i?i+"":"",o.set(f,c)}if(Array.isArray(i)&&i.length>0)for(let t=i.length-1;t>=0;t--){let e=i[t];if("string"==typeof e&&e.startsWith(Pt)){let r=e.slice(Pt.length);y(n,r,void 0),i.splice(t,1);continue}if("string"!=typeof e||!e.startsWith(Xt))continue;l=1,i.splice(t,1);let r=e.slice(Xt.length);if(r.startsWith("-")&&(r=r.slice(1)),0===r.length)continue;let s=r.indexOf("-");-1!==s&&(r=r.slice(0,s));let a=r.trim();0!==a.length&&o.delete(a)}if(l){let e=[];o.forEach((t,i)=>{let n=t.handler?.trim();if(!n)return;let r={event:i,handler:n};t.listen&&t.listen.length>0&&(r.listen=[...t.listen]),t.props&&t.props.length>0&&(r.props=[...t.props]),e.push(r)}),v(t,e)}let a=()=>{if(e)for(let[t,i]of Object.entries(e))null!=i&&(Zt.enableDirtyChecking&&n.getAttribute(t)===i+""||n.setAttribute(t,i+""));if(i)for(let t of i)n.hasAttribute(t)&&n.removeAttribute(t)};Zt.enableBatching?ie.scheduleWrite(a):a()}function bt(t,e){let i=t.attributes,n=e.attributes;for(let n=i.length-1;n>=0;n--){let r=i[n];e.hasAttribute(r.name)||t.removeAttribute(r.name)}for(let e=0;n.length>e;e++){let i=n[e];t.getAttribute(i.name)!==i.value&&t.setAttribute(i.name,i.value)}1===t.childNodes.length&&t.firstChild?.nodeType===Node.TEXT_NODE&&1===e.childNodes.length&&e.firstChild?.nodeType===Node.TEXT_NODE&&t.firstChild.textContent!==e.firstChild.textContent&&(t.firstChild.textContent=e.firstChild.textContent)}function wt(t,e,i){if(!t)return;let n=Array.isArray(t.slots)?t.slots.filter(t=>Number.isInteger(t)&&t>=0):[],r=new Set(n),o=nt(t.slotPaths,i);if(o.size>0)if(r.size>0)for(let t of Array.from(r)){let e=o.get(t);e&&(L(t,e),r.delete(t))}else for(let[t,e]of o.entries())L(t,e);let s=rt(t.listPaths,i);for(let[t,e]of s.entries())H(t,e);r.size>0&&n.length>0&&r.forEach(()=>{})}function vt(t,e){if(!Array.isArray(e)||0===e.length)return;let i=W(t),n=i.container,r=Zt.enableBatching?Array.from(n.children):null,o=i.rows.size;for(let i of e)if(i&&i.length)switch(i[0]){case"del":{let e=i[1],r=B(t,e);if(r&&r.parentNode===n){let t=()=>{a(r),n.removeChild(r)};Zt.enableBatching?ie.scheduleWrite(t):t()}G(t,e),o--;break}case"ins":{let e=i[1],s=i[2]||{key:"",html:""},l=s&&"object"==typeof s?s.bindings??null:null;if(l?.slots)for(let[t,e]of Object.entries(l.slots)){let i=+t;Number.isNaN(i)||v(i,e??[])}let a,u=ee.key("ins",t,s.html);Zt.enableMemoization&&ee.has(u)?a=ee.get(u).cloneNode(1):(a=pt(s.html||""),Zt.enableMemoization&&ee.set(u,a.cloneNode(1)));let f=Array.from(a.childNodes);if(0===f.length)break;let c=()=>{n.insertBefore(a,Zt.enableBatching?r[e]||null:n.children[e]||null);let i=f[0];if(i instanceof Element){J(t,s.key,i);let n=ot(s.componentPaths);wt(s,0,n);let r={overrides:n};if(lt(l?.router??null,r),at(l?.refs??null,r),ht(l?.uploads??null,n),mt(0,o)){let n=ne.get(t);n&&(n.visibleRange.start>e||e>n.visibleRange.end)&&(i instanceof HTMLElement||i instanceof SVGElement)&&(i.style.display="none")}}};Zt.enableBatching?ie.scheduleWrite(c):c(),o++;break}case"mov":{let t=i[1],e=i[2];if(t===e)break;let o=()=>{let i=Zt.enableBatching?r:Array.from(n.children),o=i[t];o&&n.insertBefore(o,i.length>e?i[e]:null)};Zt.enableBatching?ie.scheduleWrite(o):o();break}}if(mt(0,o)){let e=ne.get(t);e?e.totalItems=o:function(t,e){if(!Zt.enableVirtualScrolling)return;let i={container:e,totalItems:0,visibleRange:{start:0,end:50},itemHeight:0};i.observer=new IntersectionObserver(t=>{t.forEach(t=>{if(t.isIntersecting){let e=t.target;(e instanceof HTMLElement||e instanceof SVGElement)&&(e.style.display="")}})},{root:e,threshold:.1}),ne.set(t,i)}(t,n)}}function xt(t){if(Array.isArray(t)){for(let e of t)if(e&&0!==e.length)switch(e[0]){case"setText":yt(e[1],e[2]);break;case"setAttrs":gt(e[1],e[2]||{},e[3]||[]);break;case"list":vt(e[1],e.slice(2))}Zt.enableBatching&&ie.immediate()}}function kt(t){Object.assign(Zt,t)}function Et(){return{...Zt}}function Mt(){te.clear(),ee.clear(),ne.clear()}function Ot(){return{htmlCacheSize:te.size,memoizerCacheSize:ee.cache.size,virtualScrollCount:ne.size}}function At({force:t=0}={}){let e=typeof window>"u"?null:window;return e?(t&&(ce=null),ce||(ce=function(t){return new Promise((e,i)=>{let n=()=>{try{let i=function(t){let e={...t.i??{}},i=function(t){let e=t.o;if(e&&"object"==typeof e&&"string"==typeof e.sid)return e;if(typeof document>"u")return null;let i=document.getElementById("live-boot")?.textContent;if(!i)return null;try{let e=JSON.parse(i);return t.o=e,e}catch{return null}}(t),n=i??e.boot??null,r=0!=e.autoConnect,o={...e,autoConnect:0},s="boolean"==typeof n?.client?.debug?n.client.debug:void 0;"u">typeof s?o.debug=s:typeof o.debug>"u"&&(o.debug=1),n&&(o.boot=n,i||(t.o=n));let l=new fe(o);return function(t,e){let i=fe;Object.assign(i,{instance:e,dom:Ct,applyOps:xt,patcher:{configure:kt,getConfig:Et,clearCaches:Mt,getStats:Ot,morphElement:bt},boot:At}),t.LiveUI=i,t.LiveUIInstance=e,t.l&&(t.l.installed=1,t.l.instance=e)}(t,l),r&&n&&l.connect().catch(()=>{}),l}(t);e(i)}catch(t){i(t)}};if("u">typeof document&&"loading"===document.readyState){let t=()=>{document.removeEventListener("DOMContentLoaded",t),n()};document.addEventListener("DOMContentLoaded",t)}else n()})}(e)),ce):Promise.reject(Error("LiveUI: window is not available for bootstrapping."))}var Nt,Ct,St,jt,_t,Tt,Rt,It,Dt,qt,Lt,Pt,$t,zt,Ft,Ut,Wt,Ht,Jt,Bt,Gt,Vt,Kt,Qt,Zt,Xt,Yt,te,ee,ie,ne,re,oe,se,le,ae,ue,fe,ce,he,de,pe=Object.create,me=Object.defineProperty,ye=Object.getOwnPropertyDescriptor,ge=Object.getOwnPropertyNames,be=Object.getPrototypeOf,we={}.hasOwnProperty,ve=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),xe=(t,e)=>{for(var i in e)me(t,i,{get:e[i],enumerable:1})},ke=(t,e,i,n)=>{if(e&&"object"==typeof e||"function"==typeof e)for(let r of ge(e))!we.call(t,r)&&r!==i&&me(t,r,{get:()=>e[r],enumerable:!(n=ye(e,r))||n.enumerable});return t},Ee=ve(t=>{var e,i,n=t&&t.u||function(t,e,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(t,i):r?r.value=i:e.set(t,i),i},r=t&&t.h||function(t,e,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(t):n?n.value:e.get(t)};Object.defineProperty(t,"p",{value:1}),t.Subject=void 0,t.Subject=class{constructor(){e.set(this,void 0),i.set(this,void 0),n(this,e,0,"f"),n(this,i,new Set,"f")}get size(){return r(this,i,"f").size}subscribe(t){if(r(this,e,"f"))throw Error("Cannot subscribe to a closed subject");return r(this,i,"f").add(t),()=>r(this,i,"f").delete(t)}publish(t){r(this,i,"f").forEach(e=>e(t))}close(){r(this,i,"f").clear(),n(this,e,1,"f")}},e=new WeakMap,i=new WeakMap}),Me=ve(t=>{var e,i,n=t&&t.u||function(t,e,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(t,i):r?r.value=i:e.set(t,i),i},r=t&&t.h||function(t,e,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(t):n?n.value:e.get(t)};Object.defineProperty(t,"p",{value:1}),t.BehaviorSubject=void 0,i=Ee(),t.BehaviorSubject=class extends i.Subject{constructor(t){super(),e.set(this,void 0),n(this,e,t,"f")}get value(){return r(this,e,"f")}publish(t){n(this,e,t,"f"),super.publish(t)}subscribe(t){return r(this,e,"f")&&t(r(this,e,"f")),super.subscribe(t)}},e=new WeakMap}),Oe=ve(t=>{var e=t&&t.m||(Object.create?function(t,e,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(e,i);(!r||("get"in r?!e.p:r.writable||r.configurable))&&(r={enumerable:1,get:function(){return e[i]}}),Object.defineProperty(t,n,r)}:function(t,e,i,n){void 0===n&&(n=i),t[n]=e[i]}),i=t&&t.v||function(t,i){for(var n in t)"default"!==n&&!{}.hasOwnProperty.call(i,n)&&e(i,t,n)};Object.defineProperty(t,"p",{value:1}),i(Me(),t),i(Ee(),t)}),Ae=ve(t=>{var e,i,n,r,o,s,l,a,u,f;Object.defineProperty(t,"p",{value:1}),t.PubSubEvents=t.Events=t.ChannelReceiver=t.SystemSender=t.ErrorTypes=t.ChannelState=t.ClientActions=t.ServerActions=t.PresenceEventTypes=void 0,(f=e||(t.PresenceEventTypes=e={})).JOIN="JOIN",f.LEAVE="LEAVE",f.UPDATE="UPDATE",function(t){t.PRESENCE="PRESENCE",t.SYSTEM="SYSTEM",t.BROADCAST="BROADCAST",t.ERROR="ERROR",t.CONNECT="CONNECT"}(i||(t.ServerActions=i={})),function(t){t.JOIN_CHANNEL="JOIN_CHANNEL",t.LEAVE_CHANNEL="LEAVE_CHANNEL",t.BROADCAST="BROADCAST"}(n||(t.ClientActions=n={})),function(t){t.IDLE="IDLE",t.JOINING="JOINING",t.JOINED="JOINED",t.STALLED="STALLED",t.CLOSED="CLOSED"}(r||(t.ChannelState=r={})),function(t){t.UNAUTHORIZED_CONNECTION="UNAUTHORIZED_CONNECTION",t.UNAUTHORIZED_JOIN_REQUEST="UNAUTHORIZED_JOIN_REQUEST",t.UNAUTHORIZED_BROADCAST="UNAUTHORIZED_BROADCAST",t.INVALID_MESSAGE="INVALID_MESSAGE",t.HANDLER_NOT_FOUND="HANDLER_NOT_FOUND",t.PRESENCE_ERROR="PRESENCE_ERROR",t.CHANNEL_ERROR="CHANNEL_ERROR",t.ENDPOINT_ERROR="ENDPOINT_ERROR",t.INTERNAL_SERVER_ERROR="INTERNAL_SERVER_ERROR"}(o||(t.ErrorTypes=o={})),function(t){t.ENDPOINT="ENDPOINT",t.CHANNEL="CHANNEL"}(s||(t.SystemSender=s={})),function(t){t.ALL_USERS="ALL_USERS",t.ALL_EXCEPT_SENDER="ALL_EXCEPT_SENDER"}(l||(t.ChannelReceiver=l={})),function(t){t.ACKNOWLEDGE="ACKNOWLEDGE",t.CONNECTION="CONNECTION"}(a||(t.Events=a={})),function(t){t.MESSAGE="MESSAGE",t.PRESENCE="PRESENCE",t.GET_PRESENCE="GET_PRESENCE"}(u||(t.PubSubEvents=u={}))}),Ne=ve(t=>{Object.defineProperty(t,"p",{value:1}),t.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{let e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})}}),Ce=ve(t=>{Object.defineProperty(t,"p",{value:1})}),Se=ve(t=>{var e=t&&t.m||(Object.create?function(t,e,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(e,i);(!r||("get"in r?!e.p:r.writable||r.configurable))&&(r={enumerable:1,get:function(){return e[i]}}),Object.defineProperty(t,n,r)}:function(t,e,i,n){void 0===n&&(n=i),t[n]=e[i]}),i=t&&t.v||function(t,i){for(var n in t)"default"!==n&&!{}.hasOwnProperty.call(i,n)&&e(i,t,n)};Object.defineProperty(t,"p",{value:1}),i(Ne(),t),i(Ce(),t)}),je=ve(t=>{function e(t){return"object"==typeof t&&null!==t&&!Array.isArray(t)}function i(t,e){if(!function(t){return"string"==typeof t}(t))throw new l("Expected string, got "+typeof t,e)}function n(t,i){if(!e(t))throw new l("Expected object, got "+typeof t,i)}function r(t,i){if(!function(t){return e(t)?Object.keys(t).every(t=>"string"==typeof t):0}(t))throw new l("Expected record with string keys, got "+typeof t,i)}function o(t,e,i){let n=Object.values(e);if(!n.includes(t))throw new l(`Expected one of [${n.join(", ")}], got ${JSON.stringify(t)}`,i)}Object.defineProperty(t,"p",{value:1}),t.channelEventSchema=t.serverMessageSchema=t.presenceMessageSchema=t.clientMessageSchema=t.ValidationError=void 0;var s=Ae(),l=class extends Error{constructor(t,e){super(e?`${e}: ${t}`:t),this.path=e,this.name="ValidationError"}};t.ValidationError=l,t.clientMessageSchema={parse(t){n(t,"clientMessage");let e=t;if(!("event"in e))throw new l("Missing required field","event");if(!("requestId"in e))throw new l("Missing required field","requestId");if(!("channelName"in e))throw new l("Missing required field","channelName");if(!("payload"in e))throw new l("Missing required field","payload");if(!("action"in e))throw new l("Missing required field","action");return i(e.event,"event"),i(e.requestId,"requestId"),i(e.channelName,"channelName"),r(e.payload,"payload"),o(e.action,s.ClientActions,"action"),{event:e.event,requestId:e.requestId,channelName:e.channelName,payload:e.payload,action:e.action}}},t.presenceMessageSchema={parse(t){n(t,"presenceMessage");let e=t;if(!("requestId"in e))throw new l("Missing required field","requestId");if(!("channelName"in e))throw new l("Missing required field","channelName");if(!("event"in e))throw new l("Missing required field","event");if(!("action"in e))throw new l("Missing required field","action");if(!("payload"in e))throw new l("Missing required field","payload");if(i(e.requestId,"requestId"),i(e.channelName,"channelName"),o(e.event,s.PresenceEventTypes,"event"),e.action!==s.ServerActions.PRESENCE)throw new l(`Expected ${s.ServerActions.PRESENCE}, got ${JSON.stringify(e.action)}`,"action");n(e.payload,"payload");let a=e.payload;if(!("presence"in a))throw new l("Missing required field","payload.presence");if(!("changed"in a))throw new l("Missing required field","payload.changed");return function(t){if(!function(t){return Array.isArray(t)}(t))throw new l("Expected array, got "+typeof t,"payload.presence")}(a.presence),a.presence.forEach((t,e)=>{r(t,`payload.presence[${e}]`)}),r(a.changed,"payload.changed"),{requestId:e.requestId,channelName:e.channelName,event:e.event,action:s.ServerActions.PRESENCE,payload:{presence:a.presence,changed:a.changed}}}},t.serverMessageSchema={parse(t){n(t,"serverMessage");let e=t;if(!("event"in e))throw new l("Missing required field","event");if(!("requestId"in e))throw new l("Missing required field","requestId");if(!("channelName"in e))throw new l("Missing required field","channelName");if(!("payload"in e))throw new l("Missing required field","payload");if(!("action"in e))throw new l("Missing required field","action");i(e.event,"event"),i(e.requestId,"requestId"),i(e.channelName,"channelName"),r(e.payload,"payload");let o=[s.ServerActions.BROADCAST,s.ServerActions.CONNECT,s.ServerActions.ERROR,s.ServerActions.SYSTEM];if(!o.includes(e.action))throw new l(`Expected one of [${o.join(", ")}], got ${JSON.stringify(e.action)}`,"action");return{event:e.event,requestId:e.requestId,channelName:e.channelName,payload:e.payload,action:e.action}}},t.channelEventSchema={parse(e){n(e,"channelEvent");let i=e;if(!("action"in i))throw new l("Missing required field","action");return i.action===s.ServerActions.PRESENCE?t.presenceMessageSchema.parse(e):t.serverMessageSchema.parse(e)}}}),_e=ve(t=>{var e=t&&t.m||(Object.create?function(t,e,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(e,i);(!r||("get"in r?!e.p:r.writable||r.configurable))&&(r={enumerable:1,get:function(){return e[i]}}),Object.defineProperty(t,n,r)}:function(t,e,i,n){void 0===n&&(n=i),t[n]=e[i]}),i=t&&t.v||function(t,i){for(var n in t)"default"!==n&&!{}.hasOwnProperty.call(i,n)&&e(i,t,n)};Object.defineProperty(t,"p",{value:1}),i(Oe(),t),i(Ae(),t),i(Se(),t),i(je(),t)}),Te=ve(t=>{var e,i,n,r,o,s,l,a,u,f,c,h,d,p,m,y,g=t&&t.u||function(t,e,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(t,i):r?r.value=i:e.set(t,i),i},b=t&&t.h||function(t,e,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(t):n?n.value:e.get(t)};Object.defineProperty(t,"p",{value:1}),t.Channel=void 0,y=_e(),t.Channel=class{constructor(t,c,h,d){e.add(this),i.set(this,void 0),n.set(this,void 0),r.set(this,void 0),o.set(this,void 0),s.set(this,void 0),l.set(this,void 0),a.set(this,void 0),u.set(this,void 0),f.set(this,void 0),g(this,i,h,"f"),g(this,n,[],"f"),g(this,r,[],"f"),g(this,l,d,"f"),g(this,s,t,"f"),g(this,u,c,"f"),g(this,a,new y.Subject,"f"),g(this,f,new y.BehaviorSubject(y.ChannelState.IDLE),"f"),g(this,o,()=>{},"f")}get channelState(){return b(this,f,"f").value}get presence(){return b(this,r,"f")}acknowledge(t){b(this,f,"f").publish(y.ChannelState.JOINED),b(this,e,"m",h).call(this,t),b(this,e,"m",c).call(this)}join(){let t={action:y.ClientActions.JOIN_CHANNEL,event:y.ClientActions.JOIN_CHANNEL,payload:b(this,l,"f"),channelName:b(this,i,"f"),requestId:(0,y.uuid)()};if(b(this,f,"f").value!==y.ChannelState.JOINED)if(b(this,f,"f").publish(y.ChannelState.JOINING),b(this,u,"f").value)b(this,s,"f").call(this,t);else{let e=b(this,u,"f").subscribe(i=>{i&&(e(),b(this,f,"f").value===y.ChannelState.JOINING&&b(this,s,"f").call(this,t))})}}leave(){let t={action:y.ClientActions.LEAVE_CHANNEL,event:y.ClientActions.LEAVE_CHANNEL,channelName:b(this,i,"f"),requestId:(0,y.uuid)(),payload:{}};b(this,e,"m",p).call(this,t),b(this,f,"f").publish(y.ChannelState.CLOSED),b(this,o,"f").call(this)}onChannelStateChange(t){return b(this,f,"f").subscribe(e=>{t(e)})}onJoin(t){return b(this,e,"m",m).call(this,(e,i)=>{if(e===y.PresenceEventTypes.JOIN)return t(i.changed)})}onLeave(t){return b(this,e,"m",m).call(this,(e,i)=>{if(e===y.PresenceEventTypes.LEAVE)return t(i.changed)})}onMessage(t){return b(this,e,"m",d).call(this,(e,i)=>{t(e,i)})}onMessageEvent(t,e){return this.onMessage((i,n)=>{if(i===t)return e(n)})}onPresenceChange(t){return b(this,e,"m",m).call(this,(e,i)=>{if(e===y.PresenceEventTypes.UPDATE)return t(i)})}onUsersChange(t){return b(this,e,"m",m).call(this,(e,i)=>t(i.presence))}sendMessage(t,n){let r=(0,y.uuid)(),o={action:y.ClientActions.BROADCAST,channelName:b(this,i,"f"),requestId:r,event:t,payload:n};b(this,e,"m",p).call(this,o)}sendForResponse(t,n){let r=(0,y.uuid)();return new Promise(o=>{let s=b(this,e,"m",d).call(this,(t,e,i)=>{r===i&&(o(e),s())}),l={action:y.ClientActions.BROADCAST,channelName:b(this,i,"f"),requestId:r,event:t,payload:n};b(this,e,"m",p).call(this,l)})}},i=new WeakMap,n=new WeakMap,r=new WeakMap,o=new WeakMap,s=new WeakMap,l=new WeakMap,a=new WeakMap,u=new WeakMap,f=new WeakMap,e=new WeakSet,c=function(){b(this,n,"f").forEach(t=>b(this,s,"f").call(this,t)),g(this,n,[],"f")},h=function(t){b(this,o,"f").call(this);let n=t.subscribe(t=>{t.channelName===b(this,i,"f")&&this.channelState===y.ChannelState.JOINED&&b(this,a,"f").publish(t)}),c=b(this,u,"f").subscribe(t=>{if(t&&b(this,f,"f").value===y.ChannelState.STALLED){let t={action:y.ClientActions.JOIN_CHANNEL,event:y.ClientActions.JOIN_CHANNEL,payload:b(this,l,"f"),channelName:b(this,i,"f"),requestId:(0,y.uuid)()};b(this,s,"f").call(this,t)}else!t&&b(this,f,"f").value===y.ChannelState.JOINED&&b(this,f,"f").publish(y.ChannelState.STALLED)}),h=b(this,e,"m",m).call(this,(t,e)=>{g(this,r,e.presence,"f")});g(this,o,()=>{n(),c(),h()},"f")},d=function(t){return b(this,a,"f").subscribe(e=>{if(e.action!==y.ServerActions.PRESENCE)return t(e.event,e.payload,e.requestId)})},p=function(t){if(b(this,f,"f").value===y.ChannelState.JOINED)return b(this,s,"f").call(this,t);b(this,n,"f").push(t)},m=function(t){return b(this,a,"f").subscribe(e=>{if(e.action===y.ServerActions.PRESENCE)return t(e.event,e.payload)})}}),Re=ve(t=>{var e,i,n,r,o,s,l,a=t&&t.u||function(t,e,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(t,i):r?r.value=i:e.set(t,i),i},u=t&&t.h||function(t,e,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(t):n?n.value:e.get(t)};Object.defineProperty(t,"p",{value:1}),t.PondClient=void 0,s=_e(),l=Te(),t.PondClient=class{constructor(t,n={}){let r;e.add(this),i.set(this,void 0);try{r=new URL(t)}catch{r=new URL(""+window.location),r.pathname=t}this.k=0;let l=new URLSearchParams(n);r.search=""+l,"wss:"!==r.protocol&&"ws:"!==r.protocol&&(r.protocol="https:"===r.protocol?"wss:":"ws:"),this.M=r,a(this,i,new Map,"f"),this.O=new s.Subject,this.A=new s.BehaviorSubject(0),u(this,e,"m",o).call(this)}connect(){this.k=0;let t=new WebSocket(""+this.M);t.onmessage=t=>{let e=t.data.trim().split("\n");for(let t of e)if(t.trim()){let e=JSON.parse(t),i=s.channelEventSchema.parse(e);this.O.publish(i)}},t.onerror=()=>t.close(),t.onclose=()=>{this.A.publish(0),!this.k&&setTimeout(()=>{this.connect()},1e3)},this.N=t}getState(){return this.A.value}disconnect(){var t;this.A.publish(0),this.k=1,null===(t=this.N)||void 0===t||t.close(),u(this,i,"f").clear()}createChannel(t,r){let o=u(this,i,"f").get(t);if(o&&o.channelState!==s.ChannelState.CLOSED)return o;let a=u(this,e,"m",n).call(this),f=new l.Channel(a,this.A,t,r||{});return u(this,i,"f").set(t,f),f}onConnectionChange(t){return this.A.subscribe(t)}},i=new WeakMap,e=new WeakSet,n=function(){return t=>{this.A.value&&this.N.send(JSON.stringify(t))}},r=function(t){var r;let o=null!==(r=u(this,i,"f").get(t.channelName))&&void 0!==r?r:new l.Channel(u(this,e,"m",n).call(this),this.A,t.channelName,{});u(this,i,"f").set(t.channelName,o),o.acknowledge(this.O)},o=function(){this.O.subscribe(t=>{t.event===s.Events.ACKNOWLEDGE?u(this,e,"m",r).call(this,t):t.event===s.Events.CONNECTION&&t.action===s.ServerActions.CONNECT&&this.A.publish(1)})}}),Ie=ve((t,e)=>{var i=function(){if("object"==typeof self&&self)return self;if("object"==typeof window&&window)return window;throw Error("Unable to resolve global `this`")};e.exports=function(){if(this)return this;if("object"==typeof globalThis&&globalThis)return globalThis;try{Object.defineProperty(Object.prototype,"C",{get:function(){return this},configurable:1})}catch{return i()}try{return __global__||i()}finally{delete Object.prototype.C}}()}),De=ve((t,e)=>{e.exports={name:"websocket",description:"Websocket Client & Server Library implementing the WebSocket protocol as specified in RFC 6455.",keywords:["websocket","websockets","socket","networking","comet","push","RFC-6455","realtime","server","client"],author:"Brian McKelvey <theturtle32@gmail.com> (https://github.com/theturtle32)",contributors:["IÃ±aki Baz Castillo <ibc@aliax.net> (http://dev.sipdoc.net)"],version:"1.0.35",repository:{type:"git",url:"https://github.com/theturtle32/WebSocket-Node.git"},homepage:"https://github.com/theturtle32/WebSocket-Node",engines:{node:">=4.0.0"},dependencies:{bufferutil:"^4.0.1",debug:"^2.2.0","es5-ext":"^0.10.63","typedarray-to-buffer":"^3.1.5","utf-8-validate":"^5.0.2",yaeti:"^0.0.6"},devDependencies:{"buffer-equal":"^1.0.0",gulp:"^4.0.2","gulp-jshint":"^2.0.4","jshint-stylish":"^2.2.1",jshint:"^2.0.0",tape:"^4.9.1"},config:{verbose:0},scripts:{test:"tape test/unit/*.js",gulp:"gulp"},main:"index",directories:{lib:"./lib"},browser:"lib/browser.js",license:"Apache-2.0"}}),qe=ve((t,e)=>{e.exports=De().version}),Le=ve((t,e)=>{function i(t,e){return e?new r(t,e):new r(t)}var n,r,o;if("object"==typeof globalThis)n=globalThis;else try{n=Ie()}catch{}finally{if(!n&&"u">typeof window&&(n=window),!n)throw Error("Could not determine global this")}r=n.WebSocket||n.MozWebSocket,o=qe(),r&&["CONNECTING","OPEN","CLOSING","CLOSED"].forEach(function(t){Object.defineProperty(i,t,{get:function(){return r[t]}})}),e.exports={w3cwebsocket:r?i:null,version:o}}),Pe=ve(t=>{Object.defineProperty(t,"p",{value:1}),t.PondClient=void 0;var e=_e(),i=Re(),n=Le().w3cwebsocket;t.PondClient=class extends i.PondClient{connect(t=1){this.k=0;let i=new n(""+this.M);i.onopen=()=>this.A.publish(1),i.onmessage=t=>{let i=t.data.trim().split("\n");for(let t of i)if(t.trim()){let i=JSON.parse(t),n=e.channelEventSchema.parse(i);this.O.publish(n)}},i.onerror=()=>i.close(),i.onclose=()=>{this.A.publish(0),!this.k&&setTimeout(()=>{this.connect()},1e3)}}}}),$e=ve(t=>{var e,i,n,r;Object.defineProperty(t,"p",{value:1}),t.PondClient=t.ChannelState=void 0,e=_e(),Object.defineProperty(t,"ChannelState",{enumerable:1,get:function(){return e.ChannelState}}),i=Re(),n=Pe(),r=typeof window>"u"?n.PondClient:i.PondClient,t.PondClient=r}),ze={};return xe(ze,{ComputedSignal:()=>oe,Signal:()=>re,applyOps:()=>xt,bootClient:()=>At,clearPatcherCaches:()=>Mt,configurePatcher:()=>kt,default:()=>fe,dom:()=>Ct,getPatcherConfig:()=>Et,getPatcherStats:()=>Ot,getRefElement:()=>u,getRefMeta:()=>f,morphElement:()=>bt}),de=null!=(he=$e())?pe(be(he)):{},Nt=ke(me(de,"default",{value:he,enumerable:1}),he),xe(Ct={},{deleteRow:()=>G,ensureList:()=>W,getRow:()=>B,getSlot:()=>P,initLists:()=>U,registerList:()=>H,registerSlot:()=>L,reset:()=>F,setRow:()=>J,unregisterList:()=>z,unregisterSlot:()=>$}),St=new Map,jt=new WeakMap,_t=new Map,Tt=new Map,Rt=new Map,It=new WeakMap,Dt=new Map,qt=new Map,Lt=new WeakMap,Pt="data-router-",$t=["click","input","change","submit"],zt=new Set(["blur","focus","mouseenter","mouseleave","pointerenter","pointerleave"]),Ft=null,Ut=null,Wt=null,Ht=new Map,Jt=new Map,Bt=new Map,Gt=new WeakMap,Vt=new Map,Kt=new Map,Qt=class{constructor(t){this.uploads=new Map,this.options=t,O((t,e)=>this.handleDomEvent(t,e))}dispose(){O(null),this.abortAll()}onDisconnect(){this.abortAll()}handleControl(t){if(!t||"cancel"!==t.op)return;let e=this.uploads.get(t.id);e?.xhr&&e.xhr.abort()}handleDomEvent(t,e){if("change"!==e)return;let i=t.target;if(!i)return;let n=this.resolveInput(i);if(!n)return;let r=function(t){if(t)return Gt.get(t)??void 0}(n)?.id;if(!r)return;let o=n.files;if(!o||0===o.length)return;let s=o[0],l=this.options.getSessionId();l&&this.options.isConnected()?(this.sendMessage({t:"upload",sid:l,id:r,op:"change",meta:this.buildMeta(s)}),this.startUpload(l,r,s,n)):l&&this.sendMessage({t:"upload",sid:l,id:r,op:"error",error:"not connected"})}startUpload(t,e,i,n){let r=this.uploads.get(e);r?.xhr&&r.xhr.abort();let o=this.options.getEndpoint();if(!o)return void this.sendMessage({t:"upload",sid:t,id:e,op:"error",error:"upload endpoint missing"});let s=this.buildUploadURL(o,t,e),l=new XMLHttpRequest;l.open("POST",s,1),l.upload.onprogress=t=>{if(!t.lengthComputable)return;let i=this.options.getSessionId();i&&this.sendMessage({t:"upload",sid:i,id:e,op:"progress",loaded:t.loaded,total:t.total})};let a=()=>{this.uploads.get(e)?.xhr===l&&this.uploads.delete(e)};l.onload=()=>{if(a(),l.status>=200&&300>l.status)return;let t=this.options.getSessionId();t&&this.sendMessage({t:"upload",sid:t,id:e,op:"error",error:"HTTP "+l.status})},l.onerror=()=>{a();let t=this.options.getSessionId();t&&this.sendMessage({t:"upload",sid:t,id:e,op:"error",error:"network error"})},l.onabort=()=>{a();let t=this.options.getSessionId();t&&this.sendMessage({t:"upload",sid:t,id:e,op:"cancelled"})};let u=new FormData;u.append("file",i,i.name),l.send(u),this.uploads.set(e,{xhr:l,input:n}),n.value=""}buildUploadURL(t,e,i){return`${t.endsWith("/")?t:t+"/"}${encodeURIComponent(e)}/${encodeURIComponent(i)}`}buildMeta(t){return{name:t.name,size:t.size,type:t.type||void 0}}resolveInput(t){if(t instanceof HTMLInputElement)return t;if(t.closest){let e=t.closest('input[type="file"][data-pond-upload]');return e instanceof HTMLInputElement?e:null}return null}sendMessage(t){try{this.options.send(t)}catch{}}abortAll(){for(let[,t]of this.uploads)try{t.xhr.abort()}catch{}this.uploads.clear()}},Zt={enableDirtyChecking:1,enableBatching:1,enableFragmentPooling:1,enableMemoization:1,enableVirtualScrolling:1,virtualScrollThreshold:100,memoizationCacheSize:1e3},Xt="data-on",Yt=document.createElement("template"),te=new Map,ee=new class{constructor(t){this.cache=new Map,this.maxSize=t}key(t,e,i){return`${t}:${e}:${JSON.stringify(i)}`}has(t){return this.cache.has(t)}get(t){return this.cache.get(t)}set(t,e){if(this.cache.size>=this.maxSize){let t=this.cache.keys().next().value;void 0!==t&&this.cache.delete(t)}this.cache.set(t,e)}clear(){this.cache.clear()}}(Zt.memoizationCacheSize),ie=new class{constructor(){this.batch={reads:[],writes:[]},this.scheduled=0}scheduleRead(t){this.batch.reads.push(t),this.schedule()}scheduleWrite(t){this.batch.writes.push(t),this.schedule()}schedule(){this.scheduled||(this.scheduled=1,requestAnimationFrame(()=>{this.flush()}))}flush(){this.batch.reads.forEach(t=>t()),this.batch.writes.forEach(t=>t()),this.batch={reads:[],writes:[]},this.scheduled=0}immediate(){this.scheduled&&this.flush()}},ne=new Map,re=class{constructor(t){this.subscribers=new Set,this.value=t}get(){return this.value}set(t){this.value!==t&&(this.value=t,this.notify())}update(t){this.set(t(this.value))}subscribe(t){return this.subscribers.add(t),t(this.value),()=>this.subscribers.delete(t)}notify(){this.subscribers.forEach(t=>t(this.value))}},oe=class{constructor(t,e){this.subscribers=new Set,this.unsubscribers=[],this.value=t(),e.forEach(e=>{let i=e.subscribe(()=>{let e=t();this.value!==e&&(this.value=e,this.notify())});this.unsubscribers.push(i)})}get(){return this.value}subscribe(t){return this.subscribers.add(t),t(this.value),()=>this.subscribers.delete(t)}destroy(){this.unsubscribers.forEach(t=>t()),this.unsubscribers=[],this.subscribers.clear()}notify(){this.subscribers.forEach(t=>t(this.value))}},se=class{constructor(){this.listeners=new Map}on(t,e){return this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e),()=>this.off(t,e)}off(t,e){let i=this.listeners.get(t);i&&(i.delete(e),0===i.size&&this.listeners.delete(t))}emit(t,e){let i=this.listeners.get(t);i&&i.forEach(t=>{try{t(e)}catch{}})}once(t,e){let i=n=>{e(n),this.off(t,i)};return this.on(t,i)}removeAllListeners(t){t?this.listeners.delete(t):this.listeners.clear()}listenerCount(t){return this.listeners.get(t)?.size??0}},le=class{constructor(t){this.updates=new Map,this.nextId=0,this.debug=0,this.onRollback=t?.onRollback,this.onError=t?.onError,this.debug=t?.debug||0}apply(t){let e="opt_"+this.nextId++,i=function(t){let e=[];for(let i of t){let[t,n,...r]=i;if("setText"===t){let t=P(n);t&&e.push(["setText",n,t.textContent||""])}else if("setAttrs"===t){let t=P(n);if(t&&t instanceof Element){let[i,o]=r,s={},l=[];for(let e of Object.keys(i)){let i=t.getAttribute(e);null!==i?s[e]=i:l.push(e)}for(let e of o){let i=t.getAttribute(e);null!==i&&(s[e]=i)}e.push(["setAttrs",n,s,l])}}else if("list"===t){let t=r,i=[];for(let e of t){let[t,...n]=e;if("ins"===t){let[,{key:t}]=n;i.push(["del",t])}else if("del"!==t&&"mov"===t){let[t,e]=n;i.push(["mov",e,t])}}i.length>0&&e.push(["list",n,...i.reverse()])}}return e.reverse()}(t),n={id:e,patches:t,inverseOps:i,timestamp:Date.now()};return this.updates.set(e,n),xt(t),e}commit(t){this.updates.delete(t)}rollback(t){let e=this.updates.get(t);if(e){try{xt(e.inverseOps),this.onRollback?.(t,e.patches)}catch(t){this.onError?.(t,"rollback")}this.updates.delete(t)}}getPendingCount(){return this.updates.size}clear(){this.updates.clear()}},ae=class{constructor(t){this.boot=null,this.debug=0,this.debug=t?.debug||0}load(t){let e=t??this.detect();return e&&"string"==typeof e.sid&&0!==e.sid.length?(this.apply(e),e):(this.log("No boot payload detected or payload invalid"),null)}detect(){if("u">typeof window){let t=window.o;if(t&&"object"==typeof t&&"string"==typeof t.sid)return t}if("u">typeof document){let t=document.getElementById("live-boot")?.textContent;if(t)try{return JSON.parse(t)}catch(t){this.log("Failed to parse boot payload from DOM",t)}}return null}apply(t){this.boot=t,t.handlers&&(M(),E(t.handlers),C()),w(t.bindings?.slots??null),o(),s(t.refs?.add??null);let e,i=null;"u">typeof document&&(V(),e=ot(t.componentPaths,{root:document}),i=this.computeRootRange()),this.registerInitialDom(t);let n={overrides:e,fallbackRange:i};if(lt(t.bindings?.router??null,n),at(t.bindings?.refs??null,n),dt(t.bindings?.uploads??null,e),"u">typeof window&&t.location){let e=`${t.location.path}${t.location.q?"?"+t.location.q:""}${t.location.hash?"#"+t.location.hash:""}`,i=`${window.location.pathname}${window.location.search}${window.location.hash}`;e&&i!==e&&window.history.replaceState({},"",e)}}registerInitialDom(t){if(typeof document>"u")return;F();let e=nt(t.slotPaths);if(Array.isArray(t.slots)&&t.slots.length>0)for(let i of t.slots){if(!i||"number"!=typeof i.anchorId)continue;let t=e.get(i.anchorId);t&&L(i.anchorId,t)}else for(let[t,i]of e.entries())L(t,i);let i=rt(t.listPaths);for(let[t,e]of i.entries())H(t,e)}computeRootRange(){if(typeof document>"u")return null;let t=document.body??document,e=t.childNodes.length;return{container:t,startIndex:0,endIndex:e>0?e-1:-1}}get(){return this.boot}ensure(){if(!this.boot||!this.boot.sid)throw Error("LiveUI: boot payload is required before connecting");return this.boot}getJoinLocation(){let t=this.boot?.location??{path:"/",q:"",hash:""};if(typeof window>"u")return t;let e=window.location.pathname||t.path||"/",i=window.location.search??"",n=i.startsWith("?")?i.substring(1):i,r=window.location.hash??"";return{path:e,q:n,hash:r.startsWith("#")?r.substring(1):r}}log(...t){}},ue=t=>null===t||"object"!=typeof t?0:"string"==typeof t.t,fe=class extends se{constructor(t={}){super(),this.client=null,this.channel=null,this.pubsubChannels=new Map,this.connectionState=new re({status:"disconnected"}),this.sessionId=new re(null),this.version=new re(0),this.lastAck=0,this.hasBootPayload=0,this.autoConnectCleanup=null,this.expectedSeq=null,this.frameBuffer=new Map,this.MAX_FRAME_BUFFER_SIZE=50,this.eventQueue=[],this.patchQueue=[],this.batchScheduled=0,this.rafHandle=null,this.rafUsesTimeoutFallback=0,this.pendingUploadBindings=[],this.cookieRequests=new Set,this.templateCache=new Map,this.MAX_TEMPLATE_CACHE_SIZE=100,this.reconnectAttempts=0,this.reconnectTimer=null,this.isReconnecting=0,this.diagnostics=[],this.errorOverlay=null,this.errorListEl=null,this.errorOverlayVisible=0,this.handleDebugKeydown=t=>this.onDebugKeydown(t),this.metrics={patchesApplied:0,averagePatchTime:0,framesReceived:0,eventsProcessed:0,reconnections:0,uptime:0,effectsMs:0,maxEffectMs:0,slowEffects:0,framesBuffered:0,framesDropped:0,sequenceGaps:0},this.startTime=0,this.patchTimes=[],this.patchTimeTotal=0,this.uploads=null,this.lastOptimisticNavTime=0,this.OPTIMISTIC_NAV_WINDOW=100,this.eventDebouncer=new Map,this.handlePopState=()=>{if("connected"!==this.connectionState.get().status||!this.channel)return void this.log("Not connected, cannot handle popstate");let t=window.location.pathname,e=window.location.search.substring(1),i=window.location.hash.startsWith("#")?window.location.hash.substring(1):window.location.hash,n={t:"pop",sid:this.sessionId.get(),path:t,q:e,hash:i};this.log("Sending popstate navigation:",n),this.channel.sendMessage("pop",n)},this.bootHandler=new ae({debug:t.debug||0}),this.optimistic=new le({onRollback:(t,e)=>this.emit("rollback",{id:t,patches:e}),onError:(t,e)=>this.emit("error",{error:t,context:e}),debug:t.debug||0}),this.uploads=new Qt({getSessionId:()=>this.sessionId.get(),getEndpoint:()=>this.options.uploadEndpoint??null,send:t=>this.sendUploadMessage(t),isConnected:()=>"connected"===this.connectionState.get().status&&null!==this.channel});let e={...t??{}},i=e.boot??null;delete e.boot,this.options={endpoint:e.endpoint??"/live",uploadEndpoint:e.uploadEndpoint??"/pondlive/upload/",autoConnect:0!=e.autoConnect,debug:e.debug??0,reconnect:0!=e.reconnect,maxReconnectAttempts:e.maxReconnectAttempts??5,reconnectDelay:e.reconnectDelay??1e3,...e},i&&(this.options.boot=i);let n=this.bootHandler.load(i);if(this.hasBootPayload=!!n,n&&(n.client?.endpoint&&"string"==typeof n.client.endpoint&&(this.options.endpoint=n.client.endpoint),n.client?.upload&&"string"==typeof n.client.upload&&(this.options.uploadEndpoint=n.client.upload),"boolean"==typeof n.client?.debug&&(this.options.debug=n.client.debug),this.sessionId.set(n.sid),this.version.set(n.ver??0),this.lastAck=n.seq??0,n.errors&&n.errors.length>0))for(let t of n.errors)this.recordDiagnostic(t);this.connectionState.subscribe(t=>{this.log("Connection state changed:",t)}),this.options.debug&&"u">typeof window&&window.addEventListener("keydown",this.handleDebugKeydown),this.setupAutoConnect()}async connect(){this.clearAutoConnect();let t,e=this.connectionState.get();if("connected"!==e.status&&"connecting"!==e.status){try{t=this.bootHandler.ensure()}catch(t){return this.log("Boot payload error:",t),this.setState({status:"error",error:t}),void this.emit("error",{error:t,context:"boot"})}t.client?.endpoint&&"string"==typeof t.client.endpoint&&(this.options.endpoint=t.client.endpoint),t.client?.upload&&"string"==typeof t.client.upload&&(this.options.uploadEndpoint=t.client.upload),this.setState({status:"connecting"}),this.startTime=Date.now();try{this.log("Connecting to",this.options.endpoint);let e=t.sid,i=this.bootHandler.getJoinLocation(),n={sid:e,ver:t.ver??0,ack:this.lastAck??t.seq??0,loc:{path:i.path,q:i.q,hash:i.hash}};this.client=new Nt.PondClient(this.options.endpoint),"u">typeof document&&(Ft=t=>this.sendEvent(t),$t.forEach(t=>{N(t)})),"u">typeof document&&function(t){Ut=t,Rt.has("click")||N("click")}((t,e,i)=>this.sendNavigation(t,e,i)),"u">typeof window&&window.addEventListener("popstate",this.handlePopState),this.channel=this.client.createChannel("live/"+e,n),this.channel.onChannelStateChange(t=>{this.log("Channel state changed:",t),"JOINED"===t&&this.onConnected()}),this.channel.onMessage((t,e)=>{ue(e)?this.handleMessage(e):this.log("Ignoring non-server payload",t,e)}),this.channel.onLeave(()=>{this.log("Channel left"),this.onDisconnected()}),this.client.connect(),this.channel.join()}catch(t){this.log("Connection error:",t),this.setState({status:"error",error:t}),this.emit("error",{error:t,context:"connect"}),this.options.reconnect&&!this.isReconnecting&&this.scheduleReconnect()}}else this.log("Already connected or connecting")}disconnect(){this.clearReconnectTimer(),this.isReconnecting=0,this.cancelScheduledBatch(),this.patchQueue=[],this.pendingUploadBindings=[];for(let t of this.pubsubChannels.values())try{t.dispose(),t.channel.leave()}catch(t){this.log("Error leaving pubsub channel",t)}this.pubsubChannels.clear(),this.channel&&(this.channel.leave(),this.channel=null),this.client&&(this.client.disconnect(),this.client=null),"u">typeof window&&window.removeEventListener("popstate",this.handlePopState),this.setState({status:"disconnected"}),this.sessionId.set(null),this.version.set(0),M(),o(),Rt.forEach((t,e)=>{document.removeEventListener(e,t,"blur"===e||"focus"===e)}),Rt.clear(),Ft=null,Wt=null,Ut=null,this.uploads?.onDisconnect(),this.emit("disconnected",void 0)}setupAutoConnect(){if(!this.options.autoConnect)return;if(!this.hasBootPayload)return void this.log("Auto-connect skipped: no boot payload detected");let t=()=>{this.clearAutoConnect(),this.log("Auto-connecting after DOM ready"),this.connect().catch(t=>{this.log("Auto-connect failed:",t)})};if(typeof document>"u")t();else{if("loading"===document.readyState){let e=()=>{document.removeEventListener("DOMContentLoaded",e),t()};return document.addEventListener("DOMContentLoaded",e),void(this.autoConnectCleanup=()=>{document.removeEventListener("DOMContentLoaded",e)})}"function"==typeof queueMicrotask?queueMicrotask(t):Promise.resolve().then(t)}}clearAutoConnect(){this.autoConnectCleanup&&(this.autoConnectCleanup(),this.autoConnectCleanup=null)}getConnectionState(){return this.connectionState.get()}getMetrics(){return{...this.metrics,uptime:this.startTime?Date.now()-this.startTime:0}}onStateChange(t){return this.connectionState.subscribe(t)}onSessionIdChange(t){return this.sessionId.subscribe(t)}onVersionChange(t){return this.version.subscribe(t)}sendEventDebounced(t,e=300){let i=this.eventDebouncer.get(t.hid);i&&clearTimeout(i);let n=setTimeout(()=>{this.sendEvent(t),this.eventDebouncer.delete(t.hid)},e);this.eventDebouncer.set(t.hid,n)}applyOptimistic(t){return this.optimistic.apply(t)}commitOptimistic(t){this.optimistic.commit(t)}rollbackOptimistic(t){this.optimistic.rollback(t)}setState(t){let e=this.connectionState.get();this.hasStateChanged(e,t)&&(this.connectionState.set(t),this.emit("stateChanged",{from:e,to:t}))}onConnected(){let t=this.sessionId.get(),e=this.version.get();t&&(this.isReconnecting&&(this.isReconnecting=0,this.reconnectAttempts=0,this.emit("reconnected",{sessionId:t})),this.setState({status:"connected",sessionId:t,version:e}),this.emit("connected",{sessionId:t,version:e}),this.flushEventQueue())}onDisconnected(){this.setState({status:"disconnected"}),this.options.reconnect&&!this.isReconnecting&&this.scheduleReconnect(),this.uploads?.onDisconnect()}scheduleReconnect(){if(this.reconnectAttempts>=this.options.maxReconnectAttempts)return this.log("Max reconnect attempts reached"),void this.emit("error",{error:Error("Max reconnect attempts reached"),context:"reconnect"});this.isReconnecting=1,this.reconnectAttempts++;let t=this.options.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);this.log(`Reconnecting in ${t}ms (attempt ${this.reconnectAttempts}/${this.options.maxReconnectAttempts})`),this.setState({status:"reconnecting",attempt:this.reconnectAttempts}),this.emit("reconnecting",{attempt:this.reconnectAttempts}),this.reconnectTimer=setTimeout(()=>{this.metrics.reconnections++,this.connect()},t)}clearReconnectTimer(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null)}handleMessage(t){if(t&&t.t)switch(this.log("Received message:",t.t,t),t.t){case"init":this.handleInit(t);break;case"frame":this.handleFrame(t);break;case"template":this.handleTemplate(t);break;case"join":this.handleJoin(t);break;case"resume":this.handleResume(t);break;case"error":this.handleError(t);break;case"diagnostic":this.handleDiagnostic(t);break;case"pubsub":this.handlePubsub(t);break;case"upload":this.uploads?.handleControl(t);break;case"domreq":this.handleDOMRequest(t);break;default:this.log("Unknown message type:",t.t)}else this.log("Invalid message",t)}handleInit(t){if(this.sessionId.set(t.sid),this.version.set(t.ver),this.expectedSeq=void 0!==t.seq?t.seq+1:null,this.frameBuffer.clear(),Array.isArray(t.errors)&&t.errors.length>0)for(let e of t.errors)this.recordDiagnostic(e);t.handlers&&(E(t.handlers),C()),w(t.bindings?.slots??null),o(),t.refs?.add&&s(t.refs.add);let e,i=null;if("u">typeof document){let n=document.body??document,r=n.childNodes.length;i={container:n,startIndex:0,endIndex:r>0?r-1:-1},V(),e=ot(t.componentPaths,{root:document})}let n={overrides:e,fallbackRange:i};lt(t.bindings?.router??null,n),at(t.bindings?.refs??null,n),dt(t.bindings?.uploads??null,e),void 0!==t.seq&&(this.lastAck=t.seq,this.sendAck(t.seq)),this.log("Session initialized:",t.sid,"version:",t.ver),this.onConnected()}handleFrame(t){let e=this.sessionId.get();if(t.sid===e)if(this.metrics.framesReceived++,void 0!==t.seq){if(null===this.expectedSeq)return this.expectedSeq=t.seq+1,this.applyFrame(t),void this.drainFrameBuffer();if(t.seq===this.expectedSeq)return this.expectedSeq=t.seq+1,this.applyFrame(t),void this.drainFrameBuffer();if(t.seq>this.expectedSeq){if(this.metrics.sequenceGaps++,this.log("Frame arrived out of order",{expected:this.expectedSeq,received:t.seq,gap:t.seq-this.expectedSeq}),this.frameBuffer.size>=this.MAX_FRAME_BUFFER_SIZE){this.metrics.framesDropped++,this.log("Frame buffer full, dropping oldest frame");let t=Math.min(...this.frameBuffer.keys());this.frameBuffer.delete(t)}return this.frameBuffer.set(t.seq,t),void this.metrics.framesBuffered++}if(this.expectedSeq>t.seq)return this.metrics.framesDropped++,void this.log("Dropping duplicate/late frame",{expected:this.expectedSeq,received:t.seq})}else this.applyFrame(t);else this.log("Session mismatch, ignoring frame")}applyFrame(t){if(this.version.set(t.ver),t.patch&&t.patch.length>0&&(this.log("Queueing",t.patch.length,"operations"),this.patchQueue.push(...t.patch),this.scheduleBatch()),t.handlers&&(t.handlers.add&&E(t.handlers.add),t.handlers.del&&function(t){if(Array.isArray(t))for(let e of t){let t=_t.get(e);if(_t.delete(e),t)for(let e of I(t))R(e)}}(t.handlers.del),C()),t.bindings?.slots)for(let[e,i]of Object.entries(t.bindings.slots)){let t=+e;!Number.isInteger(t)||0>t||v(t,Array.isArray(i)?i:[])}if(t.bindings?.uploads&&ht(t.bindings.uploads),t.bindings?.router&&lt(t.bindings.router),t.bindings?.refs&&at(t.bindings.refs),Array.isArray(t.bindings?.uploads)&&(this.batchScheduled||this.patchQueue.length>0?this.pendingUploadBindings.push(t.bindings.uploads):ht(t.bindings.uploads)),t.refs&&(t.refs.del&&l(t.refs.del),t.refs.add&&s(t.refs.add)),t.nav){let e=Date.now()-this.lastOptimisticNavTime<this.OPTIMISTIC_NAV_WINDOW;t.nav.push?e?window.history.replaceState({},"",t.nav.push):window.history.pushState({},"",t.nav.push):t.nav.replace&&window.history.replaceState({},"",t.nav.replace),this.lastOptimisticNavTime=0}t.effects&&t.effects.length>0&&this.applyEffects(t.effects),void 0!==t.seq&&this.sendAck(t.seq),t.metrics&&(this.log("Frame metrics:",t.metrics),"number"==typeof t.metrics.effectsMs&&(this.metrics.effectsMs=t.metrics.effectsMs),"number"==typeof t.metrics.maxEffectMs&&(this.metrics.maxEffectMs=t.metrics.maxEffectMs),"number"==typeof t.metrics.slowEffects&&(this.metrics.slowEffects=t.metrics.slowEffects))}handleTemplate(t){if(!t)return;let e=this.sessionId.get();t.sid&&e&&t.sid!==e?this.log("Template message for different session",t.sid):t.scope?this.applyComponentTemplatePayload(t,t.scope):this.applyRootTemplatePayload(t)}handleDiagnostic(t){t&&this.recordDiagnostic(t)}drainFrameBuffer(){for(;null!==this.expectedSeq&&this.frameBuffer.has(this.expectedSeq);){let t=this.frameBuffer.get(this.expectedSeq);this.frameBuffer.delete(this.expectedSeq),this.expectedSeq=t.seq+1,this.log("Draining buffered frame",{seq:t.seq}),this.applyFrame(t)}}applyEffects(t){if(t&&0!==t.length){(this.patchQueue.length>0||this.batchScheduled)&&(this.batchScheduled&&this.cancelScheduledBatch(),this.flushBatch());for(let e of t)try{switch(this.log("Applying effect:",e),this.emit("effect",{effect:e}),"string"==typeof e.type?e.type.toLowerCase():""){case"boot":this.applyBootEffect(e);break;case"componentboot":this.applyComponentBootEffect(e);break;case"dom":this.applyDOMActionEffect(e);break;case"domcall":this.applyLegacyDOMCallEffect(e);break;case"scroll":case"scrolltop":this.applyScrollEffect(e);break;case"focus":this.applyFocusEffect(e);break;case"alert":window.alert(e.message);break;case"toast":this.applyToastEffect(e);break;case"push":this.applyPushEffect(e);break;case"replace":this.applyReplaceEffect(e);break;case"dispatch":this.dispatchCustomEvent(e.eventName,e.detail);break;case"metadata":this.applyMetadataEffect(e);break;case"cookies":this.handleCookieEffect(e);break;case"custom":break;default:this.log("Unknown effect type:",e.type)}}catch(t){this.log("Error applying effect:",e,t),this.emit("error",{error:t,context:"effect"})}}}applyRootTemplatePayload(t){if(typeof document>"u")return;o();let e=this.getTemplateMarkup(t,"__root__");Mt(),F(),document.body?document.body.innerHTML=e:document.documentElement&&(document.documentElement.innerHTML=e);let i=document.body??document;M(),t.handlers&&Object.keys(t.handlers).length>0&&E(t.handlers),C(),w(t.bindings?.slots??null),t.refs?.del&&l(t.refs.del),t.refs?.add&&s(t.refs.add),V();let n=i.childNodes.length,r={container:i,startIndex:0,endIndex:n>0?n-1:-1},a=ot(t.componentPaths,{root:document});this.registerTemplateAnchors(r,t,a);let u={overrides:a,fallbackRange:r};lt(t.bindings?.router??null,u),at(t.bindings?.refs??null,u),dt(t.bindings?.uploads??null,a)}applyComponentTemplatePayload(t,e){if(typeof document>"u"||!e||!e.componentId)return;let i=this.findComponentRange(e.componentId);if(!i)return;let n=this.extractSlotIds(t.slots);for(let t of n)$(t);let r=this.extractListSlotIds(t.listPaths);for(let t of r)z(t);Mt();let o=document.createElement("template"),u=this.getTemplateMarkup(t,e.componentId);o.innerHTML=u;let f=o.content.cloneNode(1),c=[];for(let t=f.firstChild;t;t=t.nextSibling)c.push(t);let{container:h}=i,d=i.startIndex,p=i.endIndex,m=h.childNodes.length>p+1?h.childNodes.item(p+1):null;for(let t=p;t>=d;t--){let e=h.childNodes.item(t);e&&((e instanceof Element||e instanceof DocumentFragment)&&a(e),h.removeChild(e))}h.insertBefore(f,m);let y=c.length,g=K(e.componentId,{container:h,startIndex:d,endIndex:y>0?d+y-1:d-1});g||(g={container:h,startIndex:d,endIndex:y>0?d+y-1:d-1});let b=ot(t.componentPaths,{baseId:e.componentId,baseRange:g});this.registerTemplateAnchors(g,t,b);let w={overrides:b,fallbackRange:g};if(lt(t.bindings?.router??null,w),at(t.bindings?.refs??null,w),ct(e.componentId,t.bindings?.uploads??null,b),t.handlers&&Object.keys(t.handlers).length>0&&(E(t.handlers),C()),t.bindings?.slots)for(let[e,i]of Object.entries(t.bindings.slots)){let t=+e;!Number.isInteger(t)||0>t||v(t,Array.isArray(i)?i:[])}t.refs?.del&&l(t.refs.del),t.refs?.add&&s(t.refs.add)}serializeDOMResult(t){if(null==t)return t;if("object"==typeof t&&"length"in t&&"function"==typeof t.start&&"function"==typeof t.end){let e=[];for(let i=0;t.length>i;i++)e.push({start:t.start(i),end:t.end(i)});return{length:t.length,ranges:e}}if(t instanceof DOMRect||t instanceof DOMRectReadOnly)return{x:t.x,y:t.y,width:t.width,height:t.height,top:t.top,right:t.right,bottom:t.bottom,left:t.left};if(t&&"object"==typeof t&&"length"in t&&"function"==typeof t.contains)return Array.from(t);if(t instanceof NodeList||t instanceof HTMLCollection)return Array.from(t).map(t=>t instanceof Element?{tagName:t.tagName,id:t.id,className:t.className}:null).filter(Boolean);if(t&&t.constructor&&"CSSStyleDeclaration"===t.constructor.name){let e={};for(let i=0;t.length>i;i++){let n=t[i];e[n]=t.getPropertyValue(n)}return e}return t}handleDOMRequest(t){if(!t||!t.id)return;let e=t.ref??"",i=Array.isArray(t.props)?t.props:[],n={t:"domres",id:t.id};if(!e)return n.error="missing_ref",void this.sendDOMResponse(n);let r=u(e);if(!r)return n.error="not_found",void this.sendDOMResponse(n);if(t.method)try{let e=t.method.trim();if(!e)return n.error="empty_method",void this.sendDOMResponse(n);switch(e){case"getComputedStyle":{let e=Array.isArray(t.args)&&t.args.length>0?t.args[0]:[],i=window.getComputedStyle(r);if(Array.isArray(e)&&e.length>0){let t={};for(let n of e)t[n]=i.getPropertyValue(n);n.result=t}else n.result={display:i.display,visibility:i.visibility,opacity:i.opacity,position:i.position,zIndex:i.zIndex,width:i.width,height:i.height,top:i.top,left:i.left,right:i.right,bottom:i.bottom,margin:i.margin,padding:i.padding,border:i.border,backgroundColor:i.backgroundColor,color:i.color,fontSize:i.fontSize,fontFamily:i.fontFamily,fontWeight:i.fontWeight,lineHeight:i.lineHeight,textAlign:i.textAlign,overflow:i.overflow,transform:i.transform};break}default:{let i,o=r[e];if(void 0===o)return n.error="method_not_found",void this.sendDOMResponse(n);i="function"==typeof o?o.apply(r,Array.isArray(t.args)?t.args:[]):o,n.result=this.serializeDOMResult(i)}}}catch(t){return n.error=t instanceof Error?t.message:t+"",void this.sendDOMResponse(n)}if(i.length>0)try{let t=d(i,{event:null,target:r,handlerElement:r,refElement:r});n.values=t&&Object.keys(t).length>0?t:{}}catch(t){return n.error=t instanceof Error?t.message:t+"",void this.sendDOMResponse(n)}this.sendDOMResponse(n)}applyDOMActionEffect(t){if(typeof document>"u")return;let e=(t.kind??t.Kind??"").toLowerCase(),i=(t.ref??t.Ref??"").trim();if(e)if(i)switch(e){case"dom.call":{let e=(t.method??t.Method??"").trim();if(!e)return void this.reportDOMActionFailure(t,"missing_method");let n=this.normalizeDOMActionArgs(t),r=function(t,e,i=[]){let n=t?u(t):null;if(!n)return{ok:0,reason:"missing_element"};let r=n[e];if("function"!=typeof r)return{ok:0,reason:"missing_method"};try{let t=r.apply(n,Array.isArray(i)?i:[]);return t&&"function"==typeof t.then&&t.catch(()=>{}),{ok:1}}catch(t){return{ok:0,reason:"invoke_failed",error:t}}}(i,e,n);r.ok||this.reportDOMActionFailure(t,r.reason??"call_failed",{method:e,argsLength:n.length},r.error);break}case"dom.set":{let e=(t.prop??t.Prop??"").trim();if(!e)return void this.reportDOMActionFailure(t,"missing_property");let n=m(i,e,t.value??t.Value);n.ok||this.reportDOMActionFailure(t,n.reason??"set_failed",{prop:e},n.error);break}case"dom.toggle":{let e=(t.prop??t.Prop??"").trim();if(!e)return void this.reportDOMActionFailure(t,"missing_property");let n=t.value??t.Value;if("boolean"!=typeof n)return void this.reportDOMActionFailure(t,"invalid_toggle_value",{prop:e,value:n});let r=function(t,e,i){return"boolean"!=typeof i?{ok:0,reason:"invalid_value"}:m(t,e,i)}(i,e,n);r.ok||this.reportDOMActionFailure(t,r.reason??"toggle_failed",{prop:e,value:n},r.error);break}case"dom.class":{let e=(t.class??t.Class??"").trim();if(!e)return void this.reportDOMActionFailure(t,"missing_class");let n=t.on??t.On,r=function(t,e,i){let n=t?u(t):null;if(!n)return{ok:0,reason:"missing_element"};let r="string"==typeof e?e.trim():"";if(!r)return{ok:0,reason:"missing_class"};if(!("classList"in n))return{ok:0,reason:"classlist_missing"};try{return void 0===i?n.classList.toggle(r):n.classList.toggle(r,i),{ok:1}}catch(t){return{ok:0,reason:"class_toggle_failed",error:t}}}(i,e,n);r.ok||this.reportDOMActionFailure(t,r.reason??"class_failed",{className:e,toggle:n},r.error);break}case"dom.scroll":{let e={},n=t.behavior??t.Behavior,r=t.block??t.Block,o=t.inline??t.Inline;n&&(e.behavior=n),r&&(e.block=r),o&&(e.inline=o);let s=function(t,e){let i=t?u(t):null;if(!i)return{ok:0,reason:"missing_element"};let n=i.scrollIntoView;if("function"!=typeof n)return{ok:0,reason:"missing_scroll"};try{return e&&Object.keys(e).length>0?n.call(i,e):n.call(i),{ok:1}}catch(t){return{ok:0,reason:"scroll_failed",error:t}}}(i,Object.keys(e).length>0?e:null);s.ok||this.reportDOMActionFailure(t,s.reason??"scroll_failed",void 0,s.error);break}default:this.reportDOMActionFailure(t,"unknown_kind",{kind:e})}else this.reportDOMActionFailure(t,"missing_ref");else this.reportDOMActionFailure(t,"missing_kind")}applyLegacyDOMCallEffect(t){this.applyDOMActionEffect({type:"dom",kind:"dom.call",ref:t.ref??t.Ref??void 0,method:t.method??t.Method??void 0,args:Array.isArray(t.args)?t.args:Array.isArray(t.Args)?t.Args:void 0!==t.args?[t.args]:void 0!==t.Args?[t.Args]:void 0})}normalizeDOMActionArgs(t){return Array.isArray(t.args)?t.args:Array.isArray(t.Args)?t.Args:void 0!==t.args?[t.args]:void 0!==t.Args?[t.Args]:[]}reportDOMActionFailure(t,e,i,n){let r=t.kind??t.Kind??"",o=`DOM action ${r||"unknown"} failed: ${e}`,s={kind:r,ref:t.ref??t.Ref??""??""};i&&Object.assign(s,i),n instanceof Error?(s.error=n.message,n.stack&&(s.stack=n.stack)):void 0!==n&&(s.error=n);let l={t:"diagnostic",sid:this.sessionId.get()??"",code:"dom_action_failed",message:o,details:{phase:"dom_action",metadata:s}};this.recordDiagnostic(l)}sendDOMResponse(t){if(this.channel)try{this.channel.sendMessage("domres",t)}catch(t){this.log("Failed to send DOM response",t)}else this.log("Cannot send DOM response without channel",t)}applyScrollEffect(t){let e=t.behavior||"smooth",i=t.selector;if(!i||"ScrollTop"===t.type)return void window.scrollTo({top:0,behavior:e});let n=document.querySelector(i);n instanceof Element&&n.scrollIntoView({behavior:e,block:t.block||"start"})}applyMetadataEffect(t){if(typeof document>"u")return;({}).hasOwnProperty.call(t,"title")&&void 0!==t.title&&(document.title=t.title);let e=document.head;if(!e)return;let i="data-live-key",n="data-live-head",r=t=>{!Array.isArray(t)||0===t.length||t.forEach(t=>{e.querySelectorAll(`[${i}="${t}"]`).forEach(t=>{t.parentNode?.removeChild(t)})})},o=(t,e)=>{let i=new Set(e);Array.from(t.attributes).forEach(e=>{i.has(e.name)||t.removeAttribute(e.name)})},s=(t,r)=>{if(!t||!t.key)return;let s=e.querySelector(`meta[${i}="${t.key}"]`);if(s||(s=document.createElement("meta"),e.appendChild(s)),o(s,[i]),s.setAttribute(i,t.key),s.setAttribute(n,r),void 0!==t.name&&s.setAttribute("name",t.name),void 0!==t.content&&s.setAttribute("content",t.content),void 0!==t.property&&s.setAttribute("property",t.property),void 0!==t.charset&&s.setAttribute("charset",t.charset),void 0!==t.httpEquiv&&s.setAttribute("http-equiv",t.httpEquiv),void 0!==t.itemProp&&s.setAttribute("itemprop",t.itemProp),t.attrs)for(let[e,i]of Object.entries(t.attrs))null!=i&&s.setAttribute(e,i+"")},l=t=>{if(!t||!t.key)return;let r=e.querySelector(`link[${i}="${t.key}"]`);if(r||(r=document.createElement("link"),e.appendChild(r)),o(r,[i]),r.setAttribute(i,t.key),r.setAttribute(n,"link"),void 0!==t.rel&&r.setAttribute("rel",t.rel),void 0!==t.href&&r.setAttribute("href",t.href),void 0!==t.type&&r.setAttribute("type",t.type),void 0!==t.as&&r.setAttribute("as",t.as),void 0!==t.media&&r.setAttribute("media",t.media),void 0!==t.hreflang&&r.setAttribute("hreflang",t.hreflang),void 0!==t.title&&r.setAttribute("title",t.title),void 0!==t.crossorigin&&r.setAttribute("crossorigin",t.crossorigin),void 0!==t.integrity&&r.setAttribute("integrity",t.integrity),void 0!==t.referrerpolicy&&r.setAttribute("referrerpolicy",t.referrerpolicy),void 0!==t.sizes&&r.setAttribute("sizes",t.sizes),t.attrs)for(let[e,i]of Object.entries(t.attrs))null!=i&&r.setAttribute(e,i+"")},a=t=>{if(!t||!t.key)return;let r=e.querySelector(`script[${i}="${t.key}"]`);if(r||(r=document.createElement("script"),e.appendChild(r)),o(r,[i]),r.setAttribute(i,t.key),r.setAttribute(n,"script"),t.module?r.setAttribute("type","module"):void 0!==t.type&&r.setAttribute("type",t.type),void 0!==t.src&&r.setAttribute("src",t.src),t.async&&r.setAttribute("async","async"),t.defer&&r.setAttribute("defer","defer"),t.noModule&&r.setAttribute("nomodule","nomodule"),void 0!==t.crossorigin&&r.setAttribute("crossorigin",t.crossorigin),void 0!==t.integrity&&r.setAttribute("integrity",t.integrity),void 0!==t.referrerpolicy&&r.setAttribute("referrerpolicy",t.referrerpolicy),void 0!==t.nonce&&r.setAttribute("nonce",t.nonce),t.attrs)for(let[e,i]of Object.entries(t.attrs))null!=i&&r.setAttribute(e,i+"");void 0!==t.inner&&(r.textContent=t.inner)};if(t.clearDescription&&r(["description"]),{}.hasOwnProperty.call(t,"description")&&void 0!==t.description){let e=t.description;e.trim().length>0?s({key:"description",name:"description",content:e},"description"):r(["description"])}if(Array.isArray(t.metaRemove)&&r(t.metaRemove),Array.isArray(t.metaAdd))for(let e of t.metaAdd)s(e,"meta");if(Array.isArray(t.linkRemove)&&r(t.linkRemove),Array.isArray(t.linkAdd))for(let e of t.linkAdd)l(e);if(Array.isArray(t.scriptRemove)&&r(t.scriptRemove),Array.isArray(t.scriptAdd))for(let e of t.scriptAdd)a(e)}handleCookieEffect(t){this.performCookieSync(t)}async performCookieSync(t){let e=t.token??t.Token;if(!e)return void this.log("Cookie effect missing token",t);if(this.cookieRequests.has(e))return;let i=t.endpoint??t.Endpoint??"/pondlive/cookie";if(!i)return void this.log("Cookie effect missing endpoint",t);let n=t.sid??t.SID??this.sessionId.get();if(!n)return void this.log("Cookie effect missing session identifier",t);let r=(t.method??t.Method??"POST").toUpperCase();this.cookieRequests.add(e);try{let t=await fetch(i,{method:r,credentials:"include",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({sid:n,token:e})});!t.ok&&204!==t.status&&this.log("Cookie negotiation failed",{endpoint:i,status:t.status,statusText:t.statusText})}catch(t){this.log("Cookie negotiation error",t),this.emit("error",{error:t,context:"cookies"})}finally{this.cookieRequests.delete(e)}}applyFocusEffect(t){let e=t.selector||t.Selector;if(!e)return;let i=document.querySelector(e);i&&(i instanceof HTMLElement||i instanceof SVGElement)&&"function"==typeof i.focus&&i.focus()}applyToastEffect(t){this.emit("effect",{effect:{type:"toast",message:t.message||t.Message,duration:t.duration||3e3,variant:t.variant||"info"}}),this.listenerCount("effect")}applyPushEffect(t){let e=t.url||t.URL;e&&window.history.pushState({},"",e)}applyReplaceEffect(t){let e=t.url||t.URL;e&&window.history.replaceState({},"",e)}applyBootEffect(t){let e=t?.boot;e&&(this.applyRootTemplatePayload(e),this.bootHandler.load(e))}applyComponentBootEffect(t){if(typeof document>"u"||!t||!t.componentId)return;let{componentId:e,html:i,slots:n,listSlots:r,bindings:o,slotPaths:s,listPaths:l}=t,a=this.findComponentRange(e);if(!a)return;if(Array.isArray(n))for(let t of n)$(t);if(Array.isArray(r))for(let t of r)z(t);Mt();let u=document.createElement("template");u.innerHTML=i||"";let f=u.content.cloneNode(1),c=[];for(let t=f.firstChild;t;t=t.nextSibling)c.push(t);let h=a.container,d=a.endIndex+1,p=h.childNodes.length>d?h.childNodes.item(d):null;for(let t=a.endIndex;t>=a.startIndex;t--){let e=h.childNodes.item(t);e&&h.removeChild(e)}h.insertBefore(f,p??null);let m=c.length,y=null;y=K(e,m>0?{container:h,startIndex:a.startIndex,endIndex:a.startIndex+m-1}:{container:h,startIndex:a.startIndex,endIndex:a.startIndex-1}),y||(y={container:h,startIndex:a.startIndex,endIndex:a.startIndex-1});let g=ot(t.componentPaths,{baseId:e,baseRange:y}),b=o?.slots??o;if(b&&"object"==typeof b)for(let[t,e]of Object.entries(b)){let i=+t;Number.isNaN(i)||v(i,Array.isArray(e)?e:[])}this.registerComponentAnchors(y,Array.isArray(n)?n:[],Array.isArray(r)?r:[],Array.isArray(s)?s:void 0,Array.isArray(l)?l:void 0,g),ct(e,o?.uploads??o?.uploads??null,g),Array.isArray(s)&&s.length>0&&nt(s,g).forEach((t,e)=>L(e,t))}registerTemplateAnchors(t,e,i){if(!t)return;let n=this.extractSlotIds(e.slots),r=this.extractListSlotIds(e.listPaths);this.registerComponentAnchors(t,n,r,e.slotPaths,e.listPaths,i)}extractSlotIds(t){if(!Array.isArray(t))return[];let e=[];for(let i of t){let t=+i?.anchorId;Number.isInteger(t)&&t>=0&&e.push(t)}return e}extractListSlotIds(t){if(!Array.isArray(t))return[];let e=new Set,i=[];for(let n of t){let t=+n?.slot;!Number.isInteger(t)||0>t||e.has(t)||(e.add(t),i.push(t))}return i}getTemplateMarkup(t,e){let i=e&&e.length>0?e:"__root__",n="string"==typeof t.templateHash?t.templateHash:"";if("string"==typeof t.html)return this.cacheTemplateMarkup(i,n,t.html),t.html;if(n){let t=this.lookupTemplateMarkup(i,n);if(null!==t)return t}if(Array.isArray(t.s)&&t.s.length>0){let e=t.s.join("");return this.cacheTemplateMarkup(i,n,e),e}return this.cacheTemplateMarkup(i,n,""),""}buildTemplateCacheKey(t,e){return`${t}::${e}`}cacheTemplateMarkup(t,e,i){if(!e)return;let n=this.buildTemplateCacheKey(t,e);if(this.templateCache.has(n)&&this.templateCache.delete(n),this.templateCache.set(n,i),this.templateCache.size>this.MAX_TEMPLATE_CACHE_SIZE){let t=this.templateCache.keys().next();t.done||this.templateCache.delete(t.value)}}lookupTemplateMarkup(t,e){if(!e)return null;let i=this.buildTemplateCacheKey(t,e);if(!this.templateCache.has(i))return null;let n=this.templateCache.get(i);return void 0!==n?n:null}findComponentRange(t){return typeof document>"u"||!t?null:Q(t)}registerComponentAnchors(t,e,i,n,r,o){if(!t||t.startIndex>t.endIndex)return;let s=Array.isArray(e)?e.filter(t=>Number.isInteger(t)&&t>=0):[],l=Array.isArray(i)?i.filter(t=>Number.isInteger(t)&&t>=0):[],a=new Set(s),u=new Set(l),f=nt(n,o);if(f.size>0)if(a.size>0)for(let t of Array.from(a)){let e=f.get(t);e&&(L(t,e),a.delete(t))}else for(let[t,e]of f.entries())L(t,e);let c=rt(r,o);if(c.size>0)if(u.size>0)for(let t of Array.from(u)){let e=c.get(t);e&&(H(t,e),u.delete(t))}else for(let[t,e]of c.entries())H(t,e)}dispatchCustomEvent(t,e){let i=new CustomEvent(t,{detail:e,bubbles:1,cancelable:1});document.dispatchEvent(i)}scheduleBatch(){if(this.batchScheduled)return;if(this.batchScheduled=1,"function"==typeof requestAnimationFrame)return this.rafUsesTimeoutFallback=0,void(this.rafHandle=requestAnimationFrame(()=>{this.rafHandle=null,this.flushBatch()}));this.rafUsesTimeoutFallback=1;let t=setTimeout(()=>{this.rafHandle=null,this.flushBatch()},16);this.rafHandle=t}flushBatch(){if(0===this.patchQueue.length)return this.batchScheduled=0,this.rafHandle=null,this.rafUsesTimeoutFallback=0,void(this.pendingUploadBindings.length>0&&this.flushPendingUploadBindings());let t=performance.now();this.log("Applying batched",this.patchQueue.length,"operations");let e=this.patchQueue;this.patchQueue=[],this.batchScheduled=0,this.rafHandle=null,this.rafUsesTimeoutFallback=0,xt(e),this.flushPendingUploadBindings();let i=performance.now()-t;if(this.metrics.patchesApplied+=e.length,this.patchTimes.push(i),this.patchTimeTotal+=i,this.patchTimes.length>100){let t=this.patchTimes.shift();void 0!==t&&(this.patchTimeTotal-=t)}let n=this.patchTimes.length;this.metrics.averagePatchTime=n?this.patchTimeTotal/n:0,this.emit("frameApplied",{operations:e.length,duration:i}),this.emit("metricsUpdated",this.getMetrics())}cancelScheduledBatch(){null!==this.rafHandle&&(this.rafUsesTimeoutFallback?clearTimeout(this.rafHandle):"function"==typeof cancelAnimationFrame&&cancelAnimationFrame(this.rafHandle),this.rafHandle=null,this.batchScheduled=0,this.rafUsesTimeoutFallback=0)}flushPendingUploadBindings(){if(0===this.pendingUploadBindings.length)return;let t=this.pendingUploadBindings;this.pendingUploadBindings=[];let e=[];for(let i of t)!Array.isArray(i)||0===i.length||e.push(...i);e.length>0&&ht(e)}hasStateChanged(t,e){if(t.status!==e.status)return 1;switch(e.status){case"connected":return"connected"!==t.status||t.sessionId!==e.sessionId||t.version!==e.version;case"reconnecting":return"reconnecting"!==t.status||t.attempt!==e.attempt;case"error":return"error"!==t.status||t.error!==e.error;default:return 0}}handleJoin(t){this.sessionId.set(t.sid),this.version.set(t.ver),"number"==typeof t.ack&&t.ack>this.lastAck&&(this.lastAck=t.ack),this.log("Joined session:",t.sid,"ack:",t.ack)}handleResume(t){this.log("Resume from",t.from,"to",t.to);let e=t.from>0?t.from-1:0;if(e>this.lastAck&&(this.lastAck=e),this.expectedSeq=t.from,this.frameBuffer.clear(),Array.isArray(t.errors)&&t.errors.length>0)for(let e of t.errors)this.recordDiagnostic(e);this.emit("resumed",{from:t.from,to:t.to}),this.isReconnecting&&this.flushEventQueue()}handleError(t){this.emit("error",{error:Error(t.message),context:t.code}),this.recordDiagnostic(t)}handlePubsub(t){if(t.topic)switch(t.op){case"join":this.joinPubsubTopic(t.topic);break;case"leave":this.leavePubsubTopic(t.topic);break;default:this.log("Unknown pubsub op:",t)}}normalizeDiagnosticMessage(t){return t?"diagnostic"===t.t?t:{t:"diagnostic",sid:t.sid,code:t.code,message:t.message,details:t.details}:{t:"diagnostic",sid:this.sessionId.get()??"",code:"runtime_panic",message:"Runtime diagnostic"}}recordDiagnostic(t){let e=this.normalizeDiagnosticMessage(t);if(this.emit("diagnostic",{diagnostic:e}),!this.options.debug)return;let i=this.buildDiagnosticKey(e),n={key:i,code:e.code??"runtime_panic",message:e.message??"Runtime panic recovered",details:e.details,timestamp:Date.now()},r=this.diagnostics.findIndex(t=>t.key===i);0>r?(this.diagnostics.push(n),this.diagnostics.length>20&&this.diagnostics.shift()):this.diagnostics[r]=n,"u">typeof document&&this.renderErrorOverlay()}buildDiagnosticKey(t){let e=t.details;return[t.code??"",t.message??"",e?.componentId??e?.componentName??"",e?.hook??"",e?.phase??"",e?.panic??""].join("|")}joinPubsubTopic(t){if(!t||!this.client||this.pubsubChannels.has(t))return;let e=this.client.createChannel("pubsub/"+t,{sid:this.sessionId.get()??void 0}),i=e.onLeave(()=>{this.pubsubChannels.delete(t)});this.pubsubChannels.set(t,{channel:e,dispose:i});try{e.join(),this.log("Joined pubsub topic",t)}catch(e){this.pubsubChannels.delete(t),i(),this.log("Failed to join pubsub topic",t,e)}}leavePubsubTopic(t){let e=this.pubsubChannels.get(t);if(e){this.pubsubChannels.delete(t);try{e.dispose(),e.channel.leave(),this.log("Left pubsub topic",t)}catch(e){this.log("Failed to leave pubsub topic",t,e)}}}ensureErrorOverlayElements(){if(!this.options.debug||typeof document>"u"||this.errorOverlay)return;let t=document.createElement("div");t.id="live-error-overlay",t.setAttribute("role","alertdialog"),t.setAttribute("aria-live","assertive"),t.setAttribute("aria-modal","true"),t.style.cssText="position:fixed;inset:0;background:rgba(15,23,42,0.82);color:#e2e8f0;z-index:2147483646;display:none;align-items:flex-start;justify-content:center;overflow-y:auto;padding:48px 24px;box-sizing:border-box;backdrop-filter:blur(6px)",t.addEventListener("click",e=>{e.target===t&&this.hideErrorOverlay()});let e=document.createElement("div");e.style.cssText='width:min(960px,100%);background:rgba(15,23,42,0.95);border-radius:16px;border:1px solid rgba(148,163,184,0.35);box-shadow:0 25px 50px -12px rgba(15,23,42,0.8);display:flex;flex-direction:column;overflow:hidden;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif';let i=document.createElement("header");i.style.cssText="display:flex;align-items:center;justify-content:space-between;gap:12px;padding:20px 24px;background:rgba(15,23,42,0.88);border-bottom:1px solid rgba(148,163,184,0.28);position:sticky;top:0;z-index:1";let n=document.createElement("h2");n.textContent="LiveUI Runtime Errors",n.style.cssText="margin:0;font-size:18px;font-weight:700;color:#f8fafc;";let r=document.createElement("div");r.style.cssText="display:flex;flex-direction:column;gap:4px;",r.appendChild(n);let o=document.createElement("span");o.textContent="â§âE / â§Ctrl+E to toggle â¢ Esc to dismiss",o.style.cssText="font-size:12px;color:#94a3b8;",r.appendChild(o);let s=document.createElement("div");s.style.cssText="display:flex;align-items:center;gap:8px;";let l=document.createElement("button");l.type="button",l.textContent="Retry render",l.style.cssText="padding:6px 12px;border-radius:6px;border:1px solid rgba(59,130,246,0.4);background:rgba(37,99,235,0.18);color:#bfdbfe;font-size:12px;font-weight:600;cursor:pointer",l.addEventListener("click",()=>this.requestRecovery());let a=document.createElement("button");a.type="button",a.textContent="Clear",a.style.cssText="padding:6px 12px;border-radius:6px;border:1px solid rgba(34,197,94,0.45);background:rgba(34,197,94,0.18);color:#bbf7d0;font-size:12px;font-weight:600;cursor:pointer",a.addEventListener("click",()=>this.clearDiagnostics());let u=document.createElement("button");u.type="button",u.textContent="Close",u.style.cssText="padding:6px 12px;border-radius:6px;border:1px solid rgba(248,113,113,0.4);background:rgba(248,113,113,0.18);color:#fecaca;font-size:12px;font-weight:600;cursor:pointer",u.addEventListener("click",()=>this.hideErrorOverlay()),s.appendChild(l),s.appendChild(a),s.appendChild(u),i.appendChild(r),i.appendChild(s);let f=document.createElement("div");f.style.cssText="padding:16px 24px 24px;display:flex;flex-direction:column;gap:16px;",e.appendChild(i),e.appendChild(f),t.appendChild(e),document.body.appendChild(t),this.errorOverlay=t,this.errorListEl=f}renderErrorOverlay(){if(!this.options.debug||typeof document>"u"||(this.ensureErrorOverlayElements(),!this.errorOverlay||!this.errorListEl))return;let t=this.errorListEl;if(t.innerHTML="",0===this.diagnostics.length){let e=document.createElement("div");e.textContent="No runtime errors captured yet.",e.style.cssText="font-size:14px;color:#94a3b8;",t.appendChild(e)}else{let e=[...this.diagnostics].sort((t,e)=>e.timestamp-t.timestamp);for(let i of e)t.appendChild(this.createDiagnosticElement(i))}this.errorOverlay.style.display="flex",this.errorOverlayVisible=1}createDiagnosticElement(t){let e=document.createElement("article");e.style.cssText="background:rgba(15,23,42,0.65);border:1px solid rgba(148,163,184,0.25);border-radius:12px;padding:18px 20px;display:flex;flex-direction:column;gap:12px";let i=document.createElement("div");i.style.cssText="display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px;";let n=document.createElement("h3");n.textContent=t.message||"Runtime panic recovered",n.style.cssText="margin:0;font-size:16px;font-weight:700;color:#f8fafc;";let r=document.createElement("div");r.style.cssText="display:flex;align-items:center;gap:8px;";let o=document.createElement("span");o.textContent=t.code||"runtime_panic",o.style.cssText="font-size:11px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;background:rgba(37,99,235,0.18);color:#bfdbfe;border:1px solid rgba(37,99,235,0.35);border-radius:9999px;padding:4px 10px";let s=document.createElement("time"),l=new Date(t.details?.capturedAt?t.details.capturedAt:t.timestamp);Number.isNaN(l.getTime())?s.textContent=new Date(t.timestamp).toLocaleString():(s.dateTime=l.toISOString(),s.textContent=l.toLocaleString()),s.style.cssText="font-size:12px;color:#94a3b8;",r.appendChild(o),r.appendChild(s),i.appendChild(n),i.appendChild(r),e.appendChild(i);let a=t.details,u=document.createElement("div");if(u.style.cssText="display:flex;flex-direction:column;gap:4px;font-size:12px;color:#cbd5f5;",this.appendMeta(u,"Component",a?.componentName&&a.componentId?`${a.componentName} (${a.componentId})`:a?.componentName??a?.componentId??""),this.appendMeta(u,"Phase",a?.phase),a?.hook&&this.appendMeta(u,"Hook",null!=a.hookIndex?`${a.hook} (#${a.hookIndex})`:a.hook),this.appendMeta(u,"Panic",a?.panic),u.childNodes.length>0&&e.appendChild(u),a?.suggestion){let t=document.createElement("p");t.textContent=a.suggestion,t.style.cssText="margin:0;padding:12px 14px;border-radius:8px;background:rgba(34,197,94,0.12);color:#bbf7d0;font-size:13px;border-left:3px solid rgba(34,197,94,0.45);",e.appendChild(t)}let f=a?.metadata;if(f&&Object.keys(f).length>0){let t=document.createElement("dl");t.style.cssText="display:grid;grid-template-columns:max-content 1fr;gap:4px 12px;padding:12px;border-radius:8px;background:rgba(15,23,42,0.5);";for(let[e,i]of Object.entries(f)){let n=document.createElement("dt");n.textContent=e,n.style.cssText="font-weight:600;color:#e2e8f0;";let r=document.createElement("dd");r.textContent=this.formatMetadataValue(i),r.style.cssText="margin:0;white-space:pre-wrap;color:#cbd5f5;",t.appendChild(n),t.appendChild(r)}e.appendChild(t)}let c="string"==typeof a?.componentId?a.componentId.trim():"";if(c){let t=document.createElement("div");t.style.cssText="display:flex;justify-content:flex-end;margin-top:4px;";let i=document.createElement("button");i.type="button",i.textContent="Reset component",i.title="Request router reset for "+c,i.style.cssText="padding:6px 12px;border-radius:6px;border:1px solid rgba(59,130,246,0.45);background:rgba(37,99,235,0.2);color:#dbeafe;font-size:12px;font-weight:600;cursor:pointer",i.addEventListener("click",()=>{this.requestRouterReset(c)}),t.appendChild(i),e.appendChild(t)}if(a?.stack){let t=document.createElement("pre");t.textContent=a.stack.trim(),t.style.cssText="margin:0;padding:12px;border-radius:8px;background:#020617;color:#f1f5f9;max-height:220px;overflow:auto;font-size:12px;line-height:1.45;",e.appendChild(t)}return e}appendMeta(t,e,i){if(!i)return;let n=document.createElement("div");n.style.cssText="display:flex;gap:6px;align-items:flex-start;";let r=document.createElement("span");r.textContent=e+":",r.style.cssText="font-weight:600;min-width:88px;color:#e2e8f0;";let o=document.createElement("span");o.textContent=i,o.style.cssText="flex:1;",n.appendChild(r),n.appendChild(o),t.appendChild(n)}formatMetadataValue(t){if(null==t)return"null";if("string"==typeof t)return t;if("number"==typeof t||"boolean"==typeof t)return t+"";try{return JSON.stringify(t,null,2)}catch{return t+""}}hideErrorOverlay(){this.errorOverlay&&(this.errorOverlay.style.display="none",this.errorOverlayVisible=0)}clearDiagnostics(){this.diagnostics=[],this.errorListEl&&(this.errorListEl.innerHTML=""),this.hideErrorOverlay()}requestRecovery(){let t=this.sessionId.get();t&&this.channel?(this.log("Requesting runtime recovery"),this.channel.sendMessage("recover",{t:"recover",sid:t})):this.log("Cannot request recovery without active session/channel")}onDebugKeydown(t){if(this.options.debug){if("Escape"===t.key&&this.errorOverlayVisible)return void this.hideErrorOverlay();("e"===t.key||"E"===t.key)&&t.shiftKey&&(t.metaKey||t.ctrlKey)&&(t.preventDefault(),this.renderErrorOverlay())}}sendEvent(t){if("connected"!==this.connectionState.get().status||!this.channel)return this.log("Not connected, queueing event"),void this.eventQueue.push(t);let e={t:"evt",sid:this.sessionId.get(),hid:t.hid,payload:t.payload};this.log("Sending event:",e),this.channel.sendMessage("evt",e),this.metrics.eventsProcessed++}sendUploadMessage(t){"connected"===this.connectionState.get().status&&this.channel?this.channel.sendMessage("upload",t):this.log("Not connected, skipping upload message")}sendNavigation(t,e,i){if("connected"!==this.connectionState.get().status||!this.channel)return this.log("Not connected, cannot navigate"),0;let n={t:"nav",sid:this.sessionId.get(),path:t,q:e,hash:i};return this.log("Sending navigation:",n),this.channel.sendMessage("nav",n),window.history.pushState({},"",`${t}${e?"?"+e:""}${i?"#"+i:""}`),this.lastOptimisticNavTime=Date.now(),1}requestRouterReset(t){let e=this.sessionId.get();if(!e||!this.channel)return void this.log("Cannot request router reset without active session/channel");let i="string"==typeof t?t.trim():"";if(!i)return void this.log("Cannot request router reset without component id");let n={t:"routerReset",sid:e,componentId:i};this.log("Requesting router reset:",n),this.channel.sendMessage("routerReset",n)}sendAck(t){if(!this.channel)return;let e={t:"ack",sid:this.sessionId.get(),seq:t};this.channel.sendMessage("ack",e),"number"==typeof t&&t>this.lastAck&&(this.lastAck=t)}flushEventQueue(){if(0===this.eventQueue.length)return;this.log("Flushing",this.eventQueue.length,"queued events");let t=this.eventQueue;this.eventQueue=[];for(let e of t)this.sendEvent(e)}log(...t){}},ce=null,"u">typeof window&&At().catch(()=>{}),(t=>ke(me({},"__esModule",{value:1}),t))(ze)})();"undefined"!=typeof window&&(window.LiveUI=t.default,window.LiveUI.dom=t.dom,window.LiveUI.applyOps=t.applyOps);