// LiveUI Client v1.0.0 - Built with esbuild
"use strict";var LiveUIModule=(()=>{var bn=Object.create;var we=Object.defineProperty;var yn=Object.getOwnPropertyDescriptor;var En=Object.getOwnPropertyNames;var wn=Object.getPrototypeOf,Cn=Object.prototype.hasOwnProperty;var E=(i,t)=>()=>(t||i((t={exports:{}}).exports,t),t.exports),mt=(i,t)=>{for(var e in t)we(i,e,{get:t[e],enumerable:!0})},gt=(i,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of En(t))!Cn.call(i,s)&&s!==e&&we(i,s,{get:()=>t[s],enumerable:!(n=yn(t,s))||n.enumerable});return i};var Sn=(i,t,e)=>(e=i!=null?bn(wn(i)):{},gt(t||!i||!i.__esModule?we(e,"default",{value:i,enumerable:!0}):e,i)),_n=i=>gt(we({},"__esModule",{value:!0}),i);var $e=E(k=>{"use strict";var Fe=k&&k.__classPrivateFieldSet||function(i,t,e,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?i!==t||!s:!t.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(i,e):s?s.value=e:t.set(i,e),e},G=k&&k.__classPrivateFieldGet||function(i,t,e,n){if(e==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?i!==t||!n:!t.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?n:e==="a"?n.call(i):n?n.value:t.get(i)},ue,T;Object.defineProperty(k,"__esModule",{value:!0});k.Subject=void 0;var ze=class{constructor(){ue.set(this,void 0),T.set(this,void 0),Fe(this,ue,!1,"f"),Fe(this,T,new Set,"f")}get size(){return G(this,T,"f").size}subscribe(t){if(G(this,ue,"f"))throw new Error("Cannot subscribe to a closed subject");return G(this,T,"f").add(t),()=>G(this,T,"f").delete(t)}publish(t){G(this,T,"f").forEach(e=>e(t))}close(){G(this,T,"f").clear(),Fe(this,ue,!0,"f")}};k.Subject=ze;ue=new WeakMap,T=new WeakMap});var bt=E(I=>{"use strict";var vt=I&&I.__classPrivateFieldSet||function(i,t,e,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?i!==t||!s:!t.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(i,e):s?s.value=e:t.set(i,e),e},Ve=I&&I.__classPrivateFieldGet||function(i,t,e,n){if(e==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?i!==t||!n:!t.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?n:e==="a"?n.call(i):n?n.value:t.get(i)},$;Object.defineProperty(I,"__esModule",{value:!0});I.BehaviorSubject=void 0;var An=$e(),We=class extends An.Subject{constructor(t){super(),$.set(this,void 0),vt(this,$,t,"f")}get value(){return Ve(this,$,"f")}publish(t){vt(this,$,t,"f"),super.publish(t)}subscribe(t){return Ve(this,$,"f")&&t(Ve(this,$,"f")),super.subscribe(t)}};I.BehaviorSubject=We;$=new WeakMap});var Et=E(P=>{"use strict";var xn=P&&P.__createBinding||(Object.create?(function(i,t,e,n){n===void 0&&(n=e);var s=Object.getOwnPropertyDescriptor(t,e);(!s||("get"in s?!t.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return t[e]}}),Object.defineProperty(i,n,s)}):(function(i,t,e,n){n===void 0&&(n=e),i[n]=t[e]})),yt=P&&P.__exportStar||function(i,t){for(var e in i)e!=="default"&&!Object.prototype.hasOwnProperty.call(t,e)&&xn(t,i,e)};Object.defineProperty(P,"__esModule",{value:!0});yt(bt(),P);yt($e(),P)});var Je=E(y=>{"use strict";Object.defineProperty(y,"__esModule",{value:!0});y.PubSubEvents=y.Events=y.ChannelReceiver=y.SystemSender=y.ErrorTypes=y.ChannelState=y.ClientActions=y.ServerActions=y.PresenceEventTypes=void 0;var wt;(function(i){i.JOIN="JOIN",i.LEAVE="LEAVE",i.UPDATE="UPDATE"})(wt||(y.PresenceEventTypes=wt={}));var Ct;(function(i){i.PRESENCE="PRESENCE",i.SYSTEM="SYSTEM",i.BROADCAST="BROADCAST",i.ERROR="ERROR",i.CONNECT="CONNECT"})(Ct||(y.ServerActions=Ct={}));var St;(function(i){i.JOIN_CHANNEL="JOIN_CHANNEL",i.LEAVE_CHANNEL="LEAVE_CHANNEL",i.BROADCAST="BROADCAST"})(St||(y.ClientActions=St={}));var _t;(function(i){i.IDLE="IDLE",i.JOINING="JOINING",i.JOINED="JOINED",i.STALLED="STALLED",i.CLOSED="CLOSED"})(_t||(y.ChannelState=_t={}));var At;(function(i){i.UNAUTHORIZED_CONNECTION="UNAUTHORIZED_CONNECTION",i.UNAUTHORIZED_JOIN_REQUEST="UNAUTHORIZED_JOIN_REQUEST",i.UNAUTHORIZED_BROADCAST="UNAUTHORIZED_BROADCAST",i.INVALID_MESSAGE="INVALID_MESSAGE",i.HANDLER_NOT_FOUND="HANDLER_NOT_FOUND",i.PRESENCE_ERROR="PRESENCE_ERROR",i.CHANNEL_ERROR="CHANNEL_ERROR",i.ENDPOINT_ERROR="ENDPOINT_ERROR",i.INTERNAL_SERVER_ERROR="INTERNAL_SERVER_ERROR"})(At||(y.ErrorTypes=At={}));var xt;(function(i){i.ENDPOINT="ENDPOINT",i.CHANNEL="CHANNEL"})(xt||(y.SystemSender=xt={}));var Mt;(function(i){i.ALL_USERS="ALL_USERS",i.ALL_EXCEPT_SENDER="ALL_EXCEPT_SENDER"})(Mt||(y.ChannelReceiver=Mt={}));var Ot;(function(i){i.ACKNOWLEDGE="ACKNOWLEDGE",i.CONNECTION="CONNECTION"})(Ot||(y.Events=Ot={}));var Nt;(function(i){i.MESSAGE="MESSAGE",i.PRESENCE="PRESENCE",i.GET_PRESENCE="GET_PRESENCE"})(Nt||(y.PubSubEvents=Nt={}))});var Tt=E(Ke=>{"use strict";Object.defineProperty(Ke,"__esModule",{value:!0});Ke.uuid=Mn;function Mn(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,i=>{let t=Math.random()*16|0;return(i==="x"?t:t&3|8).toString(16)})}});var It=E(kt=>{"use strict";Object.defineProperty(kt,"__esModule",{value:!0})});var Lt=E(L=>{"use strict";var On=L&&L.__createBinding||(Object.create?(function(i,t,e,n){n===void 0&&(n=e);var s=Object.getOwnPropertyDescriptor(t,e);(!s||("get"in s?!t.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return t[e]}}),Object.defineProperty(i,n,s)}):(function(i,t,e,n){n===void 0&&(n=e),i[n]=t[e]})),Pt=L&&L.__exportStar||function(i,t){for(var e in i)e!=="default"&&!Object.prototype.hasOwnProperty.call(t,e)&&On(t,i,e)};Object.defineProperty(L,"__esModule",{value:!0});Pt(Tt(),L);Pt(It(),L)});var Ut=E(w=>{"use strict";Object.defineProperty(w,"__esModule",{value:!0});w.channelEventSchema=w.serverMessageSchema=w.presenceMessageSchema=w.clientMessageSchema=w.ValidationError=void 0;var x=Je(),v=class extends Error{constructor(t,e){super(e?`${e}: ${t}`:t),this.path=e,this.name="ValidationError"}};w.ValidationError=v;function Rt(i){return typeof i=="object"&&i!==null&&!Array.isArray(i)}function Nn(i){return typeof i=="string"}function Tn(i){return Array.isArray(i)}function kn(i){return Rt(i)?Object.keys(i).every(t=>typeof t=="string"):!1}function R(i,t){if(!Nn(i))throw new v(`Expected string, got ${typeof i}`,t)}function he(i,t){if(!Rt(i))throw new v(`Expected object, got ${typeof i}`,t)}function Ce(i,t){if(!kn(i))throw new v(`Expected record with string keys, got ${typeof i}`,t)}function In(i,t){if(!Tn(i))throw new v(`Expected array, got ${typeof i}`,t)}function Dt(i,t,e){let n=Object.values(t);if(!n.includes(i))throw new v(`Expected one of [${n.join(", ")}], got ${JSON.stringify(i)}`,e)}w.clientMessageSchema={parse(i){he(i,"clientMessage");let t=i;if(!("event"in t))throw new v("Missing required field","event");if(!("requestId"in t))throw new v("Missing required field","requestId");if(!("channelName"in t))throw new v("Missing required field","channelName");if(!("payload"in t))throw new v("Missing required field","payload");if(!("action"in t))throw new v("Missing required field","action");return R(t.event,"event"),R(t.requestId,"requestId"),R(t.channelName,"channelName"),Ce(t.payload,"payload"),Dt(t.action,x.ClientActions,"action"),{event:t.event,requestId:t.requestId,channelName:t.channelName,payload:t.payload,action:t.action}}};w.presenceMessageSchema={parse(i){he(i,"presenceMessage");let t=i;if(!("requestId"in t))throw new v("Missing required field","requestId");if(!("channelName"in t))throw new v("Missing required field","channelName");if(!("event"in t))throw new v("Missing required field","event");if(!("action"in t))throw new v("Missing required field","action");if(!("payload"in t))throw new v("Missing required field","payload");if(R(t.requestId,"requestId"),R(t.channelName,"channelName"),Dt(t.event,x.PresenceEventTypes,"event"),t.action!==x.ServerActions.PRESENCE)throw new v(`Expected ${x.ServerActions.PRESENCE}, got ${JSON.stringify(t.action)}`,"action");he(t.payload,"payload");let e=t.payload;if(!("presence"in e))throw new v("Missing required field","payload.presence");if(!("changed"in e))throw new v("Missing required field","payload.changed");return In(e.presence,"payload.presence"),e.presence.forEach((n,s)=>{Ce(n,`payload.presence[${s}]`)}),Ce(e.changed,"payload.changed"),{requestId:t.requestId,channelName:t.channelName,event:t.event,action:x.ServerActions.PRESENCE,payload:{presence:e.presence,changed:e.changed}}}};w.serverMessageSchema={parse(i){he(i,"serverMessage");let t=i;if(!("event"in t))throw new v("Missing required field","event");if(!("requestId"in t))throw new v("Missing required field","requestId");if(!("channelName"in t))throw new v("Missing required field","channelName");if(!("payload"in t))throw new v("Missing required field","payload");if(!("action"in t))throw new v("Missing required field","action");R(t.event,"event"),R(t.requestId,"requestId"),R(t.channelName,"channelName"),Ce(t.payload,"payload");let e=[x.ServerActions.BROADCAST,x.ServerActions.CONNECT,x.ServerActions.ERROR,x.ServerActions.SYSTEM];if(!e.includes(t.action))throw new v(`Expected one of [${e.join(", ")}], got ${JSON.stringify(t.action)}`,"action");return{event:t.event,requestId:t.requestId,channelName:t.channelName,payload:t.payload,action:t.action}}};w.channelEventSchema={parse(i){he(i,"channelEvent");let t=i;if(!("action"in t))throw new v("Missing required field","action");return t.action===x.ServerActions.PRESENCE?w.presenceMessageSchema.parse(i):w.serverMessageSchema.parse(i)}}});var fe=E(M=>{"use strict";var Pn=M&&M.__createBinding||(Object.create?(function(i,t,e,n){n===void 0&&(n=e);var s=Object.getOwnPropertyDescriptor(t,e);(!s||("get"in s?!t.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return t[e]}}),Object.defineProperty(i,n,s)}):(function(i,t,e,n){n===void 0&&(n=e),i[n]=t[e]})),Se=M&&M.__exportStar||function(i,t){for(var e in i)e!=="default"&&!Object.prototype.hasOwnProperty.call(t,e)&&Pn(t,i,e)};Object.defineProperty(M,"__esModule",{value:!0});Se(Et(),M);Se(Je(),M);Se(Lt(),M);Se(Ut(),M)});var Ht=E(U=>{"use strict";var _=U&&U.__classPrivateFieldSet||function(i,t,e,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?i!==t||!s:!t.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(i,e):s?s.value=e:t.set(i,e),e},f=U&&U.__classPrivateFieldGet||function(i,t,e,n){if(e==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?i!==t||!n:!t.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?n:e==="a"?n.call(i):n?n.value:t.get(i)},C,O,Q,pe,ee,D,me,X,Z,S,qt,jt,Ge,_e,Y;Object.defineProperty(U,"__esModule",{value:!0});U.Channel=void 0;var m=fe(),Qe=class{constructor(t,e,n,s){C.add(this),O.set(this,void 0),Q.set(this,void 0),pe.set(this,void 0),ee.set(this,void 0),D.set(this,void 0),me.set(this,void 0),X.set(this,void 0),Z.set(this,void 0),S.set(this,void 0),_(this,O,n,"f"),_(this,Q,[],"f"),_(this,pe,[],"f"),_(this,me,s,"f"),_(this,D,t,"f"),_(this,Z,e,"f"),_(this,X,new m.Subject,"f"),_(this,S,new m.BehaviorSubject(m.ChannelState.IDLE),"f"),_(this,ee,()=>{},"f")}get channelState(){return f(this,S,"f").value}get presence(){return f(this,pe,"f")}acknowledge(t){f(this,S,"f").publish(m.ChannelState.JOINED),f(this,C,"m",jt).call(this,t),f(this,C,"m",qt).call(this)}join(){let t={action:m.ClientActions.JOIN_CHANNEL,event:m.ClientActions.JOIN_CHANNEL,payload:f(this,me,"f"),channelName:f(this,O,"f"),requestId:(0,m.uuid)()};if(f(this,S,"f").value!==m.ChannelState.JOINED)if(f(this,S,"f").publish(m.ChannelState.JOINING),f(this,Z,"f").value)f(this,D,"f").call(this,t);else{let e=f(this,Z,"f").subscribe(n=>{n&&(e(),f(this,S,"f").value===m.ChannelState.JOINING&&f(this,D,"f").call(this,t))})}}leave(){let t={action:m.ClientActions.LEAVE_CHANNEL,event:m.ClientActions.LEAVE_CHANNEL,channelName:f(this,O,"f"),requestId:(0,m.uuid)(),payload:{}};f(this,C,"m",_e).call(this,t),f(this,S,"f").publish(m.ChannelState.CLOSED),f(this,ee,"f").call(this)}onChannelStateChange(t){return f(this,S,"f").subscribe(e=>{t(e)})}onJoin(t){return f(this,C,"m",Y).call(this,(e,n)=>{if(e===m.PresenceEventTypes.JOIN)return t(n.changed)})}onLeave(t){return f(this,C,"m",Y).call(this,(e,n)=>{if(e===m.PresenceEventTypes.LEAVE)return t(n.changed)})}onMessage(t){return f(this,C,"m",Ge).call(this,(e,n)=>{t(e,n)})}onMessageEvent(t,e){return this.onMessage((n,s)=>{if(n===t)return e(s)})}onPresenceChange(t){return f(this,C,"m",Y).call(this,(e,n)=>{if(e===m.PresenceEventTypes.UPDATE)return t(n)})}onUsersChange(t){return f(this,C,"m",Y).call(this,(e,n)=>t(n.presence))}sendMessage(t,e){let n=(0,m.uuid)(),s={action:m.ClientActions.BROADCAST,channelName:f(this,O,"f"),requestId:n,event:t,payload:e};f(this,C,"m",_e).call(this,s)}sendForResponse(t,e){let n=(0,m.uuid)();return new Promise(s=>{let r=f(this,C,"m",Ge).call(this,(c,l,h)=>{n===h&&(s(l),r())}),a={action:m.ClientActions.BROADCAST,channelName:f(this,O,"f"),requestId:n,event:t,payload:e};f(this,C,"m",_e).call(this,a)})}};U.Channel=Qe;O=new WeakMap,Q=new WeakMap,pe=new WeakMap,ee=new WeakMap,D=new WeakMap,me=new WeakMap,X=new WeakMap,Z=new WeakMap,S=new WeakMap,C=new WeakSet,qt=function(){f(this,Q,"f").forEach(t=>f(this,D,"f").call(this,t)),_(this,Q,[],"f")},jt=function(t){f(this,ee,"f").call(this);let e=t.subscribe(r=>{r.channelName===f(this,O,"f")&&this.channelState===m.ChannelState.JOINED&&f(this,X,"f").publish(r)}),n=f(this,Z,"f").subscribe(r=>{if(r&&f(this,S,"f").value===m.ChannelState.STALLED){let a={action:m.ClientActions.JOIN_CHANNEL,event:m.ClientActions.JOIN_CHANNEL,payload:f(this,me,"f"),channelName:f(this,O,"f"),requestId:(0,m.uuid)()};f(this,D,"f").call(this,a)}else!r&&f(this,S,"f").value===m.ChannelState.JOINED&&f(this,S,"f").publish(m.ChannelState.STALLED)}),s=f(this,C,"m",Y).call(this,(r,a)=>{_(this,pe,a.presence,"f")});_(this,ee,()=>{e(),n(),s()},"f")},Ge=function(t){return f(this,X,"f").subscribe(e=>{if(e.action!==m.ServerActions.PRESENCE)return t(e.event,e.payload,e.requestId)})},_e=function(t){if(f(this,S,"f").value===m.ChannelState.JOINED)return f(this,D,"f").call(this,t);f(this,Q,"f").push(t)},Y=function(t){return f(this,X,"f").subscribe(e=>{if(e.action===m.ServerActions.PRESENCE)return t(e.event,e.payload)})}});var Ye=E(j=>{"use strict";var Ln=j&&j.__classPrivateFieldSet||function(i,t,e,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?i!==t||!s:!t.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(i,e):s?s.value=e:t.set(i,e),e},N=j&&j.__classPrivateFieldGet||function(i,t,e,n){if(e==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?i!==t||!n:!t.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?n:e==="a"?n.call(i):n?n.value:t.get(i)},te,q,Xe,Bt,Ft;Object.defineProperty(j,"__esModule",{value:!0});j.PondClient=void 0;var V=fe(),zt=Ht(),Ze=class{constructor(t,e={}){te.add(this),q.set(this,void 0);let n;try{n=new URL(t)}catch{n=new URL(window.location.toString()),n.pathname=t}this._disconnecting=!1;let s=new URLSearchParams(e);n.search=s.toString();let r=n.protocol==="https:"?"wss:":"ws:";n.protocol!=="wss:"&&n.protocol!=="ws:"&&(n.protocol=r),this._address=n,Ln(this,q,new Map,"f"),this._broadcaster=new V.Subject,this._connectionState=new V.BehaviorSubject(!1),N(this,te,"m",Ft).call(this)}connect(){this._disconnecting=!1;let t=new WebSocket(this._address.toString());t.onmessage=e=>{let n=e.data.trim().split(`
`);for(let s of n)if(s.trim()){let r=JSON.parse(s),a=V.channelEventSchema.parse(r);this._broadcaster.publish(a)}},t.onerror=()=>t.close(),t.onclose=()=>{this._connectionState.publish(!1),!this._disconnecting&&setTimeout(()=>{this.connect()},1e3)},this._socket=t}getState(){return this._connectionState.value}disconnect(){var t;this._connectionState.publish(!1),this._disconnecting=!0,(t=this._socket)===null||t===void 0||t.close(),N(this,q,"f").clear()}createChannel(t,e){let n=N(this,q,"f").get(t);if(n&&n.channelState!==V.ChannelState.CLOSED)return n;let s=N(this,te,"m",Xe).call(this),r=new zt.Channel(s,this._connectionState,t,e||{});return N(this,q,"f").set(t,r),r}onConnectionChange(t){return this._connectionState.subscribe(t)}};j.PondClient=Ze;q=new WeakMap,te=new WeakSet,Xe=function(){return t=>{this._connectionState.value&&this._socket.send(JSON.stringify(t))}},Bt=function(t){var e;let n=(e=N(this,q,"f").get(t.channelName))!==null&&e!==void 0?e:new zt.Channel(N(this,te,"m",Xe).call(this),this._connectionState,t.channelName,{});N(this,q,"f").set(t.channelName,n),n.acknowledge(this._broadcaster)},Ft=function(){this._broadcaster.subscribe(t=>{t.event===V.Events.ACKNOWLEDGE?N(this,te,"m",Bt).call(this,t):t.event===V.Events.CONNECTION&&t.action===V.ServerActions.CONNECT&&this._connectionState.publish(!0)})}});var Wt=E((xi,Vt)=>{var $t=function(){if(typeof self=="object"&&self)return self;if(typeof window=="object"&&window)return window;throw new Error("Unable to resolve global `this`")};Vt.exports=(function(){if(this)return this;if(typeof globalThis=="object"&&globalThis)return globalThis;try{Object.defineProperty(Object.prototype,"__global__",{get:function(){return this},configurable:!0})}catch{return $t()}try{return __global__||$t()}finally{delete Object.prototype.__global__}})()});var Jt=E((Mi,Rn)=>{Rn.exports={name:"websocket",description:"Websocket Client & Server Library implementing the WebSocket protocol as specified in RFC 6455.",keywords:["websocket","websockets","socket","networking","comet","push","RFC-6455","realtime","server","client"],author:"Brian McKelvey <theturtle32@gmail.com> (https://github.com/theturtle32)",contributors:["I\xF1aki Baz Castillo <ibc@aliax.net> (http://dev.sipdoc.net)"],version:"1.0.35",repository:{type:"git",url:"https://github.com/theturtle32/WebSocket-Node.git"},homepage:"https://github.com/theturtle32/WebSocket-Node",engines:{node:">=4.0.0"},dependencies:{bufferutil:"^4.0.1",debug:"^2.2.0","es5-ext":"^0.10.63","typedarray-to-buffer":"^3.1.5","utf-8-validate":"^5.0.2",yaeti:"^0.0.6"},devDependencies:{"buffer-equal":"^1.0.0",gulp:"^4.0.2","gulp-jshint":"^2.0.4","jshint-stylish":"^2.2.1",jshint:"^2.0.0",tape:"^4.9.1"},config:{verbose:!1},scripts:{test:"tape test/unit/*.js",gulp:"gulp"},main:"index",directories:{lib:"./lib"},browser:"lib/browser.js",license:"Apache-2.0"}});var Gt=E((Oi,Kt)=>{Kt.exports=Jt().version});var Zt=E((Ni,Xt)=>{var W;if(typeof globalThis=="object")W=globalThis;else try{W=Wt()}catch{}finally{if(!W&&typeof window<"u"&&(W=window),!W)throw new Error("Could not determine global this")}var ge=W.WebSocket||W.MozWebSocket,Dn=Gt();function Qt(i,t){var e;return t?e=new ge(i,t):e=new ge(i),e}ge&&["CONNECTING","OPEN","CLOSING","CLOSED"].forEach(function(i){Object.defineProperty(Qt,i,{get:function(){return ge[i]}})});Xt.exports={w3cwebsocket:ge?Qt:null,version:Dn}});var Yt=E(Ae=>{"use strict";Object.defineProperty(Ae,"__esModule",{value:!0});Ae.PondClient=void 0;var Un=fe(),qn=Ye(),jn=Zt().w3cwebsocket,et=class extends qn.PondClient{connect(t=1){this._disconnecting=!1;let e=new jn(this._address.toString());e.onopen=()=>this._connectionState.publish(!0),e.onmessage=n=>{let s=n.data.trim().split(`
`);for(let r of s)if(r.trim()){let a=JSON.parse(r),c=Un.channelEventSchema.parse(a);this._broadcaster.publish(c)}},e.onerror=()=>e.close(),e.onclose=()=>{this._connectionState.publish(!1),!this._disconnecting&&setTimeout(()=>{this.connect()},1e3)}}};Ae.PondClient=et});var en=E(ne=>{"use strict";Object.defineProperty(ne,"__esModule",{value:!0});ne.PondClient=ne.ChannelState=void 0;var Hn=fe();Object.defineProperty(ne,"ChannelState",{enumerable:!0,get:function(){return Hn.ChannelState}});var Bn=Ye(),Fn=Yt(),zn=typeof window>"u"?Fn.PondClient:Bn.PondClient;ne.PondClient=zn});var fi={};mt(fi,{ComputedSignal:()=>Re,Signal:()=>K,applyOps:()=>H,bootClient:()=>pt,clearPatcherCaches:()=>Ne,configurePatcher:()=>Me,default:()=>Ee,dom:()=>J,getPatcherConfig:()=>Oe,getPatcherStats:()=>Te,morphElement:()=>xe});var vn=Sn(en(),1);var J={};mt(J,{deleteRow:()=>ot,ensureList:()=>re,getRow:()=>rt,getSlot:()=>se,initLists:()=>it,registerList:()=>Vn,registerSlot:()=>ve,setRow:()=>st,unregisterSlot:()=>$n});var tt=new Map,ie=new Map;function nt(i){let t=new Map;return i&&i.querySelectorAll("[data-row-key]").forEach(n=>{let s=n.getAttribute("data-row-key");s&&t.set(s,n)}),t}function ve(i,t){t&&tt.set(i,t)}function se(i){return tt.get(i)||null}function $n(i){tt.delete(i)}function it(i){if(Array.isArray(i)&&!(typeof document>"u")){for(let t of i)if(!ie.has(t)){let e=document.querySelector(`[data-list-slot="${t}"]`);e&&ie.set(t,{container:e,rows:nt(e)})}}}function re(i){if(ie.has(i))return ie.get(i);let t=document.querySelector(`[data-list-slot="${i}"]`);if(!t)throw new Error(`liveui: list slot ${i} not registered`);let e={container:t,rows:nt(t)};return ie.set(i,e),e}function Vn(i,t,e){t&&ie.set(i,{container:t,rows:e??nt(t)})}function st(i,t,e){re(i).rows.set(t,e)}function rt(i,t){return re(i).rows.get(t)||null}function ot(i,t){re(i).rows.delete(t)}var b={enableDirtyChecking:!0,enableBatching:!0,enableFragmentPooling:!0,enableMemoization:!0,enableVirtualScrolling:!0,virtualScrollThreshold:100,memoizationCacheSize:1e3},tn=document.createElement("template"),oe=new Map;function Wn(i){if(b.enableFragmentPooling&&oe.has(i))return oe.get(i).cloneNode(!0);tn.innerHTML=i;let t=tn.content.cloneNode(!0);return b.enableFragmentPooling&&oe.size<50&&oe.set(i,t.cloneNode(!0)),t}var at=class{constructor(t){this.cache=new Map;this.maxSize=t}key(t,e,n){return`${t}:${e}:${JSON.stringify(n)}`}has(t){return this.cache.has(t)}get(t){return this.cache.get(t)}set(t,e){if(this.cache.size>=this.maxSize){let n=this.cache.keys().next().value;n!==void 0&&this.cache.delete(n)}this.cache.set(t,e)}clear(){this.cache.clear()}},ae=new at(b.memoizationCacheSize),ct=class{constructor(){this.batch={reads:[],writes:[]};this.scheduled=!1}scheduleRead(t){this.batch.reads.push(t),this.schedule()}scheduleWrite(t){this.batch.writes.push(t),this.schedule()}schedule(){this.scheduled||(this.scheduled=!0,requestAnimationFrame(()=>{this.flush()}))}flush(){this.batch.reads.forEach(t=>t()),this.batch.writes.forEach(t=>t()),this.batch={reads:[],writes:[]},this.scheduled=!1}immediate(){this.scheduled&&this.flush()}},ce=new ct,be=new Map;function Jn(i,t){if(!b.enableVirtualScrolling)return;let e={container:t,totalItems:0,visibleRange:{start:0,end:50},itemHeight:0};e.observer=new IntersectionObserver(n=>{n.forEach(s=>{if(s.isIntersecting){let r=s.target;(r instanceof HTMLElement||r instanceof SVGElement)&&(r.style.display="")}})},{root:t,threshold:.1}),be.set(i,e)}function nn(i,t){return b.enableVirtualScrolling&&t>b.virtualScrollThreshold}function Kn(i,t){if(!i)throw new Error(`liveui: slot ${t} not registered`);return i}function Gn(i,t){let e=Kn(se(i),i);b.enableDirtyChecking&&e.textContent===t||(b.enableBatching?ce.scheduleWrite(()=>{e.textContent=t}):e.textContent=t)}function Qn(i,t,e){let n=se(i);if(!(n instanceof Element))throw new Error(`liveui: slot ${i} is not an element`);let s=()=>{if(t)for(let[r,a]of Object.entries(t))a!=null&&(b.enableDirtyChecking&&n.getAttribute(r)===String(a)||n.setAttribute(r,String(a)));if(e)for(let r of e)n.hasAttribute(r)&&n.removeAttribute(r)};b.enableBatching?ce.scheduleWrite(s):s()}function xe(i,t){let e=i.attributes,n=t.attributes;for(let s=e.length-1;s>=0;s--){let r=e[s];t.hasAttribute(r.name)||i.removeAttribute(r.name)}for(let s=0;s<n.length;s++){let r=n[s];i.getAttribute(r.name)!==r.value&&i.setAttribute(r.name,r.value)}i.childNodes.length===1&&i.firstChild?.nodeType===Node.TEXT_NODE&&t.childNodes.length===1&&t.firstChild?.nodeType===Node.TEXT_NODE&&i.firstChild.textContent!==t.firstChild.textContent&&(i.firstChild.textContent=t.firstChild.textContent)}function Xn(i,t){if(!Array.isArray(i)||i.length===0)return;let e=new Set(i),n=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT),s=n.nextNode(),r=s!==null;for(;s&&e.size>0;){let a=s,c=a.getAttribute("data-slot-index");c!==null&&c.split(/\s+/).map(l=>l.trim()).filter(l=>l.length>0).forEach(l=>{let[h,u]=l.split("@"),o=Number(h);if(Number.isNaN(o)||!e.has(o))return;let d=a;if(u!==void 0){let p=Number(u);if(!Number.isNaN(p)){let g=a.childNodes.item(p);g&&(d=g)}}ve(o,d),e.delete(o)}),s=n.nextNode()}e.size>0&&r&&e.forEach(a=>{console.warn(`liveui: slot ${a} not resolved in inserted row`)})}function Zn(i,t){if(!Array.isArray(t)||t.length===0)return;let e=re(i),n=e.container,s=b.enableBatching?Array.from(n.children):null,r=e.rows.size;for(let a of t){if(!a||!a.length)continue;switch(a[0]){case"del":{let l=a[1],h=rt(i,l);if(h&&h.parentNode===n){let u=()=>{n.removeChild(h)};b.enableBatching?ce.scheduleWrite(u):u()}ot(i,l),r--;break}case"ins":{let l=a[1],h=a[2]||{key:"",html:""},u=ae.key("ins",i,h.html),o;b.enableMemoization&&ae.has(u)?o=ae.get(u).cloneNode(!0):(o=Wn(h.html||""),b.enableMemoization&&ae.set(u,o.cloneNode(!0)));let d=Array.from(o.childNodes);if(d.length===0){console.warn("live: insertion payload missing nodes for key",h.key);break}let p=()=>{let g=b.enableBatching?s[l]||null:n.children[l]||null;n.insertBefore(o,g);let A=d[0];if(A instanceof Element){if(st(i,h.key,A),Xn(h.slots||[],A),nn(i,r)){let de=be.get(i);de&&(l<de.visibleRange.start||l>de.visibleRange.end)&&(A instanceof HTMLElement||A instanceof SVGElement)&&(A.style.display="none")}}else console.warn("live: row root is not an element for key",h.key)};b.enableBatching?ce.scheduleWrite(p):p(),r++;break}case"mov":{let l=a[1],h=a[2];if(l===h)break;let u=()=>{let o=b.enableBatching?s:Array.from(n.children),d=o[l];if(d){let p=h<o.length?o[h]:null;n.insertBefore(d,p)}};b.enableBatching?ce.scheduleWrite(u):u();break}default:console.warn("live: unknown list child op",a)}}if(nn(i,r)){let a=be.get(i);a?a.totalItems=r:Jn(i,n)}}function H(i){if(Array.isArray(i)){for(let t of i){if(!t||t.length===0)continue;switch(t[0]){case"setText":Gn(t[1],t[2]);break;case"setAttrs":Qn(t[1],t[2]||{},t[3]||[]);break;case"list":Zn(t[1],t.slice(2));break;default:console.warn("live: unknown op",t)}}b.enableBatching&&ce.immediate()}}function Me(i){Object.assign(b,i)}function Oe(){return{...b}}function Ne(){oe.clear(),ae.clear(),be.clear()}function Te(){return{htmlCacheSize:oe.size,memoizerCacheSize:ae.cache.size,virtualScrollCount:be.size}}function sn(i){let t=[];for(let e of i){let[n,s,...r]=e;if(n==="setText"){let a=se(s);if(a){let c=a.textContent||"";t.push(["setText",s,c])}}else if(n==="setAttrs"){let a=se(s);if(a&&a instanceof Element){let[c,l]=r,h={},u=[];for(let o of Object.keys(c)){let d=a.getAttribute(o);d!==null?h[o]=d:u.push(o)}for(let o of l){let d=a.getAttribute(o);d!==null&&(h[o]=d)}t.push(["setAttrs",s,h,u])}}else if(n==="list"){let a=r,c=[];for(let l of a){let[h,...u]=l;if(h==="ins"){let[,{key:o}]=u;c.push(["del",o])}else if(h!=="del"){if(h==="mov"){let[o,d]=u;c.push(["mov",d,o])}}}c.length>0&&t.push(["list",s,...c.reverse()])}}return t.reverse()}var F=new Map,B=new Map,z=new Map,an=["click","input","change","submit"];function cn(i){if(!(i.hasAttribute("href")||i.hasAttribute("xlink:href")))return!1;let e=i instanceof HTMLAnchorElement,n=i.namespaceURI==="http://www.w3.org/2000/svg"&&i.tagName.toLowerCase()==="a";return e||n}function ye(i){if(i)for(let[t,e]of Object.entries(i)){let n=F.get(t);if(n)for(let s of lt(n))mn(s);F.set(t,e);for(let s of lt(e))ii(s)}}function ln(i){if(Array.isArray(i))for(let t of i){let e=F.get(t);if(F.delete(t),e)for(let n of lt(e))mn(n)}}function dn(){F.clear(),B.clear(),le()}var ke=null,Ie=null,Pe=null;function un(i){ke=i,an.forEach(t=>{ht(t)})}function hn(){z.forEach((i,t)=>{let e=t==="blur"||t==="focus";document.removeEventListener(t,i,e)}),z.clear(),ke=null,Pe=null}function ut(i){Pe=i}function fn(i){Ie=i,z.has("click")||ht("click")}function pn(){Ie=null}function ht(i){if(z.has(i))return;let t=i==="blur"||i==="focus",e=n=>{ke&&ei(n,i,ke)};document.addEventListener(i,e,t),z.set(i,e)}function Yn(i){let t=z.get(i);if(!t)return;let e=i==="blur"||i==="focus";document.removeEventListener(i,t,e),z.delete(i)}function le(){B.forEach((i,t)=>{ht(t)}),z.forEach((i,t)=>{!B.has(t)&&!an.includes(t)&&Yn(t)})}function ei(i,t,e){let n=i.target;if(!n||!(n instanceof Element))return;if(Pe)try{Pe(i,t)}catch(r){console.error("[LiveUI] upload delegate error",r)}let s=ti(n,t);if(s){let r=F.get(s);if(r&&dt(r,t)){let a=ni(i,n,r.props);if(t==="submit"&&i.preventDefault(),t==="click"){let c=rn(n);c&&on(i,c)&&i.preventDefault()}e({hid:s,payload:a});return}}if(t==="click"&&Ie&&i instanceof MouseEvent){let r=rn(n);if(r&&on(i,r)){let a=r.getAttribute("href")??r.getAttribute("xlink:href");if(a)try{let c=new URL(a,window.location.href),l=c.pathname,h=c.search.substring(1),u=c.hash.startsWith("#")?c.hash.substring(1):c.hash;if(Ie(l,h,u)){i.preventDefault(),i.stopPropagation();return}}catch{}}}}function ti(i,t){let e=i;for(;e&&e!==document.documentElement;){let n=`data-on${t}`;if(typeof e.hasAttribute=="function"&&e.hasAttribute(n)){let r=e.getAttribute(n);if(r){let a=F.get(r);if(!a||dt(a,t))return r}}let s=typeof e.getAttributeNames=="function"?e.getAttributeNames():null;if(Array.isArray(s))for(let r of s){if(!r.startsWith("data-on"))continue;let a=e.getAttribute(r);if(!a)continue;let c=F.get(a);if(c&&dt(c,t))return a}e=e.parentElement}return null}function ni(i,t,e){let n={type:i.type};if((t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement)&&(n.value=t.value,t instanceof HTMLInputElement&&(t.type==="checkbox"||t.type==="radio")&&(n.checked=t.checked)),i instanceof KeyboardEvent&&(n.key=i.key,n.keyCode=i.keyCode,n.altKey=i.altKey,n.ctrlKey=i.ctrlKey,n.metaKey=i.metaKey,n.shiftKey=i.shiftKey),i instanceof MouseEvent&&(n.clientX=i.clientX,n.clientY=i.clientY),Array.isArray(e))for(let s of e){let r=si(s,i,t);if(r===void 0)continue;let a=gn(r);a!==void 0&&(n[s]=a)}return n}function rn(i){let t=i;for(;t&&t!==document.documentElement;){if(cn(t))return t;t=t.parentElement}return null}function on(i,t){if(i.button!==0||i.ctrlKey||i.metaKey||i.altKey||i.shiftKey||!cn(t))return!1;let e=t.getAttribute("href")??t.getAttribute("xlink:href")??void 0;if(!e)return!1;let n=t.getAttribute("target");if(n&&n!=="_self")return!1;try{let s=new URL(e,window.location.href);return!(s.origin!==window.location.origin||s.pathname===window.location.pathname&&s.search===window.location.search&&s.hash)}catch{return!1}}function ii(i){let t=B.get(i)??0;B.set(i,t+1)}function mn(i){let t=B.get(i);t&&(t<=1?B.delete(i):B.set(i,t-1))}function lt(i){if(!i)return[];let t=new Set,e=[];if(i.event&&(t.add(i.event),e.push(i.event)),Array.isArray(i.listen))for(let n of i.listen)typeof n!="string"||n.length===0||t.has(n)||(t.add(n),e.push(n));return e}function dt(i,t){return i?i.event===t?!0:Array.isArray(i.listen)?i.listen.includes(t):!1:!1}function si(i,t,e){if(typeof i!="string")return;let n=i.trim();if(n.length===0)return;let s=n.split(".");if(s.length===0)return;let r=s.shift(),a;switch(r){case"event":a=t;break;case"target":a=e;break;case"currentTarget":a=t.currentTarget??void 0;break;default:return}let c=a;for(let l of s)if(l){if(c==null)return;c=c[l]}return c}function gn(i){if(i===null)return null;let t=typeof i;if(t==="string"||t==="number"||t==="boolean")return i;if(i instanceof Date)return i.toISOString();if(typeof FileList<"u"&&i instanceof FileList)return ri(i);if(typeof File<"u"&&i instanceof File)return{name:i.name,size:i.size,type:i.type};if(typeof DOMTokenList<"u"&&i instanceof DOMTokenList)return Array.from(i);if(typeof TimeRanges<"u"&&i instanceof TimeRanges){let e=[];for(let n=0;n<i.length;n++)try{e.push({start:i.start(n),end:i.end(n)})}catch{}return e}if(Array.isArray(i))return i.map(e=>gn(e)).filter(e=>e!==void 0);if(i&&typeof i=="object")try{return JSON.parse(JSON.stringify(i))}catch{return}}function ri(i){let t=[];for(let e=0;e<i.length;e++){let n=i.item(e);n&&t.push({name:n.name,size:n.size,type:n.type})}return t}var Le=class{constructor(t){this.uploads=new Map;this.options=t,ut((e,n)=>this.handleDomEvent(e,n))}dispose(){ut(null),this.abortAll()}onDisconnect(){this.abortAll()}handleControl(t){if(!t||t.op!=="cancel")return;let e=this.uploads.get(t.id);e?.xhr&&e.xhr.abort()}handleDomEvent(t,e){if(e!=="change")return;let n=t.target;if(!n)return;let s=this.resolveInput(n);if(!s)return;let r=s.dataset?.pondUpload;if(!r)return;let a=s.files;if(!a||a.length===0)return;let c=a[0],l=this.options.getSessionId();if(!l||!this.options.isConnected()){console.warn("[LiveUI] upload ignored because the session is not connected"),l&&this.sendMessage({t:"upload",sid:l,id:r,op:"error",error:"not connected"});return}this.sendMessage({t:"upload",sid:l,id:r,op:"change",meta:this.buildMeta(c)}),this.startUpload(l,r,c,s)}startUpload(t,e,n,s){let r=this.uploads.get(e);r?.xhr&&r.xhr.abort();let a=this.options.getEndpoint();if(!a){console.warn("[LiveUI] upload endpoint missing; aborting file upload"),this.sendMessage({t:"upload",sid:t,id:e,op:"error",error:"upload endpoint missing"});return}let c=this.buildUploadURL(a,t,e),l=new XMLHttpRequest;l.open("POST",c,!0),l.upload.onprogress=o=>{if(!o.lengthComputable)return;let d=this.options.getSessionId();d&&this.sendMessage({t:"upload",sid:d,id:e,op:"progress",loaded:o.loaded,total:o.total})};let h=()=>{this.uploads.get(e)?.xhr===l&&this.uploads.delete(e)};l.onload=()=>{if(h(),l.status>=200&&l.status<300)return;let o=this.options.getSessionId();o&&this.sendMessage({t:"upload",sid:o,id:e,op:"error",error:`HTTP ${l.status}`})},l.onerror=()=>{h();let o=this.options.getSessionId();o&&this.sendMessage({t:"upload",sid:o,id:e,op:"error",error:"network error"})},l.onabort=()=>{h();let o=this.options.getSessionId();o&&this.sendMessage({t:"upload",sid:o,id:e,op:"cancelled"})};let u=new FormData;u.append("file",n,n.name),l.send(u),this.uploads.set(e,{xhr:l,input:s}),s.value=""}buildUploadURL(t,e,n){return`${t.endsWith("/")?t:`${t}/`}${encodeURIComponent(e)}/${encodeURIComponent(n)}`}buildMeta(t){return{name:t.name,size:t.size,type:t.type||void 0}}resolveInput(t){if(t instanceof HTMLInputElement)return t;if(t.closest){let e=t.closest('input[type="file"][data-pond-upload]');return e instanceof HTMLInputElement?e:null}return null}sendMessage(t){try{this.options.send(t)}catch(e){console.error("[LiveUI] failed to send upload message",e)}}abortAll(){for(let[,t]of this.uploads)try{t.xhr.abort()}catch(e){console.error("[LiveUI] failed to abort upload",e)}this.uploads.clear()}};var K=class{constructor(t){this.subscribers=new Set;this.value=t}get(){return this.value}set(t){this.value!==t&&(this.value=t,this.notify())}update(t){this.set(t(this.value))}subscribe(t){return this.subscribers.add(t),t(this.value),()=>this.subscribers.delete(t)}notify(){this.subscribers.forEach(t=>t(this.value))}},Re=class{constructor(t,e){this.subscribers=new Set;this.unsubscribers=[];this.value=t(),e.forEach(n=>{let s=n.subscribe(()=>{let r=t();this.value!==r&&(this.value=r,this.notify())});this.unsubscribers.push(s)})}get(){return this.value}subscribe(t){return this.subscribers.add(t),t(this.value),()=>this.subscribers.delete(t)}destroy(){this.unsubscribers.forEach(t=>t()),this.unsubscribers=[],this.subscribers.clear()}notify(){this.subscribers.forEach(t=>t(this.value))}};var De=class{constructor(){this.listeners=new Map}on(t,e){return this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e),()=>this.off(t,e)}off(t,e){let n=this.listeners.get(t);n&&(n.delete(e),n.size===0&&this.listeners.delete(t))}emit(t,e){let n=this.listeners.get(t);n&&n.forEach(s=>{try{s(e)}catch(r){console.error(`Error in event handler for ${String(t)}:`,r)}})}once(t,e){let n=s=>{e(s),this.off(t,n)};return this.on(t,n)}removeAllListeners(t){t?this.listeners.delete(t):this.listeners.clear()}listenerCount(t){return this.listeners.get(t)?.size??0}};var Ue=class{constructor(t){this.updates=new Map;this.nextId=0;this.debug=!1;this.onRollback=t?.onRollback,this.onError=t?.onError,this.debug=t?.debug||!1}apply(t){let e=`opt_${this.nextId++}`,n=sn(t),s={id:e,patches:t,inverseOps:n,timestamp:Date.now()};return this.updates.set(e,s),H(t),this.debug&&console.log("[optimistic] Applied update:",e,"patches:",t.length),e}commit(t){this.updates.delete(t)&&this.debug&&console.log("[optimistic] Committed update:",t)}rollback(t){let e=this.updates.get(t);if(e){this.debug&&console.log("[optimistic] Rolling back update:",t,"inverse ops:",e.inverseOps.length);try{H(e.inverseOps),this.onRollback?.(t,e.patches)}catch(n){console.error("[optimistic] Rollback error:",n),this.onError?.(n,"rollback")}this.updates.delete(t)}}getPendingCount(){return this.updates.size}clear(){this.updates.clear()}};var qe=class{constructor(t){this.boot=null;this.debug=!1;this.debug=t?.debug||!1}load(t){let e=t??this.detect();return!e||typeof e.sid!="string"||e.sid.length===0?(this.log("No boot payload detected or payload invalid"),null):(this.apply(e),e)}detect(){if(typeof window<"u"){let t=window.__LIVEUI_BOOT__;if(t&&typeof t=="object"&&typeof t.sid=="string")return t}if(typeof document<"u"){let e=document.getElementById("live-boot")?.textContent;if(e)try{return JSON.parse(e)}catch(n){this.log("Failed to parse boot payload from DOM",n)}}return null}apply(t){if(this.boot=t,t.handlers&&(ye(t.handlers),le()),this.registerInitialDom(t),typeof window<"u"&&t.location){let e=t.location.q?`?${t.location.q}`:"",n=t.location.hash?`#${t.location.hash}`:"",s=`${t.location.path}${e}${n}`,r=`${window.location.pathname}${window.location.search}${window.location.hash}`;s&&r!==s&&window.history.replaceState({},"",s)}}registerInitialDom(t){if(typeof document>"u")return;let e=this.collectSlotAnchors();if(Array.isArray(t.slots))for(let s of t.slots){if(!s||typeof s.anchorId!="number")continue;let r=e.get(s.anchorId);r?ve(s.anchorId,r):this.debug&&console.warn(`liveui: slot ${s.anchorId} not registered during boot`)}let n=this.collectListSlotIndexes(t.d);n.length>0&&it(n)}collectListSlotIndexes(t){if(!Array.isArray(t))return[];let e=[];return t.forEach((n,s)=>{n&&n.kind==="list"&&e.push(s)}),e}collectSlotAnchors(){let t=new Map;return typeof document>"u"||document.querySelectorAll("[data-slot-index]").forEach(n=>{let s=n.getAttribute("data-slot-index");s&&s.split(/\s+/).map(r=>r.trim()).filter(r=>r.length>0).forEach(r=>{let[a,c]=r.split("@"),l=Number(a);if(Number.isNaN(l)||t.has(l))return;let h=n;if(c!==void 0){let u=Number(c);if(!Number.isNaN(u)){let o=n.childNodes.item(u);o&&(h=o)}}t.set(l,h)})}),t}get(){return this.boot}ensure(){if(!this.boot||!this.boot.sid)throw new Error("LiveUI: boot payload is required before connecting");return this.boot}getJoinLocation(){let t=this.boot?.location??{path:"/",q:"",hash:""};if(typeof window>"u")return t;let e=window.location.pathname||t.path||"/",n=window.location.search??"",s=n.startsWith("?")?n.substring(1):n,r=window.location.hash??"",a=r.startsWith("#")?r.substring(1):r;return{path:e,q:s,hash:a}}log(...t){this.debug&&console.log("[boot]",...t)}};var oi=i=>i===null||typeof i!="object"?!1:typeof i.t=="string",ai="/pondlive/cookie",ft=class extends De{constructor(e={}){super();this.client=null;this.channel=null;this.pubsubChannels=new Map;this.connectionState=new K({status:"disconnected"});this.sessionId=new K(null);this.version=new K(0);this.lastAck=0;this.hasBootPayload=!1;this.autoConnectCleanup=null;this.expectedSeq=null;this.frameBuffer=new Map;this.MAX_FRAME_BUFFER_SIZE=50;this.eventQueue=[];this.patchQueue=[];this.batchScheduled=!1;this.rafHandle=null;this.rafUsesTimeoutFallback=!1;this.cookieRequests=new Set;this.reconnectAttempts=0;this.reconnectTimer=null;this.isReconnecting=!1;this.diagnostics=[];this.errorOverlay=null;this.errorListEl=null;this.errorOverlayVisible=!1;this.handleDebugKeydown=e=>this.onDebugKeydown(e);this.metrics={patchesApplied:0,averagePatchTime:0,framesReceived:0,eventsProcessed:0,reconnections:0,uptime:0,effectsMs:0,maxEffectMs:0,slowEffects:0,framesBuffered:0,framesDropped:0,sequenceGaps:0};this.startTime=0;this.patchTimes=[];this.patchTimeTotal=0;this.uploads=null;this.lastOptimisticNavTime=0;this.OPTIMISTIC_NAV_WINDOW=100;this.eventDebouncer=new Map;this.handlePopState=()=>{if(this.connectionState.get().status!=="connected"||!this.channel){this.log("Not connected, cannot handle popstate");return}let n=window.location.pathname,s=window.location.search.substring(1),r=window.location.hash.startsWith("#")?window.location.hash.substring(1):window.location.hash,a={t:"pop",sid:this.sessionId.get(),path:n,q:s,hash:r};this.log("Sending popstate navigation:",a),this.channel.sendMessage("pop",a)};this.bootHandler=new qe({debug:e.debug||!1}),this.optimistic=new Ue({onRollback:(a,c)=>this.emit("rollback",{id:a,patches:c}),onError:(a,c)=>this.emit("error",{error:a,context:c}),debug:e.debug||!1}),this.uploads=new Le({getSessionId:()=>this.sessionId.get(),getEndpoint:()=>this.options.uploadEndpoint??null,send:a=>this.sendUploadMessage(a),isConnected:()=>this.connectionState.get().status==="connected"&&this.channel!==null});let n={...e??{}},s=n.boot??null;delete n.boot,this.options={endpoint:n.endpoint??"/live",uploadEndpoint:n.uploadEndpoint??"/pondlive/upload/",autoConnect:n.autoConnect!==!1,debug:n.debug??!1,reconnect:n.reconnect!==!1,maxReconnectAttempts:n.maxReconnectAttempts??5,reconnectDelay:n.reconnectDelay??1e3,...n},s&&(this.options.boot=s);let r=this.bootHandler.load(s);if(this.hasBootPayload=!!r,r&&(r.client?.endpoint&&typeof r.client.endpoint=="string"&&(this.options.endpoint=r.client.endpoint),r.client?.upload&&typeof r.client.upload=="string"&&(this.options.uploadEndpoint=r.client.upload),this.sessionId.set(r.sid),this.version.set(r.ver??0),this.lastAck=r.seq??0,r.errors&&r.errors.length>0))for(let a of r.errors)this.recordDiagnostic(a);this.connectionState.subscribe(a=>{this.log("Connection state changed:",a)}),this.options.debug&&typeof window<"u"&&window.addEventListener("keydown",this.handleDebugKeydown),this.setupAutoConnect()}async connect(){this.clearAutoConnect();let e=this.connectionState.get();if(e.status==="connected"||e.status==="connecting"){this.log("Already connected or connecting");return}let n;try{n=this.bootHandler.ensure()}catch(s){this.log("Boot payload error:",s),this.setState({status:"error",error:s}),this.emit("error",{error:s,context:"boot"});return}n.client?.endpoint&&typeof n.client.endpoint=="string"&&(this.options.endpoint=n.client.endpoint),n.client?.upload&&typeof n.client.upload=="string"&&(this.options.uploadEndpoint=n.client.upload),this.setState({status:"connecting"}),this.startTime=Date.now();try{this.log("Connecting to",this.options.endpoint);let s=n.sid,r=this.bootHandler.getJoinLocation(),a={sid:s,ver:n.ver??0,ack:this.lastAck??n.seq??0,loc:{path:r.path,q:r.q,hash:r.hash}};this.client=new vn.PondClient(this.options.endpoint),typeof document<"u"&&un(l=>this.sendEvent(l)),typeof document<"u"&&fn((l,h,u)=>this.sendNavigation(l,h,u)),typeof window<"u"&&window.addEventListener("popstate",this.handlePopState);let c=`live/${s}`;this.channel=this.client.createChannel(c,a),this.channel.onChannelStateChange(l=>{this.log("Channel state changed:",l),l==="JOINED"&&this.onConnected()}),this.channel.onMessage((l,h)=>{oi(h)?this.handleMessage(h):this.log("Ignoring non-server payload",l,h)}),this.channel.onLeave(()=>{this.log("Channel left"),this.onDisconnected()}),this.client.connect(),this.channel.join()}catch(s){this.log("Connection error:",s),this.setState({status:"error",error:s}),this.emit("error",{error:s,context:"connect"}),this.options.reconnect&&!this.isReconnecting&&this.scheduleReconnect()}}disconnect(){this.clearReconnectTimer(),this.isReconnecting=!1,this.cancelScheduledBatch(),this.patchQueue=[];for(let e of this.pubsubChannels.values())try{e.dispose(),e.channel.leave()}catch(n){this.log("Error leaving pubsub channel",n)}this.pubsubChannels.clear(),this.channel&&(this.channel.leave(),this.channel=null),this.client&&(this.client.disconnect(),this.client=null),typeof window<"u"&&window.removeEventListener("popstate",this.handlePopState),this.setState({status:"disconnected"}),this.sessionId.set(null),this.version.set(0),dn(),hn(),pn(),this.uploads?.onDisconnect(),this.emit("disconnected",void 0)}setupAutoConnect(){if(!this.options.autoConnect)return;if(!this.hasBootPayload){this.log("Auto-connect skipped: no boot payload detected");return}let e=()=>{this.clearAutoConnect(),this.log("Auto-connecting after DOM ready"),this.connect().catch(n=>{this.log("Auto-connect failed:",n)})};if(typeof document>"u"){e();return}if(document.readyState==="loading"){let n=()=>{document.removeEventListener("DOMContentLoaded",n),e()};document.addEventListener("DOMContentLoaded",n),this.autoConnectCleanup=()=>{document.removeEventListener("DOMContentLoaded",n)};return}typeof queueMicrotask=="function"?queueMicrotask(e):Promise.resolve().then(e)}clearAutoConnect(){this.autoConnectCleanup&&(this.autoConnectCleanup(),this.autoConnectCleanup=null)}getConnectionState(){return this.connectionState.get()}getMetrics(){return{...this.metrics,uptime:this.startTime?Date.now()-this.startTime:0}}onStateChange(e){return this.connectionState.subscribe(e)}onSessionIdChange(e){return this.sessionId.subscribe(e)}onVersionChange(e){return this.version.subscribe(e)}sendEventDebounced(e,n=300){let s=this.eventDebouncer.get(e.hid);s&&clearTimeout(s);let r=setTimeout(()=>{this.sendEvent(e),this.eventDebouncer.delete(e.hid)},n);this.eventDebouncer.set(e.hid,r)}applyOptimistic(e){return this.optimistic.apply(e)}commitOptimistic(e){this.optimistic.commit(e)}rollbackOptimistic(e){this.optimistic.rollback(e)}setState(e){let n=this.connectionState.get();this.hasStateChanged(n,e)&&(this.connectionState.set(e),this.emit("stateChanged",{from:n,to:e}))}onConnected(){let e=this.sessionId.get(),n=this.version.get();e&&(this.isReconnecting&&(this.isReconnecting=!1,this.reconnectAttempts=0,this.emit("reconnected",{sessionId:e})),this.setState({status:"connected",sessionId:e,version:n}),this.emit("connected",{sessionId:e,version:n}),this.flushEventQueue())}onDisconnected(){this.setState({status:"disconnected"}),this.options.reconnect&&!this.isReconnecting&&this.scheduleReconnect(),this.uploads?.onDisconnect()}scheduleReconnect(){if(this.reconnectAttempts>=this.options.maxReconnectAttempts){this.log("Max reconnect attempts reached"),this.emit("error",{error:new Error("Max reconnect attempts reached"),context:"reconnect"});return}this.isReconnecting=!0,this.reconnectAttempts++;let e=this.options.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);this.log(`Reconnecting in ${e}ms (attempt ${this.reconnectAttempts}/${this.options.maxReconnectAttempts})`),this.setState({status:"reconnecting",attempt:this.reconnectAttempts}),this.emit("reconnecting",{attempt:this.reconnectAttempts}),this.reconnectTimer=setTimeout(()=>{this.metrics.reconnections++,this.connect()},e)}clearReconnectTimer(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null)}handleMessage(e){if(!e||!e.t){this.log("Invalid message",e);return}switch(this.log("Received message:",e.t,e),e.t){case"init":this.handleInit(e);break;case"frame":this.handleFrame(e);break;case"join":this.handleJoin(e);break;case"resume":this.handleResume(e);break;case"error":this.handleError(e);break;case"pubsub":this.handlePubsub(e);break;case"upload":this.uploads?.handleControl(e);break;default:this.log("Unknown message type:",e.t)}}handleInit(e){if(this.sessionId.set(e.sid),this.version.set(e.ver),this.expectedSeq=e.seq!==void 0?e.seq+1:null,this.frameBuffer.clear(),Array.isArray(e.errors)&&e.errors.length>0)for(let n of e.errors)this.recordDiagnostic(n);e.handlers&&(ye(e.handlers),le()),e.seq!==void 0&&(this.lastAck=e.seq,this.sendAck(e.seq)),this.log("Session initialized:",e.sid,"version:",e.ver),this.onConnected()}handleFrame(e){let n=this.sessionId.get();if(e.sid!==n){this.log("Session mismatch, ignoring frame");return}if(this.metrics.framesReceived++,e.seq!==void 0){if(this.expectedSeq===null){this.expectedSeq=e.seq+1,this.applyFrame(e),this.drainFrameBuffer();return}if(e.seq===this.expectedSeq){this.expectedSeq=e.seq+1,this.applyFrame(e),this.drainFrameBuffer();return}if(e.seq>this.expectedSeq){if(this.metrics.sequenceGaps++,this.log("Frame arrived out of order",{expected:this.expectedSeq,received:e.seq,gap:e.seq-this.expectedSeq}),this.frameBuffer.size>=this.MAX_FRAME_BUFFER_SIZE){this.metrics.framesDropped++,this.log("Frame buffer full, dropping oldest frame");let s=Math.min(...this.frameBuffer.keys());this.frameBuffer.delete(s)}this.frameBuffer.set(e.seq,e),this.metrics.framesBuffered++;return}if(e.seq<this.expectedSeq){this.metrics.framesDropped++,this.log("Dropping duplicate/late frame",{expected:this.expectedSeq,received:e.seq});return}}else this.applyFrame(e)}applyFrame(e){if(this.version.set(e.ver),e.patch&&e.patch.length>0&&(this.log("Queueing",e.patch.length,"operations"),this.patchQueue.push(...e.patch),this.scheduleBatch()),e.handlers&&(e.handlers.add&&ye(e.handlers.add),e.handlers.del&&ln(e.handlers.del),le()),e.nav){let s=Date.now()-this.lastOptimisticNavTime<this.OPTIMISTIC_NAV_WINDOW;e.nav.push?s?window.history.replaceState({},"",e.nav.push):window.history.pushState({},"",e.nav.push):e.nav.replace&&window.history.replaceState({},"",e.nav.replace),this.lastOptimisticNavTime=0}e.effects&&e.effects.length>0&&this.applyEffects(e.effects),e.seq!==void 0&&this.sendAck(e.seq),e.metrics&&(this.log("Frame metrics:",e.metrics),typeof e.metrics.effectsMs=="number"&&(this.metrics.effectsMs=e.metrics.effectsMs),typeof e.metrics.maxEffectMs=="number"&&(this.metrics.maxEffectMs=e.metrics.maxEffectMs),typeof e.metrics.slowEffects=="number"&&(this.metrics.slowEffects=e.metrics.slowEffects))}drainFrameBuffer(){for(;this.expectedSeq!==null&&this.frameBuffer.has(this.expectedSeq);){let e=this.frameBuffer.get(this.expectedSeq);this.frameBuffer.delete(this.expectedSeq),this.expectedSeq=e.seq+1,this.log("Draining buffered frame",{seq:e.seq}),this.applyFrame(e)}}applyEffects(e){for(let n of e)try{switch(this.log("Applying effect:",n),this.emit("effect",{effect:n}),typeof n.type=="string"?n.type.toLowerCase():""){case"scroll":case"scrolltop":this.applyScrollEffect(n);break;case"focus":this.applyFocusEffect(n);break;case"alert":window.alert(n.message);break;case"toast":this.applyToastEffect(n);break;case"push":this.applyPushEffect(n);break;case"replace":this.applyReplaceEffect(n);break;case"dispatch":this.dispatchCustomEvent(n.eventName,n.detail);break;case"metadata":this.applyMetadataEffect(n);break;case"cookies":this.handleCookieEffect(n);break;case"custom":break;default:this.log("Unknown effect type:",n.type);break}}catch(s){this.log("Error applying effect:",n,s),this.emit("error",{error:s,context:"effect"})}}applyScrollEffect(e){let n=e.behavior||"smooth",s=e.selector;if(!s||e.type==="ScrollTop"){window.scrollTo({top:0,behavior:n});return}let r=document.querySelector(s);r instanceof Element&&r.scrollIntoView({behavior:n,block:e.block||"start"})}applyMetadataEffect(e){if(typeof document>"u")return;Object.prototype.hasOwnProperty.call(e,"title")&&e.title!==void 0&&(document.title=e.title);let n=document.head;if(!n)return;let s="data-live-key",r="data-live-head",a=o=>{!Array.isArray(o)||o.length===0||o.forEach(d=>{n.querySelectorAll(`[${s}="${d}"]`).forEach(p=>{p.parentNode?.removeChild(p)})})},c=(o,d)=>{let p=new Set(d);Array.from(o.attributes).forEach(g=>{p.has(g.name)||o.removeAttribute(g.name)})},l=(o,d)=>{if(!o||!o.key)return;let p=n.querySelector(`meta[${s}="${o.key}"]`);if(p||(p=document.createElement("meta"),n.appendChild(p)),c(p,[s]),p.setAttribute(s,o.key),p.setAttribute(r,d),o.name!==void 0&&p.setAttribute("name",o.name),o.content!==void 0&&p.setAttribute("content",o.content),o.property!==void 0&&p.setAttribute("property",o.property),o.charset!==void 0&&p.setAttribute("charset",o.charset),o.httpEquiv!==void 0&&p.setAttribute("http-equiv",o.httpEquiv),o.itemProp!==void 0&&p.setAttribute("itemprop",o.itemProp),o.attrs)for(let[g,A]of Object.entries(o.attrs))A!=null&&p.setAttribute(g,String(A))},h=o=>{if(!o||!o.key)return;let d=n.querySelector(`link[${s}="${o.key}"]`);if(d||(d=document.createElement("link"),n.appendChild(d)),c(d,[s]),d.setAttribute(s,o.key),d.setAttribute(r,"link"),o.rel!==void 0&&d.setAttribute("rel",o.rel),o.href!==void 0&&d.setAttribute("href",o.href),o.type!==void 0&&d.setAttribute("type",o.type),o.as!==void 0&&d.setAttribute("as",o.as),o.media!==void 0&&d.setAttribute("media",o.media),o.hreflang!==void 0&&d.setAttribute("hreflang",o.hreflang),o.title!==void 0&&d.setAttribute("title",o.title),o.crossorigin!==void 0&&d.setAttribute("crossorigin",o.crossorigin),o.integrity!==void 0&&d.setAttribute("integrity",o.integrity),o.referrerpolicy!==void 0&&d.setAttribute("referrerpolicy",o.referrerpolicy),o.sizes!==void 0&&d.setAttribute("sizes",o.sizes),o.attrs)for(let[p,g]of Object.entries(o.attrs))g!=null&&d.setAttribute(p,String(g))},u=o=>{if(!o||!o.key)return;let d=n.querySelector(`script[${s}="${o.key}"]`);if(d||(d=document.createElement("script"),n.appendChild(d)),c(d,[s]),d.setAttribute(s,o.key),d.setAttribute(r,"script"),o.module?d.setAttribute("type","module"):o.type!==void 0&&d.setAttribute("type",o.type),o.src!==void 0&&d.setAttribute("src",o.src),o.async&&d.setAttribute("async","async"),o.defer&&d.setAttribute("defer","defer"),o.noModule&&d.setAttribute("nomodule","nomodule"),o.crossorigin!==void 0&&d.setAttribute("crossorigin",o.crossorigin),o.integrity!==void 0&&d.setAttribute("integrity",o.integrity),o.referrerpolicy!==void 0&&d.setAttribute("referrerpolicy",o.referrerpolicy),o.nonce!==void 0&&d.setAttribute("nonce",o.nonce),o.attrs)for(let[p,g]of Object.entries(o.attrs))g!=null&&d.setAttribute(p,String(g));o.inner!==void 0&&(d.textContent=o.inner)};if(e.clearDescription&&a(["description"]),Object.prototype.hasOwnProperty.call(e,"description")&&e.description!==void 0){let o=e.description;o.trim().length>0?l({key:"description",name:"description",content:o},"description"):a(["description"])}if(Array.isArray(e.metaRemove)&&a(e.metaRemove),Array.isArray(e.metaAdd))for(let o of e.metaAdd)l(o,"meta");if(Array.isArray(e.linkRemove)&&a(e.linkRemove),Array.isArray(e.linkAdd))for(let o of e.linkAdd)h(o);if(Array.isArray(e.scriptRemove)&&a(e.scriptRemove),Array.isArray(e.scriptAdd))for(let o of e.scriptAdd)u(o)}handleCookieEffect(e){this.performCookieSync(e)}async performCookieSync(e){let n=e.token??e.Token;if(!n){this.log("Cookie effect missing token",e);return}if(this.cookieRequests.has(n))return;let s=e.endpoint??e.Endpoint??ai;if(!s){this.log("Cookie effect missing endpoint",e);return}let r=e.sid??e.SID??this.sessionId.get();if(!r){this.log("Cookie effect missing session identifier",e);return}let a=(e.method??e.Method??"POST").toUpperCase();this.cookieRequests.add(n);try{let c=await fetch(s,{method:a,credentials:"include",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({sid:r,token:n})});!c.ok&&c.status!==204&&this.log("Cookie negotiation failed",{endpoint:s,status:c.status,statusText:c.statusText})}catch(c){this.log("Cookie negotiation error",c),this.emit("error",{error:c,context:"cookies"})}finally{this.cookieRequests.delete(n)}}applyFocusEffect(e){let n=e.selector||e.Selector;if(!n)return;let s=document.querySelector(n);s&&(s instanceof HTMLElement||s instanceof SVGElement)&&typeof s.focus=="function"&&s.focus()}applyToastEffect(e){let n=e.message||e.Message,s=e.duration||3e3,r=e.variant||"info";this.emit("effect",{effect:{type:"toast",message:n,duration:s,variant:r}}),this.listenerCount("effect")||console.info(`[Toast ${r}] ${n}`)}applyPushEffect(e){let n=e.url||e.URL;n&&window.history.pushState({},"",n)}applyReplaceEffect(e){let n=e.url||e.URL;n&&window.history.replaceState({},"",n)}dispatchCustomEvent(e,n){let s=new CustomEvent(e,{detail:n,bubbles:!0,cancelable:!0});document.dispatchEvent(s)}scheduleBatch(){if(this.batchScheduled)return;if(this.batchScheduled=!0,typeof requestAnimationFrame=="function"){this.rafUsesTimeoutFallback=!1,this.rafHandle=requestAnimationFrame(()=>{this.rafHandle=null,this.flushBatch()});return}this.rafUsesTimeoutFallback=!0;let e=setTimeout(()=>{this.rafHandle=null,this.flushBatch()},16);this.rafHandle=e}flushBatch(){if(this.patchQueue.length===0){this.batchScheduled=!1,this.rafHandle=null,this.rafUsesTimeoutFallback=!1;return}let e=performance.now();this.log("Applying batched",this.patchQueue.length,"operations");let n=this.patchQueue;this.patchQueue=[],this.batchScheduled=!1,this.rafHandle=null,this.rafUsesTimeoutFallback=!1,H(n);let s=performance.now()-e;if(this.metrics.patchesApplied+=n.length,this.patchTimes.push(s),this.patchTimeTotal+=s,this.patchTimes.length>100){let a=this.patchTimes.shift();a!==void 0&&(this.patchTimeTotal-=a)}let r=this.patchTimes.length;this.metrics.averagePatchTime=r?this.patchTimeTotal/r:0,this.emit("frameApplied",{operations:n.length,duration:s}),this.emit("metricsUpdated",this.getMetrics())}cancelScheduledBatch(){this.rafHandle!==null&&(this.rafUsesTimeoutFallback?clearTimeout(this.rafHandle):typeof cancelAnimationFrame=="function"&&cancelAnimationFrame(this.rafHandle),this.rafHandle=null,this.batchScheduled=!1,this.rafUsesTimeoutFallback=!1)}hasStateChanged(e,n){if(e.status!==n.status)return!0;switch(n.status){case"connected":return e.status!=="connected"||e.sessionId!==n.sessionId||e.version!==n.version;case"reconnecting":return e.status!=="reconnecting"||e.attempt!==n.attempt;case"error":return e.status!=="error"||e.error!==n.error;default:return!1}}handleJoin(e){this.sessionId.set(e.sid),this.version.set(e.ver),typeof e.ack=="number"&&e.ack>this.lastAck&&(this.lastAck=e.ack),this.log("Joined session:",e.sid,"ack:",e.ack)}handleResume(e){this.log("Resume from",e.from,"to",e.to);let n=e.from>0?e.from-1:0;if(n>this.lastAck&&(this.lastAck=n),this.expectedSeq=e.from,this.frameBuffer.clear(),Array.isArray(e.errors)&&e.errors.length>0)for(let s of e.errors)this.recordDiagnostic(s);this.emit("resumed",{from:e.from,to:e.to}),this.isReconnecting&&this.flushEventQueue()}handleError(e){let n=new Error(e.message);console.error("LiveUI error:",e.code,e.message),this.emit("error",{error:n,context:e.code}),this.recordDiagnostic(e)}handlePubsub(e){if(e.topic)switch(e.op){case"join":this.joinPubsubTopic(e.topic);break;case"leave":this.leavePubsubTopic(e.topic);break;default:this.log("Unknown pubsub op:",e)}}recordDiagnostic(e){if(!this.options.debug)return;let n=this.buildDiagnosticKey(e),s={key:n,code:e.code??"runtime_panic",message:e.message??"Runtime panic recovered",details:e.details,timestamp:Date.now()},r=this.diagnostics.findIndex(a=>a.key===n);r>=0?this.diagnostics[r]=s:(this.diagnostics.push(s),this.diagnostics.length>20&&this.diagnostics.shift()),typeof document<"u"&&this.renderErrorOverlay()}buildDiagnosticKey(e){let n=e.details,s=n?.componentId??n?.componentName??"",r=n?.hook??"",a=n?.phase??"",c=n?.panic??"";return[e.code??"",e.message??"",s,r,a,c].join("|")}joinPubsubTopic(e){if(!e||!this.client||this.pubsubChannels.has(e))return;let n=this.client.createChannel(`pubsub/${e}`,{sid:this.sessionId.get()??void 0}),s=n.onLeave(()=>{this.pubsubChannels.delete(e)});this.pubsubChannels.set(e,{channel:n,dispose:s});try{n.join(),this.log("Joined pubsub topic",e)}catch(r){this.pubsubChannels.delete(e),s(),this.log("Failed to join pubsub topic",e,r)}}leavePubsubTopic(e){let n=this.pubsubChannels.get(e);if(n){this.pubsubChannels.delete(e);try{n.dispose(),n.channel.leave(),this.log("Left pubsub topic",e)}catch(s){this.log("Failed to leave pubsub topic",e,s)}}}ensureErrorOverlayElements(){if(!this.options.debug||typeof document>"u"||this.errorOverlay)return;let e=document.createElement("div");e.id="live-error-overlay",e.setAttribute("role","alertdialog"),e.setAttribute("aria-live","assertive"),e.setAttribute("aria-modal","true"),e.style.cssText=["position:fixed","inset:0","background:rgba(15,23,42,0.82)","color:#e2e8f0","z-index:2147483646","display:none","align-items:flex-start","justify-content:center","overflow-y:auto","padding:48px 24px","box-sizing:border-box","backdrop-filter:blur(6px)"].join(";"),e.addEventListener("click",p=>{p.target===e&&this.hideErrorOverlay()});let n=document.createElement("div");n.style.cssText=["width:min(960px,100%)","background:rgba(15,23,42,0.95)","border-radius:16px","border:1px solid rgba(148,163,184,0.35)","box-shadow:0 25px 50px -12px rgba(15,23,42,0.8)","display:flex","flex-direction:column","overflow:hidden",'font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif'].join(";");let s=document.createElement("header");s.style.cssText=["display:flex","align-items:center","justify-content:space-between","gap:12px","padding:20px 24px","background:rgba(15,23,42,0.88)","border-bottom:1px solid rgba(148,163,184,0.28)","position:sticky","top:0","z-index:1"].join(";");let r=document.createElement("h2");r.textContent="LiveUI Runtime Errors",r.style.cssText="margin:0;font-size:18px;font-weight:700;color:#f8fafc;";let a=document.createElement("div");a.style.cssText="display:flex;flex-direction:column;gap:4px;",a.appendChild(r);let c=document.createElement("span");c.textContent="\u21E7\u2318E / \u21E7Ctrl+E to toggle \u2022 Esc to dismiss",c.style.cssText="font-size:12px;color:#94a3b8;",a.appendChild(c);let l=document.createElement("div");l.style.cssText="display:flex;align-items:center;gap:8px;";let h=document.createElement("button");h.type="button",h.textContent="Retry render",h.style.cssText=["padding:6px 12px","border-radius:6px","border:1px solid rgba(59,130,246,0.4)","background:rgba(37,99,235,0.18)","color:#bfdbfe","font-size:12px","font-weight:600","cursor:pointer"].join(";"),h.addEventListener("click",()=>this.requestRecovery());let u=document.createElement("button");u.type="button",u.textContent="Clear",u.style.cssText=["padding:6px 12px","border-radius:6px","border:1px solid rgba(34,197,94,0.45)","background:rgba(34,197,94,0.18)","color:#bbf7d0","font-size:12px","font-weight:600","cursor:pointer"].join(";"),u.addEventListener("click",()=>this.clearDiagnostics());let o=document.createElement("button");o.type="button",o.textContent="Close",o.style.cssText=["padding:6px 12px","border-radius:6px","border:1px solid rgba(248,113,113,0.4)","background:rgba(248,113,113,0.18)","color:#fecaca","font-size:12px","font-weight:600","cursor:pointer"].join(";"),o.addEventListener("click",()=>this.hideErrorOverlay()),l.appendChild(h),l.appendChild(u),l.appendChild(o),s.appendChild(a),s.appendChild(l);let d=document.createElement("div");d.style.cssText="padding:16px 24px 24px;display:flex;flex-direction:column;gap:16px;",n.appendChild(s),n.appendChild(d),e.appendChild(n),document.body.appendChild(e),this.errorOverlay=e,this.errorListEl=d}renderErrorOverlay(){if(!this.options.debug||typeof document>"u"||(this.ensureErrorOverlayElements(),!this.errorOverlay||!this.errorListEl))return;let e=this.errorListEl;if(e.innerHTML="",this.diagnostics.length===0){let n=document.createElement("div");n.textContent="No runtime errors captured yet.",n.style.cssText="font-size:14px;color:#94a3b8;",e.appendChild(n)}else{let n=[...this.diagnostics].sort((s,r)=>r.timestamp-s.timestamp);for(let s of n)e.appendChild(this.createDiagnosticElement(s))}this.errorOverlay.style.display="flex",this.errorOverlayVisible=!0}createDiagnosticElement(e){let n=document.createElement("article");n.style.cssText=["background:rgba(15,23,42,0.65)","border:1px solid rgba(148,163,184,0.25)","border-radius:12px","padding:18px 20px","display:flex","flex-direction:column","gap:12px"].join(";");let s=document.createElement("div");s.style.cssText="display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px;";let r=document.createElement("h3");r.textContent=e.message||"Runtime panic recovered",r.style.cssText="margin:0;font-size:16px;font-weight:700;color:#f8fafc;";let a=document.createElement("div");a.style.cssText="display:flex;align-items:center;gap:8px;";let c=document.createElement("span");c.textContent=e.code||"runtime_panic",c.style.cssText=["font-size:11px","font-weight:700","letter-spacing:0.08em","text-transform:uppercase","background:rgba(37,99,235,0.18)","color:#bfdbfe","border:1px solid rgba(37,99,235,0.35)","border-radius:9999px","padding:4px 10px"].join(";");let l=document.createElement("time"),h=e.details?.capturedAt?new Date(e.details.capturedAt):new Date(e.timestamp);Number.isNaN(h.getTime())?l.textContent=new Date(e.timestamp).toLocaleString():(l.dateTime=h.toISOString(),l.textContent=h.toLocaleString()),l.style.cssText="font-size:12px;color:#94a3b8;",a.appendChild(c),a.appendChild(l),s.appendChild(r),s.appendChild(a),n.appendChild(s);let u=e.details,o=document.createElement("div");o.style.cssText="display:flex;flex-direction:column;gap:4px;font-size:12px;color:#cbd5f5;";let d=u?.componentName&&u.componentId?`${u.componentName} (${u.componentId})`:u?.componentName??u?.componentId??"";if(this.appendMeta(o,"Component",d),this.appendMeta(o,"Phase",u?.phase),u?.hook){let g=u.hookIndex!=null?`${u.hook} (#${u.hookIndex})`:u.hook;this.appendMeta(o,"Hook",g)}if(this.appendMeta(o,"Panic",u?.panic),o.childNodes.length>0&&n.appendChild(o),u?.suggestion){let g=document.createElement("p");g.textContent=u.suggestion,g.style.cssText="margin:0;padding:12px 14px;border-radius:8px;background:rgba(34,197,94,0.12);color:#bbf7d0;font-size:13px;border-left:3px solid rgba(34,197,94,0.45);",n.appendChild(g)}let p=u?.metadata;if(p&&Object.keys(p).length>0){let g=document.createElement("dl");g.style.cssText="display:grid;grid-template-columns:max-content 1fr;gap:4px 12px;padding:12px;border-radius:8px;background:rgba(15,23,42,0.5);";for(let[A,de]of Object.entries(p)){let He=document.createElement("dt");He.textContent=A,He.style.cssText="font-weight:600;color:#e2e8f0;";let Be=document.createElement("dd");Be.textContent=this.formatMetadataValue(de),Be.style.cssText="margin:0;white-space:pre-wrap;color:#cbd5f5;",g.appendChild(He),g.appendChild(Be)}n.appendChild(g)}if(u?.stack){let g=document.createElement("pre");g.textContent=u.stack.trim(),g.style.cssText="margin:0;padding:12px;border-radius:8px;background:#020617;color:#f1f5f9;max-height:220px;overflow:auto;font-size:12px;line-height:1.45;",n.appendChild(g)}return n}appendMeta(e,n,s){if(!s)return;let r=document.createElement("div");r.style.cssText="display:flex;gap:6px;align-items:flex-start;";let a=document.createElement("span");a.textContent=`${n}:`,a.style.cssText="font-weight:600;min-width:88px;color:#e2e8f0;";let c=document.createElement("span");c.textContent=s,c.style.cssText="flex:1;",r.appendChild(a),r.appendChild(c),e.appendChild(r)}formatMetadataValue(e){if(e==null)return"null";if(typeof e=="string")return e;if(typeof e=="number"||typeof e=="boolean")return String(e);try{return JSON.stringify(e,null,2)}catch{return String(e)}}hideErrorOverlay(){this.errorOverlay&&(this.errorOverlay.style.display="none",this.errorOverlayVisible=!1)}clearDiagnostics(){this.diagnostics=[],this.errorListEl&&(this.errorListEl.innerHTML=""),this.hideErrorOverlay()}requestRecovery(){let e=this.sessionId.get();if(!e||!this.channel){this.log("Cannot request recovery without active session/channel");return}this.log("Requesting runtime recovery"),this.channel.sendMessage("recover",{t:"recover",sid:e})}onDebugKeydown(e){if(this.options.debug){if(e.key==="Escape"&&this.errorOverlayVisible){this.hideErrorOverlay();return}(e.key==="e"||e.key==="E")&&e.shiftKey&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),this.renderErrorOverlay())}}sendEvent(e){if(this.connectionState.get().status!=="connected"||!this.channel){this.log("Not connected, queueing event"),this.eventQueue.push(e);return}let s={t:"evt",sid:this.sessionId.get(),hid:e.hid,payload:e.payload};this.log("Sending event:",s),this.channel.sendMessage("evt",s),this.metrics.eventsProcessed++}sendUploadMessage(e){if(this.connectionState.get().status!=="connected"||!this.channel){this.log("Not connected, skipping upload message");return}this.channel.sendMessage("upload",e)}sendNavigation(e,n,s){if(this.connectionState.get().status!=="connected"||!this.channel)return this.log("Not connected, cannot navigate"),!1;let a={t:"nav",sid:this.sessionId.get(),path:e,q:n,hash:s};this.log("Sending navigation:",a),this.channel.sendMessage("nav",a);let c=n?`?${n}`:"",l=s?`#${s}`:"";return window.history.pushState({},"",`${e}${c}${l}`),this.lastOptimisticNavTime=Date.now(),!0}sendAck(e){if(!this.channel)return;let n={t:"ack",sid:this.sessionId.get(),seq:e};this.channel.sendMessage("ack",n),typeof e=="number"&&e>this.lastAck&&(this.lastAck=e)}flushEventQueue(){if(this.eventQueue.length===0)return;this.log("Flushing",this.eventQueue.length,"queued events");let e=this.eventQueue;this.eventQueue=[];for(let n of e)this.sendEvent(n)}log(...e){this.options.debug&&console.log("[LiveUI]",...e)}},Ee=ft;var je=null;function ci(){return typeof window>"u"?null:window}function li(i){let t=i.__LIVEUI_BOOT__;if(t&&typeof t=="object"&&typeof t.sid=="string")return t;if(typeof document>"u")return null;let n=document.getElementById("live-boot")?.textContent;if(!n)return null;try{let s=JSON.parse(n);return i.__LIVEUI_BOOT__=s,s}catch(s){return console.error("[LiveUI] Failed to parse boot payload",s),null}}function di(i,t){let e=Ee;Object.assign(e,{instance:t,dom:J,applyOps:H,patcher:{configure:Me,getConfig:Oe,clearCaches:Ne,getStats:Te,morphElement:xe},boot:pt}),i.LiveUI=e,i.LiveUIInstance=t,i.__LIVEUI_DEVTOOLS__&&(i.__LIVEUI_DEVTOOLS__.installed=!0,i.__LIVEUI_DEVTOOLS__.instance=t)}function ui(i){let t={...i.__LIVEUI_OPTIONS__??{}},e=li(i),n=t.boot,s=e??n??null,r=t.autoConnect!==!1,a={...t,autoConnect:!1};s&&(a.boot=s,e||(i.__LIVEUI_BOOT__=s));let c=new Ee(a);return di(i,c),r&&(s?c.connect().catch(l=>{console.error("[LiveUI] Failed to connect during boot",l)}):console.warn("[LiveUI] Boot payload missing; auto-connect skipped.")),c}function hi(i){return new Promise((t,e)=>{let n=()=>{try{let s=ui(i);t(s)}catch(s){console.error("[LiveUI] Boot failed",s),e(s)}};if(typeof document<"u"&&document.readyState==="loading"){let s=()=>{document.removeEventListener("DOMContentLoaded",s),n()};document.addEventListener("DOMContentLoaded",s)}else n()})}function pt({force:i=!1}={}){let t=ci();return t?(i&&(je=null),je||(je=hi(t)),je):Promise.reject(new Error("LiveUI: window is not available for bootstrapping."))}typeof window<"u"&&pt().catch(()=>{});return _n(fi);})();

// Export to global window object
if (typeof window !== 'undefined') {
  window.LiveUI = LiveUIModule.default;
  window.LiveUI.dom = LiveUIModule.dom;
  window.LiveUI.applyOps = LiveUIModule.applyOps;
}

//# sourceMappingURL=pondlive.js.map
