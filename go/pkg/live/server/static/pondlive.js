// LiveUI Client v1.0.0
"use strict";(()=>{function e(){if(typeof window>"u")return null;let e=document.getElementById("live-boot"),t=null;if(e?.textContent)try{t=JSON.parse(e.textContent)}catch(e){s.error("Runtime","Failed to parse boot payload",e)}if(t||(t=window.__LIVEUI_BOOT__??null),!t)return s.error("Runtime","No boot payload found"),null;let i={root:document.documentElement,sessionId:t.sid,version:t.ver,seq:t.seq,endpoint:t.client?.endpoint??"/live",uploadEndpoint:t.client?.upload??"/pondlive/upload",location:t.location,debug:t.client?.debug},n=new c(i);return n.handleBoot(t),n.connect(),n}var t,i,n,s,r,o,a,h,l,c,d,u=Object.create,f=Object.defineProperty,w=Object.getOwnPropertyDescriptor,p=Object.getOwnPropertyNames,v=Object.getPrototypeOf,b={}.hasOwnProperty,m=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),y=(e,t,i,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let s of p(t))!b.call(e,s)&&s!==i&&f(e,s,{get:()=>t[s],enumerable:!(n=w(t,s))||n.enumerable});return e},g=(e,t,i)=>(i=null!=e?u(v(e)):{},y(!t&&e&&e.i?i:f(i,"default",{value:e,enumerable:1}),e)),E=m(e=>{var t,i,n=e&&e.o||function(e,t,i,n,s){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,i):s?s.value=i:t.set(e,i),i},s=e&&e.h||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"i",{value:1}),e.Subject=void 0,e.Subject=class{constructor(){t.set(this,void 0),i.set(this,void 0),n(this,t,0,"f"),n(this,i,new Set,"f")}get size(){return s(this,i,"f").size}subscribe(e){if(s(this,t,"f"))throw Error("Cannot subscribe to a closed subject");return s(this,i,"f").add(e),()=>s(this,i,"f").delete(e)}publish(e){s(this,i,"f").forEach(t=>t(e))}close(){s(this,i,"f").clear(),n(this,t,1,"f")}},t=new WeakMap,i=new WeakMap}),O=m(e=>{var t,i,n=e&&e.o||function(e,t,i,n,s){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,i):s?s.value=i:t.set(e,i),i},s=e&&e.h||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"i",{value:1}),e.BehaviorSubject=void 0,i=E(),e.BehaviorSubject=class extends i.Subject{constructor(e){super(),t.set(this,void 0),n(this,t,e,"f")}get value(){return s(this,t,"f")}publish(e){n(this,t,e,"f"),super.publish(e)}subscribe(e){return s(this,t,"f")&&e(s(this,t,"f")),super.subscribe(e)}},t=new WeakMap}),k=m(e=>{var t=e&&e.l||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);(!s||("get"in s?!t.i:s.writable||s.configurable))&&(s={enumerable:1,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.u||function(e,i){for(var n in e)"default"!==n&&!{}.hasOwnProperty.call(i,n)&&t(i,e,n)};Object.defineProperty(e,"i",{value:1}),i(O(),e),i(E(),e)}),N=m(e=>{var t,i,n,s,r,o,a,h,l,c;Object.defineProperty(e,"i",{value:1}),e.PubSubEvents=e.Events=e.ChannelReceiver=e.SystemSender=e.ErrorTypes=e.ChannelState=e.ClientActions=e.ServerActions=e.PresenceEventTypes=void 0,(c=t||(e.PresenceEventTypes=t={})).JOIN="JOIN",c.LEAVE="LEAVE",c.UPDATE="UPDATE",function(e){e.PRESENCE="PRESENCE",e.SYSTEM="SYSTEM",e.BROADCAST="BROADCAST",e.ERROR="ERROR",e.CONNECT="CONNECT"}(i||(e.ServerActions=i={})),function(e){e.JOIN_CHANNEL="JOIN_CHANNEL",e.LEAVE_CHANNEL="LEAVE_CHANNEL",e.BROADCAST="BROADCAST"}(n||(e.ClientActions=n={})),function(e){e.IDLE="IDLE",e.JOINING="JOINING",e.JOINED="JOINED",e.STALLED="STALLED",e.CLOSED="CLOSED"}(s||(e.ChannelState=s={})),function(e){e.UNAUTHORIZED_CONNECTION="UNAUTHORIZED_CONNECTION",e.UNAUTHORIZED_JOIN_REQUEST="UNAUTHORIZED_JOIN_REQUEST",e.UNAUTHORIZED_BROADCAST="UNAUTHORIZED_BROADCAST",e.INVALID_MESSAGE="INVALID_MESSAGE",e.HANDLER_NOT_FOUND="HANDLER_NOT_FOUND",e.PRESENCE_ERROR="PRESENCE_ERROR",e.CHANNEL_ERROR="CHANNEL_ERROR",e.ENDPOINT_ERROR="ENDPOINT_ERROR",e.INTERNAL_SERVER_ERROR="INTERNAL_SERVER_ERROR"}(r||(e.ErrorTypes=r={})),function(e){e.ENDPOINT="ENDPOINT",e.CHANNEL="CHANNEL"}(o||(e.SystemSender=o={})),function(e){e.ALL_USERS="ALL_USERS",e.ALL_EXCEPT_SENDER="ALL_EXCEPT_SENDER"}(a||(e.ChannelReceiver=a={})),function(e){e.ACKNOWLEDGE="ACKNOWLEDGE",e.CONNECTION="CONNECTION"}(h||(e.Events=h={})),function(e){e.MESSAGE="MESSAGE",e.PRESENCE="PRESENCE",e.GET_PRESENCE="GET_PRESENCE"}(l||(e.PubSubEvents=l={}))}),M=m(e=>{Object.defineProperty(e,"i",{value:1}),e.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}}),R=m(e=>{Object.defineProperty(e,"i",{value:1})}),C=m(e=>{var t=e&&e.l||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);(!s||("get"in s?!t.i:s.writable||s.configurable))&&(s={enumerable:1,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.u||function(e,i){for(var n in e)"default"!==n&&!{}.hasOwnProperty.call(i,n)&&t(i,e,n)};Object.defineProperty(e,"i",{value:1}),i(M(),e),i(R(),e)}),S=m(e=>{function t(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}function i(e,t){if(!function(e){return"string"==typeof e}(e))throw new a("Expected string, got "+typeof e,t)}function n(e,i){if(!t(e))throw new a("Expected object, got "+typeof e,i)}function s(e,i){if(!function(e){return t(e)?Object.keys(e).every(e=>"string"==typeof e):0}(e))throw new a("Expected record with string keys, got "+typeof e,i)}function r(e,t,i){let n=Object.values(t);if(!n.includes(e))throw new a(`Expected one of [${n.join(", ")}], got ${JSON.stringify(e)}`,i)}Object.defineProperty(e,"i",{value:1}),e.channelEventSchema=e.serverMessageSchema=e.presenceMessageSchema=e.clientMessageSchema=e.ValidationError=void 0;var o=N(),a=class extends Error{constructor(e,t){super(t?`${t}: ${e}`:e),this.path=t,this.name="ValidationError"}};e.ValidationError=a,e.clientMessageSchema={parse(e){n(e,"clientMessage");let t=e;if(!("event"in t))throw new a("Missing required field","event");if(!("requestId"in t))throw new a("Missing required field","requestId");if(!("channelName"in t))throw new a("Missing required field","channelName");if(!("payload"in t))throw new a("Missing required field","payload");if(!("action"in t))throw new a("Missing required field","action");return i(t.event,"event"),i(t.requestId,"requestId"),i(t.channelName,"channelName"),s(t.payload,"payload"),r(t.action,o.ClientActions,"action"),{event:t.event,requestId:t.requestId,channelName:t.channelName,payload:t.payload,action:t.action}}},e.presenceMessageSchema={parse(e){n(e,"presenceMessage");let t=e;if(!("requestId"in t))throw new a("Missing required field","requestId");if(!("channelName"in t))throw new a("Missing required field","channelName");if(!("event"in t))throw new a("Missing required field","event");if(!("action"in t))throw new a("Missing required field","action");if(!("payload"in t))throw new a("Missing required field","payload");if(i(t.requestId,"requestId"),i(t.channelName,"channelName"),r(t.event,o.PresenceEventTypes,"event"),t.action!==o.ServerActions.PRESENCE)throw new a(`Expected ${o.ServerActions.PRESENCE}, got ${JSON.stringify(t.action)}`,"action");n(t.payload,"payload");let h=t.payload;if(!("presence"in h))throw new a("Missing required field","payload.presence");if(!("changed"in h))throw new a("Missing required field","payload.changed");return function(e){if(!function(e){return Array.isArray(e)}(e))throw new a("Expected array, got "+typeof e,"payload.presence")}(h.presence),h.presence.forEach((e,t)=>{s(e,`payload.presence[${t}]`)}),s(h.changed,"payload.changed"),{requestId:t.requestId,channelName:t.channelName,event:t.event,action:o.ServerActions.PRESENCE,payload:{presence:h.presence,changed:h.changed}}}},e.serverMessageSchema={parse(e){n(e,"serverMessage");let t=e;if(!("event"in t))throw new a("Missing required field","event");if(!("requestId"in t))throw new a("Missing required field","requestId");if(!("channelName"in t))throw new a("Missing required field","channelName");if(!("payload"in t))throw new a("Missing required field","payload");if(!("action"in t))throw new a("Missing required field","action");i(t.event,"event"),i(t.requestId,"requestId"),i(t.channelName,"channelName"),s(t.payload,"payload");let r=[o.ServerActions.BROADCAST,o.ServerActions.CONNECT,o.ServerActions.ERROR,o.ServerActions.SYSTEM];if(!r.includes(t.action))throw new a(`Expected one of [${r.join(", ")}], got ${JSON.stringify(t.action)}`,"action");return{event:t.event,requestId:t.requestId,channelName:t.channelName,payload:t.payload,action:t.action}}},e.channelEventSchema={parse(t){n(t,"channelEvent");let i=t;if(!("action"in i))throw new a("Missing required field","action");return i.action===o.ServerActions.PRESENCE?e.presenceMessageSchema.parse(t):e.serverMessageSchema.parse(t)}}}),x=m(e=>{var t=e&&e.l||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);(!s||("get"in s?!t.i:s.writable||s.configurable))&&(s={enumerable:1,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.u||function(e,i){for(var n in e)"default"!==n&&!{}.hasOwnProperty.call(i,n)&&t(i,e,n)};Object.defineProperty(e,"i",{value:1}),i(k(),e),i(N(),e),i(C(),e),i(S(),e)}),T=m(e=>{var t,i,n,s,r,o,a,h,l,c,d,u,f,w,p,v,b=e&&e.o||function(e,t,i,n,s){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,i):s?s.value=i:t.set(e,i),i},m=e&&e.h||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"i",{value:1}),e.Channel=void 0,v=x(),e.Channel=class{constructor(e,d,u,f){t.add(this),i.set(this,void 0),n.set(this,void 0),s.set(this,void 0),r.set(this,void 0),o.set(this,void 0),a.set(this,void 0),h.set(this,void 0),l.set(this,void 0),c.set(this,void 0),b(this,i,u,"f"),b(this,n,[],"f"),b(this,s,[],"f"),b(this,a,f,"f"),b(this,o,e,"f"),b(this,l,d,"f"),b(this,h,new v.Subject,"f"),b(this,c,new v.BehaviorSubject(v.ChannelState.IDLE),"f"),b(this,r,()=>{},"f")}get channelState(){return m(this,c,"f").value}get presence(){return m(this,s,"f")}acknowledge(e){m(this,c,"f").publish(v.ChannelState.JOINED),m(this,t,"m",u).call(this,e),m(this,t,"m",d).call(this)}join(){let e={action:v.ClientActions.JOIN_CHANNEL,event:v.ClientActions.JOIN_CHANNEL,payload:m(this,a,"f"),channelName:m(this,i,"f"),requestId:(0,v.uuid)()};if(m(this,c,"f").value!==v.ChannelState.JOINED)if(m(this,c,"f").publish(v.ChannelState.JOINING),m(this,l,"f").value)m(this,o,"f").call(this,e);else{let t=m(this,l,"f").subscribe(i=>{i&&(t(),m(this,c,"f").value===v.ChannelState.JOINING&&m(this,o,"f").call(this,e))})}}leave(){let e={action:v.ClientActions.LEAVE_CHANNEL,event:v.ClientActions.LEAVE_CHANNEL,channelName:m(this,i,"f"),requestId:(0,v.uuid)(),payload:{}};m(this,t,"m",w).call(this,e),m(this,c,"f").publish(v.ChannelState.CLOSED),m(this,r,"f").call(this)}onChannelStateChange(e){return m(this,c,"f").subscribe(t=>{e(t)})}onJoin(e){return m(this,t,"m",p).call(this,(t,i)=>{if(t===v.PresenceEventTypes.JOIN)return e(i.changed)})}onLeave(e){return m(this,t,"m",p).call(this,(t,i)=>{if(t===v.PresenceEventTypes.LEAVE)return e(i.changed)})}onMessage(e){return m(this,t,"m",f).call(this,(t,i)=>{e(t,i)})}onMessageEvent(e,t){return this.onMessage((i,n)=>{if(i===e)return t(n)})}onPresenceChange(e){return m(this,t,"m",p).call(this,(t,i)=>{if(t===v.PresenceEventTypes.UPDATE)return e(i)})}onUsersChange(e){return m(this,t,"m",p).call(this,(t,i)=>e(i.presence))}sendMessage(e,n){let s=(0,v.uuid)(),r={action:v.ClientActions.BROADCAST,channelName:m(this,i,"f"),requestId:s,event:e,payload:n};m(this,t,"m",w).call(this,r)}sendForResponse(e,n){let s=(0,v.uuid)();return new Promise(r=>{let o=m(this,t,"m",f).call(this,(e,t,i)=>{s===i&&(r(t),o())}),a={action:v.ClientActions.BROADCAST,channelName:m(this,i,"f"),requestId:s,event:e,payload:n};m(this,t,"m",w).call(this,a)})}},i=new WeakMap,n=new WeakMap,s=new WeakMap,r=new WeakMap,o=new WeakMap,a=new WeakMap,h=new WeakMap,l=new WeakMap,c=new WeakMap,t=new WeakSet,d=function(){m(this,n,"f").forEach(e=>m(this,o,"f").call(this,e)),b(this,n,[],"f")},u=function(e){m(this,r,"f").call(this);let n=e.subscribe(e=>{e.channelName===m(this,i,"f")&&this.channelState===v.ChannelState.JOINED&&m(this,h,"f").publish(e)}),d=m(this,l,"f").subscribe(e=>{if(e&&m(this,c,"f").value===v.ChannelState.STALLED){let e={action:v.ClientActions.JOIN_CHANNEL,event:v.ClientActions.JOIN_CHANNEL,payload:m(this,a,"f"),channelName:m(this,i,"f"),requestId:(0,v.uuid)()};m(this,o,"f").call(this,e)}else!e&&m(this,c,"f").value===v.ChannelState.JOINED&&m(this,c,"f").publish(v.ChannelState.STALLED)}),u=m(this,t,"m",p).call(this,(e,t)=>{b(this,s,t.presence,"f")});b(this,r,()=>{n(),d(),u()},"f")},f=function(e){return m(this,h,"f").subscribe(t=>{if(t.action!==v.ServerActions.PRESENCE)return e(t.event,t.payload,t.requestId)})},w=function(e){if(m(this,c,"f").value===v.ChannelState.JOINED)return m(this,o,"f").call(this,e);m(this,n,"f").push(e)},p=function(e){return m(this,h,"f").subscribe(t=>{if(t.action===v.ServerActions.PRESENCE)return e(t.event,t.payload)})}}),j=m(e=>{var t,i,n,s,r,o,a,h=e&&e.o||function(e,t,i,n,s){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,i):s?s.value=i:t.set(e,i),i},l=e&&e.h||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"i",{value:1}),e.PondClient=void 0,o=x(),a=T(),e.PondClient=class{constructor(e,n={}){let s;t.add(this),i.set(this,void 0);try{s=new URL(e)}catch{s=new URL(""+window.location),s.pathname=e}this.p=0;let a=new URLSearchParams(n);s.search=""+a,"wss:"!==s.protocol&&"ws:"!==s.protocol&&(s.protocol="https:"===s.protocol?"wss:":"ws:"),this.v=s,h(this,i,new Map,"f"),this.m=new o.Subject,this.O=new o.BehaviorSubject(0),l(this,t,"m",r).call(this)}connect(){this.p=0;let e=new WebSocket(""+this.v);e.onmessage=e=>{let t=e.data.trim().split("\n");for(let e of t)if(e.trim()){let t=JSON.parse(e),i=o.channelEventSchema.parse(t);this.m.publish(i)}},e.onerror=()=>e.close(),e.onclose=()=>{this.O.publish(0),!this.p&&setTimeout(()=>{this.connect()},1e3)},this.k=e}getState(){return this.O.value}disconnect(){var e;this.O.publish(0),this.p=1,null===(e=this.k)||void 0===e||e.close(),l(this,i,"f").clear()}createChannel(e,s){let r=l(this,i,"f").get(e);if(r&&r.channelState!==o.ChannelState.CLOSED)return r;let h=l(this,t,"m",n).call(this),c=new a.Channel(h,this.O,e,s||{});return l(this,i,"f").set(e,c),c}onConnectionChange(e){return this.O.subscribe(e)}},i=new WeakMap,t=new WeakSet,n=function(){return e=>{this.O.value&&this.k.send(JSON.stringify(e))}},s=function(e){var s;let r=null!==(s=l(this,i,"f").get(e.channelName))&&void 0!==s?s:new a.Channel(l(this,t,"m",n).call(this),this.O,e.channelName,{});l(this,i,"f").set(e.channelName,r),r.acknowledge(this.m)},r=function(){this.m.subscribe(e=>{e.event===o.Events.ACKNOWLEDGE?l(this,t,"m",s).call(this,e):e.event===o.Events.CONNECTION&&e.action===o.ServerActions.CONNECT&&this.O.publish(1)})}}),_=m((e,t)=>{var i=function(){if("object"==typeof self&&self)return self;if("object"==typeof window&&window)return window;throw Error("Unable to resolve global `this`")};t.exports=function(){if(this)return this;if("object"==typeof globalThis&&globalThis)return globalThis;try{Object.defineProperty(Object.prototype,"N",{get:function(){return this},configurable:1})}catch{return i()}try{return __global__||i()}finally{delete Object.prototype.N}}()}),I=m((e,t)=>{t.exports={name:"websocket",description:"Websocket Client & Server Library implementing the WebSocket protocol as specified in RFC 6455.",keywords:["websocket","websockets","socket","networking","comet","push","RFC-6455","realtime","server","client"],author:"Brian McKelvey <theturtle32@gmail.com> (https://github.com/theturtle32)",contributors:["IÃ±aki Baz Castillo <ibc@aliax.net> (http://dev.sipdoc.net)"],version:"1.0.35",repository:{type:"git",url:"https://github.com/theturtle32/WebSocket-Node.git"},homepage:"https://github.com/theturtle32/WebSocket-Node",engines:{node:">=4.0.0"},dependencies:{bufferutil:"^4.0.1",debug:"^2.2.0","es5-ext":"^0.10.63","typedarray-to-buffer":"^3.1.5","utf-8-validate":"^5.0.2",yaeti:"^0.0.6"},devDependencies:{"buffer-equal":"^1.0.0",gulp:"^4.0.2","gulp-jshint":"^2.0.4","jshint-stylish":"^2.2.1",jshint:"^2.0.0",tape:"^4.9.1"},config:{verbose:0},scripts:{test:"tape test/unit/*.js",gulp:"gulp"},main:"index",directories:{lib:"./lib"},browser:"lib/browser.js",license:"Apache-2.0"}}),P=m((e,t)=>{t.exports=I().version}),q=m((e,t)=>{function i(e,t){return t?new s(e,t):new s(e)}var n,s,r;if("object"==typeof globalThis)n=globalThis;else try{n=_()}catch{}finally{if(!n&&"u">typeof window&&(n=window),!n)throw Error("Could not determine global this")}s=n.WebSocket||n.MozWebSocket,r=P(),s&&["CONNECTING","OPEN","CLOSING","CLOSED"].forEach(function(e){Object.defineProperty(i,e,{get:function(){return s[e]}})}),t.exports={w3cwebsocket:s?i:null,version:r}}),D=m(e=>{Object.defineProperty(e,"i",{value:1}),e.PondClient=void 0;var t=x(),i=j(),n=q().w3cwebsocket;e.PondClient=class extends i.PondClient{connect(e=1){this.p=0;let i=new n(""+this.v);i.onopen=()=>this.O.publish(1),i.onmessage=e=>{let i=e.data.trim().split("\n");for(let e of i)if(e.trim()){let i=JSON.parse(e),n=t.channelEventSchema.parse(i);this.m.publish(n)}},i.onerror=()=>i.close(),i.onclose=()=>{this.O.publish(0),!this.p&&setTimeout(()=>{this.connect()},1e3)}}}}),A=m(e=>{var t,i,n,s;Object.defineProperty(e,"i",{value:1}),e.PondClient=e.ChannelState=void 0,t=x(),Object.defineProperty(e,"ChannelState",{enumerable:1,get:function(){return t.ChannelState}}),i=j(),n=D(),s=typeof window>"u"?n.PondClient:i.PondClient,e.PondClient=s}),L={};((e,t)=>{for(var i in t)f(e,i,{get:t[i],enumerable:1})})(L,{EffectExecutor:()=>h,Logger:()=>s,Patcher:()=>r,Router:()=>o,Runtime:()=>c,Transport:()=>i,Uploader:()=>a,boot:()=>e}),t=g(A(),1),i=class{constructor(e){this.handler=null,this.M=e.sessionId,this.client=new t.PondClient(e.endpoint),this.channel=this.client.createChannel("live/"+e.sessionId,{sid:e.sessionId,ver:e.version,ack:e.ack,loc:e.location}),this.channel.join(),this.channel.onMessage((e,t)=>{this.handler?.(t)})}get sessionId(){return this.M}connect(){this.client.connect()}disconnect(){this.channel.leave(),this.client.disconnect()}send(e){this.channel.sendMessage(e.t,e)}onMessage(e){this.handler=e}onStateChange(e){this.channel.onChannelStateChange(e)}},n={debug:0,info:1,warn:2,error:3},s=new class{constructor(){this.enabled=0,this.level="info"}configure(e){void 0!==e.enabled&&(this.enabled=e.enabled),void 0!==e.level&&(this.level=e.level)}debug(e,t,...i){this.log("debug",e,t,i)}info(e,t,...i){this.log("info",e,t,i)}warn(e,t,...i){this.log("warn",e,t,i)}error(e,t,...i){this.log("error",e,t,i)}log(e,t,i,s){if(!this.enabled||n[this.level]>n[e])return;let r=`[LiveUI:${t}]`,o=console[e]||console.log;s.length>0?o(r,i,...s):o(r,i)}},r=class{constructor(e,t){this.handlerStore=new WeakMap,this.routerStore=new WeakMap,this.uploadStore=new WeakMap,this.root=e,this.callbacks=t}apply(e){let t=[...e].sort((e,t)=>e.seq-t.seq);for(let e of t)this.applyPatch(e)}applyPatch(e){let t=this.resolvePath(e.path);if(t)switch(e.op){case"setText":this.setText(t,e.value);break;case"setComment":this.setComment(t,e.value);break;case"setAttr":this.setAttr(t,e.value);break;case"delAttr":this.delAttr(t,e.name);break;case"setStyle":this.setStyle(t,e.value);break;case"delStyle":this.delStyle(t,e.name);break;case"setStyleDecl":this.setStyleDecl(t,e.selector,e.name,e.value);break;case"delStyleDecl":this.delStyleDecl(t,e.selector,e.name);break;case"setHandlers":this.setHandlers(t,e.value);break;case"setRouter":this.setRouter(t,e.value);break;case"delRouter":this.delRouter(t);break;case"setUpload":this.setUpload(t,e.value);break;case"delUpload":this.delUpload(t);break;case"setRef":this.callbacks.onRef(e.value,t);break;case"delRef":this.callbacks.onRefDelete(e.value);break;case"replaceNode":this.replaceNode(t,e.value);break;case"addChild":this.addChild(t,e.index,e.value);break;case"delChild":this.delChild(t,e.index);break;case"moveChild":this.moveChild(t,e.value)}else s.warn("Patcher","Could not resolve path",e.path)}resolvePath(e){let t=this.root;for(let i of e){if(!t)return null;t=t.childNodes[i]??null}return t}setText(e,t){e.textContent=t}setComment(e,t){e.textContent=t}setAttr(e,t){s.info("Patcher","setAttr",e,t);for(let[i,n]of Object.entries(t))"class"===i?e.className=n.join(" "):"value"===i&&e instanceof HTMLInputElement?e.value=n[0]??"":"checked"===i&&e instanceof HTMLInputElement?e.checked=n.length>0&&"false"!==n[0]:"selected"===i&&e instanceof HTMLOptionElement?e.selected=n.length>0&&"false"!==n[0]:e.setAttribute(i,0===n.length?"":n.join(" "))}delAttr(e,t){s.info("Patcher","delAttr",e,t),"value"===t&&e instanceof HTMLInputElement?e.value="":"checked"===t&&e instanceof HTMLInputElement?e.checked=0:"selected"===t&&e instanceof HTMLOptionElement?e.selected=0:e.removeAttribute(t)}setStyle(e,t){s.info("Patcher","setStyle",e,t);for(let[i,n]of Object.entries(t))e.style.setProperty(i,n)}delStyle(e,t){s.info("Patcher","delStyle",e,t),e.style.removeProperty(t)}setStyleDecl(e,t,i,n){s.info("Patcher","setStyleDecl",e,t,i,n);let r=e.sheet;if(!r)return;let o=this.findOrCreateRule(r,t);o&&o.style.setProperty(i,n)}delStyleDecl(e,t,i){s.info("Patcher","delStyleDecl",e,t,i);let n=e.sheet;if(!n)return;let r=this.findRule(n,t);r&&r.style.removeProperty(i)}findRule(e,t){for(let i=0;e.cssRules.length>i;i++){let n=e.cssRules[i];if(n instanceof CSSStyleRule&&n.selectorText===t)return n}return null}findOrCreateRule(e,t){let i=this.findRule(e,t);if(!i){let n=e.insertRule(t+" {}",e.cssRules.length);i=e.cssRules[n]}return i}setHandlers(e,t){s.info("Patcher","setHandlers",e,t);let i=this.handlerStore.get(e);if(i)for(let[t,n]of i)e.removeEventListener(t,n);let n=new Map;for(let i of t){let t=i.listen??[],s=e=>{!t.includes("allowDefault")&&e.cancelable&&e.preventDefault();let n=this.extractEventData(e,i.props??[]);this.callbacks.onEvent(i.event,i.handler,n),t.includes("bubble")||e.stopPropagation()};e.addEventListener(i.event,s),n.set(i.event,s)}this.handlerStore.set(e,n)}extractEventData(e,t,i){return s.info("Patcher","extractEventData",e,t,i),Object.fromEntries(t.map(t=>[t,this.resolveProp(e,t,i)]).filter(([e,t])=>void 0!==t))}resolveProp(e,t,i){let n=t.split(".").map(e=>e.trim()).filter(Boolean);if(0===n.length)return;let s,r=n.shift();switch(r){case"event":s=e;break;case"target":s=e.target;break;case"currentTarget":s=e.currentTarget;break;case"element":case"ref":s=i??(e.currentTarget instanceof Element?e.currentTarget:null);break;default:s=e[r]}for(let e of n){if(null==s)return;try{s=s[e]}catch{return}}return this.serializeValue(s)}serializeValue(e){if(null==e)return null;let t=typeof e;if("string"===t||"number"===t||"boolean"===t)return e;if(Array.isArray(e)){let t=e.map(e=>this.serializeValue(e)).filter(e=>void 0!==e);return t.length>0?t:null}if(e instanceof Date)return e.toISOString();if(e instanceof DOMTokenList)return Array.from(e);if(!(e instanceof Node))try{return JSON.parse(JSON.stringify(e))}catch{return}}setRouter(e,t){s.info("Patcher","setRouter",e,t),this.delRouter(e);let i=e=>{e.preventDefault(),this.callbacks.onRouter(t)};e.addEventListener("click",i),this.routerStore.set(e,i)}delRouter(e){s.info("Patcher","delRouter",e);let t=this.routerStore.get(e);t&&(e.removeEventListener("click",t),this.routerStore.delete(e))}setUpload(e,t){s.info("Patcher","setUpload",e,t),this.delUpload(e),t.multiple&&(e.multiple=1),t.accept&&t.accept.length>0&&(e.accept=t.accept.join(","));let i=()=>{e.files&&e.files.length>0&&this.callbacks.onUpload(t,e.files)};e.addEventListener("change",i),this.uploadStore.set(e,i)}delUpload(e){s.info("Patcher","delUpload",e);let t=this.uploadStore.get(e);t&&(e.removeEventListener("change",t),this.uploadStore.delete(e)),e.multiple=0,e.accept=""}replaceNode(e,t){s.info("Patcher","replaceNode",e,t);let i=this.createNode(t);i&&e.parentNode&&e.parentNode.replaceChild(i,e)}addChild(e,t,i){s.info("Patcher","addChild",e,t,i);let n=this.createNode(i);n&&e.insertBefore(n,e.childNodes[t]??null)}delChild(e,t){s.info("Patcher","delChild",e,t);let i=e.childNodes[t];i&&e.removeChild(i)}moveChild(e,t){s.info("Patcher","moveChild",e,t);let i=e.childNodes[t.fromIndex];i&&(e.removeChild(i),e.insertBefore(i,e.childNodes[t.newIdx]??null))}createNode(e){if(s.info("Patcher","createNode",e),void 0!==e.text)return document.createTextNode(e.text);if(void 0!==e.comment)return document.createComment(e.comment);if(!e.tag)return null;let t=document.createElement(e.tag);if(e.attrs&&this.setAttr(t,e.attrs),e.style&&this.setStyle(t,e.style),e.handlers&&e.handlers.length>0&&this.setHandlers(t,e.handlers),e.router&&this.setRouter(t,e.router),e.upload&&t instanceof HTMLInputElement&&this.setUpload(t,e.upload),e.refId&&this.callbacks.onRef(e.refId,t),e.unsafeHTML)t.innerHTML=e.unsafeHTML;else if(e.children)for(let i of e.children){let e=this.createNode(i);e&&t.appendChild(e)}return t}},o=class{constructor(e){this.onNav=e,window.addEventListener("popstate",()=>this.handlePopState())}navigate(e){let t=e.pathValue??window.location.pathname,i=void 0!==e.query?e.query:window.location.search,n=void 0!==e.hash?e.hash:window.location.hash,s=i.startsWith("?")?i.substring(1):i,r=n.startsWith("#")?n.substring(1):n,o=t+(s?"?"+s:"")+(r?"#"+r:"");e.replace?window.history.replaceState({},"",o):window.history.pushState({},"",o),this.onNav("nav",t,s,r)}handlePopState(){let e=window.location.pathname,t=window.location.search,i=window.location.hash,n=t.startsWith("?")?t.substring(1):t,s=i.startsWith("#")?i.substring(1):i;this.onNav("pop",e,n,s)}destroy(){window.removeEventListener("popstate",()=>this.handlePopState())}},a=class{constructor(e){this.active=new Map,this.endpoint=e.endpoint.replace(/\/+$/,""),this.sessionId=e.sessionId,this.onMessage=e.onMessage}upload(e,t,i){let n=e.uploadId;if(0===t.length)return void this.send({t:"upload",op:"cancelled",id:n});let s=t[0];if(e.maxSize&&e.maxSize>0&&s.size>e.maxSize)return this.send({t:"upload",op:"error",id:n,error:`File exceeds maximum size (${e.maxSize} bytes)`}),void(i&&(i.value=""));this.send({t:"upload",op:"change",id:n,meta:{name:s.name,size:s.size,type:s.type}}),this.startUpload(n,s,i??null)}cancel(e){let t=this.active.get(e);t&&(t.xhr.abort(),t.input&&(t.input.value=""),this.active.delete(e))}startUpload(e,t,i){this.cancel(e);let n=`${this.endpoint}/${encodeURIComponent(this.sessionId)}/${encodeURIComponent(e)}`,s=new XMLHttpRequest;s.upload.onprogress=i=>{this.send({t:"upload",op:"progress",id:e,loaded:i.loaded,total:i.lengthComputable?i.total:t.size})},s.onerror=()=>{this.active.delete(e),this.send({t:"upload",op:"error",id:e,error:"Upload failed"})},s.onabort=()=>{this.active.delete(e),this.send({t:"upload",op:"cancelled",id:e})},s.onload=()=>{this.active.delete(e),200>s.status||s.status>=300?this.send({t:"upload",op:"error",id:e,error:`Upload failed (${s.status})`}):(this.send({t:"upload",op:"progress",id:e,loaded:t.size,total:t.size}),i&&(i.value=""))};let r=new FormData;r.append("file",t),s.open("POST",n,1),s.send(r),this.active.set(e,{xhr:s,input:i})}send(e){this.onMessage(e)}},h=class{constructor(e){this.sessionId=e.sessionId,this.resolveRef=e.resolveRef,this.onDOMResponse=e.onDOMResponse}execute(e){if(e&&0!==e.length)for(let t of e)this.executeOne(t)}handleDOMRequest(e){let t=this.resolveRef(e.ref);if(t)try{if(e.props&&e.props.length>0){let i=this.readProps(t,e.props);this.sendDOMResponse(e.id,i,void 0,void 0)}else if(e.method){let i=this.callMethod(t,e.method,e.args??[]);this.sendDOMResponse(e.id,void 0,i,void 0)}else this.sendDOMResponse(e.id,void 0,void 0,"no props or method specified")}catch(t){this.sendDOMResponse(e.id,void 0,void 0,t instanceof Error?t.message:t+"")}else this.sendDOMResponse(e.id,void 0,void 0,"ref not found: "+e.ref)}executeOne(e){switch(e.type){case"dom":this.executeDOMAction(e);break;case"cookies":this.executeCookieSync(e)}}executeDOMAction(e){let t=this.resolveRef(e.ref);if(t)try{switch(e.kind){case"dom.call":this.executeCall(t,e);break;case"dom.set":this.executeSet(t,e);break;case"dom.toggle":this.executeToggle(t,e);break;case"dom.class":this.executeClass(t,e);break;case"dom.scroll":this.executeScroll(t,e);break;default:s.warn("Effects","Unknown kind",e.kind)}}catch(e){s.error("Effects","Execution failed",e)}else s.warn("Effects","Ref not found",e.ref)}executeCall(e,t){if(!t.method)return;let i=e[t.method];"function"==typeof i?i.apply(e,t.args??[]):s.warn("Effects","Method not found",t.method)}executeSet(e,t){t.prop&&(e[t.prop]=t.value)}executeToggle(e,t){t.prop&&(e[t.prop]=!e[t.prop])}executeClass(e,t){t.class&&(1==t.on?e.classList.add(t.class):0==t.on?e.classList.remove(t.class):e.classList.toggle(t.class))}executeScroll(e,t){if(!e.scrollIntoView)return;let i={};t.behavior&&(i.behavior=t.behavior),t.block&&(i.block=t.block),t.inline&&(i.inline=t.inline),e.scrollIntoView(i)}executeCookieSync(e){fetch(`${e.endpoint}?sid=${encodeURIComponent(e.sid)}&token=${encodeURIComponent(e.token)}`,{method:e.method??"GET",credentials:"include"}).catch(e=>{s.error("Effects","Cookie sync failed",e)})}readProps(e,t){let i={};for(let n of t)i[n]=this.resolveProp(e,n);return i}resolveProp(e,t){let i=t.split("."),n=e;for(let e of i){if(null==n)return;n=n[e]}return this.serializeValue(n)}callMethod(e,t,i){let n=e[t];if("function"!=typeof n)throw Error("method not found: "+t);let s=n.apply(e,i);return this.serializeValue(s)}serializeValue(e){if(null==e)return null;let t=typeof e;if("string"===t||"number"===t||"boolean"===t)return e;if(Array.isArray(e))return e.map(e=>this.serializeValue(e));if(e instanceof Date)return e.toISOString();if(e instanceof DOMTokenList)return Array.from(e);if(!(e instanceof Node))try{return JSON.parse(JSON.stringify(e))}catch{return}}sendDOMResponse(e,t,i,n){let s={t:"dom_res",sid:this.sessionId,id:e};void 0!==t&&(s.values=t),void 0!==i&&(s.result=i),void 0!==n&&(s.error=n),this.onDOMResponse(s)}},l=g(A(),1),c=class{constructor(e){this.connectedState=1,this.refs=new Map,this.cseq=0,this.sessionId=e.sessionId,s.configure({enabled:e.debug??0,level:"debug"}),this.transport=new i({endpoint:e.endpoint,sessionId:e.sessionId,version:e.version,ack:e.seq,location:e.location}),this.patcher=new r(e.root,{onEvent:(e,t,i)=>this.handleEvent(t,i),onRef:(e,t)=>this.refs.set(e,t),onRefDelete:e=>this.refs.delete(e),onRouter:e=>this.handleRouterClick(e),onUpload:(e,t)=>this.handleUpload(e,t)}),this.router=new o((e,t,i,n)=>{this.sendNav(e,t,i,n)}),this.uploader=new a({endpoint:e.uploadEndpoint,sessionId:e.sessionId,onMessage:e=>this.transport.send(e)}),this.effects=new h({sessionId:e.sessionId,resolveRef:e=>this.refs.get(e),onDOMResponse:e=>this.transport.send(e)}),this.transport.onMessage(e=>this.handleMessage(e)),this.transport.onStateChange(e=>this.handleStateChange(e))}connect(){this.transport.connect(),s.info("Runtime","Connected")}disconnect(){this.transport.disconnect(),s.info("Runtime","Disconnected")}connected(){return this.connectedState}handleMessage(e){switch(s.debug("Runtime","Received",e.t),e.t){case"boot":this.handleBoot(e);break;case"init":this.handleInit(e);break;case"frame":this.handleFrame(e);break;case"resume_ok":this.handleResumeOK(e);break;case"dom_req":this.handleDOMRequest(e);break;case"evt_ack":break;case"error":s.error("Runtime","Server error",e.code,e.message);break;case"diagnostic":s.warn("Runtime","Diagnostic",e.code,e.message)}}handleBoot(e){s.info("Runtime","Boot received",{ver:e.ver,seq:e.seq,patches:e.patch?.length??0}),e.patch&&e.patch.length>0&&this.patcher.apply(e.patch),this.sendAck(e.seq)}handleInit(e){s.info("Runtime","Init received",{ver:e.ver,seq:e.seq}),this.sendAck(e.seq)}handleFrame(e){s.debug("Runtime","Frame",{seq:e.seq,ops:e.patch?.length??0}),e.patch&&e.patch.length>0&&this.patcher.apply(e.patch),e.effects&&e.effects.length>0&&this.effects.execute(e.effects),e.nav&&this.handleServerNav(e.nav),this.sendAck(e.seq)}handleResumeOK(e){s.info("Runtime","Resume OK",{from:e.from,to:e.to})}handleDOMRequest(e){this.effects.handleDOMRequest(e)}handleServerNav(e){e.push?window.history.pushState({},"",e.push):e.replace?window.history.replaceState({},"",e.replace):e.back&&window.history.back()}handleEvent(e,t){let i={t:"evt",sid:this.sessionId,hid:e,cseq:++this.cseq,payload:t??{}};this.transport.send(i),s.debug("Runtime","Event sent",e)}handleRouterClick(e){this.router.navigate(e)}handleUpload(e,t){this.uploader.upload(e,t)}sendNav(e,t,i,n){this.transport.send({t:e,sid:this.sessionId,path:t,q:i,hash:n}),s.debug("Runtime","Nav sent",e,t)}sendAck(e){this.transport.send({t:"ack",sid:this.sessionId,seq:e})}handleStateChange(e){s.debug("Runtime","Channel state",e),(e===l.ChannelState.STALLED||e===l.ChannelState.CLOSED)&&(this.connectedState=0)}},"u">typeof window&&window.addEventListener("DOMContentLoaded",()=>{let t=e();t&&(window.__LIVEUI__=t)}),d=L,y(f({},"__esModule",{value:1}),d)})();