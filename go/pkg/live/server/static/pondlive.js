"use strict";var e=(()=>{var e=Object.create,t=Object.defineProperty,i=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyNames,s=Object.getPrototypeOf,r=Object.prototype.hasOwnProperty,o=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),a=(e,i)=>{for(var n in i)t(e,n,{get:i[n],enumerable:!0})},l=(e,s,o,a)=>{if(s&&"object"==typeof s||"function"==typeof s)for(let l of n(s))!r.call(e,l)&&l!==o&&t(e,l,{get:()=>s[l],enumerable:!(a=i(s,l))||a.enumerable});return e},c=o(e=>{var t,i,n=e&&e.__classPrivateFieldSet||function(e,t,i,n,s){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,i):s?s.value=i:t.set(e,i),i},s=e&&e.__classPrivateFieldGet||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"__esModule",{value:!0}),e.Subject=void 0,e.Subject=class{constructor(){t.set(this,void 0),i.set(this,void 0),n(this,t,!1,"f"),n(this,i,new Set,"f")}get size(){return s(this,i,"f").size}subscribe(e){if(s(this,t,"f"))throw Error("Cannot subscribe to a closed subject");return s(this,i,"f").add(e),()=>s(this,i,"f").delete(e)}publish(e){s(this,i,"f").forEach(t=>t(e))}close(){s(this,i,"f").clear(),n(this,t,!0,"f")}},t=new WeakMap,i=new WeakMap}),h=o(e=>{var t,i=e&&e.__classPrivateFieldSet||function(e,t,i,n,s){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,i):s?s.value=i:t.set(e,i),i},n=e&&e.__classPrivateFieldGet||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"__esModule",{value:!0}),e.BehaviorSubject=void 0;var s=c(),r=class extends s.Subject{constructor(e){super(),t.set(this,void 0),i(this,t,e,"f")}get value(){return n(this,t,"f")}publish(e){i(this,t,e,"f"),super.publish(e)}subscribe(e){return n(this,t,"f")&&e(n(this,t,"f")),super.subscribe(e)}};e.BehaviorSubject=r,t=new WeakMap}),d=o(e=>{var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);(!s||("get"in s?!t.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__exportStar||function(e,i){for(var n in e)"default"!==n&&!Object.prototype.hasOwnProperty.call(i,n)&&t(i,e,n)};Object.defineProperty(e,"__esModule",{value:!0}),i(h(),e),i(c(),e)}),u=o(e=>{var t,i,n,s,r,o,a,l,c,h;Object.defineProperty(e,"__esModule",{value:!0}),e.PubSubEvents=e.Events=e.ChannelReceiver=e.SystemSender=e.ErrorTypes=e.ChannelState=e.ClientActions=e.ServerActions=e.PresenceEventTypes=void 0,(i=t||(e.PresenceEventTypes=t={})).JOIN="JOIN",i.LEAVE="LEAVE",i.UPDATE="UPDATE",function(e){e.PRESENCE="PRESENCE",e.SYSTEM="SYSTEM",e.BROADCAST="BROADCAST",e.ERROR="ERROR",e.CONNECT="CONNECT"}(n||(e.ServerActions=n={})),function(e){e.JOIN_CHANNEL="JOIN_CHANNEL",e.LEAVE_CHANNEL="LEAVE_CHANNEL",e.BROADCAST="BROADCAST"}(s||(e.ClientActions=s={})),function(e){e.IDLE="IDLE",e.JOINING="JOINING",e.JOINED="JOINED",e.STALLED="STALLED",e.CLOSED="CLOSED"}(r||(e.ChannelState=r={})),function(e){e.UNAUTHORIZED_CONNECTION="UNAUTHORIZED_CONNECTION",e.UNAUTHORIZED_JOIN_REQUEST="UNAUTHORIZED_JOIN_REQUEST",e.UNAUTHORIZED_BROADCAST="UNAUTHORIZED_BROADCAST",e.INVALID_MESSAGE="INVALID_MESSAGE",e.HANDLER_NOT_FOUND="HANDLER_NOT_FOUND",e.PRESENCE_ERROR="PRESENCE_ERROR",e.CHANNEL_ERROR="CHANNEL_ERROR",e.ENDPOINT_ERROR="ENDPOINT_ERROR",e.INTERNAL_SERVER_ERROR="INTERNAL_SERVER_ERROR"}(o||(e.ErrorTypes=o={})),function(e){e.ENDPOINT="ENDPOINT",e.CHANNEL="CHANNEL"}(a||(e.SystemSender=a={})),function(e){e.ALL_USERS="ALL_USERS",e.ALL_EXCEPT_SENDER="ALL_EXCEPT_SENDER"}(l||(e.ChannelReceiver=l={})),function(e){e.ACKNOWLEDGE="ACKNOWLEDGE",e.CONNECTION="CONNECTION"}(c||(e.Events=c={})),function(e){e.MESSAGE="MESSAGE",e.PRESENCE="PRESENCE",e.GET_PRESENCE="GET_PRESENCE"}(h||(e.PubSubEvents=h={}))}),p=o(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}}),f=o(e=>{Object.defineProperty(e,"__esModule",{value:!0})}),m=o(e=>{var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);(!s||("get"in s?!t.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__exportStar||function(e,i){for(var n in e)"default"!==n&&!Object.prototype.hasOwnProperty.call(i,n)&&t(i,e,n)};Object.defineProperty(e,"__esModule",{value:!0}),i(p(),e),i(f(),e)}),b=o(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.channelEventSchema=e.serverMessageSchema=e.presenceMessageSchema=e.clientMessageSchema=e.ValidationError=void 0;var t=u(),i=class extends Error{constructor(e,t){super(t?`${t}: ${e}`:e),this.path=t,this.name="ValidationError"}};function n(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}function s(e,t){if(!function(e){return"string"==typeof e}(e))throw new i("Expected string, got "+typeof e,t)}function r(e,t){if(!n(e))throw new i("Expected object, got "+typeof e,t)}function o(e,t){if(!function(e){return!!n(e)&&Object.keys(e).every(e=>"string"==typeof e)}(e))throw new i("Expected record with string keys, got "+typeof e,t)}function a(e,t,n){let s=Object.values(t);if(!s.includes(e))throw new i(`Expected one of [${s.join(", ")}], got ${JSON.stringify(e)}`,n)}e.ValidationError=i,e.clientMessageSchema={parse(e){r(e,"clientMessage");let n=e;if(!("event"in n))throw new i("Missing required field","event");if(!("requestId"in n))throw new i("Missing required field","requestId");if(!("channelName"in n))throw new i("Missing required field","channelName");if(!("payload"in n))throw new i("Missing required field","payload");if(!("action"in n))throw new i("Missing required field","action");return s(n.event,"event"),s(n.requestId,"requestId"),s(n.channelName,"channelName"),o(n.payload,"payload"),a(n.action,t.ClientActions,"action"),{event:n.event,requestId:n.requestId,channelName:n.channelName,payload:n.payload,action:n.action}}},e.presenceMessageSchema={parse(e){r(e,"presenceMessage");let n=e;if(!("requestId"in n))throw new i("Missing required field","requestId");if(!("channelName"in n))throw new i("Missing required field","channelName");if(!("event"in n))throw new i("Missing required field","event");if(!("action"in n))throw new i("Missing required field","action");if(!("payload"in n))throw new i("Missing required field","payload");if(s(n.requestId,"requestId"),s(n.channelName,"channelName"),a(n.event,t.PresenceEventTypes,"event"),n.action!==t.ServerActions.PRESENCE)throw new i(`Expected ${t.ServerActions.PRESENCE}, got ${JSON.stringify(n.action)}`,"action");r(n.payload,"payload");let l=n.payload;if(!("presence"in l))throw new i("Missing required field","payload.presence");if(!("changed"in l))throw new i("Missing required field","payload.changed");return function(e,t){if(!function(e){return Array.isArray(e)}(e))throw new i("Expected array, got "+typeof e,t)}(l.presence,"payload.presence"),l.presence.forEach((e,t)=>{o(e,`payload.presence[${t}]`)}),o(l.changed,"payload.changed"),{requestId:n.requestId,channelName:n.channelName,event:n.event,action:t.ServerActions.PRESENCE,payload:{presence:l.presence,changed:l.changed}}}},e.serverMessageSchema={parse(e){r(e,"serverMessage");let n=e;if(!("event"in n))throw new i("Missing required field","event");if(!("requestId"in n))throw new i("Missing required field","requestId");if(!("channelName"in n))throw new i("Missing required field","channelName");if(!("payload"in n))throw new i("Missing required field","payload");if(!("action"in n))throw new i("Missing required field","action");s(n.event,"event"),s(n.requestId,"requestId"),s(n.channelName,"channelName"),o(n.payload,"payload");let a=[t.ServerActions.BROADCAST,t.ServerActions.CONNECT,t.ServerActions.ERROR,t.ServerActions.SYSTEM];if(!a.includes(n.action))throw new i(`Expected one of [${a.join(", ")}], got ${JSON.stringify(n.action)}`,"action");return{event:n.event,requestId:n.requestId,channelName:n.channelName,payload:n.payload,action:n.action}}},e.channelEventSchema={parse(n){r(n,"channelEvent");let s=n;if(!("action"in s))throw new i("Missing required field","action");return s.action===t.ServerActions.PRESENCE?e.presenceMessageSchema.parse(n):e.serverMessageSchema.parse(n)}}}),g=o(e=>{var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);(!s||("get"in s?!t.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__exportStar||function(e,i){for(var n in e)"default"!==n&&!Object.prototype.hasOwnProperty.call(i,n)&&t(i,e,n)};Object.defineProperty(e,"__esModule",{value:!0}),i(d(),e),i(u(),e),i(m(),e),i(b(),e)}),y=o(e=>{var t,i,n,s,r,o,a,l,c,h,d,u,p,f,m,b=e&&e.__classPrivateFieldSet||function(e,t,i,n,s){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,i):s?s.value=i:t.set(e,i),i},y=e&&e.__classPrivateFieldGet||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"__esModule",{value:!0}),e.Channel=void 0;var v=g();e.Channel=class{constructor(e,d,u,p){t.add(this),i.set(this,void 0),n.set(this,void 0),s.set(this,void 0),r.set(this,void 0),o.set(this,void 0),a.set(this,void 0),l.set(this,void 0),c.set(this,void 0),h.set(this,void 0),b(this,i,u,"f"),b(this,n,[],"f"),b(this,s,[],"f"),b(this,a,p,"f"),b(this,o,e,"f"),b(this,c,d,"f"),b(this,l,new v.Subject,"f"),b(this,h,new v.BehaviorSubject(v.ChannelState.IDLE),"f"),b(this,r,()=>{},"f")}get channelState(){return y(this,h,"f").value}get presence(){return y(this,s,"f")}acknowledge(e){y(this,h,"f").publish(v.ChannelState.JOINED),y(this,t,"m",u).call(this,e),y(this,t,"m",d).call(this)}join(){let e={action:v.ClientActions.JOIN_CHANNEL,event:v.ClientActions.JOIN_CHANNEL,payload:y(this,a,"f"),channelName:y(this,i,"f"),requestId:(0,v.uuid)()};if(y(this,h,"f").value!==v.ChannelState.JOINED)if(y(this,h,"f").publish(v.ChannelState.JOINING),y(this,c,"f").value)y(this,o,"f").call(this,e);else{let t=y(this,c,"f").subscribe(i=>{i&&(t(),y(this,h,"f").value===v.ChannelState.JOINING&&y(this,o,"f").call(this,e))})}}leave(){let e={action:v.ClientActions.LEAVE_CHANNEL,event:v.ClientActions.LEAVE_CHANNEL,channelName:y(this,i,"f"),requestId:(0,v.uuid)(),payload:{}};y(this,t,"m",f).call(this,e),y(this,h,"f").publish(v.ChannelState.CLOSED),y(this,r,"f").call(this)}onChannelStateChange(e){return y(this,h,"f").subscribe(t=>{e(t)})}onJoin(e){return y(this,t,"m",m).call(this,(t,i)=>{if(t===v.PresenceEventTypes.JOIN)return e(i.changed)})}onLeave(e){return y(this,t,"m",m).call(this,(t,i)=>{if(t===v.PresenceEventTypes.LEAVE)return e(i.changed)})}onMessage(e){return y(this,t,"m",p).call(this,(t,i)=>{e(t,i)})}onMessageEvent(e,t){return this.onMessage((i,n)=>{if(i===e)return t(n)})}onPresenceChange(e){return y(this,t,"m",m).call(this,(t,i)=>{if(t===v.PresenceEventTypes.UPDATE)return e(i)})}onUsersChange(e){return y(this,t,"m",m).call(this,(t,i)=>e(i.presence))}sendMessage(e,n){let s=(0,v.uuid)(),r={action:v.ClientActions.BROADCAST,channelName:y(this,i,"f"),requestId:s,event:e,payload:n};y(this,t,"m",f).call(this,r)}sendForResponse(e,n){let s=(0,v.uuid)();return new Promise(r=>{let o=y(this,t,"m",p).call(this,(e,t,i)=>{s===i&&(r(t),o())}),a={action:v.ClientActions.BROADCAST,channelName:y(this,i,"f"),requestId:s,event:e,payload:n};y(this,t,"m",f).call(this,a)})}},i=new WeakMap,n=new WeakMap,s=new WeakMap,r=new WeakMap,o=new WeakMap,a=new WeakMap,l=new WeakMap,c=new WeakMap,h=new WeakMap,t=new WeakSet,d=function(){y(this,n,"f").forEach(e=>y(this,o,"f").call(this,e)),b(this,n,[],"f")},u=function(e){y(this,r,"f").call(this);let n=e.subscribe(e=>{e.channelName===y(this,i,"f")&&this.channelState===v.ChannelState.JOINED&&y(this,l,"f").publish(e)}),d=y(this,c,"f").subscribe(e=>{if(e&&y(this,h,"f").value===v.ChannelState.STALLED){let e={action:v.ClientActions.JOIN_CHANNEL,event:v.ClientActions.JOIN_CHANNEL,payload:y(this,a,"f"),channelName:y(this,i,"f"),requestId:(0,v.uuid)()};y(this,o,"f").call(this,e)}else!e&&y(this,h,"f").value===v.ChannelState.JOINED&&y(this,h,"f").publish(v.ChannelState.STALLED)}),u=y(this,t,"m",m).call(this,(e,t)=>{b(this,s,t.presence,"f")});b(this,r,()=>{n(),d(),u()},"f")},p=function(e){return y(this,l,"f").subscribe(t=>{if(t.action!==v.ServerActions.PRESENCE)return e(t.event,t.payload,t.requestId)})},f=function(e){if(y(this,h,"f").value===v.ChannelState.JOINED)return y(this,o,"f").call(this,e);y(this,n,"f").push(e)},m=function(e){return y(this,l,"f").subscribe(t=>{if(t.action===v.ServerActions.PRESENCE)return e(t.event,t.payload)})}}),v=o(e=>{var t,i,n,s,r,o=e&&e.__classPrivateFieldSet||function(e,t,i,n,s){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,i):s?s.value=i:t.set(e,i),i},a=e&&e.__classPrivateFieldGet||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"__esModule",{value:!0}),e.PondClient=void 0;var l=g(),c=y();e.PondClient=class{constructor(e,n={}){let s;t.add(this),i.set(this,void 0);try{s=new URL(e)}catch{s=new URL(window.location.toString()),s.pathname=e}this._disconnecting=!1;let c=new URLSearchParams(n);s.search=c.toString();let h="https:"===s.protocol?"wss:":"ws:";"wss:"!==s.protocol&&"ws:"!==s.protocol&&(s.protocol=h),this._address=s,o(this,i,new Map,"f"),this._broadcaster=new l.Subject,this._connectionState=new l.BehaviorSubject(!1),a(this,t,"m",r).call(this)}connect(){this._disconnecting=!1;let e=new WebSocket(this._address.toString());e.onmessage=e=>{let t=e.data.trim().split("\n");for(let e of t)if(e.trim()){let t=JSON.parse(e),i=l.channelEventSchema.parse(t);this._broadcaster.publish(i)}},e.onerror=()=>e.close(),e.onclose=()=>{this._connectionState.publish(!1),!this._disconnecting&&setTimeout(()=>{this.connect()},1e3)},this._socket=e}getState(){return this._connectionState.value}disconnect(){var e;this._connectionState.publish(!1),this._disconnecting=!0,null===(e=this._socket)||void 0===e||e.close(),a(this,i,"f").clear()}createChannel(e,s){let r=a(this,i,"f").get(e);if(r&&r.channelState!==l.ChannelState.CLOSED)return r;let o=a(this,t,"m",n).call(this),h=new c.Channel(o,this._connectionState,e,s||{});return a(this,i,"f").set(e,h),h}onConnectionChange(e){return this._connectionState.subscribe(e)}},i=new WeakMap,t=new WeakSet,n=function(){return e=>{this._connectionState.value&&this._socket.send(JSON.stringify(e))}},s=function(e){var s;let r=null!==(s=a(this,i,"f").get(e.channelName))&&void 0!==s?s:new c.Channel(a(this,t,"m",n).call(this),this._connectionState,e.channelName,{});a(this,i,"f").set(e.channelName,r),r.acknowledge(this._broadcaster)},r=function(){this._broadcaster.subscribe(e=>{e.event===l.Events.ACKNOWLEDGE?a(this,t,"m",s).call(this,e):e.event===l.Events.CONNECTION&&e.action===l.ServerActions.CONNECT&&this._connectionState.publish(!0)})}}),E=o((e,t)=>{var i=function(){if("object"==typeof self&&self)return self;if("object"==typeof window&&window)return window;throw Error("Unable to resolve global `this`")};t.exports=function(){if(this)return this;if("object"==typeof globalThis&&globalThis)return globalThis;try{Object.defineProperty(Object.prototype,"__global__",{get:function(){return this},configurable:!0})}catch{return i()}try{return __global__||i()}finally{delete Object.prototype.__global__}}()}),w=o((e,t)=>{t.exports={name:"websocket",description:"Websocket Client & Server Library implementing the WebSocket protocol as specified in RFC 6455.",keywords:["websocket","websockets","socket","networking","comet","push","RFC-6455","realtime","server","client"],author:"Brian McKelvey <theturtle32@gmail.com> (https://github.com/theturtle32)",contributors:["IÃ±aki Baz Castillo <ibc@aliax.net> (http://dev.sipdoc.net)"],version:"1.0.35",repository:{type:"git",url:"https://github.com/theturtle32/WebSocket-Node.git"},homepage:"https://github.com/theturtle32/WebSocket-Node",engines:{node:">=4.0.0"},dependencies:{bufferutil:"^4.0.1",debug:"^2.2.0","es5-ext":"^0.10.63","typedarray-to-buffer":"^3.1.5","utf-8-validate":"^5.0.2",yaeti:"^0.0.6"},devDependencies:{"buffer-equal":"^1.0.0",gulp:"^4.0.2","gulp-jshint":"^2.0.4","jshint-stylish":"^2.2.1",jshint:"^2.0.0",tape:"^4.9.1"},config:{verbose:!1},scripts:{test:"tape test/unit/*.js",gulp:"gulp"},main:"index",directories:{lib:"./lib"},browser:"lib/browser.js",license:"Apache-2.0"}}),S=o((e,t)=>{t.exports=w().version}),C=o((e,t)=>{var i;if("object"==typeof globalThis)i=globalThis;else try{i=E()}catch{}finally{if(!i&&typeof window<"u"&&(i=window),!i)throw Error("Could not determine global this")}var n=i.WebSocket||i.MozWebSocket,s=S();function r(e,t){return t?new n(e,t):new n(e)}n&&["CONNECTING","OPEN","CLOSING","CLOSED"].forEach(function(e){Object.defineProperty(r,e,{get:function(){return n[e]}})}),t.exports={w3cwebsocket:n?r:null,version:s}}),A=o(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.PondClient=void 0;var t=g(),i=v(),n=C().w3cwebsocket,s=class extends i.PondClient{connect(e=1){this._disconnecting=!1;let i=new n(this._address.toString());i.onopen=()=>this._connectionState.publish(!0),i.onmessage=e=>{let i=e.data.trim().split("\n");for(let e of i)if(e.trim()){let i=JSON.parse(e),n=t.channelEventSchema.parse(i);this._broadcaster.publish(n)}},i.onerror=()=>i.close(),i.onclose=()=>{this._connectionState.publish(!1),!this._disconnecting&&setTimeout(()=>{this.connect()},1e3)}}};e.PondClient=s}),x=o(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.PondClient=e.ChannelState=void 0;var t=g();Object.defineProperty(e,"ChannelState",{enumerable:!0,get:function(){return t.ChannelState}});var i=v(),n=A(),s=typeof window>"u"?n.PondClient:i.PondClient;e.PondClient=s}),N={};a(N,{ComputedSignal:()=>ve,Signal:()=>ye,applyOps:()=>ie,bootClient:()=>xe,clearPatcherCaches:()=>re,configurePatcher:()=>ne,default:()=>Ce,dom:()=>k,getPatcherConfig:()=>se,getPatcherStats:()=>oe,morphElement:()=>Y});var O,_,T=(_=null!=(O=x())?e(s(O)):{},l(t(_,"default",{value:O,enumerable:!0}),O)),k={};a(k,{deleteRow:()=>H,ensureList:()=>j,getRow:()=>F,getSlot:()=>P,initLists:()=>q,registerList:()=>B,registerSlot:()=>L,setRow:()=>U,unregisterSlot:()=>D});var I=new Map,M=new Map;function R(e){let t=new Map;return e&&e.querySelectorAll("[data-row-key]").forEach(e=>{let i=e.getAttribute("data-row-key");i&&t.set(i,e)}),t}function L(e,t){t&&I.set(e,t)}function P(e){return I.get(e)||null}function D(e){I.delete(e)}function q(e){if(Array.isArray(e)&&!(typeof document>"u"))for(let t of e)if(!M.has(t)){let e=document.querySelector(`[data-list-slot="${t}"]`);e&&M.set(t,{container:e,rows:R(e)})}}function j(e){if(M.has(e))return M.get(e);let t=document.querySelector(`[data-list-slot="${e}"]`);if(!t)throw Error(`liveui: list slot ${e} not registered`);let i={container:t,rows:R(t)};return M.set(e,i),i}function B(e,t,i){t&&M.set(e,{container:t,rows:i??R(t)})}function U(e,t,i){j(e).rows.set(t,i)}function F(e,t){return j(e).rows.get(t)||null}function H(e,t){j(e).rows.delete(t)}var z={enableDirtyChecking:!0,enableBatching:!0,enableFragmentPooling:!0,enableMemoization:!0,enableVirtualScrolling:!0,virtualScrollThreshold:100,memoizationCacheSize:1e3},W=document.createElement("template"),$=new Map;function J(e){if(z.enableFragmentPooling&&$.has(e))return $.get(e).cloneNode(!0);W.innerHTML=e;let t=W.content.cloneNode(!0);return z.enableFragmentPooling&&$.size<50&&$.set(e,t.cloneNode(!0)),t}var V=new class{constructor(e){this.cache=new Map,this.maxSize=e}key(e,t,i){return`${e}:${t}:${JSON.stringify(i)}`}has(e){return this.cache.has(e)}get(e){return this.cache.get(e)}set(e,t){if(this.cache.size>=this.maxSize){let e=this.cache.keys().next().value;void 0!==e&&this.cache.delete(e)}this.cache.set(e,t)}clear(){this.cache.clear()}}(z.memoizationCacheSize),K=new class{constructor(){this.batch={reads:[],writes:[]},this.scheduled=!1}scheduleRead(e){this.batch.reads.push(e),this.schedule()}scheduleWrite(e){this.batch.writes.push(e),this.schedule()}schedule(){this.scheduled||(this.scheduled=!0,requestAnimationFrame(()=>{this.flush()}))}flush(){this.batch.reads.forEach(e=>e()),this.batch.writes.forEach(e=>e()),this.batch={reads:[],writes:[]},this.scheduled=!1}immediate(){this.scheduled&&this.flush()}},G=new Map;function Q(e,t){return z.enableVirtualScrolling&&t>z.virtualScrollThreshold}function X(e,t){let i=function(e,t){if(!e)throw Error(`liveui: slot ${t} not registered`);return e}(P(e),e);z.enableDirtyChecking&&i.textContent===t||(z.enableBatching?K.scheduleWrite(()=>{i.textContent=t}):i.textContent=t)}function Z(e,t,i){let n=P(e);if(!(n instanceof Element))throw Error(`liveui: slot ${e} is not an element`);let s=()=>{if(t)for(let[e,i]of Object.entries(t))null!=i&&(z.enableDirtyChecking&&n.getAttribute(e)===i+""||n.setAttribute(e,i+""));if(i)for(let e of i)n.hasAttribute(e)&&n.removeAttribute(e)};z.enableBatching?K.scheduleWrite(s):s()}function Y(e,t){let i=e.attributes,n=t.attributes;for(let n=i.length-1;n>=0;n--){let s=i[n];t.hasAttribute(s.name)||e.removeAttribute(s.name)}for(let t=0;t<n.length;t++){let i=n[t];e.getAttribute(i.name)!==i.value&&e.setAttribute(i.name,i.value)}1===e.childNodes.length&&e.firstChild?.nodeType===Node.TEXT_NODE&&1===t.childNodes.length&&t.firstChild?.nodeType===Node.TEXT_NODE&&e.firstChild.textContent!==t.firstChild.textContent&&(e.firstChild.textContent=t.firstChild.textContent)}function ee(e,t){if(!Array.isArray(e)||0===e.length)return;let i=new Set(e),n=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT),s=n.nextNode(),r=null!==s;for(;s&&i.size>0;){let e=s.getAttribute("data-slot-index");null!==e&&e.split(/\s+/).map(e=>e.trim()).filter(e=>e.length>0).forEach(e=>{let[t,n]=e.split("@"),r=+t;if(Number.isNaN(r)||!i.has(r))return;let o=s;if(void 0!==n){let e=+n;if(!Number.isNaN(e)){let t=s.childNodes.item(e);t&&(o=t)}}L(r,o),i.delete(r)}),s=n.nextNode()}i.size>0&&r&&i.forEach(e=>{})}function te(e,t){if(!Array.isArray(t)||0===t.length)return;let i=j(e),n=i.container,s=z.enableBatching?Array.from(n.children):null,r=i.rows.size;for(let i of t)if(i&&i.length)switch(i[0]){case"del":{let t=i[1],s=F(e,t);if(s&&s.parentNode===n){let e=()=>{n.removeChild(s)};z.enableBatching?K.scheduleWrite(e):e()}H(e,t),r--;break}case"ins":{let t,o=i[1],a=i[2]||{key:"",html:""},l=V.key("ins",e,a.html);z.enableMemoization&&V.has(l)?t=V.get(l).cloneNode(!0):(t=J(a.html||""),z.enableMemoization&&V.set(l,t.cloneNode(!0)));let c=Array.from(t.childNodes);if(0===c.length)break;let h=()=>{let i=z.enableBatching?s[o]||null:n.children[o]||null;n.insertBefore(t,i);let l=c[0];if(l instanceof HTMLElement&&(U(e,a.key,l),ee(a.slots||[],l),Q(0,r))){let t=G.get(e);t&&(o<t.visibleRange.start||o>t.visibleRange.end)&&(l.style.display="none")}};z.enableBatching?K.scheduleWrite(h):h(),r++;break}case"mov":{let e=i[1],t=i[2];if(e===t)break;let r=()=>{let i=z.enableBatching?s:Array.from(n.children),r=i[e];if(r){let e=t<i.length?i[t]:null;n.insertBefore(r,e)}};z.enableBatching?K.scheduleWrite(r):r();break}}if(Q(0,r)){let t=G.get(e);t?t.totalItems=r:function(e,t){if(!z.enableVirtualScrolling)return;let i={container:t,totalItems:0,visibleRange:{start:0,end:50},itemHeight:0};i.observer=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(e.target.style.display="")})},{root:t,threshold:.1}),G.set(e,i)}(e,n)}}function ie(e){if(Array.isArray(e)){for(let t of e)if(t&&0!==t.length)switch(t[0]){case"setText":X(t[1],t[2]);break;case"setAttrs":Z(t[1],t[2]||{},t[3]||[]);break;case"list":te(t[1],t.slice(2))}z.enableBatching&&K.immediate()}}function ne(e){Object.assign(z,e)}function se(){return{...z}}function re(){$.clear(),V.clear(),G.clear()}function oe(){return{htmlCacheSize:$.size,memoizerCacheSize:V.cache.size,virtualScrollCount:G.size}}var ae=new Map,le=new Map,ce=new Map,he=["click","input","change","submit"];function de(e){if(e)for(let[t,i]of Object.entries(e)){let e=ae.get(t);e?.event&&ge(e.event),ae.set(t,i),i.event&&be(i.event)}}var ue=null,pe=null;function fe(e){if(ce.has(e))return;let t="blur"===e||"focus"===e,i=t=>{ue&&function(e,t,i){let n=e.target;if(!n)return;let s=function(e,t){let i=e,n="data-on"+t;for(;i&&i!==document.documentElement;){if(i.hasAttribute&&i.hasAttribute(n))return i.getAttribute(n);i=i.parentElement}return null}(n,t);if(s){let r=ae.get(s);if(r&&r.event===t){let r=function(e,t){let i={type:e.type};return(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement)&&(i.value=t.value,t instanceof HTMLInputElement&&("checkbox"===t.type||"radio"===t.type)&&(i.checked=t.checked)),e instanceof KeyboardEvent&&(i.key=e.key,i.keyCode=e.keyCode,i.altKey=e.altKey,i.ctrlKey=e.ctrlKey,i.metaKey=e.metaKey,i.shiftKey=e.shiftKey),e instanceof MouseEvent&&(i.clientX=e.clientX,i.clientY=e.clientY),i}(e,n);return"submit"===t&&e.preventDefault(),void i({hid:s,payload:r})}}if("click"===t&&pe&&e instanceof MouseEvent){let t=function(e){let t=e;for(;t&&t!==document.documentElement;){if(t instanceof HTMLAnchorElement&&t.hasAttribute("href"))return t;t=t.parentElement}return null}(n);if(t&&function(e,t){if(0!==e.button||e.ctrlKey||e.metaKey||e.altKey||e.shiftKey)return!1;let i=t.getAttribute("href");if(!i)return!1;let n=t.getAttribute("target");if(n&&"_self"!==n)return!1;try{let e=new URL(i,window.location.href);return!(e.origin!==window.location.origin||e.pathname===window.location.pathname&&e.search===window.location.search&&e.hash)}catch{return!1}}(e,t)){let i=t.getAttribute("href");if(i)try{let t=new URL(i,window.location.href),n=t.pathname,s=t.search.substring(1),r=t.hash.startsWith("#")?t.hash.substring(1):t.hash;if(pe(n,s,r))return e.preventDefault(),void e.stopPropagation()}catch{}}}}(t,e,ue)};document.addEventListener(e,i,t),ce.set(e,i)}function me(){le.forEach((e,t)=>{fe(t)}),ce.forEach((e,t)=>{!le.has(t)&&!he.includes(t)&&function(e){let t=ce.get(e);if(!t)return;let i="blur"===e||"focus"===e;document.removeEventListener(e,t,i),ce.delete(e)}(t)})}function be(e){let t=le.get(e)??0;le.set(e,t+1)}function ge(e){let t=le.get(e);t&&(t<=1?le.delete(e):le.set(e,t-1))}var ye=class{constructor(e){this.subscribers=new Set,this.value=e}get(){return this.value}set(e){this.value!==e&&(this.value=e,this.notify())}update(e){this.set(e(this.value))}subscribe(e){return this.subscribers.add(e),e(this.value),()=>this.subscribers.delete(e)}notify(){this.subscribers.forEach(e=>e(this.value))}},ve=class{constructor(e,t){this.subscribers=new Set,this.unsubscribers=[],this.value=e(),t.forEach(t=>{let i=t.subscribe(()=>{let t=e();this.value!==t&&(this.value=t,this.notify())});this.unsubscribers.push(i)})}get(){return this.value}subscribe(e){return this.subscribers.add(e),e(this.value),()=>this.subscribers.delete(e)}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.subscribers.clear()}notify(){this.subscribers.forEach(e=>e(this.value))}},Ee=class{constructor(){this.listeners=new Map}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.off(e,t)}off(e,t){let i=this.listeners.get(e);i&&(i.delete(t),0===i.size&&this.listeners.delete(e))}emit(e,t){let i=this.listeners.get(e);i&&i.forEach(e=>{try{e(t)}catch{}})}once(e,t){let i=n=>{t(n),this.off(e,i)};return this.on(e,i)}removeAllListeners(e){e?this.listeners.delete(e):this.listeners.clear()}listenerCount(e){return this.listeners.get(e)?.size??0}},we=class{constructor(e){this.updates=new Map,this.nextId=0,this.debug=!1,this.onRollback=e?.onRollback,this.onError=e?.onError,this.debug=e?.debug||!1}apply(e){let t="opt_"+this.nextId++,i=function(e){let t=[];for(let i of e){let[e,n,...s]=i;if("setText"===e){let e=P(n);if(e){let i=e.textContent||"";t.push(["setText",n,i])}}else if("setAttrs"===e){let e=P(n);if(e&&e instanceof Element){let[i,r]=s,o={},a=[];for(let t of Object.keys(i)){let i=e.getAttribute(t);null!==i?o[t]=i:a.push(t)}for(let t of r){let i=e.getAttribute(t);null!==i&&(o[t]=i)}t.push(["setAttrs",n,o,a])}}else if("list"===e){let e=s,i=[];for(let t of e){let[e,...n]=t;if("ins"===e){let[,{key:e}]=n;i.push(["del",e])}else if("del"!==e&&"mov"===e){let[e,t]=n;i.push(["mov",t,e])}}i.length>0&&t.push(["list",n,...i.reverse()])}}return t.reverse()}(e),n={id:t,patches:e,inverseOps:i,timestamp:Date.now()};return this.updates.set(t,n),ie(e),this.debug,t}commit(e){this.updates.delete(e)&&this.debug}rollback(e){let t=this.updates.get(e);if(t){this.debug;try{ie(t.inverseOps),this.onRollback?.(e,t.patches)}catch(e){this.onError?.(e,"rollback")}this.updates.delete(e)}}getPendingCount(){return this.updates.size}clear(){this.updates.clear()}},Se=class{constructor(e){this.boot=null,this.debug=!1,this.debug=e?.debug||!1}load(e){let t=e??this.detect();return t&&"string"==typeof t.sid&&0!==t.sid.length?(this.apply(t),t):(this.log("No boot payload detected or payload invalid"),null)}detect(){if(typeof window<"u"){let e=window.__LIVEUI_BOOT__;if(e&&"object"==typeof e&&"string"==typeof e.sid)return e}if(typeof document<"u"){let e=document.getElementById("liveui-boot")?.textContent;if(e)try{return JSON.parse(e)}catch(e){this.log("Failed to parse boot payload from DOM",e)}}return null}apply(e){if(this.boot=e,e.handlers&&(de(e.handlers),me()),this.registerInitialDom(e),typeof window<"u"&&e.location){let t=e.location.q?"?"+e.location.q:"",i=e.location.hash?"#"+e.location.hash:"",n=`${e.location.path}${t}${i}`,s=`${window.location.pathname}${window.location.search}${window.location.hash}`;n&&s!==n&&window.history.replaceState({},"",n)}}registerInitialDom(e){if(typeof document>"u")return;let t=this.collectSlotAnchors();if(Array.isArray(e.slots))for(let i of e.slots){if(!i||"number"!=typeof i.anchorId)continue;let e=t.get(i.anchorId);e?L(i.anchorId,e):this.debug}let i=this.collectListSlotIndexes(e.d);i.length>0&&q(i)}collectListSlotIndexes(e){if(!Array.isArray(e))return[];let t=[];return e.forEach((e,i)=>{e&&"list"===e.kind&&t.push(i)}),t}collectSlotAnchors(){let e=new Map;return typeof document>"u"||document.querySelectorAll("[data-slot-index]").forEach(t=>{let i=t.getAttribute("data-slot-index");i&&i.split(/\s+/).map(e=>e.trim()).filter(e=>e.length>0).forEach(i=>{let[n,s]=i.split("@"),r=+n;if(Number.isNaN(r)||e.has(r))return;let o=t;if(void 0!==s){let e=+s;if(!Number.isNaN(e)){let i=t.childNodes.item(e);i&&(o=i)}}e.set(r,o)})}),e}get(){return this.boot}ensure(){if(!this.boot||!this.boot.sid)throw Error("LiveUI: boot payload is required before connecting");return this.boot}getJoinLocation(){let e=this.boot?.location??{path:"/",q:"",hash:""};if(typeof window>"u")return e;let t=window.location.pathname||e.path||"/",i=window.location.search??"",n=i.startsWith("?")?i.substring(1):i,s=window.location.hash??"";return{path:t,q:n,hash:s.startsWith("#")?s.substring(1):s}}log(...e){this.debug}},Ce=class extends Ee{constructor(e={}){super(),this.client=null,this.channel=null,this.pubsubChannels=new Map,this.connectionState=new ye({status:"disconnected"}),this.sessionId=new ye(null),this.version=new ye(0),this.lastAck=0,this.hasBootPayload=!1,this.autoConnectCleanup=null,this.expectedSeq=null,this.frameBuffer=new Map,this.MAX_FRAME_BUFFER_SIZE=50,this.eventQueue=[],this.patchQueue=[],this.batchScheduled=!1,this.rafHandle=null,this.rafUsesTimeoutFallback=!1,this.reconnectAttempts=0,this.reconnectTimer=null,this.isReconnecting=!1,this.diagnostics=[],this.errorOverlay=null,this.errorListEl=null,this.errorOverlayVisible=!1,this.handleDebugKeydown=e=>this.onDebugKeydown(e),this.metrics={patchesApplied:0,averagePatchTime:0,framesReceived:0,eventsProcessed:0,reconnections:0,uptime:0,effectsMs:0,maxEffectMs:0,slowEffects:0,framesBuffered:0,framesDropped:0,sequenceGaps:0},this.startTime=0,this.patchTimes=[],this.patchTimeTotal=0,this.lastOptimisticNavTime=0,this.OPTIMISTIC_NAV_WINDOW=100,this.eventDebouncer=new Map,this.handlePopState=()=>{if("connected"!==this.connectionState.get().status||!this.channel)return void this.log("Not connected, cannot handle popstate");let e=window.location.pathname,t=window.location.search.substring(1),i=window.location.hash.startsWith("#")?window.location.hash.substring(1):window.location.hash,n={t:"pop",sid:this.sessionId.get(),path:e,q:t,hash:i};this.log("Sending popstate navigation:",n),this.channel.sendMessage("pop",n)},this.bootHandler=new Se({debug:e.debug||!1}),this.optimistic=new we({onRollback:(e,t)=>this.emit("rollback",{id:e,patches:t}),onError:(e,t)=>this.emit("error",{error:e,context:t}),debug:e.debug||!1});let t={...e??{}},i=t.boot??null;delete t.boot,this.options={endpoint:t.endpoint??"/live",autoConnect:!1!==t.autoConnect,debug:t.debug??!1,reconnect:!1!==t.reconnect,maxReconnectAttempts:t.maxReconnectAttempts??5,reconnectDelay:t.reconnectDelay??1e3,...t},i&&(this.options.boot=i);let n=this.bootHandler.load(i);if(this.hasBootPayload=!!n,n&&(n.client?.endpoint&&"string"==typeof n.client.endpoint&&(this.options.endpoint=n.client.endpoint),this.sessionId.set(n.sid),this.version.set(n.ver??0),this.lastAck=n.seq??0,n.errors&&n.errors.length>0))for(let e of n.errors)this.recordDiagnostic(e);this.connectionState.subscribe(e=>{this.log("Connection state changed:",e)}),this.options.debug&&typeof window<"u"&&window.addEventListener("keydown",this.handleDebugKeydown),this.setupAutoConnect()}async connect(){this.clearAutoConnect();let e,t=this.connectionState.get();if("connected"!==t.status&&"connecting"!==t.status){try{e=this.bootHandler.ensure()}catch(e){return this.log("Boot payload error:",e),this.setState({status:"error",error:e}),void this.emit("error",{error:e,context:"boot"})}e.client?.endpoint&&"string"==typeof e.client.endpoint&&(this.options.endpoint=e.client.endpoint),this.setState({status:"connecting"}),this.startTime=Date.now();try{this.log("Connecting to",this.options.endpoint);let t=e.sid,i=this.bootHandler.getJoinLocation(),n={sid:t,ver:e.ver??0,ack:this.lastAck??e.seq??0,loc:{path:i.path,q:i.q,hash:i.hash}};this.client=new T.PondClient(this.options.endpoint),typeof document<"u"&&function(e){ue=e,he.forEach(e=>{fe(e)})}(e=>this.sendEvent(e)),typeof document<"u"&&function(e){pe=e,ce.has("click")||fe("click")}((e,t,i)=>this.sendNavigation(e,t,i)),typeof window<"u"&&window.addEventListener("popstate",this.handlePopState);let s="live/"+t;this.channel=this.client.createChannel(s,n),this.channel.onChannelStateChange(e=>{this.log("Channel state changed:",e),"JOINED"===e&&this.onConnected()}),this.channel.onMessage((e,t)=>{(e=>null!==e&&"object"==typeof e&&"string"==typeof e.t)(t)?this.handleMessage(t):this.log("Ignoring non-server payload",e,t)}),this.channel.onLeave(()=>{this.log("Channel left"),this.onDisconnected()}),this.client.connect(),this.channel.join()}catch(e){this.log("Connection error:",e),this.setState({status:"error",error:e}),this.emit("error",{error:e,context:"connect"}),this.options.reconnect&&!this.isReconnecting&&this.scheduleReconnect()}}else this.log("Already connected or connecting")}disconnect(){this.clearReconnectTimer(),this.isReconnecting=!1,this.cancelScheduledBatch(),this.patchQueue=[];for(let e of this.pubsubChannels.values())try{e.dispose(),e.channel.leave()}catch(e){this.log("Error leaving pubsub channel",e)}this.pubsubChannels.clear(),this.channel&&(this.channel.leave(),this.channel=null),this.client&&(this.client.disconnect(),this.client=null),typeof window<"u"&&window.removeEventListener("popstate",this.handlePopState),this.setState({status:"disconnected"}),this.sessionId.set(null),this.version.set(0),ae.clear(),le.clear(),me(),ce.forEach((e,t)=>{let i="blur"===t||"focus"===t;document.removeEventListener(t,e,i)}),ce.clear(),ue=null,pe=null,this.emit("disconnected",void 0)}setupAutoConnect(){if(!this.options.autoConnect)return;if(!this.hasBootPayload)return void this.log("Auto-connect skipped: no boot payload detected");let e=()=>{this.clearAutoConnect(),this.log("Auto-connecting after DOM ready"),this.connect().catch(e=>{this.log("Auto-connect failed:",e)})};if(typeof document>"u")e();else{if("loading"===document.readyState){let t=()=>{document.removeEventListener("DOMContentLoaded",t),e()};return document.addEventListener("DOMContentLoaded",t),void(this.autoConnectCleanup=()=>{document.removeEventListener("DOMContentLoaded",t)})}"function"==typeof queueMicrotask?queueMicrotask(e):Promise.resolve().then(e)}}clearAutoConnect(){this.autoConnectCleanup&&(this.autoConnectCleanup(),this.autoConnectCleanup=null)}getConnectionState(){return this.connectionState.get()}getMetrics(){return{...this.metrics,uptime:this.startTime?Date.now()-this.startTime:0}}onStateChange(e){return this.connectionState.subscribe(e)}onSessionIdChange(e){return this.sessionId.subscribe(e)}onVersionChange(e){return this.version.subscribe(e)}sendEventDebounced(e,t=300){let i=this.eventDebouncer.get(e.hid);i&&clearTimeout(i);let n=setTimeout(()=>{this.sendEvent(e),this.eventDebouncer.delete(e.hid)},t);this.eventDebouncer.set(e.hid,n)}applyOptimistic(e){return this.optimistic.apply(e)}commitOptimistic(e){this.optimistic.commit(e)}rollbackOptimistic(e){this.optimistic.rollback(e)}setState(e){let t=this.connectionState.get();this.hasStateChanged(t,e)&&(this.connectionState.set(e),this.emit("stateChanged",{from:t,to:e}))}onConnected(){let e=this.sessionId.get(),t=this.version.get();e&&(this.isReconnecting&&(this.isReconnecting=!1,this.reconnectAttempts=0,this.emit("reconnected",{sessionId:e})),this.setState({status:"connected",sessionId:e,version:t}),this.emit("connected",{sessionId:e,version:t}),this.flushEventQueue())}onDisconnected(){this.setState({status:"disconnected"}),this.options.reconnect&&!this.isReconnecting&&this.scheduleReconnect()}scheduleReconnect(){if(this.reconnectAttempts>=this.options.maxReconnectAttempts)return this.log("Max reconnect attempts reached"),void this.emit("error",{error:Error("Max reconnect attempts reached"),context:"reconnect"});this.isReconnecting=!0,this.reconnectAttempts++;let e=this.options.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);this.log(`Reconnecting in ${e}ms (attempt ${this.reconnectAttempts}/${this.options.maxReconnectAttempts})`),this.setState({status:"reconnecting",attempt:this.reconnectAttempts}),this.emit("reconnecting",{attempt:this.reconnectAttempts}),this.reconnectTimer=setTimeout(()=>{this.metrics.reconnections++,this.connect()},e)}clearReconnectTimer(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null)}handleMessage(e){if(e&&e.t)switch(this.log("Received message:",e.t,e),e.t){case"init":this.handleInit(e);break;case"frame":this.handleFrame(e);break;case"join":this.handleJoin(e);break;case"resume":this.handleResume(e);break;case"error":this.handleError(e);break;case"pubsub":this.handlePubsub(e);break;default:this.log("Unknown message type:",e.t)}else this.log("Invalid message",e)}handleInit(e){if(this.sessionId.set(e.sid),this.version.set(e.ver),this.expectedSeq=void 0!==e.seq?e.seq+1:null,this.frameBuffer.clear(),Array.isArray(e.errors)&&e.errors.length>0)for(let t of e.errors)this.recordDiagnostic(t);e.handlers&&(de(e.handlers),me()),void 0!==e.seq&&(this.lastAck=e.seq,this.sendAck(e.seq)),this.log("Session initialized:",e.sid,"version:",e.ver),this.onConnected()}handleFrame(e){let t=this.sessionId.get();if(e.sid===t)if(this.metrics.framesReceived++,void 0!==e.seq){if(null===this.expectedSeq)return this.expectedSeq=e.seq+1,this.applyFrame(e),void this.drainFrameBuffer();if(e.seq===this.expectedSeq)return this.expectedSeq=e.seq+1,this.applyFrame(e),void this.drainFrameBuffer();if(e.seq>this.expectedSeq){if(this.metrics.sequenceGaps++,this.log("Frame arrived out of order",{expected:this.expectedSeq,received:e.seq,gap:e.seq-this.expectedSeq}),this.frameBuffer.size>=this.MAX_FRAME_BUFFER_SIZE){this.metrics.framesDropped++,this.log("Frame buffer full, dropping oldest frame");let e=Math.min(...this.frameBuffer.keys());this.frameBuffer.delete(e)}return this.frameBuffer.set(e.seq,e),void this.metrics.framesBuffered++}if(e.seq<this.expectedSeq)return this.metrics.framesDropped++,void this.log("Dropping duplicate/late frame",{expected:this.expectedSeq,received:e.seq})}else this.applyFrame(e);else this.log("Session mismatch, ignoring frame")}applyFrame(e){if(this.version.set(e.ver),e.patch&&e.patch.length>0&&(this.log("Queueing",e.patch.length,"operations"),this.patchQueue.push(...e.patch),this.scheduleBatch()),e.handlers&&(e.handlers.add&&de(e.handlers.add),e.handlers.del&&function(e){if(Array.isArray(e))for(let t of e){let e=ae.get(t);ae.delete(t),e?.event&&ge(e.event)}}(e.handlers.del),me()),e.nav){let t=Date.now()-this.lastOptimisticNavTime<this.OPTIMISTIC_NAV_WINDOW;e.nav.push?t?window.history.replaceState({},"",e.nav.push):window.history.pushState({},"",e.nav.push):e.nav.replace&&window.history.replaceState({},"",e.nav.replace),this.lastOptimisticNavTime=0}e.effects&&e.effects.length>0&&this.applyEffects(e.effects),void 0!==e.seq&&this.sendAck(e.seq),e.metrics&&(this.log("Frame metrics:",e.metrics),"number"==typeof e.metrics.effectsMs&&(this.metrics.effectsMs=e.metrics.effectsMs),"number"==typeof e.metrics.maxEffectMs&&(this.metrics.maxEffectMs=e.metrics.maxEffectMs),"number"==typeof e.metrics.slowEffects&&(this.metrics.slowEffects=e.metrics.slowEffects))}drainFrameBuffer(){for(;null!==this.expectedSeq&&this.frameBuffer.has(this.expectedSeq);){let e=this.frameBuffer.get(this.expectedSeq);this.frameBuffer.delete(this.expectedSeq),this.expectedSeq=e.seq+1,this.log("Draining buffered frame",{seq:e.seq}),this.applyFrame(e)}}applyEffects(e){for(let t of e)try{switch(this.log("Applying effect:",t),this.emit("effect",{effect:t}),"string"==typeof t.type?t.type.toLowerCase():""){case"scroll":case"scrolltop":this.applyScrollEffect(t);break;case"focus":this.applyFocusEffect(t);break;case"alert":window.alert(t.message);break;case"toast":this.applyToastEffect(t);break;case"push":this.applyPushEffect(t);break;case"replace":this.applyReplaceEffect(t);break;case"dispatch":this.dispatchCustomEvent(t.eventName,t.detail);break;case"metadata":this.applyMetadataEffect(t);break;case"custom":break;default:this.log("Unknown effect type:",t.type)}}catch(e){this.log("Error applying effect:",t,e),this.emit("error",{error:e,context:"effect"})}}applyScrollEffect(e){let t=e.behavior||"smooth",i=e.selector;if(!i||"ScrollTop"===e.type)return void window.scrollTo({top:0,behavior:t});let n=document.querySelector(i);n instanceof Element&&n.scrollIntoView({behavior:t,block:e.block||"start"})}applyMetadataEffect(e){if(typeof document>"u")return;Object.prototype.hasOwnProperty.call(e,"title")&&void 0!==e.title&&(document.title=e.title);let t=document.head;if(!t)return;let i="data-liveui-key",n="data-liveui-head",s=e=>{!Array.isArray(e)||0===e.length||e.forEach(e=>{t.querySelectorAll(`[${i}="${e}"]`).forEach(e=>{e.parentNode?.removeChild(e)})})},r=(e,t)=>{let i=new Set(t);Array.from(e.attributes).forEach(t=>{i.has(t.name)||e.removeAttribute(t.name)})},o=(e,s)=>{if(!e||!e.key)return;let o=t.querySelector(`meta[${i}="${e.key}"]`);if(o||(o=document.createElement("meta"),t.appendChild(o)),r(o,[i]),o.setAttribute(i,e.key),o.setAttribute(n,s),void 0!==e.name&&o.setAttribute("name",e.name),void 0!==e.content&&o.setAttribute("content",e.content),void 0!==e.property&&o.setAttribute("property",e.property),void 0!==e.charset&&o.setAttribute("charset",e.charset),void 0!==e.httpEquiv&&o.setAttribute("http-equiv",e.httpEquiv),void 0!==e.itemProp&&o.setAttribute("itemprop",e.itemProp),e.attrs)for(let[t,i]of Object.entries(e.attrs))null!=i&&o.setAttribute(t,i+"")},a=e=>{if(!e||!e.key)return;let s=t.querySelector(`link[${i}="${e.key}"]`);if(s||(s=document.createElement("link"),t.appendChild(s)),r(s,[i]),s.setAttribute(i,e.key),s.setAttribute(n,"link"),void 0!==e.rel&&s.setAttribute("rel",e.rel),void 0!==e.href&&s.setAttribute("href",e.href),void 0!==e.type&&s.setAttribute("type",e.type),void 0!==e.as&&s.setAttribute("as",e.as),void 0!==e.media&&s.setAttribute("media",e.media),void 0!==e.hreflang&&s.setAttribute("hreflang",e.hreflang),void 0!==e.title&&s.setAttribute("title",e.title),void 0!==e.crossorigin&&s.setAttribute("crossorigin",e.crossorigin),void 0!==e.integrity&&s.setAttribute("integrity",e.integrity),void 0!==e.referrerpolicy&&s.setAttribute("referrerpolicy",e.referrerpolicy),void 0!==e.sizes&&s.setAttribute("sizes",e.sizes),e.attrs)for(let[t,i]of Object.entries(e.attrs))null!=i&&s.setAttribute(t,i+"")},l=e=>{if(!e||!e.key)return;let s=t.querySelector(`script[${i}="${e.key}"]`);if(s||(s=document.createElement("script"),t.appendChild(s)),r(s,[i]),s.setAttribute(i,e.key),s.setAttribute(n,"script"),e.module?s.setAttribute("type","module"):void 0!==e.type&&s.setAttribute("type",e.type),void 0!==e.src&&s.setAttribute("src",e.src),e.async&&s.setAttribute("async","async"),e.defer&&s.setAttribute("defer","defer"),e.noModule&&s.setAttribute("nomodule","nomodule"),void 0!==e.crossorigin&&s.setAttribute("crossorigin",e.crossorigin),void 0!==e.integrity&&s.setAttribute("integrity",e.integrity),void 0!==e.referrerpolicy&&s.setAttribute("referrerpolicy",e.referrerpolicy),void 0!==e.nonce&&s.setAttribute("nonce",e.nonce),e.attrs)for(let[t,i]of Object.entries(e.attrs))null!=i&&s.setAttribute(t,i+"");void 0!==e.inner&&(s.textContent=e.inner)};if(e.clearDescription&&s(["description"]),Object.prototype.hasOwnProperty.call(e,"description")&&void 0!==e.description){let t=e.description;t.trim().length>0?o({key:"description",name:"description",content:t},"description"):s(["description"])}if(Array.isArray(e.metaRemove)&&s(e.metaRemove),Array.isArray(e.metaAdd))for(let t of e.metaAdd)o(t,"meta");if(Array.isArray(e.linkRemove)&&s(e.linkRemove),Array.isArray(e.linkAdd))for(let t of e.linkAdd)a(t);if(Array.isArray(e.scriptRemove)&&s(e.scriptRemove),Array.isArray(e.scriptAdd))for(let t of e.scriptAdd)l(t)}applyFocusEffect(e){let t=e.selector||e.Selector;if(!t)return;let i=document.querySelector(t);i&&i instanceof HTMLElement&&i.focus()}applyToastEffect(e){let t=e.message||e.Message,i=e.duration||3e3,n=e.variant||"info";this.emit("effect",{effect:{type:"toast",message:t,duration:i,variant:n}}),this.listenerCount("effect")}applyPushEffect(e){let t=e.url||e.URL;t&&window.history.pushState({},"",t)}applyReplaceEffect(e){let t=e.url||e.URL;t&&window.history.replaceState({},"",t)}dispatchCustomEvent(e,t){let i=new CustomEvent(e,{detail:t,bubbles:!0,cancelable:!0});document.dispatchEvent(i)}scheduleBatch(){if(this.batchScheduled)return;if(this.batchScheduled=!0,"function"==typeof requestAnimationFrame)return this.rafUsesTimeoutFallback=!1,void(this.rafHandle=requestAnimationFrame(()=>{this.rafHandle=null,this.flushBatch()}));this.rafUsesTimeoutFallback=!0;let e=setTimeout(()=>{this.rafHandle=null,this.flushBatch()},16);this.rafHandle=e}flushBatch(){if(0===this.patchQueue.length)return this.batchScheduled=!1,this.rafHandle=null,void(this.rafUsesTimeoutFallback=!1);let e=performance.now();this.log("Applying batched",this.patchQueue.length,"operations");let t=this.patchQueue;this.patchQueue=[],this.batchScheduled=!1,this.rafHandle=null,this.rafUsesTimeoutFallback=!1,ie(t);let i=performance.now()-e;if(this.metrics.patchesApplied+=t.length,this.patchTimes.push(i),this.patchTimeTotal+=i,this.patchTimes.length>100){let e=this.patchTimes.shift();void 0!==e&&(this.patchTimeTotal-=e)}let n=this.patchTimes.length;this.metrics.averagePatchTime=n?this.patchTimeTotal/n:0,this.emit("frameApplied",{operations:t.length,duration:i}),this.emit("metricsUpdated",this.getMetrics())}cancelScheduledBatch(){null!==this.rafHandle&&(this.rafUsesTimeoutFallback?clearTimeout(this.rafHandle):"function"==typeof cancelAnimationFrame&&cancelAnimationFrame(this.rafHandle),this.rafHandle=null,this.batchScheduled=!1,this.rafUsesTimeoutFallback=!1)}hasStateChanged(e,t){if(e.status!==t.status)return!0;switch(t.status){case"connected":return"connected"!==e.status||e.sessionId!==t.sessionId||e.version!==t.version;case"reconnecting":return"reconnecting"!==e.status||e.attempt!==t.attempt;case"error":return"error"!==e.status||e.error!==t.error;default:return!1}}handleJoin(e){this.sessionId.set(e.sid),this.version.set(e.ver),"number"==typeof e.ack&&e.ack>this.lastAck&&(this.lastAck=e.ack),this.log("Joined session:",e.sid,"ack:",e.ack)}handleResume(e){this.log("Resume from",e.from,"to",e.to);let t=e.from>0?e.from-1:0;if(t>this.lastAck&&(this.lastAck=t),this.expectedSeq=e.from,this.frameBuffer.clear(),Array.isArray(e.errors)&&e.errors.length>0)for(let t of e.errors)this.recordDiagnostic(t);this.emit("resumed",{from:e.from,to:e.to}),this.isReconnecting&&this.flushEventQueue()}handleError(e){let t=Error(e.message);this.emit("error",{error:t,context:e.code}),this.recordDiagnostic(e)}handlePubsub(e){if(e.topic)switch(e.op){case"join":this.joinPubsubTopic(e.topic);break;case"leave":this.leavePubsubTopic(e.topic);break;default:this.log("Unknown pubsub op:",e)}}recordDiagnostic(e){if(!this.options.debug)return;let t=this.buildDiagnosticKey(e),i={key:t,code:e.code??"runtime_panic",message:e.message??"Runtime panic recovered",details:e.details,timestamp:Date.now()},n=this.diagnostics.findIndex(e=>e.key===t);n>=0?this.diagnostics[n]=i:(this.diagnostics.push(i),this.diagnostics.length>20&&this.diagnostics.shift()),typeof document<"u"&&this.renderErrorOverlay()}buildDiagnosticKey(e){let t=e.details,i=t?.componentId??t?.componentName??"",n=t?.hook??"",s=t?.phase??"",r=t?.panic??"";return[e.code??"",e.message??"",i,n,s,r].join("|")}joinPubsubTopic(e){if(!e||!this.client||this.pubsubChannels.has(e))return;let t=this.client.createChannel("pubsub/"+e,{sid:this.sessionId.get()??void 0}),i=t.onLeave(()=>{this.pubsubChannels.delete(e)});this.pubsubChannels.set(e,{channel:t,dispose:i});try{t.join(),this.log("Joined pubsub topic",e)}catch(t){this.pubsubChannels.delete(e),i(),this.log("Failed to join pubsub topic",e,t)}}leavePubsubTopic(e){let t=this.pubsubChannels.get(e);if(t){this.pubsubChannels.delete(e);try{t.dispose(),t.channel.leave(),this.log("Left pubsub topic",e)}catch(t){this.log("Failed to leave pubsub topic",e,t)}}}ensureErrorOverlayElements(){if(!this.options.debug||typeof document>"u"||this.errorOverlay)return;let e=document.createElement("div");e.id="liveui-error-overlay",e.setAttribute("role","alertdialog"),e.setAttribute("aria-live","assertive"),e.setAttribute("aria-modal","true"),e.style.cssText="position:fixed;inset:0;background:rgba(15,23,42,0.82);color:#e2e8f0;z-index:2147483646;display:none;align-items:flex-start;justify-content:center;overflow-y:auto;padding:48px 24px;box-sizing:border-box;backdrop-filter:blur(6px)",e.addEventListener("click",t=>{t.target===e&&this.hideErrorOverlay()});let t=document.createElement("div");t.style.cssText='width:min(960px,100%);background:rgba(15,23,42,0.95);border-radius:16px;border:1px solid rgba(148,163,184,0.35);box-shadow:0 25px 50px -12px rgba(15,23,42,0.8);display:flex;flex-direction:column;overflow:hidden;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif';let i=document.createElement("header");i.style.cssText="display:flex;align-items:center;justify-content:space-between;gap:12px;padding:20px 24px;background:rgba(15,23,42,0.88);border-bottom:1px solid rgba(148,163,184,0.28);position:sticky;top:0;z-index:1";let n=document.createElement("h2");n.textContent="LiveUI Runtime Errors",n.style.cssText="margin:0;font-size:18px;font-weight:700;color:#f8fafc;";let s=document.createElement("div");s.style.cssText="display:flex;flex-direction:column;gap:4px;",s.appendChild(n);let r=document.createElement("span");r.textContent="â§âE / â§Ctrl+E to toggle â¢ Esc to dismiss",r.style.cssText="font-size:12px;color:#94a3b8;",s.appendChild(r);let o=document.createElement("div");o.style.cssText="display:flex;align-items:center;gap:8px;";let a=document.createElement("button");a.type="button",a.textContent="Retry render",a.style.cssText="padding:6px 12px;border-radius:6px;border:1px solid rgba(59,130,246,0.4);background:rgba(37,99,235,0.18);color:#bfdbfe;font-size:12px;font-weight:600;cursor:pointer",a.addEventListener("click",()=>this.requestRecovery());let l=document.createElement("button");l.type="button",l.textContent="Clear",l.style.cssText="padding:6px 12px;border-radius:6px;border:1px solid rgba(34,197,94,0.45);background:rgba(34,197,94,0.18);color:#bbf7d0;font-size:12px;font-weight:600;cursor:pointer",l.addEventListener("click",()=>this.clearDiagnostics());let c=document.createElement("button");c.type="button",c.textContent="Close",c.style.cssText="padding:6px 12px;border-radius:6px;border:1px solid rgba(248,113,113,0.4);background:rgba(248,113,113,0.18);color:#fecaca;font-size:12px;font-weight:600;cursor:pointer",c.addEventListener("click",()=>this.hideErrorOverlay()),o.appendChild(a),o.appendChild(l),o.appendChild(c),i.appendChild(s),i.appendChild(o);let h=document.createElement("div");h.style.cssText="padding:16px 24px 24px;display:flex;flex-direction:column;gap:16px;",t.appendChild(i),t.appendChild(h),e.appendChild(t),document.body.appendChild(e),this.errorOverlay=e,this.errorListEl=h}renderErrorOverlay(){if(!this.options.debug||typeof document>"u"||(this.ensureErrorOverlayElements(),!this.errorOverlay||!this.errorListEl))return;let e=this.errorListEl;if(e.innerHTML="",0===this.diagnostics.length){let t=document.createElement("div");t.textContent="No runtime errors captured yet.",t.style.cssText="font-size:14px;color:#94a3b8;",e.appendChild(t)}else{let t=[...this.diagnostics].sort((e,t)=>t.timestamp-e.timestamp);for(let i of t)e.appendChild(this.createDiagnosticElement(i))}this.errorOverlay.style.display="flex",this.errorOverlayVisible=!0}createDiagnosticElement(e){let t=document.createElement("article");t.style.cssText="background:rgba(15,23,42,0.65);border:1px solid rgba(148,163,184,0.25);border-radius:12px;padding:18px 20px;display:flex;flex-direction:column;gap:12px";let i=document.createElement("div");i.style.cssText="display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px;";let n=document.createElement("h3");n.textContent=e.message||"Runtime panic recovered",n.style.cssText="margin:0;font-size:16px;font-weight:700;color:#f8fafc;";let s=document.createElement("div");s.style.cssText="display:flex;align-items:center;gap:8px;";let r=document.createElement("span");r.textContent=e.code||"runtime_panic",r.style.cssText="font-size:11px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;background:rgba(37,99,235,0.18);color:#bfdbfe;border:1px solid rgba(37,99,235,0.35);border-radius:9999px;padding:4px 10px";let o=document.createElement("time"),a=e.details?.capturedAt?new Date(e.details.capturedAt):new Date(e.timestamp);Number.isNaN(a.getTime())?o.textContent=new Date(e.timestamp).toLocaleString():(o.dateTime=a.toISOString(),o.textContent=a.toLocaleString()),o.style.cssText="font-size:12px;color:#94a3b8;",s.appendChild(r),s.appendChild(o),i.appendChild(n),i.appendChild(s),t.appendChild(i);let l=e.details,c=document.createElement("div");c.style.cssText="display:flex;flex-direction:column;gap:4px;font-size:12px;color:#cbd5f5;";let h=l?.componentName&&l.componentId?`${l.componentName} (${l.componentId})`:l?.componentName??l?.componentId??"";if(this.appendMeta(c,"Component",h),this.appendMeta(c,"Phase",l?.phase),l?.hook){let e=null!=l.hookIndex?`${l.hook} (#${l.hookIndex})`:l.hook;this.appendMeta(c,"Hook",e)}if(this.appendMeta(c,"Panic",l?.panic),c.childNodes.length>0&&t.appendChild(c),l?.suggestion){let e=document.createElement("p");e.textContent=l.suggestion,e.style.cssText="margin:0;padding:12px 14px;border-radius:8px;background:rgba(34,197,94,0.12);color:#bbf7d0;font-size:13px;border-left:3px solid rgba(34,197,94,0.45);",t.appendChild(e)}let d=l?.metadata;if(d&&Object.keys(d).length>0){let e=document.createElement("dl");e.style.cssText="display:grid;grid-template-columns:max-content 1fr;gap:4px 12px;padding:12px;border-radius:8px;background:rgba(15,23,42,0.5);";for(let[t,i]of Object.entries(d)){let n=document.createElement("dt");n.textContent=t,n.style.cssText="font-weight:600;color:#e2e8f0;";let s=document.createElement("dd");s.textContent=this.formatMetadataValue(i),s.style.cssText="margin:0;white-space:pre-wrap;color:#cbd5f5;",e.appendChild(n),e.appendChild(s)}t.appendChild(e)}if(l?.stack){let e=document.createElement("pre");e.textContent=l.stack.trim(),e.style.cssText="margin:0;padding:12px;border-radius:8px;background:#020617;color:#f1f5f9;max-height:220px;overflow:auto;font-size:12px;line-height:1.45;",t.appendChild(e)}return t}appendMeta(e,t,i){if(!i)return;let n=document.createElement("div");n.style.cssText="display:flex;gap:6px;align-items:flex-start;";let s=document.createElement("span");s.textContent=t+":",s.style.cssText="font-weight:600;min-width:88px;color:#e2e8f0;";let r=document.createElement("span");r.textContent=i,r.style.cssText="flex:1;",n.appendChild(s),n.appendChild(r),e.appendChild(n)}formatMetadataValue(e){if(null==e)return"null";if("string"==typeof e)return e;if("number"==typeof e||"boolean"==typeof e)return e+"";try{return JSON.stringify(e,null,2)}catch{return e+""}}hideErrorOverlay(){this.errorOverlay&&(this.errorOverlay.style.display="none",this.errorOverlayVisible=!1)}clearDiagnostics(){this.diagnostics=[],this.errorListEl&&(this.errorListEl.innerHTML=""),this.hideErrorOverlay()}requestRecovery(){let e=this.sessionId.get();e&&this.channel?(this.log("Requesting runtime recovery"),this.channel.sendMessage("recover",{t:"recover",sid:e})):this.log("Cannot request recovery without active session/channel")}onDebugKeydown(e){if(this.options.debug){if("Escape"===e.key&&this.errorOverlayVisible)return void this.hideErrorOverlay();("e"===e.key||"E"===e.key)&&e.shiftKey&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),this.renderErrorOverlay())}}sendEvent(e){if("connected"!==this.connectionState.get().status||!this.channel)return this.log("Not connected, queueing event"),void this.eventQueue.push(e);let t={t:"evt",sid:this.sessionId.get(),hid:e.hid,payload:e.payload};this.log("Sending event:",t),this.channel.sendMessage("evt",t),this.metrics.eventsProcessed++}sendNavigation(e,t,i){if("connected"!==this.connectionState.get().status||!this.channel)return this.log("Not connected, cannot navigate"),!1;let n={t:"nav",sid:this.sessionId.get(),path:e,q:t,hash:i};this.log("Sending navigation:",n),this.channel.sendMessage("nav",n);let s=t?"?"+t:"",r=i?"#"+i:"";return window.history.pushState({},"",`${e}${s}${r}`),this.lastOptimisticNavTime=Date.now(),!0}sendAck(e){if(!this.channel)return;let t={t:"ack",sid:this.sessionId.get(),seq:e};this.channel.sendMessage("ack",t),"number"==typeof e&&e>this.lastAck&&(this.lastAck=e)}flushEventQueue(){if(0===this.eventQueue.length)return;this.log("Flushing",this.eventQueue.length,"queued events");let e=this.eventQueue;this.eventQueue=[];for(let t of e)this.sendEvent(t)}log(...e){this.options.debug}},Ae=null;function xe({force:e=!1}={}){let t=typeof window>"u"?null:window;return t?(e&&(Ae=null),Ae||(Ae=function(e){return new Promise((t,i)=>{let n=()=>{try{let i=function(e){let t={...e.__LIVEUI_OPTIONS__??{}},i=function(e){let t=e.__LIVEUI_BOOT__;if(t&&"object"==typeof t&&"string"==typeof t.sid)return t;if(typeof document>"u")return null;let i=document.getElementById("liveui-boot")?.textContent;if(!i)return null;try{let t=JSON.parse(i);return e.__LIVEUI_BOOT__=t,t}catch{return null}}(e),n=t.boot,s=i??n??null,r=!1!==t.autoConnect,o={...t,autoConnect:!1};s&&(o.boot=s,i||(e.__LIVEUI_BOOT__=s));let a=new Ce(o);return function(e,t){let i=Ce;Object.assign(i,{instance:t,dom:k,applyOps:ie,patcher:{configure:ne,getConfig:se,clearCaches:re,getStats:oe,morphElement:Y},boot:xe}),e.LiveUI=i,e.LiveUIInstance=t,e.__LIVEUI_DEVTOOLS__&&(e.__LIVEUI_DEVTOOLS__.installed=!0,e.__LIVEUI_DEVTOOLS__.instance=t)}(e,a),r&&s&&a.connect().catch(e=>{}),a}(e);t(i)}catch(e){i(e)}};if(typeof document<"u"&&"loading"===document.readyState){let e=()=>{document.removeEventListener("DOMContentLoaded",e),n()};document.addEventListener("DOMContentLoaded",e)}else n()})}(t)),Ae):Promise.reject(Error("LiveUI: window is not available for bootstrapping."))}return typeof window<"u"&&xe().catch(()=>{}),(e=>l(t({},"__esModule",{value:!0}),e))(N)})();"undefined"!=typeof window&&(window.LiveUI=e.default,window.LiveUI.dom=e.dom,window.LiveUI.applyOps=e.applyOps);