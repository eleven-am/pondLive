// LiveUI Client v1.0.0
"use strict";(()=>{function e(e){return"script:"+e}function t(e){return"object"==typeof e&&null!==e&&"boot"===e.t}function i(e){return"object"==typeof e&&null!==e&&"error"===e.t}function n(e){return"object"==typeof e&&null!==e&&"string"==typeof e.t&&"string"==typeof e.a}function s(e){return"object"==typeof e&&null!==e&&"ack"===e.t&&"number"==typeof e.seq}function r(e){return"object"==typeof e&&null!==e&&"number"==typeof e.seq&&"string"==typeof e.topic&&"string"==typeof e.event}function o(){if(typeof window>"u")return null;let e=document.getElementById("live-boot"),i=null;if(e?.textContent)try{i=JSON.parse(e.textContent)}catch{f.error("Runtime","Failed to parse boot payload")}if(i||(i=window.__LIVEUI_BOOT__??null),!i||!t(i))return f.error("Runtime","No boot payload found"),null;let n={root:document.documentElement,sessionId:i.sid,version:i.ver,seq:i.seq,endpoint:"/live",location:i.location,debug:i.client?.debug},s=new b(n);return s.handleBoot(i),s.connect(),s}var h,a,c,l,u,f,d,p,w,m,v,b,y,g,S=Object.create,E=Object.defineProperty,O=Object.getOwnPropertyDescriptor,M=Object.getOwnPropertyNames,C=Object.getPrototypeOf,T={}.hasOwnProperty,k=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),N=(e,t,i,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let s of M(t))!T.call(e,s)&&s!==i&&E(e,s,{get:()=>t[s],enumerable:!(n=O(t,s))||n.enumerable});return e},R=k(e=>{var t,i,n=e&&e.i||function(e,t,i,n,s){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,i):s?s.value=i:t.set(e,i),i},s=e&&e.o||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"h",{value:1}),e.Subject=void 0,e.Subject=class{constructor(){t.set(this,void 0),i.set(this,void 0),n(this,t,0,"f"),n(this,i,new Set,"f")}get size(){return s(this,i,"f").size}subscribe(e){if(s(this,t,"f"))throw Error("Cannot subscribe to a closed subject");return s(this,i,"f").add(e),()=>s(this,i,"f").delete(e)}publish(e){s(this,i,"f").forEach(t=>t(e))}close(){s(this,i,"f").clear(),n(this,t,1,"f")}},t=new WeakMap,i=new WeakMap}),I=k(e=>{var t,i,n=e&&e.i||function(e,t,i,n,s){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,i):s?s.value=i:t.set(e,i),i},s=e&&e.o||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"h",{value:1}),e.BehaviorSubject=void 0,i=R(),e.BehaviorSubject=class extends i.Subject{constructor(e){super(),t.set(this,void 0),n(this,t,e,"f")}get value(){return s(this,t,"f")}publish(e){n(this,t,e,"f"),super.publish(e)}subscribe(e){return s(this,t,"f")&&e(s(this,t,"f")),super.subscribe(e)}},t=new WeakMap}),j=k(e=>{var t=e&&e.l||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);(!s||("get"in s?!t.h:s.writable||s.configurable))&&(s={enumerable:1,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.u||function(e,i){for(var n in e)"default"!==n&&!{}.hasOwnProperty.call(i,n)&&t(i,e,n)};Object.defineProperty(e,"h",{value:1}),i(I(),e),i(R(),e)}),x=k(e=>{var t,i,n,s,r,o,h,a,c,l;Object.defineProperty(e,"h",{value:1}),e.PubSubEvents=e.Events=e.ChannelReceiver=e.SystemSender=e.ErrorTypes=e.ChannelState=e.ClientActions=e.ServerActions=e.PresenceEventTypes=void 0,(l=t||(e.PresenceEventTypes=t={})).JOIN="JOIN",l.LEAVE="LEAVE",l.UPDATE="UPDATE",function(e){e.PRESENCE="PRESENCE",e.SYSTEM="SYSTEM",e.BROADCAST="BROADCAST",e.ERROR="ERROR",e.CONNECT="CONNECT"}(i||(e.ServerActions=i={})),function(e){e.JOIN_CHANNEL="JOIN_CHANNEL",e.LEAVE_CHANNEL="LEAVE_CHANNEL",e.BROADCAST="BROADCAST"}(n||(e.ClientActions=n={})),function(e){e.IDLE="IDLE",e.JOINING="JOINING",e.JOINED="JOINED",e.STALLED="STALLED",e.CLOSED="CLOSED"}(s||(e.ChannelState=s={})),function(e){e.UNAUTHORIZED_CONNECTION="UNAUTHORIZED_CONNECTION",e.UNAUTHORIZED_JOIN_REQUEST="UNAUTHORIZED_JOIN_REQUEST",e.UNAUTHORIZED_BROADCAST="UNAUTHORIZED_BROADCAST",e.INVALID_MESSAGE="INVALID_MESSAGE",e.HANDLER_NOT_FOUND="HANDLER_NOT_FOUND",e.PRESENCE_ERROR="PRESENCE_ERROR",e.CHANNEL_ERROR="CHANNEL_ERROR",e.ENDPOINT_ERROR="ENDPOINT_ERROR",e.INTERNAL_SERVER_ERROR="INTERNAL_SERVER_ERROR"}(r||(e.ErrorTypes=r={})),function(e){e.ENDPOINT="ENDPOINT",e.CHANNEL="CHANNEL"}(o||(e.SystemSender=o={})),function(e){e.ALL_USERS="ALL_USERS",e.ALL_EXCEPT_SENDER="ALL_EXCEPT_SENDER"}(h||(e.ChannelReceiver=h={})),function(e){e.ACKNOWLEDGE="ACKNOWLEDGE",e.CONNECTION="CONNECTION"}(a||(e.Events=a={})),function(e){e.MESSAGE="MESSAGE",e.PRESENCE="PRESENCE",e.GET_PRESENCE="GET_PRESENCE"}(c||(e.PubSubEvents=c={}))}),_=k(e=>{Object.defineProperty(e,"h",{value:1}),e.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}}),D=k(e=>{Object.defineProperty(e,"h",{value:1})}),A=k(e=>{var t=e&&e.l||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);(!s||("get"in s?!t.h:s.writable||s.configurable))&&(s={enumerable:1,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.u||function(e,i){for(var n in e)"default"!==n&&!{}.hasOwnProperty.call(i,n)&&t(i,e,n)};Object.defineProperty(e,"h",{value:1}),i(_(),e),i(D(),e)}),q=k(e=>{function t(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}function i(e,t){if(!function(e){return"string"==typeof e}(e))throw new h("Expected string, got "+typeof e,t)}function n(e,i){if(!t(e))throw new h("Expected object, got "+typeof e,i)}function s(e,i){if(!function(e){return t(e)?Object.keys(e).every(e=>"string"==typeof e):0}(e))throw new h("Expected record with string keys, got "+typeof e,i)}function r(e,t,i){let n=Object.values(t);if(!n.includes(e))throw new h(`Expected one of [${n.join(", ")}], got ${JSON.stringify(e)}`,i)}Object.defineProperty(e,"h",{value:1}),e.channelEventSchema=e.serverMessageSchema=e.presenceMessageSchema=e.clientMessageSchema=e.ValidationError=void 0;var o=x(),h=class extends Error{constructor(e,t){super(t?`${t}: ${e}`:e),this.path=t,this.name="ValidationError"}};e.ValidationError=h,e.clientMessageSchema={parse(e){n(e,"clientMessage");let t=e;if(!("event"in t))throw new h("Missing required field","event");if(!("requestId"in t))throw new h("Missing required field","requestId");if(!("channelName"in t))throw new h("Missing required field","channelName");if(!("payload"in t))throw new h("Missing required field","payload");if(!("action"in t))throw new h("Missing required field","action");return i(t.event,"event"),i(t.requestId,"requestId"),i(t.channelName,"channelName"),s(t.payload,"payload"),r(t.action,o.ClientActions,"action"),{event:t.event,requestId:t.requestId,channelName:t.channelName,payload:t.payload,action:t.action}}},e.presenceMessageSchema={parse(e){n(e,"presenceMessage");let t=e;if(!("requestId"in t))throw new h("Missing required field","requestId");if(!("channelName"in t))throw new h("Missing required field","channelName");if(!("event"in t))throw new h("Missing required field","event");if(!("action"in t))throw new h("Missing required field","action");if(!("payload"in t))throw new h("Missing required field","payload");if(i(t.requestId,"requestId"),i(t.channelName,"channelName"),r(t.event,o.PresenceEventTypes,"event"),t.action!==o.ServerActions.PRESENCE)throw new h(`Expected ${o.ServerActions.PRESENCE}, got ${JSON.stringify(t.action)}`,"action");n(t.payload,"payload");let a=t.payload;if(!("presence"in a))throw new h("Missing required field","payload.presence");if(!("changed"in a))throw new h("Missing required field","payload.changed");return function(e){if(!function(e){return Array.isArray(e)}(e))throw new h("Expected array, got "+typeof e,"payload.presence")}(a.presence),a.presence.forEach((e,t)=>{s(e,`payload.presence[${t}]`)}),s(a.changed,"payload.changed"),{requestId:t.requestId,channelName:t.channelName,event:t.event,action:o.ServerActions.PRESENCE,payload:{presence:a.presence,changed:a.changed}}}},e.serverMessageSchema={parse(e){n(e,"serverMessage");let t=e;if(!("event"in t))throw new h("Missing required field","event");if(!("requestId"in t))throw new h("Missing required field","requestId");if(!("channelName"in t))throw new h("Missing required field","channelName");if(!("payload"in t))throw new h("Missing required field","payload");if(!("action"in t))throw new h("Missing required field","action");i(t.event,"event"),i(t.requestId,"requestId"),i(t.channelName,"channelName"),s(t.payload,"payload");let r=[o.ServerActions.BROADCAST,o.ServerActions.CONNECT,o.ServerActions.ERROR,o.ServerActions.SYSTEM];if(!r.includes(t.action))throw new h(`Expected one of [${r.join(", ")}], got ${JSON.stringify(t.action)}`,"action");return{event:t.event,requestId:t.requestId,channelName:t.channelName,payload:t.payload,action:t.action}}},e.channelEventSchema={parse(t){n(t,"channelEvent");let i=t;if(!("action"in i))throw new h("Missing required field","action");return i.action===o.ServerActions.PRESENCE?e.presenceMessageSchema.parse(t):e.serverMessageSchema.parse(t)}}}),P=k(e=>{var t=e&&e.l||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);(!s||("get"in s?!t.h:s.writable||s.configurable))&&(s={enumerable:1,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.u||function(e,i){for(var n in e)"default"!==n&&!{}.hasOwnProperty.call(i,n)&&t(i,e,n)};Object.defineProperty(e,"h",{value:1}),i(j(),e),i(x(),e),i(A(),e),i(q(),e)}),L=k(e=>{var t,i;Object.defineProperty(e,"h",{value:1}),e.ConnectionState=void 0,(i=t||(e.ConnectionState=t={})).DISCONNECTED="disconnected",i.CONNECTING="connecting",i.CONNECTED="connected"}),W=k(e=>{var t,i,n,s,r,o,h,a,c,l,u,f,d,p,w,m,v,b=e&&e.i||function(e,t,i,n,s){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,i):s?s.value=i:t.set(e,i),i},y=e&&e.o||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"h",{value:1}),e.Channel=void 0,m=P(),v=L(),e.Channel=class{constructor(e,u,f,d){t.add(this),i.set(this,void 0),n.set(this,void 0),s.set(this,void 0),r.set(this,void 0),o.set(this,void 0),h.set(this,void 0),a.set(this,void 0),c.set(this,void 0),l.set(this,void 0),b(this,i,f,"f"),b(this,n,[],"f"),b(this,s,[],"f"),b(this,h,d,"f"),b(this,o,e,"f"),b(this,c,u,"f"),b(this,a,new m.Subject,"f"),b(this,l,new m.BehaviorSubject(m.ChannelState.IDLE),"f"),b(this,r,()=>{},"f")}get channelState(){return y(this,l,"f").value}get presence(){return y(this,s,"f")}acknowledge(e){y(this,l,"f").publish(m.ChannelState.JOINED),y(this,t,"m",f).call(this,e),y(this,t,"m",u).call(this)}join(){let e={action:m.ClientActions.JOIN_CHANNEL,event:m.ClientActions.JOIN_CHANNEL,payload:y(this,h,"f"),channelName:y(this,i,"f"),requestId:(0,m.uuid)()};if(y(this,l,"f").value!==m.ChannelState.JOINED)if(y(this,l,"f").publish(m.ChannelState.JOINING),y(this,c,"f").value===v.ConnectionState.CONNECTED)y(this,o,"f").call(this,e);else{let t=y(this,c,"f").subscribe(i=>{i===v.ConnectionState.CONNECTED&&(t(),y(this,l,"f").value===m.ChannelState.JOINING&&y(this,o,"f").call(this,e))})}}leave(){let e={action:m.ClientActions.LEAVE_CHANNEL,event:m.ClientActions.LEAVE_CHANNEL,channelName:y(this,i,"f"),requestId:(0,m.uuid)(),payload:{}};y(this,t,"m",p).call(this,e),y(this,l,"f").publish(m.ChannelState.CLOSED),y(this,r,"f").call(this)}onChannelStateChange(e){return y(this,l,"f").subscribe(t=>{e(t)})}onJoin(e){return y(this,t,"m",w).call(this,(t,i)=>{if(t===m.PresenceEventTypes.JOIN)return e(i.changed)})}onLeave(e){return y(this,t,"m",w).call(this,(t,i)=>{if(t===m.PresenceEventTypes.LEAVE)return e(i.changed)})}onMessage(e){return y(this,t,"m",d).call(this,(t,i)=>{e(t,i)})}onMessageEvent(e,t){return this.onMessage((i,n)=>{if(i===e)return t(n)})}onPresenceChange(e){return y(this,t,"m",w).call(this,(t,i)=>{if(t===m.PresenceEventTypes.UPDATE)return e(i)})}onUsersChange(e){return y(this,t,"m",w).call(this,(t,i)=>e(i.presence))}sendMessage(e,n){let s=(0,m.uuid)(),r={action:m.ClientActions.BROADCAST,channelName:y(this,i,"f"),requestId:s,event:e,payload:n};y(this,t,"m",p).call(this,r)}sendForResponse(e,n){let s=(0,m.uuid)();return new Promise(r=>{let o=y(this,t,"m",d).call(this,(e,t,i)=>{s===i&&(r(t),o())}),h={action:m.ClientActions.BROADCAST,channelName:y(this,i,"f"),requestId:s,event:e,payload:n};y(this,t,"m",p).call(this,h)})}},i=new WeakMap,n=new WeakMap,s=new WeakMap,r=new WeakMap,o=new WeakMap,h=new WeakMap,a=new WeakMap,c=new WeakMap,l=new WeakMap,t=new WeakSet,u=function(){y(this,n,"f").forEach(e=>y(this,o,"f").call(this,e)),b(this,n,[],"f")},f=function(e){y(this,r,"f").call(this);let n=e.subscribe(e=>{e.channelName===y(this,i,"f")&&this.channelState===m.ChannelState.JOINED&&y(this,a,"f").publish(e)}),u=y(this,c,"f").subscribe(e=>{if(e===v.ConnectionState.CONNECTED&&y(this,l,"f").value===m.ChannelState.STALLED){let e={action:m.ClientActions.JOIN_CHANNEL,event:m.ClientActions.JOIN_CHANNEL,payload:y(this,h,"f"),channelName:y(this,i,"f"),requestId:(0,m.uuid)()};y(this,o,"f").call(this,e)}else e!==v.ConnectionState.CONNECTED&&y(this,l,"f").value===m.ChannelState.JOINED&&y(this,l,"f").publish(m.ChannelState.STALLED)}),f=y(this,t,"m",w).call(this,(e,t)=>{b(this,s,t.presence,"f")});b(this,r,()=>{n(),u(),f()},"f")},d=function(e){return y(this,a,"f").subscribe(t=>{if(t.action!==m.ServerActions.PRESENCE)return e(t.event,t.payload,t.requestId)})},p=function(e){if(y(this,l,"f").value===m.ChannelState.JOINED)return y(this,o,"f").call(this,e);y(this,n,"f").push(e)},w=function(e){return y(this,a,"f").subscribe(t=>{if(t.action===m.ServerActions.PRESENCE)return e(t.event,t.payload)})}}),$=k(e=>{var t,i,n,s,r,o,h,a,c,l=e&&e.i||function(e,t,i,n,s){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,i):s?s.value=i:t.set(e,i),i},u=e&&e.o||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"h",{value:1}),e.PondClient=void 0,h=P(),a=W(),c=L(),e.PondClient=class{constructor(e,n={},s={}){var r,a;let f;t.add(this),i.set(this,void 0);try{f=new URL(e)}catch{f=new URL(""+window.location),f.pathname=e}this.m=0,this.v=0;let d=new URLSearchParams(n);f.search=""+d,"wss:"!==f.protocol&&"ws:"!==f.protocol&&(f.protocol="https:"===f.protocol?"wss:":"ws:"),this.S=f,this.O={connectionTimeout:null!==(r=s.connectionTimeout)&&void 0!==r?r:1e4,maxReconnectDelay:null!==(a=s.maxReconnectDelay)&&void 0!==a?a:3e4,pingInterval:s.pingInterval},l(this,i,new Map,"f"),this.M=new h.Subject,this.C=new h.BehaviorSubject(c.ConnectionState.DISCONNECTED),this.T=new h.Subject,u(this,t,"m",o).call(this)}connect(){this.m=0,this.C.publish(c.ConnectionState.CONNECTING);let e=new WebSocket(""+this.S);this.k=setTimeout(()=>{e.readyState===WebSocket.CONNECTING&&(this.T.publish(Error("Connection timeout")),e.close())},this.O.connectionTimeout),e.onopen=()=>{u(this,t,"m",n).call(this),this.v=0,this.O.pingInterval&&(this.N=setInterval(()=>{e.readyState===WebSocket.OPEN&&e.send(JSON.stringify({action:"ping"}))},this.O.pingInterval))},e.onmessage=e=>{let t=e.data.trim().split("\n");for(let e of t)if(e.trim()){let t=JSON.parse(e),i=h.channelEventSchema.parse(t);this.M.publish(i)}},e.onerror=()=>{this.T.publish(Error("WebSocket error")),e.close()},e.onclose=()=>{if(u(this,t,"m",n).call(this),this.C.publish(c.ConnectionState.DISCONNECTED),this.m)return;let e=Math.min(1e3*Math.pow(2,this.v),this.O.maxReconnectDelay);this.v++,setTimeout(()=>{this.connect()},e)},this.R=e}getState(){return this.C.value}disconnect(){var e;u(this,t,"m",n).call(this),this.m=1,this.C.publish(c.ConnectionState.DISCONNECTED),null===(e=this.R)||void 0===e||e.close(),u(this,i,"f").clear()}createChannel(e,n){let r=u(this,i,"f").get(e);if(r&&r.channelState!==h.ChannelState.CLOSED)return r;let o=u(this,t,"m",s).call(this),c=new a.Channel(o,this.C,e,n||{});return u(this,i,"f").set(e,c),c}onConnectionChange(e){return this.C.subscribe(e)}onError(e){return this.T.subscribe(e)}},i=new WeakMap,t=new WeakSet,n=function(){this.k&&(clearTimeout(this.k),this.k=void 0),this.N&&(clearInterval(this.N),this.N=void 0)},s=function(){return e=>{this.C.value===c.ConnectionState.CONNECTED&&this.R.send(JSON.stringify(e))}},r=function(e){var n;let r=null!==(n=u(this,i,"f").get(e.channelName))&&void 0!==n?n:new a.Channel(u(this,t,"m",s).call(this),this.C,e.channelName,{});u(this,i,"f").set(e.channelName,r),r.acknowledge(this.M)},o=function(){this.M.subscribe(e=>{e.event===h.Events.ACKNOWLEDGE?u(this,t,"m",r).call(this,e):e.event===h.Events.CONNECTION&&e.action===h.ServerActions.CONNECT&&this.C.publish(c.ConnectionState.CONNECTED)})}}),H=k(e=>{var t,i,n,s,r,o,h,a,c,l,u=e&&e.i||function(e,t,i,n,s){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,i):s?s.value=i:t.set(e,i),i},f=e&&e.o||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"h",{value:1}),e.SSEClient=void 0,a=P(),c=W(),l=L(),e.SSEClient=class{constructor(e,n={},s={}){var r,o;let c;t.add(this),i.set(this,void 0);try{c=new URL(e)}catch{c=new URL(""+window.location),c.pathname=e}this.m=0,this.v=0;let d=new URLSearchParams(n);c.search=""+d,"https:"!==c.protocol&&"http:"!==c.protocol&&(c.protocol=window.location.protocol),this.S=c,this.I=new URL(""+c),this.O={connectionTimeout:null!==(r=s.connectionTimeout)&&void 0!==r?r:1e4,maxReconnectDelay:null!==(o=s.maxReconnectDelay)&&void 0!==o?o:3e4,pingInterval:s.pingInterval,withCredentials:s.withCredentials},u(this,i,new Map,"f"),this.M=new a.Subject,this.C=new a.BehaviorSubject(l.ConnectionState.DISCONNECTED),this.T=new a.Subject,f(this,t,"m",h).call(this)}connect(){var e;this.m=0,this.C.publish(l.ConnectionState.CONNECTING);let i=new EventSource(""+this.S,{withCredentials:null!==(e=this.O.withCredentials)&&void 0!==e?e:0});this.k=setTimeout(()=>{i.readyState===EventSource.CONNECTING&&(this.T.publish(Error("Connection timeout")),i.close())},this.O.connectionTimeout),i.onopen=()=>{f(this,t,"m",s).call(this),this.v=0},i.onmessage=e=>{f(this,t,"m",n).call(this,e.data)},i.onerror=()=>{if(this.T.publish(Error("SSE connection error")),i.close(),f(this,t,"m",s).call(this),this.C.publish(l.ConnectionState.DISCONNECTED),this.m)return;let e=Math.min(1e3*Math.pow(2,this.v),this.O.maxReconnectDelay);this.v++,setTimeout(()=>{this.connect()},e)},this.j=i}getState(){return this.C.value}getConnectionId(){return this._}disconnect(){var e;f(this,t,"m",s).call(this),this.m=1,this.C.publish(l.ConnectionState.DISCONNECTED),this._&&fetch(""+this.I,{method:"DELETE",headers:{"X-Connection-ID":this._},credentials:this.O.withCredentials?"include":"same-origin"}).catch(()=>{}),null===(e=this.j)||void 0===e||e.close(),this._=void 0,f(this,i,"f").clear()}createChannel(e,n){let s=f(this,i,"f").get(e);if(s&&s.channelState!==a.ChannelState.CLOSED)return s;let o=f(this,t,"m",r).call(this),h=new c.Channel(o,this.C,e,n||{});return f(this,i,"f").set(e,h),h}onConnectionChange(e){return this.C.subscribe(e)}onError(e){return this.T.subscribe(e)}},i=new WeakMap,t=new WeakSet,n=function(e){try{let t=e.trim().split("\n");for(let e of t)if(e.trim()){let t=JSON.parse(e),i=a.channelEventSchema.parse(t);i.event===a.Events.CONNECTION&&i.action===a.ServerActions.CONNECT&&i.payload&&"object"==typeof i.payload&&"connectionId"in i.payload&&(this._=i.payload.connectionId),this.M.publish(i)}}catch(e){this.T.publish(e instanceof Error?e:Error("Failed to parse SSE message"))}},s=function(){this.k&&(clearTimeout(this.k),this.k=void 0)},r=function(){return e=>{this.C.value===l.ConnectionState.CONNECTED&&this._&&fetch(""+this.I,{method:"POST",headers:{"Content-Type":"application/json","X-Connection-ID":this._},body:JSON.stringify(e),credentials:this.O.withCredentials?"include":"same-origin"}).catch(e=>{this.T.publish(e instanceof Error?e:Error("Failed to send message"))})}},o=function(e){var n;let s=null!==(n=f(this,i,"f").get(e.channelName))&&void 0!==n?n:new c.Channel(f(this,t,"m",r).call(this),this.C,e.channelName,{});f(this,i,"f").set(e.channelName,s),s.acknowledge(this.M)},h=function(){this.M.subscribe(e=>{e.event===a.Events.ACKNOWLEDGE?f(this,t,"m",o).call(this,e):e.event===a.Events.CONNECTION&&e.action===a.ServerActions.CONNECT&&this.C.publish(l.ConnectionState.CONNECTED)})}}),J=k((e,t)=>{var i=function(){if("object"==typeof self&&self)return self;if("object"==typeof window&&window)return window;throw Error("Unable to resolve global `this`")};t.exports=function(){if(this)return this;if("object"==typeof globalThis&&globalThis)return globalThis;try{Object.defineProperty(Object.prototype,"D",{get:function(){return this},configurable:1})}catch{return i()}try{return __global__||i()}finally{delete Object.prototype.D}}()}),U=k((e,t)=>{t.exports={name:"websocket",description:"Websocket Client & Server Library implementing the WebSocket protocol as specified in RFC 6455.",keywords:["websocket","websockets","socket","networking","comet","push","RFC-6455","realtime","server","client"],author:"Brian McKelvey <theturtle32@gmail.com> (https://github.com/theturtle32)",contributors:["IÃ±aki Baz Castillo <ibc@aliax.net> (http://dev.sipdoc.net)"],version:"1.0.35",repository:{type:"git",url:"https://github.com/theturtle32/WebSocket-Node.git"},homepage:"https://github.com/theturtle32/WebSocket-Node",engines:{node:">=4.0.0"},dependencies:{bufferutil:"^4.0.1",debug:"^2.2.0","es5-ext":"^0.10.63","typedarray-to-buffer":"^3.1.5","utf-8-validate":"^5.0.2",yaeti:"^0.0.6"},devDependencies:{"buffer-equal":"^1.0.0",gulp:"^4.0.2","gulp-jshint":"^2.0.4","jshint-stylish":"^2.2.1",jshint:"^2.0.0",tape:"^4.9.1"},config:{verbose:0},scripts:{test:"tape test/unit/*.js",gulp:"gulp"},main:"index",directories:{lib:"./lib"},browser:"lib/browser.js",license:"Apache-2.0"}}),B=k((e,t)=>{t.exports=U().version}),F=k((e,t)=>{function i(e,t){return t?new s(e,t):new s(e)}var n,s,r;if("object"==typeof globalThis)n=globalThis;else try{n=J()}catch{}finally{if(!n&&"u">typeof window&&(n=window),!n)throw Error("Could not determine global this")}s=n.WebSocket||n.MozWebSocket,r=B(),s&&["CONNECTING","OPEN","CLOSING","CLOSED"].forEach(function(e){Object.defineProperty(i,e,{get:function(){return s[e]}})}),t.exports={w3cwebsocket:s?i:null,version:r}}),G=k(e=>{var t,i,n,s,r,o,h=e&&e.o||function(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)};Object.defineProperty(e,"h",{value:1}),e.PondClient=void 0,n=P(),s=$(),r=L(),o=F().w3cwebsocket,e.PondClient=class extends s.PondClient{constructor(){super(...arguments),t.add(this)}connect(){this.m=0,this.C.publish(r.ConnectionState.CONNECTING);let e=new o(""+this.S);this.k=setTimeout(()=>{e.readyState===o.CONNECTING&&(this.T.publish(Error("Connection timeout")),e.close())},this.O.connectionTimeout),e.onopen=()=>{h(this,t,"m",i).call(this),this.v=0,this.O.pingInterval&&(this.N=setInterval(()=>{e.readyState===o.OPEN&&e.send(JSON.stringify({action:"ping"}))},this.O.pingInterval))},e.onmessage=e=>{let t=e.data.trim().split("\n");for(let e of t)if(e.trim()){let t=JSON.parse(e),i=n.channelEventSchema.parse(t);this.M.publish(i)}},e.onerror=()=>{this.T.publish(Error("WebSocket error")),e.close()},e.onclose=()=>{if(h(this,t,"m",i).call(this),this.C.publish(r.ConnectionState.DISCONNECTED),this.m)return;let e=Math.min(1e3*Math.pow(2,this.v),this.O.maxReconnectDelay);this.v++,setTimeout(()=>{this.connect()},e)},this.R=e}},t=new WeakSet,i=function(){this.k&&(clearTimeout(this.k),this.k=void 0),this.N&&(clearInterval(this.N),this.N=void 0)}}),V=k(e=>{var t,i,n,s,r,o;Object.defineProperty(e,"h",{value:1}),e.SSEClient=e.PondClient=e.ConnectionState=e.ChannelState=void 0,t=P(),Object.defineProperty(e,"ChannelState",{enumerable:1,get:function(){return t.ChannelState}}),i=$(),n=H(),Object.defineProperty(e,"SSEClient",{enumerable:1,get:function(){return n.SSEClient}}),s=G(),r=L(),Object.defineProperty(e,"ConnectionState",{enumerable:1,get:function(){return r.ConnectionState}}),o=typeof window>"u"?s.PondClient:i.PondClient,e.PondClient=o}),z={};((e,t)=>{for(var i in t)E(e,i,{get:t[i],enumerable:1})})(z,{Bus:()=>c,Executor:()=>m,Logger:()=>f,OpKinds:()=>a,Patcher:()=>w,Runtime:()=>b,ScriptExecutor:()=>v,Topics:()=>h,Transport:()=>d,boot:()=>o,isBoot:()=>t,isMessage:()=>r,isServerAck:()=>s,isServerError:()=>i,isServerEvt:()=>n}),h={Router:"router",DOM:"dom",Frame:"frame",Ack:"ack"},a={SetText:"setText",SetComment:"setComment",SetAttr:"setAttr",DelAttr:"delAttr",SetStyle:"setStyle",DelStyle:"delStyle",SetStyleDecl:"setStyleDecl",DelStyleDecl:"delStyleDecl",SetHandlers:"setHandlers",SetScript:"setScript",DelScript:"delScript",SetRef:"setRef",DelRef:"delRef",ReplaceNode:"replaceNode",AddChild:"addChild",DelChild:"delChild",MoveChild:"moveChild"},c=class{constructor(){this.subscribers=new Map,this.wildcardSubscribers=[],this.nextSubId=0}subscribe(e,t,i){let n=`${e}:${t+""}`,s=++this.nextSubId,r={id:s,callback:i},o=this.subscribers.get(n)??[];return o.push(r),this.subscribers.set(n,o),{unsubscribe:()=>this.unsubscribe(n,s)}}upsert(e,t,i){let n=`${e}:${t+""}`,s=this.subscribers.get(n);if(s&&s.length>0){let e=s[0];e.callback=i,s.length>1&&this.subscribers.set(n,[e]);let t=e.id;return{unsubscribe:()=>this.unsubscribe(n,t)}}let r=++this.nextSubId;return this.subscribers.set(n,[{id:r,callback:i}]),{unsubscribe:()=>this.unsubscribe(n,r)}}subscribeAll(e){let t=++this.nextSubId;return this.wildcardSubscribers.push({id:t,callback:e}),{unsubscribe:()=>this.unsubscribeWildcard(t)}}publish(e,t,i){let n=this.subscribers.get(`${e}:${t+""}`)??[];for(let e of n)try{e.callback(i)}catch{}for(let n of this.wildcardSubscribers)try{n.callback(e,t+"",i)}catch{}}subscriberCount(e,t){let i=`${e}:${t+""}`;return this.subscribers.get(i)?.length??0}subscribeScript(t,i,n){return this.subscribe(e(t),i,n)}publishScript(t,i,n){let s=e(t),r=this.subscribers.get(`${s}:${i+""}`)??[];for(let e of r)try{e.callback(n)}catch{}for(let e of this.wildcardSubscribers)try{e.callback(s,i+"",n)}catch{}}publishHandler(e,t){let i=e,n=this.subscribers.get(i+":invoke")??[];for(let e of n)try{e.callback(t)}catch{}for(let e of this.wildcardSubscribers)try{e.callback(i,"invoke",t)}catch{}}clear(){this.subscribers.clear(),this.wildcardSubscribers=[]}unsubscribe(e,t){let i=this.subscribers.get(e);if(!i)return;let n=i.findIndex(e=>e.id===t);-1!==n&&(i.splice(n,1),0===i.length&&this.subscribers.delete(e))}unsubscribeWildcard(e){let t=this.wildcardSubscribers.findIndex(t=>t.id===e);-1!==t&&this.wildcardSubscribers.splice(t,1)}},g=null!=(y=V())?S(C(y)):{},l=N(E(g,"default",{value:y,enumerable:1}),y),u={debug:0,info:1,warn:2,error:3},f=new class{constructor(){this.enabled=0,this.level="info"}configure(e){void 0!==e.enabled&&(this.enabled=e.enabled),void 0!==e.level&&(this.level=e.level)}debug(e,t,...i){this.log("debug",e,t,i)}info(e,t,...i){this.log("info",e,t,i)}warn(e,t,...i){this.log("warn",e,t,i)}error(e,t,...i){this.log("error",e,t,i)}log(e,t,i,n){if(!this.enabled||u[this.level]>u[e])return;let s=`[Pond:${t}]`,r=console[e]||console.log;n.length>0?r(s,i,...n):r(s,i)}},d=class{constructor(e){this.state="disconnected",this.stateListeners=[],this.sessionId=e.sessionId,this.bus=e.bus,this.client=new l.PondClient(e.endpoint),this.channel=this.client.createChannel("live/"+e.sessionId,{sid:e.sessionId,ver:e.version,ack:e.lastAck,loc:e.location}),this.channel.onMessage((e,t)=>{this.handleMessage(t)}),this.channel.onChannelStateChange(e=>{this.handleStateChange(e)})}get sid(){return this.sessionId}get connectionState(){return this.state}connect(){this.state="connecting",this.notifyStateChange(),this.channel.join(),this.client.connect()}disconnect(){this.channel.leave(),this.client.disconnect(),this.state="disconnected",this.notifyStateChange()}onStateChange(e){return this.stateListeners.push(e),()=>{let t=this.stateListeners.indexOf(e);-1!==t&&this.stateListeners.splice(t,1)}}send(e,t,i){this.sendMessage("evt",{t:e,sid:this.sessionId,a:t+"",p:i})}sendAck(e){this.sendMessage("ack",{t:h.Ack,sid:this.sessionId,seq:e})}sendHandler(e,t){this.sendMessage("evt",{t:e,sid:this.sessionId,a:"invoke",p:t})}sendScript(e,t){this.sendMessage("evt",{t:"script:"+e,sid:this.sessionId,a:"message",p:t})}handleMessage(e){if(f.info("TRANSPORT","Transport received message:",e),!r(e))return;let{seq:t,topic:i,event:n,data:s}=e;this.isValidTopic(i)&&this.publishToBus(i,n,s,t)}isValidTopic(e){return"router"===e||"dom"===e||"frame"===e||"ack"===e||e.startsWith("script:")}publishToBus(e,t,i,n){switch(e){case"frame":"patch"===t&&this.bus.publish("frame","patch",{seq:n,patches:i});break;case"router":"push"===t?this.bus.publish("router","push",i):"replace"===t?this.bus.publish("router","replace",i):"back"===t?this.bus.publish("router","back",void 0):"forward"===t&&this.bus.publish("router","forward",void 0);break;case"dom":"call"===t?this.bus.publish("dom","call",i):"set"===t?this.bus.publish("dom","set",i):"query"===t?this.bus.publish("dom","query",i):"async"===t&&this.bus.publish("dom","async",i);break;case"ack":"ack"===t&&this.bus.publish("ack","ack",i);break;default:e.startsWith("script:")&&"send"===t&&this.bus.publishScript(i.scriptId,"send",i)}}handleStateChange(e){switch(e){case l.ChannelState.JOINED:this.state="connected";break;case l.ChannelState.STALLED:this.state="stalled";break;case l.ChannelState.CLOSED:this.state="disconnected";break;case l.ChannelState.JOINING:case l.ChannelState.IDLE:this.state="connecting"}this.notifyStateChange()}notifyStateChange(){for(let e of this.stateListeners)try{e(this.state)}catch{}}sendMessage(e,t){f.info("TRANSPORT","Transport sending message:",e,t),this.channel.sendMessage(e,t)}},(p=class e{constructor(e,t){this.handlerStore=new WeakMap,this.scriptStore=new WeakMap,this.keyedElements=new Map,this.root=e,this.callbacks=t}apply(e){let t=[...e].sort((e,t)=>e.seq-t.seq);for(let e of t)this.applyPatch(e)}applyPatch(e){let t=this.resolvePath(e.path);if(t)switch(e.op){case"setText":this.setText(t,e.value);break;case"setComment":this.setComment(t,e.value);break;case"setAttr":this.setAttr(t,e.value);break;case"delAttr":this.delAttr(t,e.name);break;case"setStyle":this.setStyle(t,e.value);break;case"delStyle":this.delStyle(t,e.name);break;case"setStyleDecl":this.setStyleDecl(t,e.selector,e.name,e.value);break;case"delStyleDecl":this.delStyleDecl(t,e.selector,e.name);break;case"setHandlers":this.setHandlers(t,e.value);break;case"setScript":this.setScript(t,e.value);break;case"delScript":this.delScript(t);break;case"setRef":this.callbacks.onRef(e.value,t);break;case"delRef":this.callbacks.onRefDelete(e.value);break;case"replaceNode":this.replaceNode(t,e.value);break;case"addChild":this.addChild(t,e.index,e.value,e.path);break;case"delChild":this.delChild(t,e.index);break;case"moveChild":this.moveChild(t,e.value,e.path)}}resolvePath(e){let t=this.root;if(e)for(let i of e){if(!t)return null;t=t.childNodes[i]??null}return t}setText(e,t){e.textContent=t}setComment(e,t){e.textContent=t}setAttr(e,t){for(let[i,n]of Object.entries(t))"class"===i?e instanceof SVGElement?e.setAttribute("class",n.join(" ")):e.className=n.join(" "):"value"===i&&e instanceof HTMLInputElement?e.value=n[0]??"":"checked"===i&&e instanceof HTMLInputElement?e.checked=n.length>0&&"false"!==n[0]:"selected"===i&&e instanceof HTMLOptionElement?e.selected=n.length>0&&"false"!==n[0]:e.setAttribute(i,0===n.length?"":n.join(" "))}delAttr(e,t){"value"===t&&e instanceof HTMLInputElement?e.value="":"checked"===t&&e instanceof HTMLInputElement?e.checked=0:"selected"===t&&e instanceof HTMLOptionElement?e.selected=0:e.removeAttribute(t)}setStyle(e,t){for(let[i,n]of Object.entries(t))e.style.setProperty(i,n)}delStyle(e,t){e.style.removeProperty(t)}setStyleDecl(e,t,i,n){let s=e.sheet;if(!s)return;let r=this.findOrCreateRule(s,t);r&&r.style.setProperty(i,n)}delStyleDecl(e,t,i){let n=e.sheet;if(!n)return;let s=this.findRule(n,t);s&&s.style.removeProperty(i)}findRule(e,t){for(let i=0;e.cssRules.length>i;i++){let n=e.cssRules[i];if(n instanceof CSSStyleRule&&n.selectorText===t)return n}return null}findOrCreateRule(e,t){let i=this.findRule(e,t);if(!i){let n=e.insertRule(t+" {}",e.cssRules.length);i=e.cssRules[n]}return i}setHandlers(e,t){let i=this.handlerStore.get(e);i&&i.forEach(e=>{e.cleanup&&e.cleanup()});let n=new Map;for(let i of t){let t=this.createHandler(e,i);n.set(i.event,t)}this.handlerStore.set(e,n)}createHandler(e,t){let i,n=null,s=0;i=t.debounce&&t.debounce>0?e=>{t.prevent&&e.cancelable&&e.preventDefault(),t.stop&&e.stopPropagation(),n&&clearTimeout(n),n=setTimeout(()=>{let i=this.extractEventData(e,t.props??[]);this.callbacks.onEvent(t.handler,i)},t.debounce)}:t.throttle&&t.throttle>0?e=>{t.prevent&&e.cancelable&&e.preventDefault(),t.stop&&e.stopPropagation();let i=Date.now();if(i-s>=t.throttle){s=i;let n=this.extractEventData(e,t.props??[]);this.callbacks.onEvent(t.handler,n)}}:e=>{t.prevent&&e.cancelable&&e.preventDefault(),t.stop&&e.stopPropagation();let i=this.extractEventData(e,t.props??[]);this.callbacks.onEvent(t.handler,i)};let r={};return t.passive&&(r.passive=1),t.once&&(r.once=1),t.capture&&(r.capture=1),e.addEventListener(t.event,i,r),{listener:i,cleanup:()=>{e.removeEventListener(t.event,i,r),n&&clearTimeout(n)}}}extractEventData(e,t){let i={};for(let n of t){let t=this.resolveProp(e,n);void 0!==t&&(i[n]=t)}return i}resolveProp(e,t){let i=t.split(".").map(e=>e.trim()).filter(Boolean);if(0===i.length)return;let n,s=i.shift();switch(s){case"event":n=e;break;case"target":n=e.target;break;case"currentTarget":n=e.currentTarget;break;default:n=e[s]}for(let e of i){if(null==n)return;try{n=n[e]}catch{return}}return this.serializeValue(n)}serializeValue(e){if(null==e)return null;let t=typeof e;if("string"===t||"number"===t||"boolean"===t)return e;if(Array.isArray(e)){let t=e.map(e=>this.serializeValue(e)).filter(e=>void 0!==e);return t.length>0?t:null}if(e instanceof Date)return e.toISOString();if(e instanceof DOMTokenList)return Array.from(e);if(!(e instanceof Node))try{return JSON.parse(JSON.stringify(e))}catch{return}}setScript(e,t){this.delScript(e),this.scriptStore.set(e,t.scriptId),this.callbacks.onScript(t,e)}delScript(e){let t=this.scriptStore.get(e);t&&(this.scriptStore.delete(e),this.callbacks.onScriptCleanup(t))}replaceNode(e,t){let i=this.createNode(t);i&&e.parentNode&&(this.cleanupTree(e),e.parentNode.replaceChild(i,e))}addChild(e,t,i,n){let s=this.createNode(i);if(s){if(i.key&&s instanceof Element){let e=`${n.join(",")}-${i.key}`;this.keyedElements.set(e,s)}e.insertBefore(s,e.childNodes[t]??null)}}delChild(e,t){let i=e.childNodes[t];i&&(this.cleanupTree(i),e.removeChild(i))}moveChild(e,t,i){let n=null;if(t.key){let e=`${i.join(",")}-${t.key}`;n=this.keyedElements.get(e)??null}n||(n=e.childNodes[t.fromIndex]??null),n&&(e.removeChild(n),e.insertBefore(n,e.childNodes[t.newIdx]??null))}cleanupTree(e){if(e.nodeType===Node.ELEMENT_NODE){let t=e,i=this.handlerStore.get(t);i&&(i.forEach(e=>{e.cleanup&&e.cleanup()}),this.handlerStore.delete(t));let n=this.scriptStore.get(t);n&&(this.scriptStore.delete(t),this.callbacks.onScriptCleanup(n));for(let t=0;e.childNodes.length>t;t++)this.cleanupTree(e.childNodes[t])}}createNode(t,i=0){if(void 0!==t.text)return document.createTextNode(t.text);if(void 0!==t.comment)return document.createComment(t.comment);if(!t.tag)return null;let n=e.SVG_TAGS.has(t.tag),s=i||n,r=s?document.createElementNS(e.SVG_NS,t.tag):document.createElement(t.tag);if(t.attrs&&this.setAttr(r,t.attrs),t.style&&this.setStyle(r,t.style),t.handlers&&t.handlers.length>0&&this.setHandlers(r,t.handlers),t.script&&this.setScript(r,t.script),t.refId&&this.callbacks.onRef(t.refId,r),t.unsafeHTML)r.innerHTML=t.unsafeHTML;else if(t.children){let e=s&&"foreignObject"!==t.tag;for(let i of t.children){let t=this.createNode(i,e);t&&r.appendChild(t)}}return r}}).SVG_NS="http://www.w3.org/2000/svg",p.SVG_TAGS=new Set(["svg","animate","animateMotion","animateTransform","circle","clipPath","defs","desc","ellipse","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","filter","foreignObject","g","image","line","linearGradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialGradient","rect","set","stop","switch","symbol","text","textPath","title","tspan","use","view"]),w=p,m=class{constructor(e){this.subscriptions=[],this.popstateHandler=null,this.bus=e.bus,this.transport=e.transport,this.resolveRef=e.resolveRef,this.setupDOMSubscriptions(),this.setupRouterSubscriptions(),this.setupPopstateListener()}destroy(){for(let e of this.subscriptions)e.unsubscribe();this.subscriptions.length=0,this.popstateHandler&&(window.removeEventListener("popstate",this.popstateHandler),this.popstateHandler=null)}setupDOMSubscriptions(){this.subscriptions.push(this.bus.subscribe("dom","call",e=>this.handleCall(e))),this.subscriptions.push(this.bus.subscribe("dom","set",e=>this.handleSet(e))),this.subscriptions.push(this.bus.subscribe("dom","query",e=>this.handleQuery(e))),this.subscriptions.push(this.bus.subscribe("dom","async",e=>this.handleAsync(e)))}setupRouterSubscriptions(){this.subscriptions.push(this.bus.subscribe("router","push",e=>this.handlePush(e))),this.subscriptions.push(this.bus.subscribe("router","replace",e=>this.handleReplace(e))),this.subscriptions.push(this.bus.subscribe("router","back",()=>this.handleBack())),this.subscriptions.push(this.bus.subscribe("router","forward",()=>this.handleForward()))}setupPopstateListener(){this.popstateHandler=()=>{let e={path:window.location.pathname,query:window.location.search.replace(/^\?/,""),hash:window.location.hash.replace(/^#/,"")};this.transport.send("router","popstate",e)},window.addEventListener("popstate",this.popstateHandler)}handleCall(e){let t=this.resolveRef(e.ref);if(!t)return;let i=t[e.method];"function"==typeof i&&i.apply(t,e.args??[])}handleSet(e){let t=this.resolveRef(e.ref);t&&(t[e.prop]=e.value)}handleQuery(e){let t=this.resolveRef(e.ref),i={requestId:e.requestId};if(!t)return i.error="ref not found: "+e.ref,void this.transport.send("dom","response",i);let n={};for(let i of e.selectors)n[i]=this.readProperty(t,i);i.values=n,this.transport.send("dom","response",i)}handleAsync(e){let t=this.resolveRef(e.ref),i={requestId:e.requestId};if(!t)return i.error="ref not found: "+e.ref,void this.transport.send("dom","response",i);let n=t[e.method];if("function"!=typeof n)return i.error="method not found: "+e.method,void this.transport.send("dom","response",i);Promise.resolve(n.apply(t,e.args??[])).then(e=>{i.result=this.serializeValue(e),this.transport.send("dom","response",i)}).catch(e=>{i.error=e instanceof Error?e.message:e+"",this.transport.send("dom","response",i)})}handlePush(e){let t=this.buildUrl(e);window.history.pushState({},"",t)}handleReplace(e){let t=this.buildUrl(e);window.history.replaceState({},"",t)}handleBack(){window.history.back()}handleForward(){window.history.forward()}buildUrl(e){let t=e.path;return e.query&&(t+="?"+e.query),e.hash&&(t+="#"+e.hash),t}readProperty(e,t){let i=t.split("."),n=e;for(let e of i){if(null==n)return;n=n[e]}return this.serializeValue(n)}serializeValue(e){if(null==e)return null;let t=typeof e;if("string"===t||"number"===t||"boolean"===t)return e;if(Array.isArray(e))return e.map(e=>this.serializeValue(e)).filter(e=>void 0!==e);if(e instanceof Date)return e.toISOString();if(e instanceof DOMTokenList)return Array.from(e);if(!(e instanceof Node))try{return JSON.parse(JSON.stringify(e))}catch{return}}},v=class{constructor(e){this.scripts=new Map,this.bus=e.bus,this.transport=e.transport}async execute(e,t){let{scriptId:i,script:n}=e;f.debug("Script","execute called",{scriptId:i,element:t.tagName,script:n.substring(0,100)+"..."}),this.cleanup(i);let s={eventHandlers:new Map,subscription:this.bus.subscribeScript(i,"send",e=>{f.debug("Script","server message received",{scriptId:i,event:e.event,data:e.data}),this.handleServerMessage(i,e.event,e.data)})},r={send:(e,t)=>{f.debug("Script","transport.send called",{scriptId:i,event:e,data:t}),this.transport.sendScript(i,{scriptId:i,event:e,data:t})},on:(e,t)=>{f.debug("Script","transport.on registered",{scriptId:i,event:e}),s.eventHandlers.set(e,t)}};try{f.debug("Script","creating function",{scriptId:i});let e=Function("element","transport",`return (${n})(element, transport);`);f.debug("Script","executing function",{scriptId:i});let o=await e(t,r);"function"==typeof o&&(f.debug("Script","cleanup function returned",{scriptId:i}),s.cleanup=o),this.scripts.set(i,s),f.debug("Script","execute complete",{scriptId:i,handlers:Array.from(s.eventHandlers.keys())})}catch(e){throw f.error("Script","execute failed",{scriptId:i,error:e+""}),s.subscription.unsubscribe(),e}}handleServerMessage(e,t,i){f.debug("Script","handleServerMessage",{scriptId:e,event:t,data:i});let n=this.scripts.get(e);if(!n)return void f.warn("Script","no instance found",{scriptId:e});let s=n.eventHandlers.get(t);if(s)try{f.debug("Script","invoking handler",{scriptId:e,event:t}),s(i)}catch(i){f.error("Script","handler error",{scriptId:e,event:t,error:i+""})}else f.warn("Script","no handler found",{scriptId:e,event:t,availableHandlers:Array.from(n.eventHandlers.keys())})}cleanup(e){f.debug("Script","cleanup called",{scriptId:e});let t=this.scripts.get(e);if(t){if(t.cleanup)try{f.debug("Script","running cleanup function",{scriptId:e}),t.cleanup()}catch(t){f.error("Script","cleanup function error",{scriptId:e,error:t+""})}t.subscription.unsubscribe(),this.scripts.delete(e),f.debug("Script","cleanup complete",{scriptId:e})}else f.debug("Script","cleanup: no instance found",{scriptId:e})}destroy(){for(let e of this.scripts.keys())this.cleanup(e)}},b=class{constructor(e){this.refs=new Map,this.cseq=0,this.lastSeq=0,this.connectedState=0,this.lastSeq=e.seq,f.configure({enabled:e.debug??0,level:"debug"}),f.info("Runtime","Initializing",{sid:e.sessionId,ver:e.version}),this.bus=new c,this.transport=new d({endpoint:e.endpoint,sessionId:e.sessionId,version:e.version,lastAck:e.seq,location:e.location,bus:this.bus}),this.patcher=new w(e.root,{onEvent:(e,t)=>this.handleEvent(e,t),onRef:(e,t)=>{this.refs.set(e,t),f.debug("Runtime","Ref set",e)},onRefDelete:e=>{this.refs.delete(e),f.debug("Runtime","Ref deleted",e)},onScript:(e,t)=>this.handleScript(e,t),onScriptCleanup:e=>this.handleScriptCleanup(e)}),this.executor=new m({bus:this.bus,transport:this.transport,resolveRef:e=>this.refs.get(e)}),this.scripts=new v({bus:this.bus,transport:this.transport}),this.bus.subscribe("frame","patch",e=>this.handlePatch(e)),this.transport.onStateChange(e=>this.handleStateChange(e)),window.__POND_RUNTIME__=this}connect(){f.info("Runtime","Connecting"),this.transport.connect()}disconnect(){f.info("Runtime","Disconnecting"),this.transport.disconnect(),this.executor.destroy(),this.scripts.destroy(),this.bus.clear(),this.refs.clear()}connected(){return this.connectedState}get seq(){return this.lastSeq}handleBoot(e){f.info("Runtime","Boot received",{ver:e.ver,seq:e.seq,patches:e.patch?.length??0}),e.patch&&e.patch.length>0&&this.applyPatches(e.patch),this.lastSeq=e.seq,this.transport.sendAck(e.seq)}handleMessage(e){if(i(e))f.error("Runtime","Server error",{code:e.code,message:e.message});else if("object"!=typeof(t=e)||null===t||"resume_ok"!==t.t)var t;else this.handleResumeOK(e)}handlePatch(e){f.debug("Runtime","Patch received",{seq:e.seq,count:e.patches?.length??0}),e.patches&&e.patches.length>0&&this.applyPatches(e.patches),this.lastSeq=e.seq,this.transport.sendAck(e.seq)}handleResumeOK(e){f.info("Runtime","Resume OK",{from:e.from,to:e.to})}handleEvent(e,t){this.cseq++,f.debug("Runtime","Event",{handler:e,cseq:this.cseq});let i={...t,cseq:this.cseq};this.transport.sendHandler(e,i)}handleScript(e,t){f.debug("Runtime","Script execute",e.scriptId),this.scripts.execute(e,t).catch(t=>{f.error("Runtime","Script error",{scriptId:e.scriptId,error:t+""})})}handleScriptCleanup(e){f.debug("Runtime","Script cleanup",e),this.scripts.cleanup(e)}handleStateChange(e){f.debug("Runtime","Connection state",e);let t=this.connectedState;this.connectedState="connected"===e,!t&&this.connectedState?f.info("Runtime","Connected"):t&&!this.connectedState&&f.warn("Runtime","Disconnected")}applyPatches(e){this.patcher.apply(e)}},"u">typeof window&&"u">typeof document&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>o()):o()),(e=>{N(E({},"__esModule",{value:1}),e)})(z)})();